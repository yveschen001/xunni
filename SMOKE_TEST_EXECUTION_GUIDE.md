# Smoke Test åŸ·è¡ŒæŒ‡å—

**æ—¥æœŸ**: 2025-11-19  
**ç‰ˆæœ¬**: v2.0 - æ“´å±•ç‰ˆ

---

## ğŸ“‹ å¿«é€Ÿé–‹å§‹

### åŸ·è¡Œæ¸¬è©¦

```bash
# åŸ·è¡Œå®Œæ•´ Smoke Test
pnpm smoke-test

# æˆ–ä½¿ç”¨ tsx ç›´æ¥åŸ·è¡Œ
pnpm tsx scripts/smoke-test.ts
```

### é æœŸçµæœ

```
ğŸš€ XunNi Bot - Comprehensive Smoke Test

================================================================================
Worker URL: https://xunni-bot-staging.yves221.workers.dev
Test User ID: 123456789
â±ï¸  Request Timeout: 10s per request
â±ï¸  Test Timeout: 30s per test
â±ï¸  Suite Timeout: 60s per suite
â±ï¸  Total Timeout: 10 minutes
================================================================================

âœ… Infrastructure completed in 1234ms
âœ… User Commands completed in 2345ms
...
âœ… Analytics Commands completed in 3456ms

================================================================================
ğŸ“Š Test Summary
================================================================================

ğŸ“ˆ Overall Results:
   Total Tests: 42
   âœ… Passed: 42
   âŒ Failed: 0
   â­ï¸  Skipped: 0
   â±ï¸  Duration: 45s
   ğŸ“Š Success Rate: 100.0%

âœ… All tests passed!
ğŸ‰ Bot is working correctly!
```

---

## ğŸ†• æ–°å¢æ¸¬è©¦å¥—ä»¶ï¼ˆ2025-11-19ï¼‰

### 1. Tutorial Systemï¼ˆæ–°æ‰‹å¼•å°æ•™å­¸ï¼‰

**æ¸¬è©¦å…§å®¹**:
- âœ… ç”¨æˆ¶è¨­ç½®æ¸¬è©¦
- âœ… Tutorial æ–‡ä»¶å­˜åœ¨æª¢æŸ¥
  - `src/telegram/handlers/tutorial.ts`
  - `src/domain/tutorial.ts`
  - `src/db/migrations/0033_alter_users_add_tutorial_fields.sql`

**é æœŸè¡Œç‚º**:
- æ‰€æœ‰æ–‡ä»¶å­˜åœ¨
- `/dev_skip` å‘½ä»¤æˆåŠŸ

---

### 2. Task Systemï¼ˆä»»å‹™ä¸­å¿ƒï¼‰

**æ¸¬è©¦å…§å®¹**:
- âœ… ç”¨æˆ¶è¨­ç½®æ¸¬è©¦
- âœ… `/tasks` å‘½ä»¤æ¸¬è©¦
- âœ… Task æ–‡ä»¶å­˜åœ¨æª¢æŸ¥
  - `src/telegram/handlers/tasks.ts`
  - `src/domain/task.ts`
  - `src/db/queries/tasks.ts`
  - `src/db/queries/user_tasks.ts`
  - `src/db/migrations/0030_create_tasks_table.sql`
  - `src/db/migrations/0031_create_user_tasks_table.sql`
- âœ… `/menu` æ•´åˆæ¸¬è©¦

**é æœŸè¡Œç‚º**:
- æ‰€æœ‰æ–‡ä»¶å­˜åœ¨
- `/tasks` å‘½ä»¤è¿”å› 200
- `/menu` å‘½ä»¤è¿”å› 200

---

### 3. Channel Membershipï¼ˆé »é“æœƒå“¡é©—è­‰ï¼‰

**æ¸¬è©¦å…§å®¹**:
- âœ… æœå‹™æ–‡ä»¶æª¢æŸ¥
  - `src/services/channel_membership_check.ts`
- âœ… API ç«¯é»æ¸¬è©¦ï¼ˆ5ç§’è¶…æ™‚ï¼‰
  - `/api/test/check-channel`

**é æœŸè¡Œç‚º**:
- æœå‹™æ–‡ä»¶å­˜åœ¨
- API ç«¯é»è¿”å› 200 æˆ– 404ï¼ˆæœªé…ç½®ï¼‰

**è¶…æ™‚ä¿è­·**:
- 5ç§’è¶…æ™‚ï¼Œå¿«é€Ÿå¤±æ•—
- ä¸æœƒé˜»å¡æ¸¬è©¦æµç¨‹

---

### 4. GigaPub Integrationï¼ˆå»£å‘Šæ•´åˆï¼‰

**æ¸¬è©¦å…§å®¹**:
- âœ… Ad é é¢å­˜åœ¨æª¢æŸ¥
  - `public/ad.html`
- âœ… GigaPub Script æª¢æŸ¥
  - `ad.gigapub.tech/script?id=4406`
  - `window.showGiga` å‡½æ•¸
- âœ… Migration æª¢æŸ¥
  - `src/db/migrations/0035_insert_gigapub_provider.sql`
  - åŒ…å« `gigapub` æä¾›å•†
  - åŒ…å« Project ID `4406`
- âœ… é é¢å¯è¨ªå•æ€§æ¸¬è©¦ï¼ˆ5ç§’è¶…æ™‚ï¼‰
  - `/ad.html` è¿”å› 200
  - HTML åŒ…å« GigaPub å…§å®¹

**é æœŸè¡Œç‚º**:
- æ‰€æœ‰æ–‡ä»¶å­˜åœ¨
- GigaPub Script æ­£ç¢ºé…ç½®
- Ad é é¢å¯è¨ªå•

**è¶…æ™‚ä¿è­·**:
- é é¢è¨ªå•ï¼š5ç§’è¶…æ™‚
- æ–‡ä»¶æª¢æŸ¥ï¼šç„¡è¶…æ™‚ï¼ˆæœ¬åœ°æ“ä½œï¼‰

---

### 5. Smart Command Promptsï¼ˆæ™ºèƒ½å‘½ä»¤æç¤ºï¼‰

**æ¸¬è©¦å…§å®¹**:
- âœ… ç”¨æˆ¶è¨­ç½®æ¸¬è©¦
- âœ… ä¸Ÿç“¶æ„åœ–è­˜åˆ¥
  - ç™¼é€ã€Œæˆ‘è¦ä¸Ÿç“¶å­ã€
  - ç³»çµ±è­˜åˆ¥ä¸¦æç¤º
- âœ… æ’¿ç“¶æ„åœ–è­˜åˆ¥
  - ç™¼é€ã€Œæˆ‘æƒ³æ’¿ç“¶å­ã€
  - ç³»çµ±è­˜åˆ¥ä¸¦æç¤º
- âœ… æœªçŸ¥å‘½ä»¤è™•ç†
  - ç™¼é€éš¨æ©Ÿæ–‡å­—
  - ç³»çµ±æä¾›å¹«åŠ©ä¿¡æ¯

**é æœŸè¡Œç‚º**:
- æ‰€æœ‰å‘½ä»¤è¿”å› 200
- ç³»çµ±æ­£ç¢ºè­˜åˆ¥ç”¨æˆ¶æ„åœ–

---

### 6. Ad System Basicsï¼ˆå»£å‘Šç³»çµ±åŸºç¤ï¼‰

**æ¸¬è©¦å…§å®¹**:
- âœ… Ad Tables Migration æª¢æŸ¥
  - `src/db/migrations/0024_create_ad_providers_table.sql`
  - `src/db/migrations/0025_create_ad_rewards_table.sql`
- âœ… Ad Handlers æª¢æŸ¥
  - `src/telegram/handlers/ad_reward.ts`
  - `src/db/queries/ad_providers.ts`
  - `src/db/queries/ad_rewards.ts`
- âœ… Ad Completion ç«¯é»æ¸¬è©¦ï¼ˆ5ç§’è¶…æ™‚ï¼‰
  - `/api/ad/complete`
  - æ¥å— 200, 400, 401, 403ï¼ˆç«¯é»å­˜åœ¨ï¼‰

**é æœŸè¡Œç‚º**:
- æ‰€æœ‰æ–‡ä»¶å­˜åœ¨
- API ç«¯é»å­˜åœ¨ï¼ˆå³ä½¿é©—è­‰å¤±æ•—ï¼‰

**è¶…æ™‚ä¿è­·**:
- API è«‹æ±‚ï¼š5ç§’è¶…æ™‚
- æ¥å—å¤šç¨®ç‹€æ…‹ç¢¼ï¼ˆç«¯é»å­˜åœ¨å³å¯ï¼‰

---

### 7. Analytics Commandsï¼ˆåˆ†æå ±è¡¨ï¼‰

**æ¸¬è©¦å…§å®¹**:
- âœ… `/analytics` å‘½ä»¤ï¼ˆè¶…ç´šç®¡ç†å“¡ï¼‰
- âœ… `/ad_performance` å‘½ä»¤ï¼ˆè¶…ç´šç®¡ç†å“¡ï¼‰
- âœ… `/funnel` å‘½ä»¤ï¼ˆè¶…ç´šç®¡ç†å“¡ï¼‰

**é æœŸè¡Œç‚º**:
- æ‰€æœ‰å‘½ä»¤è¿”å› 200
- ä½¿ç”¨è¶…ç´šç®¡ç†å“¡ ID: 396943893

**æ³¨æ„**:
- éœ€è¦è¶…ç´šç®¡ç†å“¡æ¬Šé™
- æ¸¬è©¦ä½¿ç”¨çœŸå¯¦ç®¡ç†å“¡ ID

---

## â±ï¸ è¶…æ™‚ä¿è­·æ©Ÿåˆ¶

### å¤šå±¤è¶…æ™‚è¨­è¨ˆ

```
ç¸½æ¸¬è©¦æ™‚é–“ï¼ˆ10åˆ†é˜ï¼‰
  â””â”€ æ¸¬è©¦å¥—ä»¶ï¼ˆ60ç§’ï¼‰
      â””â”€ å–®å€‹æ¸¬è©¦ï¼ˆ30ç§’ï¼‰
          â””â”€ å–®å€‹è«‹æ±‚ï¼ˆ10ç§’ï¼‰
              â””â”€ API ç«¯é»ï¼ˆ5ç§’ï¼‰- å¿«é€Ÿå¤±æ•—
```

### è¶…æ™‚é…ç½®

| å±¤ç´š | è¶…æ™‚æ™‚é–“ | èªªæ˜ |
|------|----------|------|
| **ç¸½æ¸¬è©¦** | 10 åˆ†é˜ | æ•´å€‹æ¸¬è©¦æµç¨‹ |
| **æ¸¬è©¦å¥—ä»¶** | 60 ç§’ | æ¯å€‹æ¸¬è©¦å¥—ä»¶ |
| **å–®å€‹æ¸¬è©¦** | 30 ç§’ | æ¯å€‹æ¸¬è©¦ç”¨ä¾‹ |
| **HTTP è«‹æ±‚** | 10 ç§’ | Webhook è«‹æ±‚ |
| **API ç«¯é»** | 5 ç§’ | å¿«é€Ÿå¤±æ•—æ¸¬è©¦ |

### è¶…æ™‚è¡Œç‚º

1. **è«‹æ±‚è¶…æ™‚**ï¼ˆ10ç§’ï¼‰
   - è‡ªå‹•å–æ¶ˆè«‹æ±‚
   - æ‹‹å‡º `Request timeout (10s)` éŒ¯èª¤
   - æ¨™è¨˜æ¸¬è©¦ç‚ºå¤±æ•—
   - ç¹¼çºŒä¸‹ä¸€å€‹æ¸¬è©¦

2. **æ¸¬è©¦è¶…æ™‚**ï¼ˆ30ç§’ï¼‰
   - è‡ªå‹•ä¸­æ–·æ¸¬è©¦
   - æ‹‹å‡º `Test timeout after 30000ms` éŒ¯èª¤
   - æ¨™è¨˜æ¸¬è©¦ç‚ºå¤±æ•—
   - ç¹¼çºŒä¸‹ä¸€å€‹æ¸¬è©¦

3. **å¥—ä»¶è¶…æ™‚**ï¼ˆ60ç§’ï¼‰
   - è‡ªå‹•ä¸­æ–·å¥—ä»¶
   - æ‹‹å‡º `Test suite timeout` éŒ¯èª¤
   - æ¨™è¨˜å¥—ä»¶ç‚ºå¤±æ•—
   - ç¹¼çºŒä¸‹ä¸€å€‹å¥—ä»¶

4. **ç¸½è¶…æ™‚**ï¼ˆ10åˆ†é˜ï¼‰
   - è‡ªå‹•ä¸­æ–·æ‰€æœ‰æ¸¬è©¦
   - è¼¸å‡ºå·²å®Œæˆçš„æ¸¬è©¦çµæœ
   - é€€å‡ºæ¸¬è©¦æµç¨‹

---

## ğŸš€ æ¸¬è©¦æµç¨‹

### æ¸¬è©¦åŸ·è¡Œé †åº

```
1. Core Infrastructure Tests
   â”œâ”€ Infrastructure
   â”œâ”€ User Commands
   â”œâ”€ Onboarding
   â””â”€ Dev Commands

2. Feature Tests
   â”œâ”€ Message Quota
   â”œâ”€ Conversation Identifiers
   â”œâ”€ Invite System
   â”œâ”€ MBTI Version Support
   â”œâ”€ Edit Profile Features
   â”œâ”€ Blood Type Features
   â””â”€ Conversation History Posts

3. New Feature Tests (2025-11-19)
   â”œâ”€ Tutorial System
   â”œâ”€ Task System
   â”œâ”€ Channel Membership
   â”œâ”€ GigaPub Integration
   â”œâ”€ Smart Command Prompts
   â”œâ”€ Ad System Basics
   â””â”€ Analytics Commands

4. System Tests
   â”œâ”€ Error Handling
   â”œâ”€ Database Connectivity
   â”œâ”€ Performance
   â””â”€ Command Coverage
```

### å¤±æ•—è™•ç†

1. **å–®å€‹æ¸¬è©¦å¤±æ•—**
   - âŒ æ¨™è¨˜ç‚ºå¤±æ•—
   - è¨˜éŒ„éŒ¯èª¤ä¿¡æ¯
   - ç¹¼çºŒåŸ·è¡Œå…¶ä»–æ¸¬è©¦

2. **å¥—ä»¶å¤±æ•—**
   - âŒ æ¨™è¨˜å¥—ä»¶ç‚ºå¤±æ•—
   - è¨˜éŒ„å¤±æ•—åŸå› 
   - ç¹¼çºŒåŸ·è¡Œå…¶ä»–å¥—ä»¶

3. **ç¸½æ¸¬è©¦å¤±æ•—**
   - è¼¸å‡ºæ‰€æœ‰å¤±æ•—æ¸¬è©¦
   - é¡¯ç¤ºéŒ¯èª¤è©³æƒ…
   - é€€å‡ºç¢¼ï¼š1

---

## ğŸ“Š æ¸¬è©¦è¦†è“‹ç‡

### ç•¶å‰è¦†è“‹ç‡

| åˆ†é¡ | æ¸¬è©¦æ•¸ | ç‹€æ…‹ |
|------|--------|------|
| **åŸºç¤è¨­æ–½** | 2 | âœ… |
| **ç”¨æˆ¶å‘½ä»¤** | 4 | âœ… |
| **è¨»å†Šæµç¨‹** | 2 | âœ… |
| **é–‹ç™¼å‘½ä»¤** | 4 | âœ… |
| **æ¶ˆæ¯é…é¡** | 3 | âœ… |
| **å°è©±æ¨™è­˜ç¬¦** | 2 | âœ… |
| **é‚€è«‹ç³»çµ±** | 5 | âœ… |
| **MBTI æ¸¬é©—** | 2 | âœ… |
| **å€‹äººè³‡æ–™ç·¨è¼¯** | 3 | âœ… |
| **è¡€å‹åŠŸèƒ½** | 2 | âœ… |
| **å°è©±æ­·å²** | 3 | âœ… |
| **æ–°æ‰‹å¼•å°** | 2 | ğŸ†• |
| **ä»»å‹™ä¸­å¿ƒ** | 4 | ğŸ†• |
| **é »é“é©—è­‰** | 2 | ğŸ†• |
| **GigaPub** | 3 | ğŸ†• |
| **æ™ºèƒ½æç¤º** | 4 | ğŸ†• |
| **å»£å‘Šç³»çµ±** | 3 | ğŸ†• |
| **åˆ†æå ±è¡¨** | 3 | ğŸ†• |
| **éŒ¯èª¤è™•ç†** | 3 | âœ… |
| **æ•¸æ“šåº«** | 1 | âœ… |
| **æ€§èƒ½æ¸¬è©¦** | 2 | âœ… |
| **å‘½ä»¤è¦†è“‹** | 1 | âœ… |

**ç¸½è¨ˆ**: 42+ å€‹æ¸¬è©¦  
**è¦†è“‹ç‡**: ~40%ï¼ˆå¾ 14.4% æå‡ï¼‰

---

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

#### 1. æ¸¬è©¦è¶…æ™‚

**ç—‡ç‹€**: `Request timeout (10s)` æˆ– `Test timeout after 30000ms`

**åŸå› **:
- Worker éŸ¿æ‡‰æ…¢
- ç¶²çµ¡å•é¡Œ
- æ•¸æ“šåº«æŸ¥è©¢æ…¢

**è§£æ±ºæ–¹æ¡ˆ**:
- æª¢æŸ¥ Worker ç‹€æ…‹
- æª¢æŸ¥ç¶²çµ¡é€£æ¥
- å¢åŠ è¶…æ™‚æ™‚é–“ï¼ˆå¦‚æœåˆç†ï¼‰

---

#### 2. API ç«¯é» 404

**ç—‡ç‹€**: `Expected 200 or 404, got 500`

**åŸå› **:
- ç«¯é»æœªå¯¦ç¾
- è·¯ç”±é…ç½®éŒ¯èª¤

**è§£æ±ºæ–¹æ¡ˆ**:
- æª¢æŸ¥ `src/router.ts`
- æª¢æŸ¥ `src/worker.ts`
- ç¢ºèªç«¯é»å·²éƒ¨ç½²

---

#### 3. æ–‡ä»¶ä¸å­˜åœ¨

**ç—‡ç‹€**: `Required file missing: ...`

**åŸå› **:
- Migration æœªåŸ·è¡Œ
- æ–‡ä»¶è·¯å¾‘éŒ¯èª¤
- Git æœªåŒæ­¥

**è§£æ±ºæ–¹æ¡ˆ**:
- æª¢æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- åŸ·è¡Œ `git pull`
- æª¢æŸ¥æ–‡ä»¶è·¯å¾‘

---

#### 4. æ¬Šé™éŒ¯èª¤

**ç—‡ç‹€**: `Expected 200, got 403`

**åŸå› **:
- è¶…ç´šç®¡ç†å“¡ ID ä¸æ­£ç¢º
- æ¬Šé™é…ç½®éŒ¯èª¤

**è§£æ±ºæ–¹æ¡ˆ**:
- æª¢æŸ¥ `SUPER_ADMIN_USER_ID` é…ç½®
- æª¢æŸ¥ `wrangler.toml`
- ä½¿ç”¨æ­£ç¢ºçš„æ¸¬è©¦ ID

---

## ğŸ“ æœ€ä½³å¯¦è¸

### 1. å®šæœŸåŸ·è¡Œæ¸¬è©¦

```bash
# æ¯æ¬¡éƒ¨ç½²å‰
pnpm smoke-test

# æ¯æ¬¡é‡å¤§æ›´æ–°å¾Œ
pnpm smoke-test

# æ¯é€±å®šæœŸæª¢æŸ¥
pnpm smoke-test
```

### 2. ç›£æ§æ¸¬è©¦æ™‚é–“

- ç¸½æ¸¬è©¦æ™‚é–“æ‡‰ < 2 åˆ†é˜
- å–®å€‹æ¸¬è©¦æ‡‰ < 5 ç§’
- æ…¢æ¸¬è©¦ï¼ˆ>5ç§’ï¼‰æœƒè¢«æ¨™è¨˜

### 3. è™•ç†å¤±æ•—æ¸¬è©¦

1. æŸ¥çœ‹å¤±æ•—åŸå› 
2. æª¢æŸ¥ Cloudflare Logs
3. ä¿®å¾©å•é¡Œ
4. é‡æ–°é‹è¡Œæ¸¬è©¦
5. ç¢ºèªé€šé

### 4. æ·»åŠ æ–°æ¸¬è©¦

1. åœ¨ç¾æœ‰å¥—ä»¶ä¸­æ·»åŠ 
2. ä½¿ç”¨ `testEndpoint` å‡½æ•¸
3. è¨­ç½®é©ç•¶çš„è¶…æ™‚
4. æ·»åŠ éŒ¯èª¤è™•ç†
5. æ¸¬è©¦é€šéå¾Œæäº¤

---

## ğŸ”„ æŒçºŒæ”¹é€²

### ä¸‹ä¸€æ­¥è¨ˆåŠƒ

1. **å¢åŠ æ¸¬è©¦è¦†è“‹ç‡**
   - ç›®æ¨™ï¼š60%ï¼ˆç•¶å‰ 40%ï¼‰
   - æ·»åŠ å°è©±å®Œæ•´æµç¨‹æ¸¬è©¦
   - æ·»åŠ  VIP åŠŸèƒ½æ¸¬è©¦

2. **æ”¹é€²æ¸¬è©¦è³ªé‡**
   - æ·»åŠ æ›´å¤šé‚Šç•Œæ¸¬è©¦
   - æ·»åŠ éŒ¯èª¤æƒ…æ³æ¸¬è©¦
   - æ·»åŠ æ€§èƒ½åŸºæº–æ¸¬è©¦

3. **è‡ªå‹•åŒ–æ¸¬è©¦**
   - CI/CD æ•´åˆ
   - è‡ªå‹•é‹è¡Œæ¸¬è©¦
   - è‡ªå‹•å ±å‘Šçµæœ

---

## ğŸ“š ç›¸é—œæ–‡æª”

- **æ¸¬è©¦ç¼ºå£åˆ†æ**: `SMOKE_TEST_GAP_ANALYSIS.md`
- **æ¸¬è©¦è¦†è“‹å ±å‘Š**: `SMOKE_TEST_COVERAGE_REPORT.md`
- **é–‹ç™¼æ¨™æº–**: `doc/DEVELOPMENT_STANDARDS.md`

---

**æœ€å¾Œæ›´æ–°**: 2025-11-19  
**ç‰ˆæœ¬**: v2.0 - æ“´å±•ç‰ˆ

