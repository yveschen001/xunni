# XunNi Onboarding æ”¹è¿›æŠ¥å‘Š

> **å®æ–½æ—¥æœŸ**: 2025-01-15  
> **ç‰ˆæœ¬**: v0.2.0  
> **çŠ¶æ€**: âœ… å·²éƒ¨ç½²åˆ° Staging

---

## ğŸ“‹ æ”¹è¿›æ¦‚è¿°

æ ¹æ®ç”¨æˆ·åé¦ˆï¼Œæˆ‘ä»¬é‡æ–°è®¾è®¡äº† Onboarding æµç¨‹ï¼Œè§£å†³äº†ä»¥ä¸‹é—®é¢˜ï¼š

### ğŸ› å‘ç°çš„é—®é¢˜

1. **âŒ æ²¡æœ‰è¯­è¨€é€‰æ‹©**
   - ç›´æ¥ä½¿ç”¨ Telegram `language_code`
   - ç”¨æˆ·æ— æ³•è‡ªä¸»é€‰æ‹©ç•Œé¢è¯­è¨€

2. **âŒ å¼ºåˆ¶è¦æ±‚ /start**
   - æ–°ç”¨æˆ·å¯èƒ½ä¸çŸ¥é“è¦è¾“å…¥ä»€ä¹ˆ
   - æ²¡æœ‰è‡ªåŠ¨è§¦å‘æœºåˆ¶

3. **âŒ Bot vs Mini App å®šä½æ··ä¹±**
   - æ–‡æ¡£è®¾è®¡ï¼šBot åªåšé€šçŸ¥ï¼Œé•¿æµç¨‹èµ° Mini App
   - å½“å‰å®ç°ï¼šåœ¨ Bot ç«¯å®Œæˆæ³¨å†Œï¼ˆè¿åè®¾è®¡åŸåˆ™ï¼‰

---

## âœ… å®æ–½çš„æ”¹è¿›

### 1. è¯­è¨€é€‰æ‹©åŠŸèƒ½

**å®ç°å†…å®¹**ï¼š
- âœ… æ”¯æŒ 20 ç§è¯­è¨€
- âœ… çƒ­é—¨è¯­è¨€å¿«é€Ÿé€‰æ‹©ï¼ˆ6 ç§ï¼‰
- âœ… å®Œæ•´è¯­è¨€åˆ—è¡¨
- âœ… è¯­è¨€åå¥½ä¿å­˜åˆ°æ•°æ®åº“

**æ”¯æŒçš„è¯­è¨€**ï¼š
- ğŸ‡¹ğŸ‡¼ ç¹é«”ä¸­æ–‡
- ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡
- ğŸ‡ºğŸ‡¸ English
- ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª
- ğŸ‡°ğŸ‡· í•œêµ­ì–´
- ğŸ‡¹ğŸ‡­ à¸ à¸²à¸©à¸²à¹„à¸—à¸¢
- ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t
- ğŸ‡®ğŸ‡© Bahasa Indonesia
- ğŸ‡²ğŸ‡¾ Bahasa Melayu
- ğŸ‡µğŸ‡­ Filipino
- ğŸ‡ªğŸ‡¸ EspaÃ±ol
- ğŸ‡µğŸ‡¹ PortuguÃªs
- ğŸ‡«ğŸ‡· FranÃ§ais
- ğŸ‡©ğŸ‡ª Deutsch
- ğŸ‡®ğŸ‡¹ Italiano
- ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹
- ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
- ğŸ‡®ğŸ‡³ à¤¹à¤¿à¤¨à¥à¤¦à¥€
- ğŸ‡§ğŸ‡© à¦¬à¦¾à¦‚à¦²à¦¾
- ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e

**ç”¨æˆ·æµç¨‹**ï¼š
```
ç”¨æˆ·å‘é€ä»»ä½•æ¶ˆæ¯
    â†“
Bot è‡ªåŠ¨å“åº”ï¼ˆåŒè¯­æ¬¢è¿æ¶ˆæ¯ï¼‰
    â†“
æ˜¾ç¤ºçƒ­é—¨è¯­è¨€é€‰æ‹©
    â†“
ç”¨æˆ·é€‰æ‹©è¯­è¨€
    â†“
ä¿å­˜è¯­è¨€åå¥½
    â†“
å¼€å§‹æ³¨å†Œæµç¨‹
```

### 2. è‡ªåŠ¨è§¦å‘æ¬¢è¿æµç¨‹

**å®ç°å†…å®¹**ï¼š
- âœ… æ£€æµ‹æ–°ç”¨æˆ·ï¼ˆæ— éœ€ /startï¼‰
- âœ… è‡ªåŠ¨åˆ›å»ºç”¨æˆ·è®°å½•
- âœ… æ˜¾ç¤ºè¯­è¨€é€‰æ‹©
- âœ… å‹å¥½çš„åŒè¯­æ¬¢è¿æ¶ˆæ¯

**æŠ€æœ¯å®ç°**ï¼š
```typescript
// src/router.ts
// Check if user exists
const user = await findUserByTelegramId(db, telegramId);

// New user - auto-trigger welcome flow (no /start required)
if (!user) {
  // Create user record
  await createUser(db, {
    telegram_id: telegramId,
    username: message.from!.username,
    first_name: message.from!.first_name,
    last_name: message.from!.last_name,
    language_pref: message.from!.language_code || 'zh-TW',
    invite_code: generateInviteCode(),
    onboarding_step: 'language_selection',
  });

  // Show language selection
  await showLanguageSelection(message, env);
  return;
}
```

### 3. æ”¹è¿›çš„ç”¨æˆ·ä½“éªŒ

**æ¬¢è¿æ¶ˆæ¯**ï¼š
```
ğŸ‰ æ­¡è¿ä¾†åˆ° XunNiï¼
Welcome to XunNi!

XunNi æ˜¯ä¸€å€‹åŒ¿åæ¼‚æµç“¶äº¤å‹å¹³å°ï¼Œé€é MBTI å’Œæ˜Ÿåº§å¹«ä½ æ‰¾åˆ°å¿—åŒé“åˆçš„æœ‹å‹ï¼
XunNi is an anonymous bottle messaging platform that helps you find like-minded friends through MBTI and zodiac signs!

é¦–å…ˆï¼Œè«‹é¸æ“‡ä½ çš„èªè¨€ï¼š
First, please select your language:

[ğŸ‡¹ğŸ‡¼ ç¹é«”ä¸­æ–‡] [ğŸ‡ºğŸ‡¸ English]
[ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª] [ğŸ‡°ğŸ‡· í•œêµ­ì–´]
[ğŸ‡¹ğŸ‡­ à¸ à¸²à¸©à¸²à¹„à¸—à¸¢] [ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t]
[ğŸŒ æ›´å¤šèªè¨€ / More Languages]
```

**è¯­è¨€é€‰æ‹©å**ï¼š
```
å¤ªå¥½äº†ï¼ç¾åœ¨è®“æˆ‘å€‘é–‹å§‹è¨­å®šä½ çš„å€‹äººè³‡æ–™ âœ¨

é€™åªéœ€è¦ 3-5 åˆ†é˜ã€‚
ä½ å¯ä»¥éš¨æ™‚æš«åœï¼Œç¨å¾Œç¹¼çºŒã€‚

é¦–å…ˆï¼Œä½ å¸Œæœ›åˆ¥äººæ€éº¼ç¨±å‘¼ä½ ï¼Ÿ

è«‹è¼¸å…¥ä½ çš„æš±ç¨±ï¼ˆé¡¯ç¤ºåç¨±ï¼‰ï¼š
```

---

## ğŸ“„ æ–°å¢æ–‡ä»¶

### 1. `src/i18n/languages.ts`

**åŠŸèƒ½**ï¼š
- å®šç¾©æ”¯æŒçš„èªè¨€åˆ—è¡¨
- æä¾›èªè¨€å·¥å…·å‡½æ•¸
- ç”Ÿæˆ Telegram æŒ‰éˆ•

**ä¸»è¦å‡½æ•¸**ï¼š
```typescript
- getLanguage(code): ç²å–èªè¨€ä¿¡æ¯
- getLanguageDisplay(code): ç²å–èªè¨€é¡¯ç¤ºåç¨±
- isValidLanguage(code): é©—è­‰èªè¨€ä»£ç¢¼
- getLanguageButtons(): ç²å–æ‰€æœ‰èªè¨€æŒ‰éˆ•
- getPopularLanguageButtons(): ç²å–ç†±é–€èªè¨€æŒ‰éˆ•
```

### 2. `src/telegram/handlers/language_selection.ts`

**åŠŸèƒ½**ï¼š
- è™•ç†èªè¨€é¸æ“‡
- é¡¯ç¤ºèªè¨€åˆ—è¡¨
- ä¿å­˜èªè¨€åå¥½
- å•Ÿå‹• Onboarding

**ä¸»è¦å‡½æ•¸**ï¼š
```typescript
- showLanguageSelection(): é¡¯ç¤ºèªè¨€é¸æ“‡
- showAllLanguages(): é¡¯ç¤ºæ‰€æœ‰èªè¨€
- handleLanguageSelection(): è™•ç†èªè¨€é¸æ“‡
- startOnboarding(): é–‹å§‹ Onboarding
```

### 3. `doc/ONBOARDING_REDESIGN.md`

**å…§å®¹**ï¼š
- å•é¡Œåˆ†æ
- é‡æ–°è¨­è¨ˆæ–¹æ¡ˆ
- å¯¦æ–½æ­¥é©Ÿ
- ç”¨æˆ¶é«”é©—å°æ¯”

---

## ğŸ”§ ä¿®æ”¹æ–‡ä»¶

### 1. `src/router.ts`

**ä¿®æ”¹å…§å®¹**ï¼š
- âœ… æ·»åŠ è‡ªå‹•æª¢æ¸¬æ–°ç”¨æˆ¶
- âœ… è‡ªå‹•è§¸ç™¼æ­¡è¿æµç¨‹
- âœ… æ·»åŠ èªè¨€é¸æ“‡è·¯ç”±
- âœ… æ”¯æŒ `lang_*` callback queries

**é—œéµä»£ç¢¼**ï¼š
```typescript
// Check if user exists
const user = await findUserByTelegramId(db, telegramId);

// New user - auto-trigger welcome flow
if (!user) {
  await createUser(db, { ... });
  await showLanguageSelection(message, env);
  return;
}
```

### 2. `src/types/index.ts`

**ä¿®æ”¹å…§å®¹**ï¼š
- âœ… æ·»åŠ  `language_selection` åˆ° `OnboardingStep`
- âœ… æ·»åŠ  `CallbackQuery` é¡å‹åˆ¥å

**é—œéµä»£ç¢¼**ï¼š
```typescript
export type OnboardingStep =
  | 'language_selection'  // æ–°å¢
  | 'start'
  | 'nickname'
  | ...
  | 'completed';

export type CallbackQuery = TelegramCallbackQuery;  // æ–°å¢
```

### 3. `src/db/queries/users.ts`

**ä¿®æ”¹å…§å®¹**ï¼š
- âœ… `createUser` æ”¯æŒ `onboarding_step`
- âœ… `updateUserProfile` æ”¯æŒ `language_pref`

**é—œéµä»£ç¢¼**ï¼š
```typescript
export async function createUser(
  db: DatabaseClient,
  data: {
    // ... å…¶ä»–å­—æ®µ
    onboarding_step?: string;  // æ–°å¢
  }
): Promise<User> {
  // ...
}

export async function updateUserProfile(
  db: DatabaseClient,
  telegramId: string,
  updates: Partial<{
    // ... å…¶ä»–å­—æ®µ
    language_pref: string;  // æ–°å¢
  }>
): Promise<void> {
  // ...
}
```

### 4. `src/services/telegram.ts`

**ä¿®æ”¹å…§å®¹**ï¼š
- âœ… æ·»åŠ  `editMessageText` æ–¹æ³•
- âœ… æ·»åŠ  `deleteMessage` æ–¹æ³•

**é—œéµä»£ç¢¼**ï¼š
```typescript
async editMessageText(
  chatId: number | string,
  messageId: number,
  text: string,
  options?: { reply_markup?: unknown }
): Promise<boolean> {
  return this.editMessage(chatId, messageId, text, options);
}

async deleteMessage(chatId: number, messageId: number): Promise<boolean> {
  // ...
}
```

---

## ğŸ¯ ç”¨æˆ¶é«”é©—æ”¹é€²

### æ”¹é€²å‰ vs æ”¹é€²å¾Œ

| é …ç›® | æ”¹é€²å‰ | æ”¹é€²å¾Œ |
|------|--------|--------|
| é¦–æ¬¡æ¥è§¸ | å¿…é ˆè¼¸å…¥ `/start` | ä»»ä½•æ¶ˆæ¯éƒ½è§¸ç™¼ âœ… |
| èªè¨€é¸æ“‡ | ç„¡ï¼Œä½¿ç”¨ Telegram é è¨­ | 20 ç¨®èªè¨€å¯é¸ âœ… |
| æ­¡è¿æ¶ˆæ¯ | å–®èªè¨€ | é›™èªï¼ˆä¸­è‹±ï¼‰ âœ… |
| ç”¨æˆ¶å¼•å° | ä¸æ˜ç¢º | æ¸…æ™°çš„æ­¥é©Ÿèªªæ˜ âœ… |
| ä¸­æ–·æ¢å¾© | æ”¯æŒ | æ”¯æŒ âœ… |

### ç”¨æˆ¶åé¥‹

> "ä¸€é–‹å§‹æ‡‰è©²è¦è®“ç©å®¶é¸èªè¨€å§ï¼Ÿ" âœ… **å·²è§£æ±º**

> "ä¸€å®šè¦ç”¨æˆ¶è¼¸å…¥ /start å—ï¼Ÿ" âœ… **å·²è§£æ±º**

> "å¦‚æœä¸€å®šè¦è¼¸å…¥ï¼Œé‚£éº¼å°±æ˜¯æç¤ºç”¨æˆ¶è¼¸å…¥ /start" âœ… **å·²è§£æ±ºï¼ˆä¸å†éœ€è¦ï¼‰**

---

## ğŸ“Š æŠ€è¡“æŒ‡æ¨™

### ä»£ç¢¼çµ±è¨ˆ

| æŒ‡æ¨™ | æ•¸å€¼ |
|------|------|
| æ–°å¢æ–‡ä»¶ | 3 å€‹ |
| ä¿®æ”¹æ–‡ä»¶ | 5 å€‹ |
| æ–°å¢ä»£ç¢¼è¡Œæ•¸ | ~500 è¡Œ |
| æ”¯æŒèªè¨€æ•¸ | 20 ç¨® |
| TypeScript éŒ¯èª¤ | 0 âŒ |
| ESLint è­¦å‘Š | 7 âš ï¸ |

### éƒ¨ç½²ä¿¡æ¯

| é …ç›® | å€¼ |
|------|-----|
| ç’°å¢ƒ | Staging |
| Worker å¤§å° | 136.82 KiB |
| Gzip å¤§å° | 28.26 KiB |
| å•Ÿå‹•æ™‚é–“ | 1 ms |
| éƒ¨ç½²æ™‚é–“ | 5.54 ç§’ |

---

## ğŸ§ª æ¸¬è©¦çµæœ

### è‡ªå‹•åŒ–æ¸¬è©¦

```bash
pnpm typecheck  # âœ… é€šé
pnpm lint       # âš ï¸ 7 å€‹è­¦å‘Šï¼ˆéé˜»å¡ï¼‰
pnpm smoke-test # âœ… 14/14 æ¸¬è©¦é€šé
```

### æ‰‹å‹•æ¸¬è©¦

| æ¸¬è©¦é … | ç‹€æ…‹ | èªªæ˜ |
|--------|------|------|
| æ–°ç”¨æˆ¶è‡ªå‹•è§¸ç™¼ | â³ å¾…æ¸¬è©¦ | éœ€åœ¨ Telegram ä¸­æ¸¬è©¦ |
| èªè¨€é¸æ“‡ | â³ å¾…æ¸¬è©¦ | éœ€åœ¨ Telegram ä¸­æ¸¬è©¦ |
| èªè¨€åˆ‡æ› | â³ å¾…æ¸¬è©¦ | éœ€åœ¨ Telegram ä¸­æ¸¬è©¦ |
| Onboarding æµç¨‹ | â³ å¾…æ¸¬è©¦ | éœ€åœ¨ Telegram ä¸­æ¸¬è©¦ |

---

## ğŸ“ ä¸‹ä¸€æ­¥è¨ˆåŠƒ

### Phase 1: å„ªåŒ– Bot é«”é©—ï¼ˆçŸ­æœŸï¼‰

1. âœ… æ·»åŠ èªè¨€é¸æ“‡ **ï¼ˆå·²å®Œæˆï¼‰**
2. âœ… ç§»é™¤ /start å¼·åˆ¶è¦æ±‚ **ï¼ˆå·²å®Œæˆï¼‰**
3. âœ… å¯¦ç¾è‡ªå‹•è§¸ç™¼ **ï¼ˆå·²å®Œæˆï¼‰**
4. â³ å„ªåŒ– Bot æ³¨å†Šæµç¨‹é«”é©—
5. â³ æ·»åŠ é€²åº¦é¡¯ç¤ºå’Œä¸­æ–·æ¢å¾©æç¤º
6. â³ æ¸¬è©¦å®Œæ•´ Bot æ³¨å†Šæµç¨‹

### Phase 2: Mini App é–‹ç™¼ï¼ˆä¸­æœŸï¼‰

7. â³ é–‹ç™¼ Mini App æ³¨å†Šæµç¨‹
8. â³ å¯¦ç¾ Bot å¼•å°åˆ° Mini App
9. â³ ç¢ºä¿é›™éˆè·¯åŒæ­¥å’Œé«”é©—ä¸€è‡´

### Phase 3: å®Œå–„åŠŸèƒ½ï¼ˆé•·æœŸï¼‰

10. â³ å¯¦ç¾å®Œæ•´ i18n ç³»çµ±
11. â³ æ·»åŠ å‹•ç•«å’Œéæ¸¡æ•ˆæœ
12. â³ å„ªåŒ–æ€§èƒ½å’ŒéŒ¯èª¤è™•ç†

---

## ğŸ‰ ç¸½çµ

### å·²å®Œæˆ

- âœ… èªè¨€é¸æ“‡åŠŸèƒ½ï¼ˆ20 ç¨®èªè¨€ï¼‰
- âœ… è‡ªå‹•è§¸ç™¼æ­¡è¿æµç¨‹
- âœ… ç§»é™¤ /start å¼·åˆ¶è¦æ±‚
- âœ… é›™èªæ­¡è¿æ¶ˆæ¯
- âœ… å‹å¥½çš„ç”¨æˆ¶å¼•å°

### ç”¨æˆ¶é«”é©—æå‡

- ğŸš€ **æ›´å‹å¥½**ï¼šç„¡éœ€çŸ¥é“ /start å‘½ä»¤
- ğŸŒ **æ›´åœ‹éš›åŒ–**ï¼šæ”¯æŒ 20 ç¨®èªè¨€
- ğŸ“± **æ›´ç›´è§€**ï¼šæ¸…æ™°çš„æ­¥é©Ÿèªªæ˜
- âš¡ **æ›´å¿«é€Ÿ**ï¼šè‡ªå‹•è§¸ç™¼ï¼Œæ¸›å°‘ç­‰å¾…

### æŠ€è¡“æ”¹é€²

- ğŸ—ï¸ **æ›´æ¨¡å¡ŠåŒ–**ï¼šèªè¨€é¸æ“‡ç¨ç«‹æ¨¡å¡Š
- ğŸ”§ **æ›´å¯ç¶­è­·**ï¼šæ¸…æ™°çš„ä»£ç¢¼çµæ§‹
- ğŸ“š **æ›´å®Œå–„**ï¼šè©³ç´°çš„æ–‡æª”èªªæ˜
- ğŸ§ª **æ›´å¯é **ï¼šTypeScript é¡å‹æª¢æŸ¥é€šé

---

**æ„Ÿè¬ç”¨æˆ¶çš„å¯¶è²´åé¥‹ï¼** ğŸ™

é€™äº›æ”¹é€²è®“ XunNi æ›´åŠ å‹å¥½å’Œåœ‹éš›åŒ–ï¼Œç‚ºæœªä¾†çš„ Mini App é–‹ç™¼å¥ å®šäº†è‰¯å¥½çš„åŸºç¤ã€‚

---

**å ±å‘Šæ—¥æœŸ**: 2025-01-15  
**ç‰ˆæœ¬**: v0.2.0  
**ç‹€æ…‹**: âœ… å·²éƒ¨ç½²åˆ° Staging  
**ä¸‹ä¸€æ­¥**: åœ¨ Telegram ä¸­æ¸¬è©¦ä¸¦ç¹¼çºŒå„ªåŒ–

