name = "xunni-bot"
main = "src/worker.ts"
compatibility_date = "2025-01-15"
node_compat = true
account_id = "7404fbe7880034e92c7d4a20969e42f5"

# D1 Migrations
[[d1_databases]]
binding = "DB"
database_name = "xunni-db-staging"
database_id = "7b77ad82-ba26-489f-995f-8256b32379df"
migrations_dir = "src/db/migrations"

# Default environment variables (non-sensitive)
[vars]
ENVIRONMENT = "development"
LOG_LEVEL = "debug"
BROADCAST_BATCH_SIZE = "25"
BROADCAST_MAX_JOBS = "3"
ENABLE_AI_MODERATION = "true"
ENABLE_TRANSLATION = "true"
ADMIN_LOG_GROUP_ID = "-4917557179"

# Staging environment
[env.staging]
name = "xunni-bot-staging"

[env.staging.vars]
ENVIRONMENT = "staging"
LOG_LEVEL = "info"
BROADCAST_BATCH_SIZE = "25"
BROADCAST_MAX_JOBS = "3"
ENABLE_AI_MODERATION = "true"
ENABLE_TRANSLATION = "true"
ADMIN_LOG_GROUP_ID = "-4917557179"
GEMINI_PROJECT_ID = "gen-lang-client-0526946218"
GEMINI_LOCATION = "us-central1"
GEMINI_MODELS = "gemini-2.0-flash-exp,gemini-2.5-flash-lite"
GEMINI_API_VERSION = "v1beta"
OPENAI_MODEL = "gpt-4o-mini"
# Super Admin Configuration
SUPER_ADMIN_USER_ID = "396943893"
ADMIN_USER_IDS = ""  # Regular admins (comma-separated). Super admin 396943893 is always included
# Ad System Configuration
PUBLIC_URL = "https://xunni-bot-staging.yves221.workers.dev"
ENABLE_ANALYTICS = "true"
AD_PROVIDER_STRATEGY = "priority"
AD_REWARD_SECRET = "NOGD2InZ/VuIhZPSiajhwdmIc/PKHnijE/VSUKxzspM="
# Official Channel ID for task verification
OFFICIAL_CHANNEL_ID = "-1003260293651"
# VIP Subscription (requires BotFather setup - set to "true" after enabling in @BotFather)
ENABLE_VIP_SUBSCRIPTION = "false"
# Smart Matching Configuration
ENABLE_SMART_MATCHING = "true"
SMART_MATCHING_THRESHOLD = "70"  # Minimum score for smart recommendation
# MoonPacket API Configuration (Dev/Staging only - move to secrets for prod)
MOONPACKET_API_KEY = "HvQ/2z53aaqfuOyfAxqsnq1YpQWwZuPdxFWDmbXaTKM="

# Staging D1 Database
[[env.staging.d1_databases]]
binding = "DB"
database_name = "xunni-db-staging"
database_id = "7b77ad82-ba26-489f-995f-8256b32379df"
migrations_dir = "src/db/migrations"

# Staging KV Namespace for caching (free tier)
[[env.staging.kv_namespaces]]
binding = "CACHE"
id = "8222fd298f254b498b7842d03e5d2a4d"

# Staging Cron triggers (temporarily disabled due to API issue)
# [[env.staging.triggers.crons]]
# cron = "0 * * * *"  # Every hour (Channel membership check)
# 
# [[env.staging.triggers.crons]]
# cron = "0 10 * * *"  # Every day at 10:00 UTC = 18:00 Taipei (VIP expiration check)
# 
# [[env.staging.triggers.crons]]
# cron = "0 9 * * *"  # Every day at 09:00 UTC = 17:00 Taipei (Daily reports)

# Production environment
[env.production]
name = "xunni-bot"

[env.production.vars]
ENVIRONMENT = "production"
LOG_LEVEL = "warn"
ADMIN_LOG_GROUP_ID = "-4917557179"
# Super Admin Configuration
SUPER_ADMIN_USER_ID = "396943893"
ADMIN_USER_IDS = ""
# Ad System Configuration
PUBLIC_URL = "https://xunni-bot.yves221.workers.dev"
ENABLE_ANALYTICS = "true"
AD_PROVIDER_STRATEGY = "priority"
AD_REWARD_SECRET = "NOGD2InZ/VuIhZPSiajhwdmIc/PKHnijE/VSUKxzspM="
# Official Channel ID for task verification
OFFICIAL_CHANNEL_ID = "-1003260293651"
# VIP Subscription (requires BotFather setup - set to "true" after enabling in @BotFather)
ENABLE_VIP_SUBSCRIPTION = "false"
# Smart Matching Configuration
ENABLE_SMART_MATCHING = "true"
SMART_MATCHING_THRESHOLD = "70"  # Minimum score for smart recommendation
# MoonPacket API Key should be set via secrets for production

# Production D1 Database
# Run: wrangler d1 create xunni-db-production
# Then uncomment and fill in the database_id
# [[env.production.d1_databases]]
# binding = "DB"
# database_name = "xunni-db-production"
# database_id = "<PRODUCTION_D1_DATABASE_ID>"

# Production KV Namespace for caching (free tier)
[[env.production.kv_namespaces]]
binding = "CACHE"
id = "0a6b866ecab6428691f462178473f94f"

# Production Cron triggers
[[env.production.triggers.crons]]
cron = "0 9 * * 1"  # Every Monday at 9:00 UTC (Horoscope)

[[env.production.triggers.crons]]
cron = "0 9 * * *"  # Every day at 09:00 UTC = 17:00 Taipei (Daily reports to super admins)

[[env.production.triggers.crons]]
cron = "0 10 * * *"  # Every day at 10:00 UTC = 18:00 Taipei (VIP expiration check)

[[env.production.triggers.crons]]
cron = "0 * * * *"  # Every hour (Channel membership check)

[[env.production.triggers.crons]]
cron = "5 0 * * *"  # Every day at 00:05 UTC (Daily stats generation)

[[env.production.triggers.crons]]
cron = "*/5 * * * *"  # Every 5 minutes (Broadcast queue)

[[env.production.triggers.crons]]
cron = "0 * * * *"  # Every hour (Channel membership check)

[[env.production.triggers.crons]]
cron = "0 3 * * *"  # Every day at 03:00 UTC = 11:00 Taipei (Avatar cache batch update)

[[env.production.triggers.crons]]
cron = "30 2 * * *"  # Every day at 02:30 UTC = 10:30 Taipei (Birthday greetings - 錯峰發送)

[[env.production.triggers.crons]]
cron = "30 10 * * *"  # Every day at 10:30 UTC = 18:30 Taipei (Birthday greetings - 覆蓋時區)

[[env.production.triggers.crons]]
cron = "30 18 * * *"  # Every day at 18:30 UTC = 02:30 Taipei (Birthday greetings - 覆蓋時區)

# Sensitive variables should be set via:
# wrangler secret put TELEGRAM_BOT_TOKEN --env staging
# wrangler secret put TELEGRAM_BOT_TOKEN --env production
# wrangler secret put OPENAI_API_KEY --env staging
# wrangler secret put OPENAI_API_KEY --env production
# wrangler secret put TELEGRAM_WEBHOOK_SECRET --env staging
# wrangler secret put TELEGRAM_WEBHOOK_SECRET --env production
# wrangler secret put MOONPACKET_API_KEY --env production