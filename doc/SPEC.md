# XunNi å°ˆæ¡ˆè¦æ ¼æ›¸ï¼ˆAI å¿…è®€ï¼‰

> **é€™æ˜¯ AI ä»£ç†åœ¨é–‹å§‹ä»»ä½•å·¥ä½œå‰å¿…é ˆé–±è®€çš„ä¸»è¦æ–‡æª”ã€‚**  
> æœ¬æ–‡æª”åŒ…å«å°ˆæ¡ˆæ¦‚è¦½ã€æŠ€è¡“æ£§ã€å°ˆæ¡ˆçµæ§‹ã€å®Œæ•´æ¥­å‹™é‚è¼¯å’Œè³‡æ–™åº«è¨­è¨ˆã€‚

## 1. å°ˆæ¡ˆç¸½è¦½

### ç”¢å“è³‡è¨Š
- **ç”¢å“åç¨±**: XunNi
- **Telegram Bot**: @xunni_bot
- **é¡å‹**: MBTI + æ˜Ÿåº§å¿ƒç†æ¸¬é©—æ¼‚æµç“¶äº¤å‹ Botï¼ˆåŒ¿åèŠå¤©ï¼‰

### å°ˆæ¡ˆå®šç¾©

**XunNi** æ˜¯ä¸€å€‹é‹è¡Œåœ¨ Cloudflare Workers ä¸Šçš„ Telegram Botï¼Œæä¾› MBTI + æ˜Ÿåº§å¿ƒç†æ¸¬é©—æ¼‚æµç“¶åŒ¿åäº¤å‹åŠŸèƒ½ã€‚

- **é¡å‹**: Telegram Botï¼ˆåŒ¿åèŠå¤©ï¼‰
- **é‹è¡Œç’°å¢ƒ**: Cloudflare Workers + D1ï¼ˆSQLiteï¼‰
- **èªè¨€**: TypeScript (ESM)
- **è³‡æ–™åº«**: Cloudflare D1
- **å¿«å–**: Cloudflare KVï¼ˆå¯é¸ï¼‰

### æ¶æ§‹ç›®æ¨™

- é‹è¡Œåœ¨ **Cloudflare Workers**ï¼Œæ­é… **D1ï¼ˆSQL è³‡æ–™åº«ï¼‰** + ï¼ˆå¯é¸ï¼‰**KV**
- æˆæœ¬æ¥µä½ï¼Œå¯é•·æœŸé‹ç‡Ÿ
- æ‰€æœ‰é‚è¼¯é›†ä¸­åœ¨ä¸€å€‹ Worker å°ˆæ¡ˆï¼Œé€é Telegram Webhookã€HTTP APIã€Cron è§¸ç™¼

### æ ¸å¿ƒç‰¹æ€§

#### å…¨å“¡å¿…é ˆå®Œæˆ
- æš±ç¨± & é ­åƒ
- MBTI æ¸¬é©—
- åè©é¨™æ¸¬é©—
- å®Œæˆå¾Œæ‰èƒ½ä¸Ÿç“¶ï¼æ’¿ç“¶

#### æ¼‚æµç“¶åŒ¿åé…å°
- ä¾ MBTIã€å¹´é½¡ã€æ€§åˆ¥ç­‰åšåŒ¹é…

#### å…è²»ä½¿ç”¨è€…
- æ¯æ—¥æœ€å¤š 3 å€‹æ¼‚æµç“¶ï¼ˆå¯é€éé‚€è«‹å¥½å‹ï¼Œæœ€é«˜å¢åŠ åˆ° 10 å€‹ï¼‰
- åªèƒ½è¨­å®šã€Œç›®æ¨™æ€§åˆ¥ã€ï¼Œä¸èƒ½è¨­å®šæ˜Ÿåº§ï¼MBTI ç¯©é¸
- ç„¡ç¿»è­¯åŠŸèƒ½

#### VIP ä½¿ç”¨è€…
- é€é Telegram Stars ä»˜è²»è¨‚é–±ï¼ˆç´„ 5 USD / æœˆï¼‰
- æ¯æ—¥ 30 å€‹æ¼‚æµç“¶ï¼Œå¯é€éé‚€è«‹å¥½å‹æœ€é«˜å‡ç´šåˆ° 100 å€‹
- å¯æŒ‡å®šæ˜Ÿåº§ï¼MBTI ç›®æ¨™ç¯©é¸
- **34 ç¨®èªè¨€è‡ªå‹•ç¿»è­¯**ï¼š
  - å„ªå…ˆä½¿ç”¨ **OpenAI GPT-4o-mini**ï¼ˆé«˜å“è³ªï¼‰
  - å¤±æ•—æ™‚è‡ªå‹•é™ç´šåˆ° **Google Translate**ï¼ˆä¸¦æç¤ºï¼‰
  - ç¿»è­¯å¤±æ•—æ™‚ç™¼é€åŸæ–‡ + æç¤º
- ç„¡å»£å‘Š

#### æ‰€æœ‰èŠå¤©
- åªå…è¨±æ–‡å­— + å®˜æ–¹ Emoji
- åš´æ ¼ URL ç™½åå–®
- é€éä¸­è½‰ bot åŒ¿åè½‰ç™¼ï¼Œä¸æš´éœ²çœŸå¯¦ Telegram ID

#### å®‰å…¨é¢¨æ§
- åè©é¨™æ¸¬é©— + risk_score + AI å¯©æ ¸
- å¤šäººèˆ‰å ± â†’ åˆ†ç´šå°ç¦
- æä¾› `/appeal` ç”³è¨´æ©Ÿåˆ¶

#### å…¶ä»–åŠŸèƒ½
- æ¯é€±æ˜Ÿåº§é‹å‹¢æ¨æ’­ï¼Œå¬å›ä½¿ç”¨è€…ä¾†ä¸Ÿï¼æ’¿ç“¶
- å°å¤– HTTP APIï¼š
  - `/api/eligibility`ï¼šçµ¦ Moonpacket ç´…åŒ…ç³»çµ±æŸ¥è³‡æ ¼
  - `/api/public-stats`ï¼šå…¬é–‹ç‡Ÿé‹çµ±è¨ˆï¼ˆçµ¦è¡ŒéŠ·é é¢ä½¿ç”¨ï¼‰
- ä¸Šå¸ / å¤©ä½¿å¸³è™Ÿï¼šå¯æŒ‰æ¢ä»¶ï¼ˆæ€§åˆ¥ã€å¹´é½¡ã€æ˜Ÿåº§ã€èªè¨€ç­‰ï¼‰ç¾¤ç™¼è¨Šæ¯ï¼ˆéšŠåˆ— + é™é€Ÿï¼‰
- **ä½¿ç”¨è€…å°é–åŠŸèƒ½**ï¼š/blockï¼ˆä¸èˆ‰å ±ï¼Œåªæ˜¯ä¸æƒ³å†èŠï¼‰
- **é¿å…é‡è¤‡åŒ¹é…**ï¼šæ’é™¤æ›¾ç¶“å°é–/è¢«å°é–/è¢«èˆ‰å ±éçš„ä½¿ç”¨è€…
- **è³‡æ–™ä¿ç•™ç­–ç•¥**ï¼šæ¼‚æµç“¶ 90 å¤©å¾Œè»Ÿåˆªé™¤ï¼ŒèŠå¤©è¨˜éŒ„æœ€å¤š 3650 ç­†ï¼ˆæ¯å°è±¡ï¼‰
- **ä½¿ç”¨è€…æ¬Šåˆ©**ï¼š/delete_meï¼ˆåˆªé™¤å¸³è™Ÿï¼Œä¿ç•™å®‰å…¨å¯©è¨ˆè¨˜éŒ„ï¼‰

#### äº’å‹•é€šé“åˆ†å±¤èˆ‡ Mini App æœ€ä½³å¯¦è¸

**æ¶æ§‹åŸå‰‡**ï¼š
- **Bot åƒ…è™•ç†é€šçŸ¥/Deep Link**ï¼šçŸ­æµç¨‹ã€å³æ™‚å›æ‡‰ã€é€šçŸ¥æ¨é€
- **é•·æµç¨‹æ”¹èµ° WebApp**ï¼šè¨»å†Šå¼•å°ã€å€‹äººè³‡æ–™ç·¨è¼¯ã€MBTI æ¸¬é©—ã€èŠå¤©ç•Œé¢

**Telegram Mini App**ï¼ˆç•¶å‰éšæ®µï¼‰ï¼š
- ä½¿ç”¨ `initData` é©—ç°½ç¢ºä¿å®‰å…¨æ€§ï¼ˆè¦‹ä¸‹æ–¹ã€ŒMini App å®‰å…¨ã€ç« ç¯€ï¼‰
- é¦–å±è¼‰å…¥ < 2 ç§’ï¼ˆæ€§èƒ½è¦æ±‚ï¼Œè¦‹ä¸‹æ–¹ã€ŒMini App æ€§èƒ½å„ªåŒ–ã€ç« ç¯€ï¼‰
- æ”¯æ´ `WebApp.share` Deep Linkï¼ˆ`startapp=share_mbti_{resultId}`ï¼‰
- ä½¿ç”¨ `themeParams` é©é…æ·±/æ·ºè‰²ä¸»é¡Œ
- ä½¿ç”¨ `MainButton`/`SecondaryButton` æ¸›å°‘è‡ªå®šç¾© UI æˆæœ¬

**Bot Fallback æ©Ÿåˆ¶**ï¼ˆç•¶ Mini App ç„¡æ³•ä½¿ç”¨æ™‚ï¼‰ï¼š
- æä¾›æ¥µç°¡ Bot æŒ‡ä»¤ç¶­ç¹«å­˜é‡ä½¿ç”¨è€…ï¼š
  - `/start` - è¨»å†Š/æŸ¥çœ‹è³‡æ–™
  - `/throw` - ä¸Ÿæ¼‚æµç“¶
  - `/catch` - æ’¿æ¼‚æµç“¶
  - `/profile` - æŸ¥çœ‹å€‹äººè³‡æ–™
  - `/help` - å¹«åŠ©
- ç•¶æª¢æ¸¬åˆ° Mini App ç„¡æ³•è¼‰å…¥æ™‚ï¼Œè‡ªå‹•æç¤ºä½¿ç”¨è€…ä½¿ç”¨ Bot æŒ‡ä»¤
- Fallback æª¢æ¸¬ï¼šå˜—è©¦è¼‰å…¥ Mini Appï¼Œå¤±æ•—æ™‚é¡¯ç¤ºã€ŒMini App æš«æ™‚ç„¡æ³•ä½¿ç”¨ï¼Œè«‹ä½¿ç”¨æŒ‡ä»¤ï¼š/throwã€/catchã€

**æœªä¾†æ“´å±•é ç•™**ï¼ˆM2/M3ï¼Œæš«ä¸å¯¦ä½œï¼‰ï¼š
- WeChat / Line æ’ä»¶
- App Store / Google Play åŸç”Ÿ App
- è©³ç´°è¦åŠƒè«‹åƒè€ƒï¼šROADMAP.md

---

## 2. æŠ€è¡“æ£§èˆ‡å°ˆæ¡ˆçµæ§‹

### 2.1 æŠ€è¡“æ£§
- **Runtime**: Cloudflare Workers
- **DB**: Cloudflare D1ï¼ˆSQLite ç›¸å®¹ï¼‰
- **KVï¼ˆå¯é¸ï¼‰**: Cloudflare KVï¼ˆé¢¨éšªåˆ†æ•¸ã€cache ç”¨ï¼‰
- **èªè¨€**: TypeScriptï¼ˆESM æ¨¡çµ„ï¼‰
- **æ¸¬è©¦**: Vitestï¼ˆæˆ– Jestï¼‰

### 2.2 å°ˆæ¡ˆç›®éŒ„çµæ§‹ï¼ˆä¾†æºæ–‡ä»¶ä½ç½®ï¼‰

```
XunNi/
â”œâ”€â”€ src/                          # æºä»£ç¢¼ç›®éŒ„ï¼ˆ@src/ï¼‰
â”‚   â”œâ”€â”€ worker.ts                 # Worker å…¥å£é»ï¼ˆ@src/worker.tsï¼‰
â”‚   â”œâ”€â”€ router.ts                 # HTTP è·¯ç”±è™•ç†å™¨ï¼ˆ@src/router.tsï¼‰
â”‚   â”œâ”€â”€ config/                   # é…ç½®æ¨¡çµ„ï¼ˆ@src/config/ï¼‰
â”‚   â”‚   â”œâ”€â”€ env.ts                # ç’°å¢ƒè®Šæ•¸é©—è­‰ï¼ˆ@src/config/env.tsï¼‰
â”‚   â”‚   â””â”€â”€ constants.ts          # å¸¸é‡å®šç¾©ï¼ˆ@src/config/constants.tsï¼‰
â”‚   â”œâ”€â”€ db/                       # è³‡æ–™åº«å±¤ï¼ˆ@src/db/ï¼‰
â”‚   â”‚   â”œâ”€â”€ schema.sql            # è³‡æ–™åº« Schemaï¼ˆ@src/db/schema.sqlï¼‰
â”‚   â”‚   â”œâ”€â”€ migrations/           # é·ç§»è…³æœ¬ï¼ˆ@src/db/migrations/ï¼‰
â”‚   â”‚   â””â”€â”€ client.ts             # D1 å®¢æˆ¶ç«¯å°è£ï¼ˆ@src/db/client.tsï¼‰
â”‚   â”œâ”€â”€ domain/                   # æ¥­å‹™é‚è¼¯å±¤ï¼ˆç´”å‡½æ•¸ï¼Œç„¡å‰¯ä½œç”¨ï¼‰ï¼ˆ@src/domain/ï¼‰
â”‚   â”‚   â”œâ”€â”€ user.ts               # ä½¿ç”¨è€…é‚è¼¯ï¼ˆ@src/domain/user.tsï¼‰
â”‚   â”‚   â”œâ”€â”€ usage.ts              # æ¯æ—¥æ¼‚æµç“¶ / å°è©±æ¬¡æ•¸ï¼ˆ@src/domain/usage.tsï¼‰
â”‚   â”‚   â”œâ”€â”€ risk.ts               # é¢¨éšªåˆ†æ•¸ / å°ç¦ï¼ˆ@src/domain/risk.tsï¼‰
â”‚   â”‚   â”œâ”€â”€ matching.ts           # æ¼‚æµç“¶åŒ¹é…ï¼ˆ@src/domain/matching.tsï¼‰
â”‚   â”‚   â”œâ”€â”€ horoscope.ts          # æ˜Ÿåº§é‹å‹¢å·¥å…·ï¼ˆ@src/domain/horoscope.tsï¼‰
â”‚   â”‚   â”œâ”€â”€ eligibility.ts        # å°å¤–è³‡æ ¼æŸ¥è©¢ï¼ˆ@src/domain/eligibility.tsï¼‰
â”‚   â”‚   â””â”€â”€ public_stats.ts       # å…¬é–‹ç‡Ÿé‹çµ±è¨ˆ API èšåˆï¼ˆ@src/domain/public_stats.tsï¼‰
â”‚   â”œâ”€â”€ telegram/                 # Telegram ç›¸é—œï¼ˆ@src/telegram/ï¼‰
â”‚   â”‚   â”œâ”€â”€ types.ts              # Telegram Update / Callback å‹åˆ¥ï¼ˆ@src/telegram/types.tsï¼‰
â”‚   â”‚   â””â”€â”€ handlers/             # æŒ‡ä»¤è™•ç†å™¨ï¼ˆ@src/telegram/handlers/ï¼‰
â”‚   â”‚       â”œâ”€â”€ start.ts
â”‚   â”‚       â”œâ”€â”€ profile.ts
â”‚   â”‚       â”œâ”€â”€ throw.ts
â”‚   â”‚       â”œâ”€â”€ catch.ts
â”‚   â”‚       â”œâ”€â”€ msg_forward.ts    # å°è©±æ¶ˆæ¯è½‰ç™¼
â”‚   â”‚       â”œâ”€â”€ report.ts
â”‚   â”‚       â”œâ”€â”€ appeal.ts
â”‚   â”‚       â”œâ”€â”€ vip.ts
â”‚   â”‚       â”œâ”€â”€ help.ts
â”‚   â”‚       â”œâ”€â”€ broadcast.ts      # ä¸Šå¸/å¤©ä½¿
â”‚   â”‚       â””â”€â”€ admin.ts          # ç®¡ç†å“¡å·¥å…·
â”‚   â”œâ”€â”€ services/                 # å¤–éƒ¨æœå‹™æ•´åˆï¼ˆ@src/services/ï¼‰
â”‚   â”‚   â””â”€â”€ openai.ts             # OpenAI APIï¼ˆ@src/services/openai.tsï¼‰
â”‚   â”œâ”€â”€ utils/                    # é€šç”¨å·¥å…·ï¼ˆ@src/utils/ï¼‰
â”‚   â”‚   â”œâ”€â”€ url-whitelist.ts      # URL ç™½åå–®ï¼ˆ@src/utils/url-whitelist.tsï¼‰
â”‚   â”‚   â””â”€â”€ emoji.ts              # Emoji è™•ç†ï¼ˆ@src/utils/emoji.tsï¼‰
â”‚   â””â”€â”€ i18n/                     # åœ‹éš›åŒ–ï¼ˆ@src/i18n/ï¼‰
â”‚       â”œâ”€â”€ index.ts              # i18n åˆå§‹åŒ–ï¼ˆ@src/i18n/index.tsï¼‰
â”‚       â”œâ”€â”€ keys.ts               # ç¿»è­¯éµå€¼ï¼ˆ@src/i18n/keys.tsï¼‰
â”‚       â””â”€â”€ locales/              # èªè¨€åŒ…ï¼ˆ@src/i18n/locales/ï¼‰
â”œâ”€â”€ tests/                        # æ¸¬è©¦ç›®éŒ„ï¼ˆ@tests/ï¼‰
â”‚   â””â”€â”€ domain/                   # Domain å±¤æ¸¬è©¦ï¼ˆ@tests/domain/ï¼‰
â”‚       â”œâ”€â”€ usage.test.ts
â”‚       â”œâ”€â”€ risk.test.ts
â”‚       â”œâ”€â”€ matching.test.ts
â”‚       â””â”€â”€ eligibility.test.ts
â”œâ”€â”€ scripts/                      # è…³æœ¬ç›®éŒ„ï¼ˆ@scripts/ï¼‰
â”œâ”€â”€ doc/                          # æ–‡æª”ç›®éŒ„ï¼ˆ@doc/ï¼‰
â”œâ”€â”€ wrangler.toml                 # Cloudflare é…ç½®ï¼ˆ@wrangler.tomlï¼‰
â”œâ”€â”€ package.json                  # ä¾è³´é…ç½®ï¼ˆ@package.jsonï¼‰
â””â”€â”€ tsconfig.json                 # TypeScript é…ç½®ï¼ˆ@tsconfig.jsonï¼‰
```

---

## 3. è³‡æ–™åº« Schemaï¼ˆD1ï¼‰

### 3.1 users

```sql
CREATE TABLE users (
  telegram_id TEXT PRIMARY KEY,
  role TEXT,              -- user / admin / god / angel
  nickname TEXT,
  avatar_url TEXT,        -- é ­åƒ URL æˆ– TG file_id å°æ‡‰çš„ URL
  avatar_source TEXT,     -- telegram / ai / custom
  ai_gender_hint TEXT,    -- AI æ¨æ¸¬æ€§åˆ¥æç¤ºæ–‡å­—

  gender TEXT,            -- male / female / other (è¨­å®šå¾Œä¸å¯ä¿®æ”¹)
  birthday DATE,          -- ç”Ÿæ—¥ YYYY-MM-DD (è¨­å®šå¾Œä¸å¯ä¿®æ”¹ï¼Œç”¨æ–¼è¨ˆç®—å¹´é½¡å’Œæ˜Ÿåº§)
  age_range TEXT,         -- '18-22' / '23-30' / '31-40' / '40+' (ç”±ç”Ÿæ—¥è¨ˆç®—)
  country TEXT,           -- 'TW', 'JP' ç­‰
  zodiac_sign TEXT,       -- aries / taurus / ... / pisces (ç”±ç”Ÿæ—¥è¨ˆç®—)
  mbti_type TEXT,         -- 16 å‹ä¹‹ä¸€ï¼Œå®Œæˆæ¸¬é©—å¾Œå¯«å…¥
  language_pref TEXT,     -- ä»‹é¢ + èŠå¤©åå¥½èªè¨€ï¼Œå¦‚ zh-TW, en, ja

  prefer_gender TEXT,     -- æƒ³èªè­˜çš„æ€§åˆ¥
  trust_level INTEGER,    -- åè©æ¸¬é©—çµæœï¼Œ>=1 è¦–ç‚ºé€šé

  is_vip INTEGER,         -- 0/1
  vip_expire_at DATETIME,

  invite_code TEXT,       -- åˆ†é…çµ¦æ­¤ user çš„é‚€è«‹ç¢¼
  invited_by TEXT,        -- ä¸Šæ¸¸é‚€è«‹äºº telegram_id
  activated_invites INTEGER, -- å·²æ¿€æ´»çš„é‚€è«‹å¥½å‹æ•¸

  -- è¨»å†Šæµç¨‹ç›¸é—œ
  onboarding_state TEXT,  -- JSON: { step, data, last_updated }
  onboarding_started_at DATETIME,
  onboarding_completed_at DATETIME,
  
  -- æ¢æ¬¾åŒæ„
  terms_accepted INTEGER DEFAULT 0,
  privacy_accepted INTEGER DEFAULT 0,
  terms_accepted_at DATETIME,
  privacy_accepted_at DATETIME,
  terms_version TEXT,    -- æ¥å—çš„æ¢æ¬¾ç‰ˆæœ¬
  privacy_version TEXT,  -- æ¥å—çš„éš±ç§æ¬Šç‰ˆæœ¬

  risk_score INTEGER DEFAULT 0,
  created_at DATETIME,
  updated_at DATETIME
);
```

### 3.13 terms_versionsï¼ˆæ¢æ¬¾ç‰ˆæœ¬ç®¡ç†ï¼‰

```sql
CREATE TABLE terms_versions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  type TEXT,              -- 'terms' / 'privacy'
  version TEXT,           -- '1.0', '1.1', ...
  content TEXT,           -- Markdown æ ¼å¼çš„æ¢æ¬¾å…§å®¹
  effective_date DATE,    -- ç”Ÿæ•ˆæ—¥æœŸ
  created_at DATETIME
);
```

### 3.14 stats_cacheï¼ˆçµ±è¨ˆå¿«å–è¡¨ï¼Œå¯é¸ï¼‰

**ç”¨é€”**ï¼šå¿«å–å…¬é–‹çµ±è¨ˆæ•¸æ“šï¼Œé¿å…æ¯æ¬¡ API è«‹æ±‚éƒ½æŸ¥è©¢è³‡æ–™åº«

```sql
CREATE TABLE stats_cache (
  cache_key TEXT PRIMARY KEY,
  cache_value TEXT,        -- JSON å­—ä¸²
  expires_at DATETIME,
  created_at DATETIME,
  updated_at DATETIME
);

CREATE INDEX idx_stats_cache_expires_at ON stats_cache(expires_at);
```

**ä½¿ç”¨å ´æ™¯**ï¼š
- ç•¶ä¸ä½¿ç”¨ KV å¿«å–æ™‚ï¼Œä½¿ç”¨è³‡æ–™åº«è¡¨å¿«å–
- æ¯ 5 åˆ†é˜é€é Cron ä»»å‹™æ›´æ–°
- API ç›´æ¥æŸ¥è©¢æ­¤è¡¨ï¼Œç„¡éœ€å³æ™‚è¨ˆç®—

**æŸ¥è©¢é‚è¼¯**ï¼š
```typescript
// æŸ¥è©¢å¿«å–è¡¨
const cached = await db.prepare(`
  SELECT cache_value
  FROM stats_cache
  WHERE cache_key = 'public_stats'
    AND expires_at > datetime('now')
`).first();

if (cached) {
  return JSON.parse(cached.cache_value);
}
```

### 3.2 bottlesï¼ˆæ¼‚æµç“¶ï¼‰

```sql
CREATE TABLE bottles (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  owner_id TEXT,           -- FK -> users.telegram_id
  content TEXT,
  mood_tag TEXT,
  created_at DATETIME,
  expires_at DATETIME,     -- éæœŸä¸å†è¢«æ’¿èµ·
  status TEXT,             -- pending / matched / expired / deleted

  target_gender TEXT,      -- å¿…å¡«ï¼ˆä¸€èˆ¬ & VIP å…±ç”¨ï¼‰
  target_age_range TEXT,   -- åƒ… VIP å¯èƒ½å¡«
  target_region TEXT,      -- åƒ… VIP å¯èƒ½å¡«
  target_zodiac_filter TEXT, -- JSON array of zodiac (VIP)
  target_mbti_filter TEXT,   -- JSON array of MBTI types (VIP)
  language TEXT            -- æ­¤ç“¶ä¸»è¦èªè¨€ï¼ˆå¯é¸ï¼‰
);
```

### 3.3 conversationsï¼ˆå°è©±ï¼‰

```sql
CREATE TABLE conversations (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  bottle_id INTEGER,      -- FK -> bottles.id
  user_a_id TEXT,         -- FK -> users.telegram_id
  user_b_id TEXT,         -- FK -> users.telegram_id
  created_at DATETIME,
  last_message_at DATETIME,
  status TEXT,            -- active / closed / blocked

  max_rounds INTEGER,     -- å¯é¸ï¼šé™åˆ¶å°è©±å£½å‘½å…§ç¸½è¨Šæ¯æ•¸
  a_blocked INTEGER DEFAULT 0,
  b_blocked INTEGER DEFAULT 0
);
```

### 3.4 reportsï¼ˆèˆ‰å ±ï¼‰

```sql
CREATE TABLE reports (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  reporter_id TEXT,
  target_id TEXT,
  conversation_id INTEGER,
  reason TEXT,
  created_at DATETIME
);
```

### 3.5 bansï¼ˆå°ç¦ï¼‰

```sql
CREATE TABLE bans (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT,
  reason TEXT,
  risk_snapshot INTEGER,
  ban_start DATETIME,
  ban_end DATETIME,
  created_at DATETIME
);
```

### 3.6 invitesï¼ˆé‚€è«‹ï¼‰

```sql
CREATE TABLE invites (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  inviter_id TEXT,
  invitee_id TEXT,
  status TEXT,           -- pending / activated
  created_at DATETIME,
  activated_at DATETIME
);
```

### 3.7 daily_usageï¼ˆæ¯æ—¥æ¼‚æµç“¶ä½¿ç”¨æ¬¡æ•¸ï¼‰

```sql
CREATE TABLE daily_usage (
  user_id TEXT,
  date TEXT,             -- YYYY-MM-DD
  throws_count INTEGER,
  PRIMARY KEY (user_id, date)
);
```

### 3.8 appealsï¼ˆç”³è¨´ï¼‰

```sql
CREATE TABLE appeals (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT,
  ban_start DATETIME,
  ban_end DATETIME,
  message TEXT,
  status TEXT,           -- pending / accepted / rejected
  created_at DATETIME,
  reviewed_at DATETIME,
  reviewer_id TEXT
);
```

### 3.9 conversation_daily_usageï¼ˆæ¯å°è±¡æ¯æ—¥è¨Šæ¯æ•¸ï¼‰

```sql
CREATE TABLE conversation_daily_usage (
  user_id TEXT,
  conversation_id INTEGER,
  date TEXT,             -- YYYY-MM-DD
  sent_count INTEGER,
  PRIMARY KEY (user_id, conversation_id, date)
);
```

### 3.10 horoscope_templatesï¼ˆæ˜Ÿåº§é‹å‹¢æ¨¡æ¿ï¼‰

```sql
CREATE TABLE horoscope_templates (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  zodiac_sign TEXT,      -- aries / ... / pisces
  week_start DATE,
  week_end DATE,
  message TEXT,
  source TEXT,
  created_at DATETIME
);
```

### 3.11 paymentsï¼ˆVIP ä»˜æ¬¾ï¼‰

```sql
CREATE TABLE payments (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT,
  telegram_payment_id TEXT UNIQUE,  -- å”¯ä¸€ç´¢å¼•ï¼Œé˜²æ­¢é‡è¤‡æ”¯ä»˜
  stars_amount INTEGER,
  status TEXT,           -- pending / paid / refunded / failed
  product_code TEXT,     -- 'VIP_MONTHLY'
  created_at DATETIME,
  updated_at DATETIME
);

CREATE INDEX idx_payments_user_id ON payments(user_id);
CREATE INDEX idx_payments_status ON payments(status);
CREATE UNIQUE INDEX idx_payments_telegram_payment_id ON payments(telegram_payment_id);
```

**æ”¯ä»˜é‚Šç·£æƒ…æ³è™•ç†**ï¼š
- **æ”¯ä»˜æˆåŠŸä½†å¯« DB å¤±æ•—**ï¼šä½¿ç”¨ telegram_payment_id å”¯ä¸€ç´¢å¼•ï¼Œé‡è©¦å®‰å…¨ï¼ˆæª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼‰
- **ä½¿ç”¨è€…é‡è¤‡è²· VIP**ï¼šå¾ç•¶å‰ vip_expire_at å¾€å¾Œå»¶ 30 å¤©ï¼Œä¸æ˜¯å¾ç¾åœ¨ç®—
- **é€€æ¬¾**ï¼šæš«ä¸æ”¯æŒè‡ªå‹•é€€æ¬¾ï¼Œåƒ…æ‰‹å‹•è™•ç†

è©³ç´°è¨­è¨ˆè«‹åƒè€ƒï¼šTELEGRAM_STARS.md

### 3.12 broadcast_jobs / broadcast_queueï¼ˆå»£æ’­ï¼‰

```sql
CREATE TABLE broadcast_jobs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  created_by TEXT,
  role TEXT,                -- 'god' / 'angel'
  filters_json TEXT,        -- JSON æ¢ä»¶
  message TEXT,
  status TEXT,              -- pending / running / completed / cancelled
  total_targets INTEGER,
  sent_count INTEGER,
  failed_count INTEGER,
  created_at DATETIME,
  started_at DATETIME,
  completed_at DATETIME
);

CREATE TABLE broadcast_queue (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  job_id INTEGER,
  user_id TEXT,
  status TEXT,              -- pending / sent / failed
  last_error TEXT,
  created_at DATETIME,
  sent_at DATETIME
);

CREATE INDEX idx_broadcast_queue_job_id_status ON broadcast_queue(job_id, status);
```

**Cron ä»»å‹™å†ªç­‰æ€§è¨­è¨ˆ**ï¼š
- **broadcast**ï¼šåªç™¼é€ queue è£¡ status='pending' çš„é …ï¼Œç‹€æ…‹ä¸€æ—¦è®Šæˆ 'sent' å°±ä¸å†é‡ç™¼

### 3.12.1 ai_moderation_logsï¼ˆAI å¯©æ ¸æ—¥èªŒï¼‰

```sql
CREATE TABLE ai_moderation_logs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT,
  conversation_id INTEGER,
  content_summary TEXT,        -- å…§å®¹æ‘˜è¦ï¼ˆå‰ 100 å­—ï¼‰
  full_content TEXT,           -- å®Œæ•´å…§å®¹ï¼ˆåŠ å¯†æˆ–è„«æ•ï¼‰
  moderation_reason TEXT,      -- å¯©æ ¸åŸå› 
  moderation_result TEXT,      -- 'flagged' / 'safe' / 'failed'
  provider TEXT,               -- 'openai' / nullï¼ˆå¦‚æœå¤±æ•—ï¼‰
  error_message TEXT,          -- éŒ¯èª¤è¨Šæ¯ï¼ˆå¦‚æœå¤±æ•—ï¼‰
  risk_score_added INTEGER,    -- ç´¯åŠ çš„é¢¨éšªåˆ†æ•¸
  created_at DATETIME
);

CREATE INDEX idx_ai_moderation_logs_user_id ON ai_moderation_logs(user_id);
CREATE INDEX idx_ai_moderation_logs_conversation_id ON ai_moderation_logs(conversation_id);
CREATE INDEX idx_ai_moderation_logs_created_at ON ai_moderation_logs(created_at);
CREATE INDEX idx_ai_moderation_logs_result ON ai_moderation_logs(moderation_result);
```

### 3.12.2 translation_costsï¼ˆç¿»è­¯æˆæœ¬è¨˜éŒ„ï¼‰

```sql
CREATE TABLE translation_costs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT,
  provider TEXT,              -- 'openai' / 'google'
  source_language TEXT,
  target_language TEXT,
  cost_amount REAL,           -- æˆæœ¬ï¼ˆtokens æˆ– API èª¿ç”¨æ¬¡æ•¸ï¼‰
  is_fallback INTEGER DEFAULT 0, -- æ˜¯å¦ç‚ºé™ç´š
  created_at DATETIME
);

CREATE INDEX idx_translation_costs_user_id ON translation_costs(user_id);
CREATE INDEX idx_translation_costs_created_at ON translation_costs(created_at);
CREATE INDEX idx_translation_costs_provider ON translation_costs(provider);
```

### 3.12.3 translation_fallbacksï¼ˆç¿»è­¯é™ç´šè¨˜éŒ„ï¼‰

```sql
CREATE TABLE translation_fallbacks (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT,
  from_provider TEXT,         -- å¤±æ•—çš„ä¾›æ‡‰å•†ï¼ˆ'openai'ï¼‰
  to_provider TEXT,           -- é™ç´šåˆ°çš„ä¾›æ‡‰å•†ï¼ˆ'google'ï¼‰
  error_message TEXT,
  created_at DATETIME
);

CREATE INDEX idx_translation_fallbacks_user_id ON translation_fallbacks(user_id);
CREATE INDEX idx_translation_fallbacks_created_at ON translation_fallbacks(created_at);
```

---

## 4. ä¸»è¦æ¥­å‹™é‚è¼¯ï¼ˆDomainï¼‰

### 4.1 æ¯æ—¥æ¼‚æµç“¶æ¬¡æ•¸é™åˆ¶

#### 4.1.1 getDailyThrowLimit(user, today)

**è¦å‰‡**:

**å…è²»ä½¿ç”¨è€…**:
- åŸºç¤æ¯æ—¥ 3 å€‹
- æ¯æœ‰ 1 ä½ã€Œå·²æ¿€æ´»ã€é‚€è«‹å¥½å‹ï¼ˆå®Œæˆ MBTI ä¸¦è‡³å°‘ä¸Ÿ 1 ç“¶ï¼‰ â†’ +1
- ä¸Šé™ï¼š10 å€‹ / æ—¥

**VIP ä½¿ç”¨è€…ï¼ˆæœ‰æ•ˆæœŸå…§ï¼‰**:
- åŸºç¤æ¯æ—¥ 30 å€‹
- æ¯æœ‰ 1 ä½æ¿€æ´»é‚€è«‹ â†’ +1
- ä¸Šé™ï¼š100 å€‹ / æ—¥
- æœ€å¤§æ¿€æ´»é‚€è«‹æ•¸åªè¨˜åˆ° 70ï¼ˆç¸½ä¸Šé™ 100ï¼‰

**è‹¥ VIP åˆ°æœŸ**: é™åˆ¶é€€å›ã€Œå…è²»é‚è¼¯ã€ï¼Œä½†å·²æ¿€æ´»é‚€è«‹ä»å­˜åœ¨ â†’ ä¸Šé™ç‚º 10

**å‡ç¢¼**:

```typescript
function isVipActive(user: User, now: Date): boolean {
  return !!(user.is_vip && (!user.vip_expire_at || user.vip_expire_at > now));
}

function getDailyThrowLimit(user: User, today: string): number {
  const invites = user.activated_invites || 0;
  const now = new Date();

  if (isVipActive(user, now)) {
    const base = 30;
    const bonus = Math.min(invites, 70);
    return Math.min(base + bonus, 100);
  }

  // free
  const base = 3;
  const bonus = Math.min(invites, 7);
  return Math.min(base + bonus, 10);
}
```

#### 4.1.2 canThrowBottle(user, today, usage)

```typescript
function canThrowBottle(user: User, today: string, usage: DailyUsage | null): boolean {
  if (isBanned(user)) return false;
  if (!hasCompletedOnboarding(user)) return false;

  const limit = getDailyThrowLimit(user, today);
  const used = usage?.throws_count || 0;

  return used < limit;
}
```

### 4.2 æ¯æ—¥å°è©±è¨Šæ¯ä¸Šé™ï¼ˆæ¯å€‹å°è±¡ï¼‰

- **å…è²»ä½¿ç”¨è€…**: å°åŒä¸€å€‹ conversation_idï¼Œæ¯æ—¥æœ€å¤š 10 å‰‡
- **VIP ä½¿ç”¨è€…**: å°åŒä¸€å€‹ conversation_idï¼Œæ¯æ—¥æœ€å¤š 100 å‰‡

```typescript
function getConversationDailyLimit(user: User): number {
  return isVipActive(user, new Date()) ? 100 : 10;
}

async function canSendConversationMessage(user: User, convoId: number, today: string): Promise<boolean> {
  const usage = await db.getConversationDailyUsage(user.telegram_id, convoId, today);
  const used = usage?.sent_count || 0;
  const limit = getConversationDailyLimit(user);
  return used < limit;
}

async function recordConversationMessage(user: User, convoId: number, today: string) {
  await db.incrementConversationDailyUsage(user.telegram_id, convoId, today);
}
```

### 4.3 é¢¨éšªåˆ†æ•¸èˆ‡å°ç¦

ï¼ˆé‚è¼¯ç”± `domain/risk.ts` å¯¦ä½œï¼ŒåŒ…å«ï¼šï¼‰

- `addRisk(userId, reason)`: ç´¯è¨ˆ risk_score
- `applyBan(userId, hours, reason)`: å¯«å…¥ bans è¡¨
- `isBanned(user)`: ä¾ bans æª¢æŸ¥ç•¶å‰æ˜¯å¦è™•æ–¼å°ç¦æœŸ
- `maybeRunAiModeration(text, userId, conversationId, env, db)`: AI å…§å®¹å¯©æ ¸ï¼ˆå¯é¸ï¼‰

**èˆ‰å ±è¦å‰‡ï¼ˆ24 å°æ™‚å…§ã€ä¸åŒèˆ‰å ±äººæ•¸ï¼‰**:
- 1 äººèˆ‰å ±ï¼šå°ç¦ 1 å°æ™‚
- 2 äººèˆ‰å ±ï¼šå°ç¦ 6 å°æ™‚
- 3 äººèˆ‰å ±ï¼šå°ç¦ 24 å°æ™‚
- 5 äººä»¥ä¸Šï¼šå°ç¦ 3 å¤©

`/report` æäº¤å¾Œï¼Œç³»çµ±æª¢æŸ¥ 24 å°æ™‚å…§ unique reportersï¼Œè¨ˆç®—å°ç¦ç­‰ç´šä¸¦ `applyBan`ã€‚

**AI å¯©æ ¸å¤±æ•—è™•ç†**ï¼š
- ç•¶ OpenAI æ›æ‰æˆ–è¶…é¡æ™‚ï¼š
  - è¨˜éŒ„æ—¥èªŒï¼ˆåŒ…å«éŒ¯èª¤é¡å‹ã€ä½¿ç”¨è€… IDã€å…§å®¹æ‘˜è¦ï¼‰
  - **ä¸é˜»æ“‹ç™¼è¨€**ï¼ˆä¸å› ç‚º AI å¯©æ ¸å¤±æ•—è€Œ block ä½¿ç”¨è€…ï¼‰
  - åƒ…ä¾é æœ¬åœ°è¦å‰‡ï¼ˆURL ç™½åå–®ã€æ•æ„Ÿè©éæ¿¾ï¼‰
  - ç™¼é€å‘Šè­¦ï¼ˆé€šçŸ¥ç®¡ç†å“¡ï¼‰
- Audit æ—¥èªŒï¼šè¨˜éŒ„è¢« AI æ””æˆªçš„å…§å®¹æ‘˜è¦ã€reasonã€user_idã€conversation_id
- è³‡æ–™åº«è¡¨ï¼š`ai_moderation_logs`ï¼ˆè¦‹ 3.12.1 ç¯€ï¼‰

### 4.3.1 é¢¨æ§è³‡æ–™ä¾†æºèˆ‡è§¸ç™¼è¦å‰‡

**è³‡æ–™ä¾†æº**ï¼š
1. **è¡Œç‚ºæ—¥èªŒ**ï¼š
   - æ¯æ—¥ä¸Ÿç“¶/æ’¿ç“¶æ¬¡æ•¸ç•°å¸¸ï¼ˆè¶…éæ­£å¸¸ç¯„åœï¼‰
   - çŸ­æ™‚é–“å…§å¤§é‡è¨Šæ¯ï¼ˆç–‘ä¼¼æ©Ÿå™¨äººï¼‰
   - é »ç¹ä¿®æ”¹å€‹äººè³‡æ–™ï¼ˆç–‘ä¼¼å¸³è™Ÿè²·è³£ï¼‰

2. **èˆ‰å ±è¨˜éŒ„**ï¼š
   - å…¶ä»–ä½¿ç”¨è€…èˆ‰å ±ï¼ˆreports è¡¨ï¼‰
   - 24 å°æ™‚å…§è¢«èˆ‰å ±æ¬¡æ•¸

3. **è¨­å‚™æŒ‡ç´‹**ï¼ˆå¯é¸ï¼Œæœªä¾†æ“´å±•ï¼‰ï¼š
   - IP åœ°å€
   - User-Agent
   - è¨­å‚™è­˜åˆ¥è³‡è¨Šï¼ˆTelegram æä¾›çš„ client infoï¼‰

**è§¸ç™¼è¦å‰‡**ï¼š
- **é¢¨éšªåˆ†æ•¸ç´¯ç©è¦å‰‡**ï¼š
  - URL_BLOCKEDï¼š+10 åˆ†
  - SENSITIVE_WORDï¼š+5 åˆ†
  - AI_FLAGGEDï¼š+15 åˆ†
  - è¢«èˆ‰å ± 1 æ¬¡ï¼š+5 åˆ†
  - è¢«èˆ‰å ± 2 æ¬¡ï¼š+15 åˆ†
  - è¢«èˆ‰å ± 3 æ¬¡ï¼š+30 åˆ†
  - è¢«èˆ‰å ± 5 æ¬¡ä»¥ä¸Šï¼š+50 åˆ†ï¼ˆç›´æ¥å°ç¦ï¼‰

- **å°ç¦è¦å‰‡**ï¼ˆåŸºæ–¼é¢¨éšªåˆ†æ•¸ï¼‰ï¼š
  - risk_score >= 50ï¼šå°ç¦ 3 å¤©
  - risk_score >= 30ï¼šå°ç¦ 24 å°æ™‚
  - risk_score >= 15ï¼šå°ç¦ 6 å°æ™‚
  - risk_score >= 10ï¼šå°ç¦ 1 å°æ™‚

- **è‡ªå‹•å°ç¦è¦å‰‡**ï¼ˆåŸºæ–¼èˆ‰å ±ï¼‰ï¼š
  - 24 å°æ™‚å…§ 1 äººèˆ‰å ±ï¼šå°ç¦ 1 å°æ™‚
  - 24 å°æ™‚å…§ 2 äººèˆ‰å ±ï¼šå°ç¦ 6 å°æ™‚
  - 24 å°æ™‚å…§ 3 äººèˆ‰å ±ï¼šå°ç¦ 24 å°æ™‚
  - 24 å°æ™‚å…§ 5 äººä»¥ä¸Šèˆ‰å ±ï¼šå°ç¦ 3 å¤©

**è¡Œç‚ºæ—¥èªŒè¨˜éŒ„**ï¼š
```sql
CREATE TABLE behavior_logs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT,
  action_type TEXT,          -- 'throw_bottle' / 'catch_bottle' / 'send_message' / 'modify_profile'
  action_data TEXT,          -- JSONï¼šå‹•ä½œç›¸é—œè³‡æ–™
  ip_address TEXT,           -- IP åœ°å€ï¼ˆå¯é¸ï¼‰
  user_agent TEXT,           -- User-Agentï¼ˆå¯é¸ï¼‰
  created_at DATETIME
);

CREATE INDEX idx_behavior_logs_user_id ON behavior_logs(user_id);
CREATE INDEX idx_behavior_logs_action_type ON behavior_logs(action_type);
CREATE INDEX idx_behavior_logs_created_at ON behavior_logs(created_at);
```

---

## 5. ä½¿ç”¨æµç¨‹èˆ‡ Telegram æŒ‡ä»¤

### 5.1 /startï¼ˆåˆæ¬¡å¼•å°ï¼‰

**é‡è¦ç‰¹æ€§**ï¼š
- **æ™ºèƒ½å°è©±å¼å¼•å°**ï¼šä½¿ç”¨ä¿çš®çš„å°è©±é¢¨æ ¼ï¼Œè®“è¨»å†Šéç¨‹æ›´å‹å¥½
- **ä¸­æ–·æ¢å¾©æ©Ÿåˆ¶**ï¼šæ”¯æ´ä¸­æ–·å¾Œå¾ä¸Šæ¬¡æ­¥é©Ÿç¹¼çºŒ
- **æ·±åº¦ç¢ºèª**ï¼šæ€§åˆ¥ã€ç”Ÿæ—¥è¨­å®šå¾Œæ°¸é ä¸èƒ½ä¿®æ”¹ï¼Œéœ€äºŒæ¬¡ç¢ºèª
- **å¹´é½¡é™åˆ¶**ï¼šæœªæ»¿ 18 æ­²ä¸å…è¨±è¨»å†Š
- **æ¢æ¬¾åŒæ„**ï¼šå¿…é ˆåŒæ„ä½¿ç”¨è€…æ¢æ¬¾å’Œéš±ç§æ¬Šæ”¿ç­–

**è©³ç´°æµç¨‹è«‹åƒè€ƒ**ï¼š[ONBOARDING_FLOW.md](./ONBOARDING_FLOW.md)

**æµç¨‹æ¦‚è¦**:

1. å»ºç«‹æˆ–è®€å– users è¨˜éŒ„
2. æª¢æŸ¥æ˜¯å¦å·²å®Œæˆ onboardingï¼Œæœªå®Œæˆå‰‡é€²å…¥ä»¥ä¸‹ 10 æ­¥ï¼š

#### Step 0ï¼šæ­¡è¿èˆ‡æ¢æ¬¾åŒæ„

- æ™ºèƒ½å°è©±æ­¡è¿ä½¿ç”¨è€…
- å¿…é ˆæŸ¥çœ‹ä¸¦åŒæ„**ä½¿ç”¨è€…æ¢æ¬¾**å’Œ**éš±ç§æ¬Šæ”¿ç­–**
- è¨˜éŒ„åŒæ„æ™‚é–“å’Œç‰ˆæœ¬è™Ÿ

#### Step 1ï¼šæš±ç¨± & é ­åƒ

- é è¨­ä½¿ç”¨ Telegram first_name æˆ– username
- AI ç”Ÿæˆ 1â€“3 å€‹æš±ç¨±å»ºè­°ï¼ˆæ ¹æ“šèªè¨€ã€ç”¢å“ä¸»é¡Œï¼‰
- æ”¯æ´ä¸Šå‚³è‡ªè¨‚é ­åƒæˆ–ä½¿ç”¨ Telegram é ­åƒ

#### Step 2ï¼šä¸»è¦ä½¿ç”¨èªè¨€

- é¸æ“‡ä»‹é¢èªè¨€ï¼ˆzh-TW / en / ja / ...ï¼‰
- å¾ŒçºŒç¿»è­¯åŠŸèƒ½ä»¥æ­¤ç‚ºç›®æ¨™èªè¨€

#### Step 3ï¼šæ€§åˆ¥ï¼ˆæ·±åº¦ç¢ºèªï¼‰

- âš ï¸ **é‡è¦**ï¼šæ€§åˆ¥è¨­å®šå¾Œ**æ°¸é ä¸èƒ½ä¿®æ”¹**
- é¡¯ç¤º AI æ€§åˆ¥æç¤ºï¼ˆåƒ…åƒè€ƒï¼Œä¸è‡ªå‹•å¡«å¯«ï¼‰
- é¸æ“‡å¾Œéœ€**äºŒæ¬¡ç¢ºèª**æ‰èƒ½å¯«å…¥
- ç¢ºèªå¾Œè¨˜éŒ„ç¢ºèªæ™‚é–“

#### Step 4ï¼šç”Ÿæ—¥èˆ‡å¹´é½¡é©—è­‰

- âš ï¸ **é‡è¦**ï¼šç”Ÿæ—¥è¨­å®šå¾Œ**æ°¸é ä¸èƒ½ä¿®æ”¹**
- è¼¸å…¥æ ¼å¼ï¼šYYYY-MM-DD
- **å¹´é½¡é©—è­‰**ï¼šæœªæ»¿ 18 æ­²æ‹’çµ•è¨»å†Šï¼Œæç¤ºã€Œè«‹æˆå¹´å¾Œå†ä¾†ã€
- è¨ˆç®—å¹´é½¡å€é–“å’Œæ˜Ÿåº§
- é¸æ“‡å¾Œéœ€**äºŒæ¬¡ç¢ºèª**æ‰èƒ½å¯«å…¥

#### Step 5ï¼šåœ‹å®¶

- é¸æ“‡åœ‹å®¶/åœ°å€ä»£ç¢¼ï¼ˆTW, JP, KR, ...ï¼‰

#### Step 6ï¼šå–œå¥½æ€§å‘ï¼ˆç›®æ¨™å°è±¡ï¼‰

- æƒ³èªè­˜çš„æ€§åˆ¥ï¼šç”· / å¥³ / å…¶ä»– / ä¸é™
- ä¸€èˆ¬ä½¿ç”¨è€…åªæœ‰ã€Œç›®æ¨™æ€§åˆ¥ã€æœƒç”¨åˆ°

#### Step 7ï¼šMBTI æ¸¬é©—

- å•å·æ‹†é ï¼ˆæ¯é  3â€“5 é¡Œï¼‰
- æ”¯æ´ä¸­æ–·æ¢å¾©ï¼ˆä¿å­˜å·²ç­”é¡Œç›®ï¼‰
- æ¯é å®Œæˆå¾Œå›è¦†é¼“å‹µæ–‡å­—
- å®Œæˆå¾Œè¨ˆç®— MBTI é¡å‹

#### Step 8ï¼šåè©é¨™æ¸¬é©—

- æä¾› 5 é¡Œæƒ…å¢ƒé¡Œ
- æ”¯æ´ä¸­æ–·æ¢å¾©
- å¾—åˆ† >= 3 åˆ†ï¼šé€šé
- æœªé”æ¨™ï¼šå‹å–„æç¤º + å…è¨±é‡æ–°æ¸¬é©—

#### Step 9ï¼šå®Œæˆè¨»å†Š

- é¡¯ç¤ºå®Œæ•´å€‹äººè³‡æ–™æ‘˜è¦
- æ¨™è¨˜ä½¿ç”¨è€…ç‚ºã€Œå¯ç”¨ç‹€æ…‹ã€
- æä¾›å¿«é€Ÿæ“ä½œæŒ‰éˆ•

**ä¸­æ–·æ¢å¾©**ï¼š
- ä½¿ç”¨ `onboarding_state` JSON æ¬„ä½è¨˜éŒ„é€²åº¦
- ä¸‹æ¬¡ `/start` è‡ªå‹•å¾ä¸­æ–·è™•ç¹¼çºŒ
- æ”¯æ´æŸ¥çœ‹å·²å¡«å¯«è³‡æ–™

### 5.2 /profileï¼ˆå€‹äººè³‡æ–™ï¼‰

é¡¯ç¤ºï¼šæš±ç¨±ã€æ€§åˆ¥ã€å¹´é½¡å€é–“ã€åœ‹å®¶ã€MBTIã€æ˜Ÿåº§ã€èªè¨€ã€é‚€è«‹ç¢¼ã€æ˜¯å¦ VIPã€æ¯æ—¥æ¼‚æµç“¶ä¸Šé™ç­‰ã€‚

**ç·¨è¼¯é™åˆ¶**ï¼š
- **å¯ç·¨è¼¯**ï¼šæš±ç¨±ã€é ­åƒã€èªè¨€ã€åœ‹å®¶ã€å–œå¥½æ€§å‘
- **ä¸å¯ç·¨è¼¯**ï¼šæ€§åˆ¥ã€ç”Ÿæ—¥ï¼ˆæ°¸é ä¸èƒ½ä¿®æ”¹ï¼Œä¸é¡¯ç¤ºç·¨è¼¯æŒ‰éˆ•ï¼‰
- **ç®¡ç†å“¡ç‰¹æ®Šæ¬Šé™**ï¼šgod è§’è‰²å¯ä¿®æ”¹æ‰€æœ‰æ¬„ä½ï¼ˆéœ€è¨˜éŒ„æ“ä½œæ—¥èªŒï¼‰

### 5.3 /throwï¼ˆä¸Ÿæ¼‚æµç“¶ï¼‰

**æµç¨‹**:

1. æª¢æŸ¥ï¼š`isBanned(user)`ï¼Œæœªå®Œæˆ onboarding å‰‡æ‹’çµ•
2. è®€å– daily_usageï¼Œä½¿ç”¨ `canThrowBottle()` åˆ¤æ–·æ˜¯å¦é‚„æœ‰ quota

**ä¸€èˆ¬ vs VIP è¡Œç‚º**:

**ä¸€èˆ¬ä½¿ç”¨è€…**:
- å¿…é ˆè¨­å®š target_genderï¼ˆå¾ /start çš„å–œå¥½æ€§å‘å¸¶å…¥ï¼Œæˆ–ä¸Ÿç“¶æ™‚å†é¸ï¼‰
- ä¸å¯è¨­å®šæ˜Ÿåº§ / MBTI / å¹´é½¡ / åœ°å€ ç¯©é¸ â†’ å°æ‡‰æ¬„ä½ç•™ç©º
- é¡¯ç¤ºå»£å‘Šï¼š
  - å‘¼å« `fetchAd(env)`ï¼ˆgigapubï¼‰ï¼Œä¸¦åŒæ™‚å±•ç¤ºã€Œå‡ç´š VIPã€æŒ‰éˆ•
  - ä½¿ç”¨è€…é»ã€Œå…ˆä¸Ÿç“¶å­ã€æ‰é€²å…¥ä¸‹ä¸€æ­¥

**VIP ä½¿ç”¨è€…**:
- å¯è¨­å®šï¼štarget_gender + target_zodiac_filter + target_mbti_filterï¼ˆå¯é¸ï¼‰
- å¯é¡å¤–é¸æ“‡ç›®æ¨™å¹´é½¡å€é–“ / åœ°å€ï¼ˆé¸é…ï¼‰
- ä¸é¡¯ç¤ºå»£å‘Š

3. ä½¿ç”¨è€…è¼¸å…¥ç“¶å­å…§å®¹ï¼ˆæ–‡å­— + å®˜æ–¹ emojiï¼Œæª¢æŸ¥é•·åº¦ä¸Šé™ï¼‰
4. å»ºç«‹ bottles è¨˜éŒ„ï¼Œstatus='pending'ã€expires_at = created_at + 24h
5. daily_usage.throws_count += 1

### 5.4 /catchï¼ˆæ’¿æ¼‚æµç“¶ï¼‰

1. æª¢æŸ¥å°ç¦èˆ‡ onboarding
2. ç”¨ `matchBottleForUser(user)` å¾ bottles æ‰¾ç¬¦åˆæ¢ä»¶ï¼š
   - ç¬¦åˆæ€§åˆ¥ã€å¹´é½¡ã€åè©æ¢ä»¶ç­‰
   - **æ’é™¤è‡ªå·±ä¸Ÿçš„ç“¶å­**
   - **æ’é™¤æ›¾ç¶“å°é–éçš„ä½¿ç”¨è€…**ï¼ˆblocker_id = userï¼‰
   - **æ’é™¤æ›¾ç¶“è¢«å°é–çš„ä½¿ç”¨è€…**ï¼ˆblocked_id = userï¼‰
   - **æ’é™¤æ›¾è¢«èˆ‰å ±éçš„ä½¿ç”¨è€…**ï¼ˆ24 å°æ™‚å…§ï¼‰
 3. è‹¥æ‰¾åˆ°ï¼š
   - å»ºç«‹ conversationsï¼ˆuser èˆ‡ bottle.owner çš„åŒ¿åå°è©±ï¼‰
   - å»ºç«‹ bottle_chat_history è¨˜éŒ„
   - å›è¦†çµ¦ä½¿ç”¨è€…ç“¶å­å…§å®¹ + æç¤ºï¼š
     - ä½¿ç”¨ `/report` èˆ‰å ±ä¸ç•¶å…§å®¹
     - ä½¿ç”¨ `/block` å°é–ä¸æƒ³å†èŠçš„ä½¿ç”¨è€…
     - èªªæ˜é€™æ˜¯åŒ¿åå°è©±ï¼Œè«‹éµå®ˆå®‰å…¨å®ˆå‰‡
4. è‹¥æ²’æ‰¾åˆ°ï¼š
   - å›è¦†ã€Œç›®å‰æ²’æœ‰é©åˆä½ çš„ç“¶å­ï¼Œç¨å¾Œå†è©¦ã€

### 5.5 å°è©±æ¶ˆæ¯è½‰ç™¼ï¼ˆåŒ¿åèŠå¤©ï¼‰

ä»»ä½•ä¾†è‡ª conversations é›™æ–¹çš„è¨Šæ¯ï¼Œéƒ½ç”± bot ä¸­è½‰ï¼š

1. **é©—è­‰**: å°æ‡‰ conversation_id æ˜¯å¦å­˜åœ¨ä¸” status='active'
2. **æª¢æŸ¥å°é–ç‹€æ…‹**ï¼šç¢ºèªæ¥æ”¶è€…æœªå°é–ç™¼é€è€…
3. **åƒ…å…è¨±æ–‡å­— + å®˜æ–¹ emoji**ï¼ˆä¸ä½¿ç”¨ HTML/Markdownï¼‰:
   - éæ–‡å­— â†’ å›è¦†ã€Œç›®å‰åƒ…æ”¯æ´æ–‡å­—èˆ‡å®˜æ–¹è¡¨æƒ…ç¬¦è™Ÿã€
4. **æœ¬åœ°è¦å‰‡æª¢æŸ¥**ï¼ˆå¿…é ˆé€šéï¼‰:
   - **URL ç™½åå–®æª¢æŸ¥**ï¼šä¸åœ¨ç™½åå–® â†’ æ‹’çµ•è¨Šæ¯ï¼Œæç¤ºå®‰å…¨åŸå› ï¼Œä¸¦ `addRisk(URL_BLOCKED)`
   - **æ•æ„Ÿè©éæ¿¾**ï¼šåŒ…å«æ•æ„Ÿè© â†’ æ‹’çµ•è¨Šæ¯ï¼Œç´¯åŠ é¢¨éšªåˆ†æ•¸
   - **é•·åº¦æª¢æŸ¥**ï¼šè¶…é 1000 å­— â†’ æ‹’çµ•è¨Šæ¯
   - **Emoji é©—è­‰**ï¼šåƒ…å…è¨±å®˜æ–¹ Emoji
5. **AI å¯©æ ¸**ï¼ˆå¯é¸ï¼Œå¤±æ•—ä¸é˜»æ“‹ï¼‰:
   - å˜—è©¦ OpenAI å…§å®¹å¯©æ ¸ï¼ˆtimeout: 3sï¼‰
   - å¤±æ•—æ™‚ï¼šè¨˜éŒ„æ—¥èªŒï¼Œ**ä¸é˜»æ“‹ç™¼è¨€**ï¼Œåƒ…ä¾é æœ¬åœ°è¦å‰‡
   - æˆåŠŸä¸”æ¨™è¨˜é•è¦æ™‚ï¼šæ ¹æ“šé¢¨éšªåˆ†æ•¸æ±ºå®šæ˜¯å¦é˜»æ“‹
   - è¨˜éŒ„åˆ° ai_moderation_logsï¼ˆç”¨æ–¼äººå·¥æŠ½æŸ¥ï¼‰
6. **æ¯å°è±¡æ¯æ—¥è¨Šæ¯æ•¸**:
   - ç”¨ `canSendConversationMessage()` åˆ¤æ–·æ˜¯å¦è¶…é 10ï¼ˆå…è²»ï¼‰ / 100ï¼ˆVIPï¼‰
   - è¶…é¡å‰‡æç¤ºã€Œä»Šå¤©å°é€™ä½å°è±¡çš„ç™¼è¨€å·²é”ä¸Šé™ï¼Œæ˜å¤©å†èŠã€
7. **VIP ç¿»è­¯**:
   - è‹¥å°è©±ä»»ä¸€æ–¹ç‚º VIPï¼š
     - å„ªå…ˆä½¿ç”¨ **OpenAI** ç¿»è­¯
     - å¤±æ•—æ™‚è‡ªå‹•é™ç´šåˆ° **Google Translate**
     - è¨˜éŒ„é™ç´šäº‹ä»¶ï¼ˆç”¨æ–¼ç›£æ§ï¼‰
   - å…è²»ä½¿ç”¨è€…ï¼š
     - åƒ…ä½¿ç”¨ **Google Translate**
   - ç¿»è­¯å¤±æ•—æ™‚ï¼šç™¼é€åŸæ–‡ + æç¤ºã€Œç¿»è­¯æœå‹™æš«æ™‚æœ‰å•é¡Œï¼Œè«‹å…ˆçœ‹åŸæ–‡ã€
   - è©³ç´°ç­–ç•¥è«‹åƒè€ƒï¼šTRANSLATION_STRATEGY.md
8. **å„²å­˜è¨Šæ¯è¨˜éŒ„**:
   - å„²å­˜åˆ° conversation_messages
   - é™åˆ¶æ¯å€‹å°è©±å°è±¡æœ€å¤šä¿ç•™ 3650 ç­†è¨Šæ¯
   - è¶…éæ™‚åˆªé™¤æœ€èˆŠçš„ï¼Œä¿ç•™æœ€å¾Œ 100 ç­†
9. ä½¿ç”¨ `recordConversationMessage()` æ›´æ–° conversation_daily_usage

### 5.6 /reportï¼ˆèˆ‰å ±ï¼‰

1. æ¯å€‹èˆ‰å ±è¨˜éŒ„å¯«å…¥ reports
2. é‡æ–°è¨ˆç®—éå» 24 å°æ™‚å…§é‡å° target_id çš„ unique reporters æ•¸
3. ä¾å‰è¿°è¦å‰‡å°ç¦
4. åŒæ™‚ç´¯åŠ  risk_score
5. å›è¦†èˆ‰å ±è€…ã€Œå·²æ”¶åˆ°èˆ‰å ±ï¼Œæˆ‘å€‘æœƒå¯©æŸ¥ã€

### 5.7 /appealï¼ˆç”³è¨´ï¼‰

ä½¿ç”¨è€…åœ¨è¢«å°æœŸé–“å¯ç™¼ `/appeal`ï¼š

1. è¼¸å…¥ç”³è¨´å…§å®¹ï¼Œå¯«å…¥ appeals
2. ç®¡ç†å“¡å¯åœ¨ `/admin` ä»‹é¢æŸ¥çœ‹ä¸¦æ›´æ–° status

### 5.8 /vipï¼ˆVIP è³¼è²·ï¼‰

1. é¡¯ç¤º VIP æ¬Šç›Šèˆ‡ç›®å‰ç‹€æ…‹ï¼ˆæ˜¯å¦æœ‰æ•ˆã€åˆ°æœŸæ—¥ï¼‰
2. è‹¥éèª²ä¸­ï¼Œæä¾›ã€Œç”¨ Stars è³¼è²· VIPï¼ˆæœˆä»˜ï¼‰ã€æŒ‰éˆ•ï¼š
   - ä½¿ç”¨ `sendInvoice` æˆ– `createInvoiceLink`ï¼Œcurrency='XTR'ï¼Œåƒ¹æ ¼å°æ‡‰ 5 USD
3. æ”¶åˆ° `successful_payment` å¾Œï¼š
   - å¯«å…¥ä¸€ç­† payments
   - å‘¼å« `activateVip(userId, 30)`ï¼šis_vip=1ã€vip_expire_at=now+30d

### 5.9 /help

èªªæ˜ï¼š
- å¦‚ä½•ä¸Ÿç“¶ / æ’¿ç“¶
- èˆ‰å ±ï¼å°ç¦æ©Ÿåˆ¶
- é‚€è«‹å¥½å‹çå‹µæ©Ÿåˆ¶
- VIP åŠŸèƒ½

### 5.10 /blockï¼ˆå°é–åŠŸèƒ½ï¼‰

**åŠŸèƒ½èªªæ˜**ï¼š
- å°é–ç•¶å‰å°è©±å°è±¡
- ä¸æ¶‰åŠèˆ‰å ±ï¼ˆèˆ‡ `/report` ä¸åŒï¼‰
- å°é–å¾Œä¸å†åŒ¹é…åˆ°è©²ä½¿ç”¨è€…
- å°é–å¾Œè©²ä½¿ç”¨è€…ç„¡æ³•å†ç™¼é€è¨Šæ¯

**æµç¨‹**ï¼š
1. ä½¿ç”¨è€…åœ¨å°è©±ä¸­ç™¼é€ `/block`
2. Bot é¡¯ç¤ºç¢ºèªæç¤ºï¼šã€Œç¢ºå®šè¦å°é–é€™ä½ä½¿ç”¨è€…å—ï¼Ÿã€
3. ä½¿ç”¨è€…ç¢ºèªå°é–
4. å»ºç«‹ `user_blocks` è¨˜éŒ„ï¼ˆblocker_id, blocked_id, conversation_idï¼‰
5. æ›´æ–° `conversations` ç‹€æ…‹ç‚º 'blocked'ï¼ˆa_blocked=1 æˆ– b_blocked=1ï¼‰
6. é€šçŸ¥ä½¿ç”¨è€…ã€Œå·²å°é–ã€

**åŒ¹é…æ’é™¤é‚è¼¯**ï¼š
- åœ¨ `matchBottleForUser` ä¸­æ’é™¤ï¼š
  - å·²å°é–çš„ä½¿ç”¨è€…ï¼ˆblocker_id = userï¼‰
  - è¢«å°é–çš„ä½¿ç”¨è€…ï¼ˆblocked_id = userï¼‰
  - è¢«èˆ‰å ±éçš„ä½¿ç”¨è€…ï¼ˆ24 å°æ™‚å…§ï¼‰
- è³‡æ–™åº«æŸ¥è©¢æ™‚ä½¿ç”¨ `user_blocks` è¡¨æ’é™¤

**è³‡æ–™åº«è¡¨**ï¼š`user_blocks`ï¼ˆè¦‹ 3.4.1 ç¯€ï¼‰

### 5.11 /delete_meï¼ˆåˆªé™¤å¸³è™Ÿï¼‰

**åŠŸèƒ½èªªæ˜**ï¼š
- ä½¿ç”¨è€…å¯ä»¥è¦æ±‚åˆªé™¤è‡ªå·±çš„è³‡æ–™
- æ¨™è¨˜ä½¿ç”¨è€…ç‚º 'deleted'
- æ¸…é™¤å€‹äººè³‡æ–™æ¬„ä½
- ä¿ç•™å®‰å…¨å¯©è¨ˆè¨˜éŒ„ï¼ˆè„«æ•ï¼‰

**æµç¨‹**ï¼š
1. ä½¿ç”¨è€…ç™¼é€ `/delete_me`
2. Bot é¡¯ç¤ºåˆªé™¤å¾Œæœè­¦å‘Šï¼ˆä¸å¯é€†æ“ä½œï¼‰
3. ä½¿ç”¨è€…æ·±åº¦ç¢ºèªï¼ˆè¼¸å…¥ã€Œåˆªé™¤ã€ï¼‰
4. æ¨™è¨˜ä½¿ç”¨è€…ç‚ºåˆªé™¤ï¼š
   - `nickname` â†’ '[å·²åˆªé™¤]'
   - `avatar_url` â†’ NULL
   - `language_pref` â†’ NULL
   - `prefer_gender` â†’ NULL
   - `onboarding_state` â†’ NULL
   - `deleted_at` = datetime('now')
5. ä¿ç•™å®‰å…¨å¯©è¨ˆè¨˜éŒ„ï¼ˆreports, bans, risk_scoreï¼‰
6. é€šçŸ¥ä½¿ç”¨è€…ã€Œå¸³è™Ÿå·²åˆªé™¤ã€

**è³‡æ–™ä¿ç•™ç­–ç•¥**ï¼š
- å€‹äººè³‡æ–™ï¼šæ¸…é™¤
- å®‰å…¨å¯©è¨ˆè¨˜éŒ„ï¼šä¿ç•™ï¼ˆè„«æ•ï¼‰
- çµ±è¨ˆè³‡æ–™ï¼šä¿ç•™ï¼ˆä¸é¡¯ç¤ºå€‹äººè³‡è¨Šï¼‰

**è³‡æ–™åº«æ¬„ä½**ï¼š`users.deleted_at`ã€`users.anonymized_at`ã€`users.deletion_requested_at`

### 5.12 /broadcastï¼ˆä¸Šå¸ / å¤©ä½¿ï¼‰

åƒ… role ç‚º god æˆ– angel çš„ä½¿ç”¨è€…å¯ç”¨ã€‚

**æµç¨‹**:

1. é¸æ“‡å»£æ’­æ–‡å­—å…§å®¹ï¼ˆæ–‡å­— + emojiï¼‰
2. è¨­å®šç¯©é¸æ¢ä»¶ï¼š
   - æ€§åˆ¥ã€å¹´é½¡å€é–“ã€æ˜Ÿåº§ã€èªè¨€ã€VIPã€é‚€è«‹æ•¸ã€åœ‹å®¶ç­‰
3. å¯«å…¥ broadcast_jobs + å°æ‡‰çš„ broadcast_queue
4. god å¯å°æ‰€æœ‰äººå»£æ’­ï¼ˆfilters_json å¯ç‚ºç©ºï¼‰
5. angel å¿…é ˆè‡³å°‘æŒ‡å®šä¸€é …ç¯©é¸æ¢ä»¶ï¼ˆç¨‹å¼å±¤é™åˆ¶ï¼‰

---

## 6. æ˜Ÿåº§é‹å‹¢æ¨æ’­

### å¤–éƒ¨æµç¨‹ï¼ˆGoogle è¡¨å–® / Sheet + Apps Scriptï¼‰

æ¯é€±ç”¢ç”Ÿ 12 æ˜Ÿåº§çš„ä¸‹é€±é‹å‹¢æ–‡å­—ã€‚

é€é HTTP POST æˆ–å¤–éƒ¨ JSONï¼Œå¯«å…¥ horoscope_templatesã€‚

### Cloudflare Cron

æ¯é€±ä¸€ 09:00ï¼ˆå¯èª¿æ•´ï¼‰å‘¼å« `/cron/horoscope`

### /cron/horoscope handler

1. æ‰¾å‡ºæœ¬é€±å°æ‡‰çš„ horoscope_templates
2. é¸å‡º users ä¸­ horoscope_opt_in = 1 çš„ä½¿ç”¨è€…
3. ä¾ zodiac_sign ç™¼é€å°ˆå±¬é‹å‹¢è¨Šæ¯ï¼Œé™„ä¸ŠæŒ‰éˆ•ï¼š
   - ã€Œâœ¨ é‡æ–°é…å°ã€â†’ `/throw`
   - ã€ŒğŸ” æ’¿å€‹ç“¶å­ã€â†’ `/catch`

---

## 7. Telegram Mini App è©³ç´°è¨­è¨ˆ

### 7.1 Mini App æ€§èƒ½å„ªåŒ–

**é¦–å±è¼‰å…¥ < 2 ç§’ç­–ç•¥**ï¼š

1. **å¤šèªè¨€é¦–å±è³‡æºåˆ‡åˆ†**ï¼š
   - æŒ‰èªè¨€ä»£ç¢¼æ‹†åˆ†é¦–å±è³‡æºï¼ˆzh-TWã€enã€ja ç­‰ï¼‰
   - åƒ…è¼‰å…¥ç•¶å‰èªè¨€çš„ç¿»è­¯æ–‡ä»¶
   - é è¼‰å¸¸ç”¨èªè¨€åŒ…åˆ° CDN

2. **é è¼‰ MBTI é¡Œç›®/çµæœ JSON**ï¼š
   - MBTI é¡Œç›® JSON é å…ˆè¼‰å…¥åˆ° Service Worker å¿«å–
   - MBTI çµæœèªªæ˜ JSON é è¼‰åˆ°å¿«å–
   - é¿å…é¦–å±è¼‰å…¥æ™‚è«‹æ±‚é¡Œç›®è³‡æ–™

3. **Service Worker å¿«å–ç­–ç•¥**ï¼š
   - éœæ…‹è³‡æºï¼ˆCSSã€JSã€åœ–ç‰‡ï¼‰ï¼šCache First
   - API è³‡æ–™ï¼ˆMBTI é¡Œç›®ã€ç¿»è­¯æ–‡ä»¶ï¼‰ï¼šNetwork Firstï¼ŒFallback to Cache
   - å¿«å–éæœŸæ™‚é–“ï¼š24 å°æ™‚ï¼ˆMBTI é¡Œç›®ï¼‰ã€1 å°æ™‚ï¼ˆç¿»è­¯æ–‡ä»¶ï¼‰

4. **Skeleton UI**ï¼š
   - é¦–å±é¡¯ç¤º Skeleton è¼‰å…¥ç‹€æ…‹
   - é¿å…ç™½å±ï¼Œæå‡ä½¿ç”¨è€…é«”é©—
   - ä½¿ç”¨ Telegram `MainButton` é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹

**å¯¦ä½œç¯„ä¾‹**ï¼š
```typescript
// src/mini-app/utils/cache.ts
export class ServiceWorkerCache {
  static async cacheMBTIQuestions(language: string): Promise<void> {
    const questions = await fetch(`/api/mbti/questions?lang=${language}`);
    await caches.open('mbti-cache').then(cache => {
      cache.put(`/api/mbti/questions?lang=${language}`, questions);
    });
  }
  
  static async getMBTIQuestions(language: string): Promise<any> {
    const cache = await caches.open('mbti-cache');
    const cached = await cache.match(`/api/mbti/questions?lang=${language}`);
    if (cached) return cached.json();
    
    // Network First
    const response = await fetch(`/api/mbti/questions?lang=${language}`);
    await cache.put(`/api/mbti/questions?lang=${language}`, response.clone());
    return response.json();
  }
}
```

### 7.2 Mini App å®‰å…¨

**initData é©—ç°½æµç¨‹**ï¼š

1. **æ¥æ”¶ initData**ï¼š
   - Telegram Mini App å•Ÿå‹•æ™‚ï¼Œå¾ `window.Telegram.WebApp.initData` å–å¾—
   - `initData` æ ¼å¼ï¼š`user=%7B%22id%22%3A123456789%7D&auth_date=1234567890&hash=...`

2. **é©—ç°½æ­¥é©Ÿ**ï¼š
   ```typescript
   // src/telegram/webapp/validate-initdata.ts
   
   import crypto from 'crypto';
   
   export function validateInitData(
     initData: string,
     botSecret: string
   ): boolean {
     const urlParams = new URLSearchParams(initData);
     const hash = urlParams.get('hash');
     urlParams.delete('hash');
     
     // æŒ‰éµåæ’åº
     const dataCheckString = Array.from(urlParams.entries())
       .sort(([a], [b]) => a.localeCompare(b))
       .map(([key, value]) => `${key}=${value}`)
       .join('\n');
     
     // è¨ˆç®— HMAC-SHA256
     const secretKey = crypto
       .createHmac('sha256', 'WebAppData')
       .update(botSecret)
       .digest();
     
     const calculatedHash = crypto
       .createHmac('sha256', secretKey)
       .update(dataCheckString)
       .digest('hex');
     
     return calculatedHash === hash;
   }
   ```

3. **é©—è­‰ auth_date**ï¼š
   - æª¢æŸ¥ `auth_date` æ˜¯å¦åœ¨ 24 å°æ™‚å…§
   - è¶…é 24 å°æ™‚éœ€é‡æ–°é©—ç°½

4. **Token å¤±æ•ˆç­–ç•¥**ï¼š
   - `initData` ä¸­çš„ `auth_date` è¶…é 24 å°æ™‚å¾Œå¤±æ•ˆ
   - å¤±æ•ˆæ™‚æç¤ºä½¿ç”¨è€…é‡æ–°å•Ÿå‹• Mini App
   - è¨˜éŒ„å¤±æ•ˆäº‹ä»¶ï¼ˆç”¨æ–¼å®‰å…¨ç›£æ§ï¼‰

**è™•ç† web_app_data**ï¼š
- ç•¶ä½¿ç”¨è€…é»æ“Š Mini App å…§çš„æŒ‰éˆ•æäº¤è³‡æ–™æ™‚ï¼ŒTelegram æœƒç™¼é€ `web_app_data` åˆ° Bot
- Bot éœ€è¦é©—è­‰ `web_app_data` ä¾†æºï¼ˆæª¢æŸ¥ user_idã€timestampï¼‰
- æ ¼å¼ï¼š`update.message.web_app_data.data`ï¼ˆJSON å­—ä¸²ï¼‰

### 7.3 Mini App ç¤¾ç¾¤å¯¦è¸

**themeParams é©é…**ï¼š
```typescript
// src/mini-app/utils/theme.ts
const tg = window.Telegram.WebApp;
tg.ready();

// è‡ªå‹•é©é…æ·±/æ·ºè‰²ä¸»é¡Œ
const theme = tg.themeParams;
document.documentElement.style.setProperty('--bg-color', theme.bg_color || '#ffffff');
document.documentElement.style.setProperty('--text-color', theme.text_color || '#000000');
document.documentElement.style.setProperty('--button-color', theme.button_color || '#3390ec');
```

**MainButton / SecondaryButton**ï¼š
```typescript
// ä½¿ç”¨ Telegram åŸç”ŸæŒ‰éˆ•ï¼Œæ¸›å°‘è‡ªå®šç¾© UI
const tg = window.Telegram.WebApp;

// ä¸»è¦æŒ‰éˆ•ï¼ˆä¸Ÿç“¶å­ï¼‰
tg.MainButton.setText('ğŸ“¦ ä¸Ÿç“¶å­');
tg.MainButton.onClick(() => {
  // è™•ç†ä¸Ÿç“¶å­é‚è¼¯
});
tg.MainButton.show();

// æ¬¡è¦æŒ‰éˆ•ï¼ˆæŸ¥çœ‹å€‹äººè³‡æ–™ï¼‰
tg.SecondaryButton.setText('ğŸ‘¤ å€‹äººè³‡æ–™');
tg.SecondaryButton.onClick(() => {
  // è™•ç†å€‹äººè³‡æ–™é‚è¼¯
});
tg.SecondaryButton.show();
```

**WebApp.share åˆ†äº«è£‚è®Š**ï¼š
```typescript
// åˆ†äº« MBTI æ¸¬é©—çµæœ
tg.shareUrl('https://t.me/xunni_bot?startapp=share_mbti_' + resultId, {
  text: `æˆ‘çš„ MBTI æ¸¬é©—çµæœæ˜¯ ${mbtiType}ï¼ä½ ä¹Ÿä¾†æ¸¬æ¸¬å§ï½`,
});

// åˆ†äº«é‚€è«‹ç¢¼
tg.shareUrl('https://t.me/xunni_bot?startapp=invite_' + inviteCode, {
  text: `ä¾† XunNi ä¸€èµ·ä¸Ÿæ¼‚æµç“¶å§ï¼ä½¿ç”¨æˆ‘çš„é‚€è«‹ç¢¼ï¼š${inviteCode}`,
});
```

---

## 8. é‚€è«‹èˆ‡è£‚è®Šæ©Ÿåˆ¶

### 8.1 é‚€è«‹ç¢¼ç”Ÿæˆ

**é‚€è«‹ç¢¼é¡å‹**ï¼š
- **æ°¸ä¹…é‚€è«‹ç¢¼**ï¼ˆæ¯å€‹ä½¿ç”¨è€… 1 å€‹ï¼‰ï¼š
  - æ ¼å¼ï¼šä½¿ç”¨è€… `telegram_id` çš„ Base64 ç·¨ç¢¼æˆ– 8 ä½å­—æ¯æ•¸å­—æ··åˆ
  - å¯ç„¡é™æ¬¡ä½¿ç”¨
  - å„²å­˜åœ¨ `users.invite_code`

**ç”Ÿæˆé‚è¼¯**ï¼š
```typescript
// src/domain/invite.ts
export function generateInviteCode(telegramId: string): string {
  // ä½¿ç”¨ telegram_id + salt ç”Ÿæˆå”¯ä¸€é‚€è«‹ç¢¼
  const hash = crypto.createHash('sha256')
    .update(telegramId + 'INVITE_SALT')
    .digest('hex');
  
  // å–å‰ 8 ä½ï¼Œè½‰æ›ç‚ºå­—æ¯æ•¸å­—æ··åˆ
  return base64Encode(hash.substring(0, 8)).substring(0, 8);
}
```

### 8.2 é‚€è«‹é©—è­‰æµç¨‹

**è§¸ç™¼ç¯€é»**ï¼š
1. æ–°ä½¿ç”¨è€…è¨»å†Šæ™‚æª¢æŸ¥ `startapp` åƒæ•¸ï¼š
   - å¦‚æœ `startapp=invite_{code}`ï¼Œè¨˜éŒ„åˆ° `users.invited_by`
   - å»ºç«‹ `invites` è¨˜éŒ„ï¼ˆstatus='pending'ï¼‰

2. æ–°ä½¿ç”¨è€…å®Œæˆ MBTI æ¸¬é©—æ™‚ï¼š
   - æª¢æŸ¥æ˜¯å¦æœ‰ `invited_by`
   - å¦‚æœæœ‰ï¼Œå°‡ `invites.status` æ›´æ–°ç‚º 'activated'
   - æ›´æ–°é‚€è«‹äººçš„ `activated_invites` è¨ˆæ•¸

3. æ–°ä½¿ç”¨è€…è‡³å°‘ä¸Ÿ 1 å€‹ç“¶å­å¾Œï¼š
   - ç¢ºèªæ¿€æ´»æ¢ä»¶é”æˆ
   - ç™¼é€é€šçŸ¥çµ¦é‚€è«‹äººï¼šã€Œä½ çš„å¥½å‹å·²æ¿€æ´»é‚€è«‹ï¼ã€

**é©—è­‰æ¢ä»¶**ï¼š
- å®Œæˆ onboardingï¼ˆå« MBTI æ¸¬é©—ï¼‰
- è‡³å°‘ä¸Ÿé 1 å€‹ç“¶å­
- åƒ…è¨ˆç®—é¦–æ¬¡æ¿€æ´»ï¼ˆåŒä¸€é‚€è«‹ç¢¼åªèƒ½æ¿€æ´» 1 æ¬¡ï¼‰

### 8.3 é‚€è«‹æ•¸æ“šçµ±è¨ˆ

**çµ±è¨ˆç¶­åº¦**ï¼š
- é‚€è«‹ç¢¼é»æ“Šæ¬¡æ•¸ï¼ˆæœ‰å¤šå°‘äººé»æ“Šäº†é‚€è«‹é€£çµï¼‰
- é‚€è«‹ç¢¼æ¿€æ´»æ¬¡æ•¸ï¼ˆæœ‰å¤šå°‘äººå®Œæˆè¨»å†Šä¸¦æ¿€æ´»ï¼‰
- é‚€è«‹è½‰åŒ–ç‡ï¼ˆæ¿€æ´»æ¬¡æ•¸ / é»æ“Šæ¬¡æ•¸ï¼‰
- é‚€è«‹ä¾†æºåˆ†æï¼ˆMBTI åˆ†äº«ã€æ¼‚æµç“¶åˆ†äº«ã€å€‹äººè³‡æ–™åˆ†äº«ï¼‰

**KPI æŒ‡æ¨™å°ç…§è¡¨**ï¼š

| æŒ‡æ¨™ | å®šç¾© | è¨ˆç®—æ–¹å¼ | ç”¨é€” |
|------|------|---------|------|
| é‚€è«‹é»æ“Šæ•¸ | é»æ“Šé‚€è«‹é€£çµçš„äººæ•¸ | COUNT(DISTINCT invitee_id) WHERE status='pending' | è¿½è¹¤é‚€è«‹å‚³æ’­ç¯„åœ |
| é‚€è«‹æ¿€æ´»æ•¸ | å®Œæˆæ¿€æ´»çš„é‚€è«‹æ•¸ | COUNT(*) WHERE status='activated' | è¿½è¹¤é‚€è«‹æ•ˆæœ |
| é‚€è«‹è½‰åŒ–ç‡ | æ¿€æ´»ç‡ | æ¿€æ´»æ•¸ / é»æ“Šæ•¸ * 100% | å„ªåŒ–é‚€è«‹ç­–ç•¥ |
| åˆ†äº«è½‰åŒ–ç‡ | åˆ†äº«å¾Œè¨»å†Šç‡ | åˆ†äº«é€£çµè¨»å†Šæ•¸ / åˆ†äº«æ¬¡æ•¸ * 100% | å„ªåŒ–åˆ†äº«ç­–ç•¥ |
| å¹³å‡é‚€è«‹æ•¸ | æ¯ä½ä½¿ç”¨è€…å¹³å‡é‚€è«‹äººæ•¸ | SUM(activated_invites) / COUNT(*) | è¿½è¹¤æ´»èºåº¦ |

### 8.4 åˆ†äº«æµç¨‹è¨­è¨ˆ

**MBTI æ¸¬é©—çµæœåˆ†äº«**ï¼š
1. ä½¿ç”¨è€…å®Œæˆ MBTI æ¸¬é©—å¾Œï¼Œé¡¯ç¤ºã€Œåˆ†äº«çµæœã€æŒ‰éˆ•
2. é»æ“Šå¾Œä½¿ç”¨ `WebApp.share`ï¼š
   - Deep Linkï¼š`startapp=share_mbti_{resultId}`
   - åˆ†äº«æ–‡æ¡ˆï¼šã€Œæˆ‘çš„ MBTI æ¸¬é©—çµæœæ˜¯ {type}ï¼ä½ ä¹Ÿä¾†æ¸¬æ¸¬å§ï½ã€
   - é è¦½åœ–ç‰‡ï¼šMBTI çµæœå¡ç‰‡ï¼ˆå«é¡å‹ã€æè¿°ï¼‰

3. è¢«åˆ†äº«è€…é»é–‹é€£çµå¾Œï¼š
   - Bot æª¢æŸ¥ `startapp` åƒæ•¸
   - å¦‚æœæ˜¯ `share_mbti_{resultId}`ï¼š
     - é¡¯ç¤ºï¼šã€Œä½ çš„å¥½å‹é‚€è«‹ä½ ä¾†æ¸¬ MBTIï¼å¿«ä¾†çœ‹çœ‹ä½ çš„æ€§æ ¼é¡å‹å§ï½ã€
     - æŒ‰éˆ•ï¼šã€ŒğŸ“Š é–‹å§‹æ¸¬é©—ã€â†’ å•Ÿå‹• Mini App é€²å…¥ MBTI æ¸¬é©—
   - è¨˜éŒ„åˆ†äº«ä¾†æºåˆ° `referral_sources` è¡¨ï¼š
     - `source_type`: 'mbti_share'
     - `source_id`: resultId
     - `shared_by`: åˆ†äº«è€…çš„ telegram_id

**é‚€è«‹ç¢¼åˆ†äº«**ï¼š
1. ä½¿ç”¨è€…åœ¨ `/profile` ä¸­é»æ“Šã€Œåˆ†äº«é‚€è«‹ç¢¼ã€
2. ä½¿ç”¨ `WebApp.share`ï¼š
   - Deep Linkï¼š`startapp=invite_{inviteCode}`
   - åˆ†äº«æ–‡æ¡ˆï¼šã€Œä¾† XunNi ä¸€èµ·ä¸Ÿæ¼‚æµç“¶å§ï¼ä½¿ç”¨æˆ‘çš„é‚€è«‹ç¢¼ï¼š{inviteCode}ã€
3. è¢«åˆ†äº«è€…é»é–‹å¾Œï¼š
   - Bot æª¢æŸ¥ `startapp=invite_{code}`
   - å¦‚æœæ˜¯é‚€è«‹ç¢¼ï¼Œè¨˜éŒ„åˆ° `users.invited_by`
   - å•Ÿå‹•è¨»å†Šæµç¨‹æ™‚å¸¶å…¥é‚€è«‹ç¢¼

---

## 9. è³‡æ–™ä¿ç•™èˆ‡æ¸…ç†ç­–ç•¥

### 9.1 æ¼‚æµç“¶ä¿ç•™ç­–ç•¥

**ä¿ç•™æœŸé™**ï¼š
- æ­£å¸¸ç‹€æ…‹ï¼š24 å°æ™‚ï¼ˆéæœŸå¾Œä¸å†è¢«æ’¿èµ·ï¼‰
- è»Ÿåˆªé™¤ï¼š90 å¤©å¾Œæ¨™è¨˜ç‚º 'deleted'ï¼Œå…§å®¹åŒ¿ååŒ–
- ç¡¬åˆªé™¤ï¼š365 å¤©å¾Œå®Œå…¨åˆªé™¤ï¼ˆå¯é¸ï¼‰

**æ¸…ç†æµç¨‹**ï¼š
```
æ¼‚æµç“¶å»ºç«‹ â†’ 24 å°æ™‚å…§å¯è¢«æ’¿èµ·
â†’ 24 å°æ™‚å¾Œ expires_at éæœŸï¼Œstatus = 'expired'
â†’ 90 å¤©å¾Œæ¨™è¨˜ç‚º 'deleted'ï¼Œcontent åŒ¿ååŒ–ï¼ˆä¿ç•™çµ±è¨ˆç”¨ï¼‰
â†’ 365 å¤©å¾Œå®Œå…¨åˆªé™¤ï¼ˆå¯é¸ï¼‰
```

### 9.2 èŠå¤©è¨˜éŒ„ä¿ç•™ç­–ç•¥

**ä¿ç•™é™åˆ¶**ï¼š
- æ¯å€‹å°è©±å°è±¡æœ€å¤šä¿ç•™ 3650 ç­†è¨Šæ¯
- è¶…é 3650 ç­†æ™‚ï¼Œåˆªé™¤æœ€èˆŠçš„è¨Šæ¯ï¼ˆFIFOï¼‰
- æ°¸ä¹…ä¿ç•™æœ€å¾Œ 100 ç­†è¨Šæ¯ï¼ˆç”¨æ–¼ä¸Šä¸‹æ–‡ï¼‰

### 9.3 ä½¿ç”¨è€…è³‡æ–™ä¿ç•™ç­–ç•¥

**æ­£å¸¸ä½¿ç”¨è€…**ï¼š
- å€‹äººè³‡æ–™æ°¸ä¹…ä¿ç•™ï¼ˆé™¤éä½¿ç”¨è€…åˆªé™¤ï¼‰
- çµ±è¨ˆè³‡æ–™æ°¸ä¹…ä¿ç•™

**å·²åˆªé™¤ä½¿ç”¨è€…**ï¼š
- æ¨™è¨˜ç‚º 'deleted'
- æ¸…é™¤å€‹äººè³‡æ–™æ¬„ä½ï¼ˆnickname, avatar_url ç­‰ï¼‰
- ä¿ç•™å®‰å…¨å¯©è¨ˆè¨˜éŒ„ï¼ˆreports, bans, risk_scoreï¼‰
- è³‡æ–™è„«æ•è™•ç†

### 9.4 è³‡æ–™æ¸…ç† Cron ä»»å‹™

**æ¯æ—¥åŸ·è¡Œä¸€æ¬¡**ï¼š
- `/cron/cleanup_bottles`ï¼šæ¨™è¨˜ 90 å¤©å‰éæœŸçš„æ¼‚æµç“¶ç‚º 'deleted'ï¼Œå…§å®¹åŒ¿ååŒ–
- `/cron/cleanup_messages`ï¼šæ¸…ç†æ‰€æœ‰å°è©±çš„éå¤šè¨Šæ¯ï¼ˆè¶…é 3650 ç­†ï¼‰

**è³‡æ–™åº«æ¬„ä½**ï¼š
- `bottles.deleted_at`ã€`bottles.anonymized_at`
- `users.deleted_at`ã€`users.anonymized_at`ã€`users.deletion_requested_at`

---

## 10. å¤–éƒ¨è³‡æ ¼æŸ¥è©¢ APIï¼ˆçµ¦ Moonpacketï¼‰

### HTTP ç«¯é»

**POST** `/api/eligibility`

**Header**: `X-API-Key: <EXTERNAL_API_KEY>`

**Body**:
```json
{
  "telegram_id": "123456789",
  "program": "red_packet_2025_q1"
}
```

**å›æ‡‰**:
```json
{
  "eligible": true,
  "conditions": {
    "hasMbti": true,
    "passedAntiScam": true,
    "hasThrownBottle": true,
    "notBanned": true,
    "inviteCount": 3,
    "isVip": false
  },
  "reason": "OK"
}
```

### åˆ¤æ–·é‚è¼¯

```typescript
interface EligibilityConditions {
  hasMbti: boolean;
  passedAntiScam: boolean;
  hasThrownBottle: boolean;
  notBanned: boolean;
  inviteCount: number;
  isVip: boolean;
}

async function checkEligibility(telegramId: string): Promise<{ 
  eligible: boolean; 
  conditions: EligibilityConditions | null; 
  reason: string; 
}> {
  const user = await db.getUser(telegramId);
  if (!user) {
    return { eligible: false, conditions: null, reason: 'USER_NOT_FOUND' };
  }

  const hasMbti = !!user.mbti_type;
  const passedAntiScam = (user.trust_level || 0) >= 1;
  const hasThrownBottle = await db.userHasThrownBottle(telegramId);
  const notBanned = !isBanned(user);
  const inviteCount = user.activated_invites || 0;
  const isVip = isVipActive(user, new Date());

  const conditions: EligibilityConditions = {
    hasMbti,
    passedAntiScam,
    hasThrownBottle,
    notBanned,
    inviteCount,
    isVip,
  };

  const eligible = hasMbti && hasThrownBottle && notBanned;

  return {
    eligible,
    conditions,
    reason: eligible ? 'OK' : 'CONDITIONS_NOT_MET',
  };
}
```

**Moonpacket å¾Œç«¯å¯ä»¥æ ¹æ“š conditions è‡ªè¡Œæ±ºå®šç´…åŒ…è¦å‰‡**ï¼Œä¾‹å¦‚ï¼š
- å¿…é ˆ hasMbti && hasThrownBottle æ‰å¯é ˜
- inviteCount è¶Šå¤šç´…åŒ…è¶Šå¤§
- isVip æœ‰é¡å¤–çå‹µ

---

## 11. å…¬é–‹çµ±è¨ˆ APIï¼ˆçµ¦è¡ŒéŠ·é é¢ï¼‰

### 11.1 HTTP ç«¯é»

**GET** `/api/public-stats`

**ç„¡éœ€èªè­‰**ï¼šé–‹æ”¾åŒ¿åå­˜å–ï¼Œä½†éœ€é€Ÿç‡é™åˆ¶

**å›æ‡‰æ ¼å¼**ï¼š
```json
{
  "timestamp": "2025-01-15T12:00:00Z",
  "cumulative": {
    "total_bottles": 12345,      // ç´¯ç©ç¸½æ¼‚æµç“¶æ•¸
    "total_users": 5678,         // ç´¯ç©ç¸½ä½¿ç”¨è€…æ•¸
    "total_messages": 98765,     // ç´¯ç©ç¸½è¨Šæ¯æ•¸
    "total_conversations": 4321  // ç´¯ç©ç¸½å°è©±æ•¸
  },
  "yesterday": {
    "bottles": 234,              // æ˜¨æ—¥æ–°å¢æ¼‚æµç“¶æ•¸
    "users": 56,                 // æ˜¨æ—¥æ–°å¢ä½¿ç”¨è€…æ•¸
    "messages": 1234,            // æ˜¨æ—¥æ–°å¢è¨Šæ¯æ•¸
    "conversations": 89          // æ˜¨æ—¥æ–°å¢å°è©±æ•¸
  },
  "active": {
    "active_users_7d": 1234,     // æœ€è¿‘ 7 å¤©æ´»èºä½¿ç”¨è€…æ•¸
    "active_users_30d": 3456     // æœ€è¿‘ 30 å¤©æ´»èºä½¿ç”¨è€…æ•¸
  }
}
```

### 11.2 è³‡æ–™èšåˆé‚è¼¯

**Domain å±¤å‡½æ•¸**ï¼ˆ`src/domain/public_stats.ts`ï¼‰ï¼š
```typescript
export interface PublicStats {
  timestamp: string;
  cumulative: {
    total_bottles: number;
    total_users: number;
    total_messages: number;
    total_conversations: number;
  };
  yesterday: {
    bottles: number;
    users: number;
    messages: number;
    conversations: number;
  };
  active: {
    active_users_7d: number;
    active_users_30d: number;
  };
}

/**
 * è¨ˆç®—å…¬é–‹çµ±è¨ˆæ•¸æ“š
 */
export async function getPublicStats(
  db: D1Database
): Promise<PublicStats> {
  const today = new Date().toISOString().split('T')[0];
  const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];
  const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
  const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
  
  // ç´¯ç©æ•¸æ“š
  const totalBottles = await db.prepare(`
    SELECT COUNT(*) as count
    FROM bottles
    WHERE status != 'deleted'
  `).first();
  
  const totalUsers = await db.prepare(`
    SELECT COUNT(*) as count
    FROM users
    WHERE deleted_at IS NULL
  `).first();
  
  const totalMessages = await db.prepare(`
    SELECT COUNT(*) as count
    FROM conversation_messages
  `).first();
  
  const totalConversations = await db.prepare(`
    SELECT COUNT(*) as count
    FROM conversations
    WHERE status != 'closed'
  `).first();
  
  // æ˜¨æ—¥æ–°å¢
  const yesterdayBottles = await db.prepare(`
    SELECT COUNT(*) as count
    FROM bottles
    WHERE DATE(created_at) = ?
      AND status != 'deleted'
  `).bind(yesterday).first();
  
  const yesterdayUsers = await db.prepare(`
    SELECT COUNT(*) as count
    FROM users
    WHERE DATE(created_at) = ?
      AND deleted_at IS NULL
  `).bind(yesterday).first();
  
  const yesterdayMessages = await db.prepare(`
    SELECT COUNT(*) as count
    FROM conversation_messages
    WHERE DATE(created_at) = ?
  `).bind(yesterday).first();
  
  const yesterdayConversations = await db.prepare(`
    SELECT COUNT(*) as count
    FROM conversations
    WHERE DATE(created_at) = ?
      AND status != 'closed'
  `).bind(yesterday).first();
  
  // æ´»èºä½¿ç”¨è€…ï¼ˆæœ€è¿‘ 7 å¤©ã€30 å¤©ï¼‰
  const activeUsers7d = await db.prepare(`
    SELECT COUNT(DISTINCT user_id) as count
    FROM behavior_logs
    WHERE DATE(created_at) >= ?
  `).bind(sevenDaysAgo).first();
  
  const activeUsers30d = await db.prepare(`
    SELECT COUNT(DISTINCT user_id) as count
    FROM behavior_logs
    WHERE DATE(created_at) >= ?
  `).bind(thirtyDaysAgo).first();
  
  return {
    timestamp: new Date().toISOString(),
    cumulative: {
      total_bottles: (totalBottles as any).count,
      total_users: (totalUsers as any).count,
      total_messages: (totalMessages as any).count,
      total_conversations: (totalConversations as any).count,
    },
    yesterday: {
      bottles: (yesterdayBottles as any).count,
      users: (yesterdayUsers as any).count,
      messages: (yesterdayMessages as any).count,
      conversations: (yesterdayConversations as any).count,
    },
    active: {
      active_users_7d: (activeUsers7d as any).count,
      active_users_30d: (activeUsers30d as any).count,
    },
  };
}
```

### 11.3 å¿«å–ç­–ç•¥

**å¿«å–æ©Ÿåˆ¶**ï¼š
- ä½¿ç”¨ Cloudflare KV æˆ– D1 è¡¨å¿«å–çµ±è¨ˆçµæœ
- å¿«å–æ™‚é–“ï¼š5 åˆ†é˜
- é¿å…é »ç¹æŸ¥è©¢è³‡æ–™åº«ï¼Œé™ä½è² è¼‰

**å¿«å–å¯¦ä½œ**ï¼š
```typescript
// src/api/public-stats.ts

import { getPublicStats } from '../domain/public_stats';

const CACHE_KEY = 'public_stats';
const CACHE_TTL = 5 * 60; // 5 åˆ†é˜

export async function handlePublicStats(
  request: Request,
  env: Env
): Promise<Response> {
  // é€Ÿç‡é™åˆ¶ï¼ˆä½¿ç”¨ Cloudflare Rate Limiting æˆ–è‡ªå®šç¾©é‚è¼¯ï¼‰
  const clientIP = request.headers.get('CF-Connecting-IP') || 'unknown';
  if (!await checkRateLimit(clientIP, env)) {
    return new Response(
      JSON.stringify({ error: 'Rate limit exceeded' }),
      { status: 429, headers: { 'Content-Type': 'application/json' } }
    );
  }
  
  // æª¢æŸ¥å¿«å–
  const cached = await env.STATS_CACHE?.get(CACHE_KEY, { type: 'json' });
  if (cached) {
    return new Response(JSON.stringify(cached), {
      headers: {
        'Content-Type': 'application/json',
        'Cache-Control': 'public, max-age=300', // 5 åˆ†é˜
      },
    });
  }
  
  // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
  const stats = await getPublicStats(env.DB);
  
  // å¯«å…¥å¿«å–
  await env.STATS_CACHE?.put(
    CACHE_KEY,
    JSON.stringify(stats),
    { expirationTtl: CACHE_TTL }
  );
  
  return new Response(JSON.stringify(stats), {
    headers: {
      'Content-Type': 'application/json',
      'Cache-Control': 'public, max-age=300',
    },
  });
}

// é€Ÿç‡é™åˆ¶æª¢æŸ¥ï¼ˆæ¯ IP æ¯åˆ†é˜æœ€å¤š 10 æ¬¡è«‹æ±‚ï¼‰
async function checkRateLimit(
  clientIP: string,
  env: Env
): Promise<boolean> {
  const key = `rate_limit:public_stats:${clientIP}`;
  const count = await env.STATS_CACHE?.get(key, { type: 'json' });
  
  if (count && count >= 10) {
    return false;
  }
  
  await env.STATS_CACHE?.put(
    key,
    JSON.stringify((count || 0) + 1),
    { expirationTtl: 60 } // 1 åˆ†é˜
  );
  
  return true;
}
```

### 11.4 é€Ÿç‡é™åˆ¶

**é™åˆ¶è¦å‰‡**ï¼š
- æ¯ IP æ¯åˆ†é˜æœ€å¤š 10 æ¬¡è«‹æ±‚
- è¶…éé™åˆ¶è¿”å› 429 ç‹€æ…‹ç¢¼
- ä½¿ç”¨ Cloudflare KV è¨˜éŒ„è«‹æ±‚æ¬¡æ•¸

**CORS æ”¯æ´**ï¼ˆå¯é¸ï¼‰ï¼š
- å¦‚æœè¡ŒéŠ·é é¢åœ¨ä¸åŒåŸŸåï¼Œéœ€è¨­å®š CORS Header
- `Access-Control-Allow-Origin: *` æˆ–æŒ‡å®šåŸŸå

### 11.5 è³‡æ–™åº«ç´¢å¼•å„ªåŒ–

ç‚ºæå‡æŸ¥è©¢æ€§èƒ½ï¼Œéœ€ç¢ºä¿ä»¥ä¸‹ç´¢å¼•å­˜åœ¨ï¼š
```sql
-- bottles è¡¨
CREATE INDEX IF NOT EXISTS idx_bottles_created_at ON bottles(created_at);
CREATE INDEX IF NOT EXISTS idx_bottles_status ON bottles(status);

-- users è¡¨
CREATE INDEX IF NOT EXISTS idx_users_created_at ON users(created_at);
CREATE INDEX IF NOT EXISTS idx_users_deleted_at ON users(deleted_at);

-- conversation_messages è¡¨
CREATE INDEX IF NOT EXISTS idx_conversation_messages_created_at ON conversation_messages(created_at);

-- conversations è¡¨
CREATE INDEX IF NOT EXISTS idx_conversations_created_at ON conversations(created_at);
CREATE INDEX IF NOT EXISTS idx_conversations_status ON conversations(status);

-- behavior_logs è¡¨ï¼ˆç”¨æ–¼æ´»èºä½¿ç”¨è€…çµ±è¨ˆï¼‰
CREATE INDEX IF NOT EXISTS idx_behavior_logs_created_at ON behavior_logs(created_at);
CREATE INDEX IF NOT EXISTS idx_behavior_logs_user_id ON behavior_logs(user_id);
```

### 11.6 è·¯ç”±å¯¦ä½œ

**router.ts**ï¼š
```typescript
// src/router.ts

router.get('/api/public-stats', async (request, env) => {
  return handlePublicStats(request, env);
});
```

**KV å‘½åç©ºé–“é…ç½®**ï¼š
- åœ¨ `wrangler.toml` ä¸­æ–°å¢ `STATS_CACHE` KV å‘½åç©ºé–“ï¼ˆæˆ–ä½¿ç”¨ç¾æœ‰çš„ `RISK_CACHE`ï¼‰ï¼š
```toml
[[kv_namespaces]]
binding = "STATS_CACHE"
id = "<KV_NAMESPACE_ID>"
```

**æ›¿ä»£æ–¹æ¡ˆ**ï¼ˆå¦‚æœä¸æƒ³æ–°å¢ KVï¼‰ï¼š
- ä½¿ç”¨ `stats_cache` è¡¨å¿«å–çµ±è¨ˆçµæœï¼ˆè¦‹ 3.14 ç¯€ï¼‰
- æ¯ 5 åˆ†é˜æ›´æ–°ä¸€æ¬¡ï¼ˆé€é Cron ä»»å‹™ `/cron/update_stats_cache`ï¼‰
- API ç›´æ¥æŸ¥è©¢å¿«å–è¡¨ï¼Œç„¡éœ€å³æ™‚è¨ˆç®—

### 11.7 Cron ä»»å‹™æ›´æ–°å¿«å–ï¼ˆå¯é¸ï¼‰

å¦‚æœä½¿ç”¨è³‡æ–™åº«å¿«å–è€Œé KVï¼š

```typescript
// src/telegram/handlers/cron_update_stats_cache.ts

/**
 * æ¯ 5 åˆ†é˜æ›´æ–°å…¬é–‹çµ±è¨ˆå¿«å–
 */
export async function handleUpdateStatsCache(
  env: Env,
  db: D1Database
): Promise<void> {
  const stats = await getPublicStats(db);
  
  // æ›´æ–°å¿«å–è¡¨
  await db.prepare(`
    INSERT INTO stats_cache (cache_key, cache_value, expires_at)
    VALUES ('public_stats', ?, datetime('now', '+5 minutes'))
    ON CONFLICT(cache_key) DO UPDATE SET
      cache_value = excluded.cache_value,
      expires_at = excluded.expires_at,
      updated_at = datetime('now')
  `).bind(JSON.stringify(stats)).run();
}
```

**Cron é…ç½®**ï¼š
```toml
# wrangler.toml
[[triggers.crons]]
schedule = "*/5 * * * *"  # æ¯ 5 åˆ†é˜
```

---

## 12. å»£å‘Šæ’­æ”¾ï¼ˆgigapubï¼‰

### ç’°å¢ƒè®Šæ•¸
- `GIGAPUB_API_KEY`
- `GIGAPUB_PLACEMENT_ID`

### ä½¿ç”¨å ´æ™¯
åƒ…åœ¨ `/throw` ä¸Ÿç“¶å‰é¡¯ç¤ºä¸€æ¬¡ï¼ˆé VIPï¼‰ã€‚

### fetchAd(env)
- å‘¼å« gigapub API å–å¾—æ–‡æ¡ˆæˆ–ç´ æ
- è‹¥ç„¡å»£å‘Šè³‡æ–™ï¼Œé¡¯ç¤ºå…§å»º VIP æ¨å»£æ–‡å­—

---

## 13. ç’°å¢ƒè®Šæ•¸èˆ‡ wrangler è¨­å®š

### wrangler.toml ç¯„ä¾‹

```toml
name = "xunni-bot"
main = "src/worker.ts"
compatibility_date = "2025-01-01"

[[d1_databases]]
binding = "DB"
database_name = "xunni-db"
database_id = "<D1_DATABASE_ID>"

[[kv_namespaces]]
binding = "RISK_CACHE"
id = "<KV_NAMESPACE_ID>"

[vars]
TELEGRAM_BOT_TOKEN = "..."
TELEGRAM_WEBHOOK_SECRET = "..."
OPENAI_API_KEY = "..."
GIGAPUB_API_KEY = "..."
GIGAPUB_PLACEMENT_ID = "..."
HOROSCOPE_SOURCE_URL = "..."    # è‹¥ä½¿ç”¨å¤–éƒ¨ JSON
EXTERNAL_API_KEY = "..."        # çµ¦ Moonpacket ç”¨çš„ API key

BROADCAST_BATCH_SIZE = "25"
BROADCAST_MAX_JOBS = "3"
```

---

## 14. æ¸¬è©¦è¦ç¯„ï¼ˆVitestï¼‰

### å„ªå…ˆé‡å°ä»¥ä¸‹ç´”å‡½æ•¸å¯«å–®å…ƒæ¸¬è©¦

- `getDailyThrowLimit(user, today)`
- `canThrowBottle(user, today, usage)`
- `getConversationDailyLimit(user)`
- `canSendConversationMessage(user, convoId, today)`
- `addRisk(userId, reason)` / `applyBan` / `isBanned`
- `matchBottleForUser(options)`
- `checkEligibility(telegramId)`

### Handler æ¸¬è©¦

- æ¨¡æ“¬ Telegram Update JSON å‘¼å« handler
- Mock `sendTelegramMessage`ã€`db.client`

---

## 15. å»ºè­°çš„ Cursor é–‹ç™¼é †åº

### éšæ®µ 1: åŸºç¤æ¶æ§‹
1. **å»ºç«‹ schema**: æ ¹æ“šæœ¬è¦æ ¼æ›¸çš„ SQLï¼Œç”Ÿæˆ `db/schema.sql`
2. **å¯¦ä½œ db/client.ts**: å°æ¯å€‹è¡¨æä¾›åŸºæœ¬ CRUD / æŸ¥è©¢å‡½å¼

### éšæ®µ 2: Domain é‚è¼¯
3. **å¯¦ä½œ domain**:
   - `usage.ts`
   - `risk.ts`
   - `matching.ts`
   - `horoscope.ts`
   - `eligibility.ts`
4. **æ’°å¯« tests/domain/*.test.ts**

### éšæ®µ 3: Telegram Handlers
5. **å¯¦ä½œ Telegram handlers**:
   - `/start` â†’ `/profile` â†’ `/throw` â†’ `/catch` â†’ message forwarding â†’ `/report` â†’ `/appeal` â†’ `/vip` â†’ `/broadcast`

### éšæ®µ 4: è·¯ç”±èˆ‡éƒ¨ç½²
6. **å¯¦ä½œ router.ts + worker.ts**:
   - è™•ç† Telegram webhook
   - `/api/eligibility`
   - `/api/public-stats`ï¼ˆå…¬é–‹çµ±è¨ˆ APIï¼‰
   - `/cron/horoscope`
   - `/cron/broadcast`
7. **é…ç½® wranglerã€åˆå§‹åŒ– D1ã€éƒ¨ç½²ï¼Œæ¸¬è©¦èˆ‡ Moonpacket ä¸²æ¥**

---

## é™„éŒ„ï¼šè¡“èªè¡¨ / Glossary

### æ ¸å¿ƒè©å½™å®šç¾©

åœ¨æœ¬æ–‡æª”å’Œæ•´å€‹å°ˆæ¡ˆä¸­ï¼Œä»¥ä¸‹è¡“èªå…·æœ‰ç‰¹å®šå«ç¾©ï¼Œè«‹åš´æ ¼éµå®ˆï¼š

- **Userï¼ˆä½¿ç”¨è€…ï¼‰**ï¼šè¨»å†Šä¸¦ä½¿ç”¨æœ¬ Bot çš„ Telegram ä½¿ç”¨è€…ã€‚æ¯å€‹ User æœ‰å”¯ä¸€çš„ `telegram_id`ã€‚ä¸æ˜¯ "member"ã€"player" æˆ–å…¶ä»–è¡“èªã€‚
- **Bottleï¼ˆæ¼‚æµç“¶ï¼‰**ï¼šä½¿ç”¨è€…ä¸Ÿå‡ºçš„åŒ¿åè¨Šæ¯ã€‚åŒ…å«å…§å®¹ã€åŒ¹é…æ¢ä»¶ï¼ˆMBTIã€å¹´é½¡ã€æ€§åˆ¥ç­‰ï¼‰å’Œç‹€æ…‹ï¼ˆpending/matched/expired/deletedï¼‰ã€‚
- **Conversationï¼ˆå°è©±ï¼‰**ï¼šå…©å€‹ User é€šéåŒ¹é…æ¼‚æµç“¶å»ºç«‹çš„åŒ¿åèŠå¤©å°è©±ã€‚æ¯å€‹å°è©±æœ‰å”¯ä¸€çš„ `conversation_id`ï¼Œæœ€å¤šä¿å­˜ 3650 ç­†è¨Šæ¯ã€‚
- **Matchï¼ˆåŒ¹é…ï¼‰**ï¼šå°‡æ¼‚æµç“¶åˆ†é…çµ¦ç¬¦åˆæ¢ä»¶çš„ User çš„éç¨‹ã€‚åŒ¹é…é‚è¼¯éœ€æ’é™¤å·²å°é–ã€è¢«èˆ‰å ±çš„ä½¿ç”¨è€…ã€‚
- **MBTI Resultï¼ˆMBTI çµæœï¼‰**ï¼šä½¿ç”¨è€…å®Œæˆ MBTI æ¸¬é©—å¾Œçš„æ€§æ ¼é¡å‹çµæœï¼ˆå¦‚ INTJã€ENFP ç­‰ï¼‰ã€‚
- **Inviteï¼ˆé‚€è«‹ï¼‰**ï¼šä½¿ç”¨è€…é€éé‚€è«‹ç¢¼é‚€è«‹æ–°ä½¿ç”¨è€…è¨»å†Šã€‚æˆåŠŸé‚€è«‹å¯å¢åŠ æ¯æ—¥æ¼‚æµç“¶ä¸Šé™ã€‚
- **VIPï¼ˆä»˜è²»ä½¿ç”¨è€…ï¼‰**ï¼šé€é Telegram Stars ä»˜è²»è¨‚é–±çš„ä½¿ç”¨è€…ã€‚äº«æœ‰æ›´å¤šæ¼‚æµç“¶æ•¸é‡ã€ç¿»è­¯æœå‹™ã€ç„¡å»£å‘Šç­‰æ¬Šç›Šã€‚
- **Trust Levelï¼ˆä¿¡ä»»ç­‰ç´šï¼‰**ï¼šåŸºæ–¼åè©é¨™æ¸¬é©—å’Œé¢¨éšªåˆ†æ•¸çš„ä½¿ç”¨è€…ä¿¡ä»»åº¦è©•ç´šã€‚å½±éŸ¿åŒ¹é…å„ªå…ˆé †åºã€‚
- **Risk Scoreï¼ˆé¢¨éšªåˆ†æ•¸ï¼‰**ï¼šåŸºæ–¼ä½¿ç”¨è€…è¡Œç‚ºï¼ˆèˆ‰å ±ã€é•è¦ç­‰ï¼‰è¨ˆç®—çš„é¢¨éšªè©•åˆ†ã€‚éé«˜æœƒå°è‡´è‡ªå‹•å°ç¦ã€‚
- **Banï¼ˆå°ç¦ï¼‰**ï¼šå› é•è¦è¡Œç‚ºæˆ–é«˜é¢¨éšªåˆ†æ•¸å°è‡´ä½¿ç”¨è€…æš«æ™‚æˆ–æ°¸ä¹…ç„¡æ³•ä½¿ç”¨æœå‹™ã€‚
- **Blockï¼ˆå°é–ï¼‰**ï¼šä½¿ç”¨è€…ä¸»å‹•å°é–å¦ä¸€å€‹ä½¿ç”¨è€…ï¼Œä¸æƒ³å†èˆ‡å…¶èŠå¤©ã€‚ä¸å±¬æ–¼èˆ‰å ±æ©Ÿåˆ¶ã€‚
- **Reportï¼ˆèˆ‰å ±ï¼‰**ï¼šä½¿ç”¨è€…èˆ‰å ±å…¶ä»–ä½¿ç”¨è€…çš„é•è¦è¡Œç‚ºã€‚å¤šæ¬¡èˆ‰å ±æœƒè§¸ç™¼è‡ªå‹•å°ç¦æµç¨‹ã€‚
- **Appealï¼ˆç”³è¨´ï¼‰**ï¼šè¢«å°ç¦çš„ä½¿ç”¨è€…ç”³è«‹è§£é™¤å°ç¦çš„æµç¨‹ã€‚

**ä½¿ç”¨è¦ç¯„**ï¼š
- åœ¨ä»£ç¢¼ã€è¨»é‡‹å’Œæ–‡æª”ä¸­ï¼Œçµ±ä¸€ä½¿ç”¨ä¸Šè¿°è¡“èª
- ä¸è¦æ··ç”¨ "user"/"member"/"player"
- ä¸è¦ä½¿ç”¨ "message" ä»£æ›¿ "Bottle" æˆ– "Conversation Message"
- åƒè€ƒæœ¬æ–‡æª”çš„è¡“èªå®šç¾©ï¼Œä¿æŒä¸€è‡´

---

## é™„éŒ„ï¼šé‡è¦æé†’

### å®‰å…¨è¦ç¯„
- æ‰€æœ‰ URL å¿…é ˆé€šéç™½åå–®æª¢æŸ¥
- åŒ¿åè½‰ç™¼ä¸æš´éœ²çœŸå¯¦ Telegram ID
- é¢¨éšªåˆ†æ•¸ç´¯ç©æ©Ÿåˆ¶éœ€åš´æ ¼åŸ·è¡Œ

### æ€§èƒ½è€ƒé‡
- å»£æ’­ä»»å‹™éœ€ä½¿ç”¨éšŠåˆ— + é™é€Ÿ
- æ¯æ—¥ä½¿ç”¨æ¬¡æ•¸æŸ¥è©¢éœ€è€ƒæ…®å¿«å–
- åŒ¹é…ç®—æ³•éœ€å„ªåŒ–æŸ¥è©¢æ•ˆç‡

### æˆæœ¬æ§åˆ¶
- åˆç†ä½¿ç”¨ KV å¿«å–ï¼Œé¿å…éåº¦è®€å¯«
- D1 æŸ¥è©¢éœ€å„ªåŒ–ç´¢å¼•
- ç¿»è­¯ API èª¿ç”¨éœ€æ§åˆ¶é »ç‡

### é—œéµè¦å‰‡ï¼ˆå¿…é ˆéµå®ˆï¼‰

#### è¨Šæ¯æ ¼å¼
- **æ‰€æœ‰ Telegram è¨Šæ¯ä½¿ç”¨ç´”æ–‡å­— + å®˜æ–¹ Emoji**
- **ä¸ä½¿ç”¨ HTML æˆ– Markdown æ ¼å¼**

#### ä¸å¯ä¿®æ”¹çš„æ¬„ä½
- **æ€§åˆ¥ï¼ˆgenderï¼‰**: è¨­å®šå¾Œæ°¸é ä¸èƒ½ä¿®æ”¹ï¼ˆéœ€äºŒæ¬¡ç¢ºèªï¼‰
- **ç”Ÿæ—¥ï¼ˆbirthdayï¼‰**: è¨­å®šå¾Œæ°¸é ä¸èƒ½ä¿®æ”¹ï¼ˆéœ€äºŒæ¬¡ç¢ºèªï¼‰
- **å¯¦ä½œä½ç½®**: `@src/telegram/handlers/profile.ts` å’Œ `@src/telegram/handlers/start.ts`

#### å¹´é½¡é™åˆ¶
- æœªæ»¿ 18 æ­²ä¸å…è¨±è¨»å†Š
- å¿…é ˆè¼¸å…¥çœŸå¯¦ç”Ÿæ—¥é©—è­‰
- **å¯¦ä½œä½ç½®**: `@src/domain/user.ts` å’Œ `@src/telegram/handlers/start.ts`

### å—ä¿è­·çš„æ–‡ä»¶/ç›®éŒ„

**âš ï¸ ä¿®æ”¹å‰å¿…é ˆè¬¹æ…ï¼Œå»ºè­°å…ˆèˆ‡ç¶­è­·è€…ç¢ºèªï¼š**

- `@wrangler.toml` - Cloudflare é…ç½®ï¼ˆéƒ¨ç½²ç›¸é—œï¼‰
- `@src/db/schema.sql` - è³‡æ–™åº« Schemaï¼ˆå¿…é ˆé€šéé·ç§»è…³æœ¬ï¼‰
- `@src/db/migrations/` - é·ç§»è…³æœ¬ç›®éŒ„ï¼ˆè®Šæ›´éœ€å¯©æ ¸ï¼‰
- `@scripts/backup-*.ts` - å‚™ä»½è…³æœ¬ï¼ˆå‚™ä»½ç­–ç•¥ç›¸é—œï¼‰
- `@doc/SPEC.md` - æ ¸å¿ƒè¦æ ¼æ›¸ï¼ˆé‡å¤§è®Šæ›´éœ€å¯©æ ¸ï¼‰

**ğŸ”’ çµ•å°ç¦æ­¢ä¿®æ”¹ï¼š**

- `.dev.vars` - åŒ…å«æ•æ„Ÿè³‡è¨Šï¼ˆåœ¨ `.gitignore` ä¸­ï¼‰
- `node_modules/` - ä¾è³´åŒ…
- `package-lock.json` / `pnpm-lock.yaml` - é–å®šæ–‡ä»¶ï¼ˆé™¤éæ˜ç¢ºè¦æ±‚æ›´æ–°ä¾è³´ï¼‰

### é‡è¦æ–‡æª”ä½ç½®

åœ¨ç·¨è¼¯ä»»ä½•ä»£ç¢¼å‰ï¼Œå¿…é ˆå…ˆé–±è®€ï¼š

1. **å°ˆæ¡ˆè¦æ ¼æ›¸**: `@doc/SPEC.md` - æœ¬æ–‡æª”ï¼ˆå®Œæ•´çš„æ¥­å‹™é‚è¼¯å’Œè³‡æ–™åº«è¨­è¨ˆï¼‰
2. **é–‹ç™¼è¦ç¯„**: `@doc/DEVELOPMENT_STANDARDS.md` - ä»£ç¢¼é¢¨æ ¼å’Œå‘½åè¦ç¯„
3. **æ¨¡çµ„è¨­è¨ˆ**: `@doc/MODULE_DESIGN.md` - æ¶æ§‹åŸå‰‡å’Œåˆ†å±¤è¨­è¨ˆ
4. **ç’°å¢ƒé…ç½®**: `@doc/ENV_CONFIG.md` - ç’°å¢ƒè®Šæ•¸é…ç½®å’Œé–‹ç™¼ç’°å¢ƒè¨­ç½®ï¼ˆåŒ…å«**é–‹ç™¼å‰æª¢æŸ¥æ¸…å–®**ï¼‰

å®Œæ•´æ–‡æª”ç´¢å¼•è¦‹ï¼š`@doc/README.md`

### å‘½ä»¤é€ŸæŸ¥

```bash
# æœ¬åœ°é–‹ç™¼
pnpm dev

# åŸ·è¡Œæ¸¬è©¦
pnpm test

# åŸ·è¡Œ Lint
pnpm lint

# æœ¬åœ°å‚™ä»½
pnpm backup

# æ¨é€åˆ° GitHub
pnpm backup:push

# éƒ¨ç½²åˆ° Staging
pnpm deploy:staging

# éƒ¨ç½²åˆ° Production
pnpm deploy:production
```

### æ•…éšœæ’é™¤

#### å•é¡Œï¼šä¸çŸ¥é“å¾å“ªè£¡é–‹å§‹
**è§£æ±ºæ–¹æ¡ˆ**: å…ˆé–±è®€ `@doc/SPEC.md` ç¬¬ 15 ç¯€ã€Œå»ºè­°çš„ Cursor é–‹ç™¼é †åºã€

#### å•é¡Œï¼šä¸ç¢ºå®šå‘½åè¦ç¯„
**è§£æ±ºæ–¹æ¡ˆ**: æŸ¥çœ‹ `@doc/DEVELOPMENT_STANDARDS.md` ç¬¬ 2.2 ç¯€

#### å•é¡Œï¼šä¸ç¢ºå®šè¡“èªä½¿ç”¨
**è§£æ±ºæ–¹æ¡ˆ**: æŸ¥çœ‹æœ¬æ–‡æª”é™„éŒ„ã€Œè¡“èªè¡¨ / Glossaryã€ï¼Œåš´æ ¼éµå®ˆè¡“èªå®šç¾©

#### å•é¡Œï¼šä¸çŸ¥é“å¦‚ä½•æ¸¬è©¦
**è§£æ±ºæ–¹æ¡ˆ**: åƒè€ƒ `@doc/TESTING.md` å’Œç¾æœ‰æ¸¬è©¦æ–‡ä»¶ `@tests/domain/`

#### å•é¡Œï¼šä¸ç¢ºå®šæ¶æ§‹è¨­è¨ˆ
**è§£æ±ºæ–¹æ¡ˆ**: é–±è®€ `@doc/MODULE_DESIGN.md` äº†è§£åˆ†å±¤è¨­è¨ˆåŸå‰‡

---

**æœ€å¾Œæ›´æ–°**: 2025-01-15  
**ç¶­è­·è€…**: å°ˆæ¡ˆåœ˜éšŠ

