# XunNi 系統通知與自動化任務總覽

> **最後更新**：2025-11-27
> **版本**：v2.0 (整合 AI 智能分析與精緻化策略)
> **核心原則**：精簡打擾、智能分析、集中管理。

本文檔匯總了系統中所有**自動化定時執行**的任務，以及**由事件觸發**的用戶通知。

---

## 1. 一般用戶 (General Users) —— 重在「即時反饋」與「情感連結」

針對一般用戶，我們採取**「極簡打擾」**策略。只在關鍵時刻或情感需求時出現，避免無意義的機械式提醒。

| 推送類型 | 觸發機制 | 頻率/時間 | 內容策略 | AI 加值 (Gemini Flash) | 狀態 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **生日祝福** | Cron | 每天 01:00, 10:30, 18:30 (錯峰) | **內容**：發送生日祝福。<br>**目的**：提升歸屬感。 | - | ✅ 已實作 |
| **VIP 到期提醒** | Cron | 每天 10:00 UTC | **內容**：提醒 VIP 即將過期或已降級。<br>**目的**：挽留付費用戶。 | - | ✅ 已實作 |
| **匹配成功** | 事件 | 即時 | **內容**：通知瓶子被撿到，建立對話連結。<br>**目的**：核心社交閉環。 | - | ✅ 已實作 |
| **(規劃) 活躍度週報** | Cron | 每週一 09:00 | **內容**：上週數據回顧（認識幾人、漂流多遠）。<br>**目的**：增強成就感。 | **生成個性化評語**：<br>例如：「你是本週的社交達人！」 | ⏳ P2 |
| **(規劃) 關係回溫** | 事件 | 互動冷卻時 | **內容**：針對曾熱絡但冷掉的對話提醒。<br>**目的**：溫和召回。 | **情感分析**：<br>判斷是否適合打擾，避免尷尬。 | ⏳ P3 |

> **❌ 已刪除計畫**：每日丟瓶/撿瓶提醒（過於打擾，予以取消）。

---

## 2. 管理員 (Admins) —— 重在「行動指令」

所有管理員通知統一發送至 **Admin Log Group** (`-4917557179`)，確保團隊資訊同步。

| 推送類型 | 觸發機制 | 頻率 | 內容與目的 | AI 加值 (Gemini Flash) | 狀態 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **AI 審核巡邏** | Cron | 每小時 | **內容**：掃描待審核申訴/舉報，匯總報告。<br>**目的**：定期清理積壓工作。 | **預判分類**：<br>自動標記「高風險」或「建議駁回」。 | ✅ 已實作 |
| **維護模式監控** | Cron | 每 5 分鐘 | **內容**：檢查維護模式是否到期自動關閉。<br>**目的**：系統狀態同步。 | - | ✅ 已實作 |
| **(規劃) 異常流量告警** | 事件 | 實時 | **內容**：大量舉報、短時間大量註冊等異常。<br>**目的**：即時救火。 | **攻擊識別**：<br>判斷是否為惡意腳本攻擊。 | ⏳ P1 |

---

## 3. 超級管理員 (Super Admins) —— 重在「決策輔助」

針對決策者的日報，不再發送枯燥的數據表格，而是由 AI 消化後的**「經營分析摘要」**。

| 推送類型 | 觸發機制 | 頻率 | 內容策略 | AI 加值 (Gemini Flash) | 狀態 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **(升級) 智能日報** | Cron | 每天 09:00 UTC | **內容**：核心指標（營收/日活）+ **AI 分析摘要**。<br>**目的**：快速掌握營運健康度。 | **AI 經營分析師**：<br>1. **讀數據**：對比昨日與上週數據。<br>2. **找異常**：「廣告收入跌 20%，因 FB 流量減少。」<br>3. **給建議**：「建議檢查投放渠道。」 | ⏳ P1 (優化中) |
| **(規劃) 渠道 ROI 週報** | Cron | 每週一 | **內容**：對比各來源（廣告/MoonPacket）質量。<br>**目的**：優化預算分配。 | **成效評估**：<br>計算各渠道留存率與付費率，建議預算增減。 | ⏳ P2 |

---

## 4. 社交分享與外部觸及 (Social & Viral)

用戶主動觸發的傳播機制。

| 功能名稱 | 觸發時機 | 行為描述 | 狀態 |
| :--- | :--- | :--- | :--- |
| **邀請好友** | 用戶點擊 | 生成帶有 `startapp=ref_xxx` 的連結。 | ✅ 已實作 |
| **(規劃) MBTI 分享** | 測驗完成 | **新增分享按鈕**，帶有 Deep Link。<br>**目的**：核心裂變機制。 | ⏳ P1 |

---

## 5. 開發與實作規範 (Implementation Guide)

### 5.1 下一步行動 (Action Items)

1.  **智能日報升級 (P1)**：
    *   修改 `src/services/daily_reports.ts`。
    *   接入 **Gemini 1.5 Flash** (Google AI Studio)。
    *   實作 Prompt：傳入 JSON 數據，要求輸出 100 字以內的繁體中文分析摘要。
    *   **不使用圖表**，純文字呈現。
2.  **MBTI 分享按鈕 (P1)**：
    *   修改 MBTI 結果頁 handler，加入 Inline Button。
    *   處理 `startapp=share_mbti` 參數。
3.  **異常流量告警 (P1)**：
    *   在 `report` handler 中加入閾值監控（如：1分鐘內同一對象被舉報 > 5次）。

### 5.2 i18n 規範 (重要)

*   **用戶推送**：
    *   **必須** 支援多語言。
    *   根據 `users.language_pref` 選擇語言。
    *   新 Key 必須加入 `i18n_features.csv` (虛擬/暫定名稱) 並通過 `i18n-manager` 處理。
*   **管理員通知**：
    *   統一使用 **zh-TW (繁體中文)**。
    *   發送至群組 `-4917557179`。

### 5.3 AI 模型配置

*   **Model**: `gemini-1.5-flash` (或最新 Flash 版本)。
*   **Temperature**: `0.3` (保持分析客觀穩定)。
*   **Max Tokens**: `500` (不需要長篇大論)。

---

### 文檔維護
- **新增任務時**：請務必更新此表。
- **Cron 修改**：同步更新 `wrangler.toml`。
