# 🔮 AI 算命功能設計 (AI Fortune Telling)

> **⚠️ 開發規範與引用**
> 本設計必須嚴格遵守以下文檔規範：
> *   `@doc/UI_GUIDELINE.md`: UI 交互體驗、按鈕佈局、返回邏輯。
> *   `@doc/DEVELOPMENT_STANDARDS.md`: 代碼風格、錯誤處理、i18n 規範。
> *   `@doc/ECONOMICS_AND_PRICING.md`: 算命瓶消耗與經濟模型。

## 1. 核心邏輯與架構

本系統採用 **「邏輯層 (Logic)」 + 「文學層 (Literature)」** 的雙層架構，確保算命的準確性與多語言適配性。

### 1.1 差異化優勢：多維度數據融合 (Why us?)
一般的 GPT 算命只看星座。我們的優勢在於整合了用戶的 **全方位數據**：
*   **西方占星**: 太陽/月亮/上升星座 (需出生時間)。
*   **東方八字**: 天干地支、五行缺補。
*   **心理測評**: MBTI 人格類型 (已在 `users` 表中)。
*   **生理特徵**: 血型 (需收集)、性別。

**結論**：我們餵給 AI 的 Prompt 包含了「MBTI + 星盤 + 八字 + 血型」的交叉分析，這是用戶自己去問 ChatGPT 很難做到的（因為他們通常不會同時提供這麼多維度的數據，也不懂如何整合）。

### 1.3 數據源與運算 (Data Source & Calculation)

**Q: 是否需要維護龐大的命理資料庫（流年、星曆表）？**
**A: 不需要。**

我們採用 **"On-Demand Calculation" (即時運算)** 模式：

1.  **星曆數據 (Ephemeris)**:
    *   使用 `astronomy-engine` 與 `lunar-javascript`。
    *   **優勢**：輕量級、無需維護資料庫，適合 Worker 環境。

2.  **紫微/八字排盤**:
    *   使用 `lunar-javascript` 等成熟開源庫 (支援 100% 精準的紫微斗數與八字排盤)。

3.  **知識庫 (Knowledge Base)**:
    *   依賴 **LLM (Gemini 1.5 Pro / 3.0)** 的內建知識進行解讀。
    *   **多語言支援**: AI 負責將命理術語轉譯為用戶設定的語言 (34種語言)。

**結論**：我們只存「用戶的出生數據」和「算命歷史結果」。

---

## 2. 用戶體驗 (UX) 與入口設計

為避免主菜單擁擠，我們採用 **「單一入口，分層引導」** 策略。

### 2.1 菜單結構
*   **主菜單 (Level 1)**: 只有一個按鈕 `🔮 AI 算命`。
    *   **進入條件 (Mandatory)**: 用戶必須已有 **MBTI** 數據。若無，點擊後強制進入 MBTI 補全流程，並提示「需 MBTI 才能提供準確算命」。
    *   > **運營策略註記**: 雖然標準設計在 Level 2 置頂，但在「情人節」等特定活動期間，可暫時將 `🧬 屬性診斷` 提升至 Level 1 主選單，以達成『暴力推廣』效果。

*   **二級菜單 (算命大廳 Level 2)**:
    *   **🔥 置頂推薦 (Featured - 暴力推廣位)**:
        1.  `🧬 屬性診斷 (邀請好友)` - **全寬按鈕，核心裂變入口**。
    *   **基礎服務 (Basic)**:
        2.  `📅 今日運勢` (1 瓶)
        3.  `🗓️ 本週運勢` (1 瓶/週)
        4.  `🌟 名人同盤` (1 瓶/次)
    *   **進階服務 (Advanced - 深度詳解)**:
        5.  `🔮 紫微斗數` (1 瓶)
        6.  `🌠 西洋占星` (1 瓶)
        7.  `🃏 塔羅占卜` (1 瓶)
        8.  `📜 八字推命` (1 瓶)
    *   **管理與紀錄**:
        9.  `⚙️ 管理檔案` (顯示我的 ID / 配對開關)
        10. `📜 我的報告`

### 2.3 訊息策略 (Message Strategy) & 交互優化

**Telegram UX 原則**: 穩定、清晰、不遺失。

1.  **安全發送機制 (Robust Sending)**:
    *   **純文字優先 (Plain Text First)**: **⚠️ 響應用戶要求，放棄 Markdown**。所有訊息將採用 **「純文字 + 官方 Emoji」** 進行排版。
        *   不使用 `*bold*` 或 `_italic_`，避免 `Can't parse entities` 錯誤。
        *   使用 Emoji (如 📌, 💡, 🔮) 來區分段落與標題，確保 100% 的發送成功率與跨平台一致性。
    *   **自動分段**: 長文超過 4000 字自動切分，避免 Telegram API 限制。
    *   **按鈕附著**: 功能按鈕直接附著在訊息下方，不另外發送 Stickers 干擾視線。

2.  **Inline 交互 (Clean UI)**:
    *   **Wizard 流程**: 盡量使用 `editMessageText` 更新當前訊息，而不是發送新訊息。
    *   **防迷失**: 每個步驟必須帶有 `[🔙 上一步]` 和 `[❌ 取消]` 按鈕。

3.  **結構化輸出 (詳細報告)**:
    *   **Header**: Emoji 標題 + 摘要。
    *   **Body**: 詳細內容 (分段發送，如果太長)。
    *   **Footer**: 導航按鈕。

### 2.4 歷史記錄與數據完整性驗證 (Data Integrity & Re-generation)

**核心機制**: 確保報告準確性，避免「舊報告配新數據」的錯誤。

1.  **快照比對 (Snapshot Comparison)**:
    *   生成報告時，將當下的 `profile_data` (生日、時間、MBTI、血型) **完整序列化 (JSON)** 並存儲在 `fortune_history` 的 `profile_snapshot` 欄位中。
    *   當用戶點擊「查看歷史報告」時，系統會**自動比對**：
        *   `Current Profile` vs `Historical Snapshot`
    *   **若數據一致**: 直接顯示緩存報告 (免費)。
    *   **若數據不符** (用戶修改過檔案): 
        *   提示: `⚠️ 檢測到您的命盤資料 (生日/MBTI/血型) 已變更，舊報告已失效。`
        *   按鈕: `[🔄 重新生成報告 (消耗 1 瓶)]`

2.  **資料保存策略**:
    *   **每日運勢**: 保留 30 天。
    *   **進階報告 (紫微/八字/占星/愛情/名人等)**: **保留 3 年 (3 Years)**。
        *   **數據保存聲明**: 本平台所有報告（含付費項目）最長保留期限為 **3年**。
    *   **過期處理**: 超過 3 年的歷史記錄將被系統自動清理。

## 8. 我的報告與歷史記錄 (My Reports & History)

為確保用戶能方便查閱高價值報告（有效期 3 年），我們採用「分類分頁」的瀏覽模式。

*   **入口**: `🔮 AI 算命` -> `📜 我的報告`
*   **列表介面設計**:
    *   **Tab 分類 (因 Telegram 限制，使用頂部切換按鈕)**:
        *   `[📂 全部]` `[🧬 合盤]` `[🔮 命理]` `[🗓️ 運勢]`
    *   **列表項目 (Format)**:
        *   每頁顯示 5-8 筆記錄。
        *   格式：`[Icon] 標題 - 日期`
        *   範例：
            *   `🧬 與 UserB 的雙人合盤 - 2025/11/30`
            *   `🔮 紫微斗數詳批 - 2025/11/28`
            *   `🗓️ 本週運勢 (11/24-11/30)`
    *   **操作**: 點擊項目後進入「報告詳情視圖」。
    *   **分頁控制**: `[⬅️ 上一頁] [第 1/5 頁] [下一頁 ➡️]`

*   **報告詳情視圖 (Detail View)**:
    *   顯示完整報告內容。
    *   **頂部狀態欄**:
        *   顯示 `📅 生成日期: YYYY-MM-DD`
        *   顯示 `⏳ 有效期至: YYYY-MM-DD` (針對合盤與付費報告)
        *   若資料過期或已變更: 顯示 `⚠️ 資料已更新，報告可能失準` + `[🔄 重新生成 (1瓶)]` 按鈕。
    *   **底部按鈕**: `[🔙 返回列表]` `[🗑️ 刪除記錄]`

---

## 3. 算命瓶 (Fortune Bottle) 經濟模型

### 3.1 獲取機制
*   **每週免費配額 (Weekly Reset)**:
    *   一般用戶: 每週 **1 瓶** (不可累積)。
    *   **VIP 用戶**: 每天 **1 瓶** (不可累積，每日 00:00 重置)。
*   **額外獲取 (可累積)**:
    *   **活躍獎勵**: 每丟出 10 個漂流瓶 -> **+1 瓶**。
    *   **裂變獎勵**: 邀請的朋友(B)再邀請朋友(C)時 -> **A 獲得 +1 瓶**。
    *   **付費充值**:
        *   小包: 100 Stars / 10 瓶。
        *   大包: 385 Stars / 50 瓶 **(優惠 Special Offer)**。

### 3.2 產品策略轉型 (Product Pivot)
為了建立長期的用戶信任與留存，我們放棄了複雜的「模塊化收費」，改為 **「週期性訂閱制」** 體驗。

*   **今日運勢 (Daily)**: 1 瓶/次 (**VIP 會員 0 瓶/次**，不消耗每日配額)。
*   **本週運勢 (Weekly)**: 1 瓶/週 (鎖定週一，週間回看免費)。
*   **名人同盤**: 1 瓶/次 (每次查找新對象)。
*   **進階命理服務 (Advanced)**: 1 瓶/次 (一次性生成，保存3年，資料變更需重算)。

---

## 6. 進階命理服務擴充 (Advanced Fortune Services)

**設計目標**: 提供極高信息量、專業度高的命理報告，充分利用 AI 的多語言能力 (34 Languages)。
**適用對象**: 所有用戶 (一般會員 & VIP) 皆可使用。每次消耗 **1 算命瓶**。

### 6.1 紫微斗數 (Zi Wei Dou Shu)
*   **輸入**: 出生年/月/日/時 (必須精確)。
*   **運算核心**: **依賴 `lunar-javascript` 庫** 進行精確排盤（AI 不負責排盤，只負責解讀，避免幻覺）。
*   **AI 任務**: 解讀命盤格局 (如「殺破狼」、「機月同梁」) 及各宮位含義。
*   **重點**: 必須精確解釋 14 主星在用戶命盤中的具體影響，而非通用解釋。

### 6.2 西洋占星 (Astrology - Natal Chart)
*   **輸入**: 出生時間 + 出生城市 (經緯度)。
*   **運算核心**: **依賴 `astronomy-engine` 庫** 計算 10 大行星落入的星座 (Signs) 與宮位 (Houses)，以及相位 (Aspects)。
*   **AI 任務**: 進行「全盤解讀」，包含上升星座 (人格面具)、月亮星座 (內在情感)、相位衝突與調和。

### 6.3 塔羅占卜 (Tarot Reading)
*   **機制**: 
    1.  用戶心中默念問題 (或選擇「一般運勢」)。
    2.  點擊抽牌 (系統隨機數生成)。
    3.  牌陣: **聖三角 (3張)** 或 **凱爾特十字 (10張)** (視複雜度而定，建議先做 3 張)。
*   **AI 任務**: 結合牌面含義 (正/逆位) 與用戶背景進行直覺式解讀。
*   **UI 呈現**: 由於 Bot 限制，使用 **Emoji + 文字** 呈現牌面 (如 `🃏 愚者 (正位)` )，不依賴圖片以確保加載速度與穩定性。

### 6.4 八字推命 (BaZi / Four Pillars)
*   **輸入**: 出生年/月/日/時。
*   **運算核心**: **依賴 `lunar-javascript` 庫** 計算四柱干支與十神（確保農曆轉換精確）。
*   **AI 任務**: 分析「日主強弱」、「喜用神」、「五行缺失」，並提供改運建議 (顏色、方位)。

### 6.5 屬性診斷 (Attribute Diagnosis) - 隱私優先與裂變機制 (Privacy First & Viral)

**核心理念**: 確保雙方知情同意 (Consent)，避免騷擾，同時利用配對請求作為裂變傳播。這不僅限於愛情，適用於**朋友、同事、家人**之間的默契與性格共鳴分析。

#### A. 模式選擇 (Mode Selection)
用戶點擊 `🧬 屬性診斷` 後，彈出選擇菜單：
1.  `[🧚‍♀️ 隱藏屬性 (個人潛能)]` -> 進入 **單人模式** (分析自我潛在特質、適合的夥伴類型、隱藏天賦)。
2.  `[🧩 雙人合盤 (默契分析)]` -> 進入 **雙人合盤模式**。

#### B. 雙人合盤流程 (Mode 2: Attribute Match Flow)

**Step 1: 選擇關係類型 (Select Relationship Type)**
在輸入對方 ID 前，先選擇要分析的關係類型（這會影響 AI 的分析維度與語氣）。

**1. 💘 愛情 (Love)**
*   分析重點：戀愛契合度、長期相處模式、激情與承諾。
*   特別關注：年齡差距（姐弟戀/兄妹戀）對關係的影響。

**2. 👪 親情 (Family) - 深度細分**
親情關係是不可選擇的緣分，重點在於**「如何相處」**與**「互相理解」**，而非「適不適合」。
*   **系統檢測用戶性別後，顯示細分選項**：
    *   **男性用戶顯示**：`妻子`、`子女`、`父母`、`孫輩`、`祖父母`
    *   **女性用戶顯示**：`丈夫`、`子女`、`父母`、`孫輩`、`祖父母`
*   **分析重點**：
    *   接納家人的性格特質（如：父親的威嚴 vs 女兒的叛逆）。
    *   提供具體的溝通建議（如：如何與固執的長輩溝通）。
    *   **長幼輩分**：AI 必須識別並尊重長幼倫理。

**3. 🤝 友情 (Friendship)**
*   分析重點：興趣共鳴、性格互補、義氣與支持。

**4. 💼 工作 (Work)**
*   分析重點：職場協作效率、決策風格衝突、上下級或平級的相處之道。

**Step 2: 輸入與系統檢查 (Pre-check)**
   1.  **額度檢查 (Quota Check)**:
       *   系統先檢查**請求方 (User A)** 是否擁有至少 **1 個算命瓶**。
       *   **若不足**: 彈出「獲取算命瓶」引導，禁止操作。
   2.  **目標用戶檢查**:
       *   **若對方未安裝/不存在**: 
           *   提示: 「⚠️ 找不到該用戶 (尚未啟用 XunNi)。」
           *   按鈕: `[📨 邀請對方體驗]` (點擊發送邀請連結)。
       *   **若對方存在**: 進入隱私確認步驟。
   
   **Step 3: 隱私聲明與確認 (Privacy Disclaimer & Confirmation)**
   *   **核心機制**: 為簡化流程並提升體驗，系統**不再向對方發送請求訊息**，而是基於發起人的誠信聲明與平台的隱私保護機制進行單向配對。
   *   **提示訊息**:
       > 「⚠️ **隱私與授權聲明**
       >
       > 我們假設您已取得對方的同意進行此配對分析。
       >
       > 🔒 **隱私保護**:
       > 1. 我們 **不會** 向您揭露對方的出生日期、時間、地點等隱私個資。
       > 2. 我們 **不會** 通知對方您進行了此項分析。
       > 3. 您只會看到 AI 生成的『屬性相容性報告』。
       >
       > 確認要消耗 **1 算命瓶** 進行分析嗎？」
   *   **按鈕**: `[✅ 我已取得同意並支付 1 瓶]` `[❌ 取消]`
   
   **Step 4: 報告生成 (Report Generation)**
   1.  用戶 A 點擊確認後，立即扣除 1 瓶。
   2.  **生成合盤報告 (AI Synthesis)**:
       *   **綜合數據引擎**: 整合 **星盤** + **八字** + **MBTI** + **血型**。
       *   **匿名化處理**: Prompt 中嚴格限制輸出對方個資。
   3.  直接發送報告給用戶 A。
   *   *(註: 對方不會收到任何通知)*

#### C. 隱私控制與黑名單 (Privacy Control & Blocklist)
   雖然系統不通知對方，但我們仍尊重用戶的隱私設定。
   
   1.  **黑名單阻擋 (Blocklist Enforcement)**:
       *   若用戶 B 曾在 `⚙️ 設定` -> `🛡️ 隱私與黑名單` 中封鎖了用戶 A。
       *   當用戶 A 嘗試輸入用戶 B 進行配對時，系統將**直接攔截**並提示「無法對該用戶進行操作」。
   
   2.  **頻率限制 (Rate Limiting)**:
       *   為防止濫用，對同一目標的分析建議設定冷卻時間（例如：24小時內不建議重複分析，除非數據有變更）。
   
   #### D. 資料效期 (Validity)
   *   **資料變更重算**:
       *   若任一方 (A 或 B) 修改了命盤資料，舊報告標記為「失效」。
       *   用戶需主動點擊 `[🔄 資料已變更，重新生成報告]` 並再次消耗瓶子。

---

## 7. 隱私與黑名單管理 (Privacy & Blocklist Management)

**新功能**: 為了讓用戶管理被自動或手動封鎖的對象，以及行使「被遺忘權」。

### 7.1 帳戶刪除 (Account Deletion / Right to be Forgotten)
*   **指令**: `/delete_me`
*   **流程**:
    1.  用戶輸入指令。
    2.  系統彈出紅色警告：「⚠️ 刪除不可逆，且將被列入黑名單」。
    3.  用戶點擊「確認刪除」。
*   **執行邏輯 (Strict Deletion)**:
    *   **立即刪除**: 個人資料、對話記錄、漂流瓶、好友關係。
    *   **永久保留 (Retention)**: 財務記錄（訂閱/消費）、風控記錄（舉報/封禁）。
    *   **黑名單 (Blacklist)**: 自動將該 Telegram ID 加入系統 `bans` 表（原因：`account_deleted_by_user`），**永久禁止重新註冊**。

### 7.2 黑名單管理 (Blocklist UI)
*   **入口**: `⚙️ 設定` -> `🛡️ 隱私與黑名單`。
*   **UI 設計 (遵循 UI Guideline 簡潔與反饋原則)**:
    
    **1. 主界面 (Main Interface)**:
    *   **標題**: `🛡️ 隱私與黑名單管理`
    *   **說明**:
        > 在此管理您封鎖的用戶。被封鎖的對象將無法：
        > 1. 向您發送配對請求
        > 2. 撿到您的漂流瓶 (雙向屏蔽)
    *   **列表呈現**:
        *   **空狀態 (Empty)**: 顯示「目前沒有封鎖任何用戶 ✅」。
        *   **非空狀態**: 以 Inline Buttons 列出被封鎖者，格式為 `[🔓 解鎖: 暱稱/ID]`。
        *   **分頁機制**: 若超過 10 人，底部顯示 `[⬅️ 上一頁]` `[下一頁 ➡️]`。
    *   **功能按鈕**:
        *   `[➕ 手動封鎖 (輸入 ID)]` (底部固定)
        *   `[🔙 返回設定]`

    **2. 操作交互 (Interaction)**:
    *   **解除封鎖**:
        *   點擊 `[🔓 解鎖: UserA]` -> 彈出 Alert `✅ 已解除對 UserA 的封鎖` -> 列表自動刷新。
    *   **手動封鎖**:
        *   點擊 `[➕ 手動封鎖]` -> 進入 Wizard 模式。
        *   提示: 「請輸入您想封鎖的用戶 Telegram ID (或是轉發他的一條訊息給我)：」
        *   輸入後反饋:
            *   成功: `✅ 已成功封鎖 [UserB]` -> 返回列表。
            *   失敗 (無效ID): `⚠️ 找不到該用戶，請檢查 ID 是否正確。` -> 顯示重試按鈕。

---

## 12. 數據庫變更需求 (Database Schema Requirements)

**⚠️ 開發前必讀：為支援上述功能，必須執行以下 Migration**

1.  **`users` 表**:
    *   (已廢棄邏輯) `allow_matching`: 此欄位保留但被系統忽略。根據新的 ToS，所有註冊用戶默認均可被配對（強制社交屬性）。
2.  **`user_blocklist` 表 (新增)**:
    *   用於統一管理黑名單（配對與漂流瓶）。
    *   Fields:
        *   `user_id`: TEXT (Initiator)
        *   `blocked_user_id`: TEXT (Target)
        *   `reason`: TEXT (e.g., 'match_rejected', 'manual')
        *   `created_at`: TIMESTAMP
        *   Primary Key: `(user_id, blocked_user_id)`
3.  **`match_requests` 表 (新增)**:
    *   用於追蹤請求狀態與冷卻時間。
    *   Fields:
        *   `id`: UUID
        *   `requester_id`: User A Telegram ID
        *   `target_id`: User B Telegram ID
        *   `status`: `pending`, `accepted`, `rejected`, `expired`
        *   `relationship_type`: TEXT (love, family, friend, work)
        *   `family_role`: TEXT
        *   `rejection_count`: INT (連續拒絕次數)
        *   `last_rejected_at`: TIMESTAMP
        *   `created_at`: TIMESTAMP
        *   `expires_at`: TIMESTAMP
4.  **`fortune_history` 表**:
    *   新增 `profile_snapshot` (TEXT/JSON)
    *   新增 `target_user_id` (TEXT)
    *   更新 `type` Enum

---

## 13. 開發安全與 i18n 規範 (Safety & i18n Standards)

**⚠️ 開發過程中必須嚴格遵守以下原則，防止回歸錯誤 (Regression) 與 i18n 災難。**

### 13.1 功能安全 (Feature Safety)
*   **零破壞原則**: 新增功能（如屬性診斷）**絕對不可影響** 現有的 `Daily Fortune`、`Onboarding` 或 `Profile Management` 流程。
*   **代碼隔離**: 新邏輯應盡量封裝在獨立的函數或 Service 方法中，避免修改現有的核心 Helper。

### 13.2 i18n 實作規範 (Internationalization)
*   **優先複用 (Reuse First)**: 編寫 UI 時，先搜索 `src/i18n/locales/zh-TW.ts`。
*   **禁止硬編碼**: 絕對禁止在 `.ts` 檔案中直接寫死中文。
*   **參數格式**: `{variable}` 只能包含字母數字。避免使用嵌套語法 `{user.name}`，應扁平化為 `{name}`。

### 13.4 近期關鍵修復與教訓 (Recent Critical Fixes & Lessons)
**記錄日期: 2025-11-30**

1.  **Session Timeout 崩潰 (`RangeError: Invalid time value`)**:
    *   **原因**: 新增的 `SessionType` (如 `fortune_input`) 未添加到 `SESSION_TIMEOUT` 常數中，導致過期時間計算結果為 `NaN`。
    *   **預防**: 修改 `SessionType` 定義時，**必須同步** 更新 `SESSION_TIMEOUT`。

2.  **變數作用域錯誤 (`ReferenceError: user is not defined`)**:
    *   **原因**: 在 `handleFortuneInput` 中調用 `createI18n` 時使用了未在此作用域定義的 `user` 變數。
    *   **預防**: 使用任何變數前，確保已在當前 Block 中獲取或定義。

3.  **i18n 誤用與缺失**:
    *   **問題**: `common.cancel` 被錯誤覆寫為錯誤提示語；`[fortune.love.invite_btn]` 缺失。
    *   **預防**: 使用 `scripts/check-i18n-integrity.ts` 進行預部署檢查；修改通用 Key 時需格外小心。

4.  **按鈕功能異常**:
    *   **問題**: 「邀請好友」按鈕應使用 URL Scheme (`https://t.me/share/url`) 而非僅僅是文字提示。

5.  **重構提醒 (Refactoring Checklist)**:
    *   [ ] 徹底移除舊的 `fortune_love.ts` 中直接生成報告的邏輯，改為發送請求。
    *   [ ] 確保 `allow_matching` 欄位的語義變更被正確理解（舊代碼可能將其視為「可直接配對」）。
    *   [ ] 確保 `quota` 檢查邏輯在流程最前端（輸入 ID 前）就執行。

---

## 14. Cursor + AI 開發實踐守則 (AI Implementation Guidelines)

為了確保在接下來的開發週期中，避免重複過去的錯誤（i18n 回歸、資料庫不同步、邏輯死角），必須嚴格遵守以下開發守則。

### 14.1 零容忍的 i18n 流程 (Zero Tolerance i18n Flow)
**原則**: 任何被顯示在 UI 上的文字，都必須是變量。
1.  **Strict Syntax**: 在 `zh-TW.ts` 或任何語言文件中，**絕對禁止**使用 JS 模板字面量語法（反引號 `` ` `` 或 `${var}`）。必須始終使用 `{var}` 格式。
2.  **Pre-Commit Check**: 每次修改翻譯文件後，**必須**手動執行 `pnpm tsx scripts/check-i18n-integrity.ts`。如果報錯，**不允許**提交代碼。
3.  **Atomic Translation**: 不要試圖在一次編輯中翻譯所有語言。先確保 `zh-TW` 完美無缺，然後依賴後續的批量翻譯腳本。

### 14.2 資料庫變更優先 (Database Migration First)
**原則**: 應用層代碼永遠不應「猜測」資料庫結構。
1.  **Schema First**: 如果功能需要新欄位（如 `match_requests`），**第一步**永遠是編寫 Migration SQL。
2.  **Verify & Apply**: 編寫完 Migration 後，立即在 Staging 環境執行 `wrangler d1 migrations apply`，並使用 `d1 execute` 驗證表結構已生效。
3.  **Code Second**: 只有在資料庫確認更新後，才開始編寫 TypeScript 邏輯。

### 14.3 防禦性編程與日誌 (Defensive Coding & Logging)
**原則**: 永遠假設「用戶不存在」、「額度不足」或「輸入無效」。
1.  **Early Exit**: 在函數開頭進行所有必要檢查（User auth, Quota check, Input validation）。如果不通過，立即 `return` 並給出明確提示。
2.  **Granular Logging**: 在關鍵流程（如：發起配對請求、接收回調）的每個分支點添加 `console.log` 或 `console.error`。這能解決「點擊無反應」的隱形 Bug。
3.  **Type Safety**: 擴充 `FortuneType` 或 `SessionType` 時，必須同步更新所有相關的 Switch Case 和 Type Definition（如 `SESSION_TIMEOUT`），不要遺漏任何一個。

### 14.4 提示詞優化 (Prompt Optimization for Gemini)
**原則**: 對 AI 說清楚「要什麼」和「不要什麼」。
1.  **Format Enforcing**: 在 Prompt System Role 中，明確加上 `[IMPORTANT: OUTPUT MUST BE PLAIN TEXT WITH EMOJIS. NO MARKDOWN.]`。
2.  **Privacy Guard**: 在 Prompt 中強制加入 `[SECURITY RULE: DO NOT REVEAL TARGET'S BIRTH DATA]`。

---

**最後更新**: 2025-11-30
**維護者**: 專案團隊
