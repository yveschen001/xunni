# 🚀 XunNi Bot - 本地開發指南

## ✅ **快速開始（一條命令）**

```bash
pnpm dev:polling
```

就這麼簡單！🎉

---

## 📋 **什麼是 Polling 模式？**

Polling 模式讓你的 Bot 直接從 Telegram 服務器拉取更新，而不需要：
- ❌ 公網 IP 地址
- ❌ Cloudflare Workers
- ❌ ngrok 或其他隧道工具
- ❌ Webhook 設置

**優點：**
- ✅ 完全本地運行
- ✅ 不依賴 Cloudflare
- ✅ 簡單快速
- ✅ 適合快速開發和測試

**缺點：**
- ⚠️ 數據庫功能受限（使用 Mock）
- ⚠️ 不支持熱重載（需要手動重啟）
- ⚠️ 不適合生產環境

---

## 🎯 **使用場景**

### **✅ 適合用於：**

1. **測試 Bot 邏輯**
   - 測試命令處理
   - 測試消息回覆
   - 測試按鈕交互

2. **開發新功能**
   - 快速驗證想法
   - 測試 API 集成
   - 調試錯誤

3. **學習和實驗**
   - 了解 Bot 工作原理
   - 測試 Telegram API
   - 實驗新想法

### **❌ 不適合用於：**

1. **需要數據庫的功能**
   - 用戶註冊
   - 數據持久化
   - 複雜業務邏輯

2. **生產環境**
   - 正式服務
   - 大量用戶
   - 需要高可用性

---

## 🚀 **啟動步驟**

### **步驟 1: 確認環境**

確保 `.dev.vars` 文件存在：

```bash
# 檢查文件是否存在
ls -la .dev.vars

# 查看內容（確保有 TELEGRAM_BOT_TOKEN）
cat .dev.vars
```

### **步驟 2: 啟動 Bot**

```bash
pnpm dev:polling
```

### **步驟 3: 測試 Bot**

1. 打開 Telegram
2. 找到你的 Bot
3. 發送任何消息
4. 查看終端輸出

---

## 📺 **你會看到什麼**

```
╔═══════════════════════════════════════════════════════╗
║  🤖 XunNi Bot - Local Development (Polling Mode)     ║
╚═══════════════════════════════════════════════════════╝

📍 Environment: development
🔑 Bot Token: 8226418094:AAE5wfp_...
🗄️  Database: Mock (no persistence)
🔄 Mode: Long Polling (30s timeout)
⚠️  Note: Database operations will fail - use for testing bot logic only

🔧 Removing webhook to enable polling...
✅ Webhook removed successfully
🚀 Starting to poll for updates...
💡 Send a message to your bot to test!

─────────────────────────────────────────────────────────

📬 Received 1 update(s) (Total: 1)

📨 Processing update 123456789
   From: Yichen (@yichen_username)
   Text: Hello Bot!
✅ Update processed successfully

─────────────────────────────────────────────────────────
```

---

## 🔧 **開發工作流程**

### **1. 修改代碼**

編輯任何 `src/` 下的文件：

```typescript
// src/telegram/handlers/start.ts
export async function handleStart(...) {
  // 你的修改
}
```

### **2. 重啟 Bot**

```bash
# 按 Ctrl+C 停止
# 然後重新運行
pnpm dev:polling
```

### **3. 測試修改**

在 Telegram 中測試你的修改。

---

## 💡 **常見問題**

### **Q1: 為什麼數據庫操作會失敗？**

**A:** Polling 模式使用 Mock 數據庫，不支持真實的數據庫操作。

**解決方案：**
- 如果需要測試數據庫功能，使用 `wrangler dev` + ngrok
- 或者直接部署到 Cloudflare Staging 環境測試

### **Q2: 如何查看詳細日誌？**

**A:** 所有日誌都會輸出到終端。你可以：

```bash
# 保存日誌到文件
pnpm dev:polling 2>&1 | tee bot-log.txt

# 只看錯誤
pnpm dev:polling 2>&1 | grep "❌"
```

### **Q3: 如何停止 Bot？**

**A:** 按 `Ctrl+C` 即可停止。

### **Q4: Bot 沒有響應怎麼辦？**

**檢查清單：**

1. ✅ 確認 `TELEGRAM_BOT_TOKEN` 正確
2. ✅ 確認網絡連接正常
3. ✅ 確認 Bot 沒有被其他進程使用
4. ✅ 查看終端錯誤信息

```bash
# 測試 Token 是否有效
curl "https://api.telegram.org/bot你的TOKEN/getMe"
```

### **Q5: 如何切換回 Webhook 模式？**

**A:** 停止 Polling 模式後，重新設置 Webhook：

```bash
# 停止 Polling（Ctrl+C）

# 部署到 Cloudflare
pnpm deploy:staging

# 設置 Webhook
curl -X POST "https://api.telegram.org/bot你的TOKEN/setWebhook" \
  -d "url=https://你的worker地址.workers.dev/webhook"
```

---

## 🎨 **進階用法**

### **查看所有環境變數**

```bash
# 編輯 scripts/dev-polling.ts
# 在 startPolling() 函數中添加：
console.log('Environment:', env);
```

### **自定義輪詢間隔**

```bash
# 編輯 scripts/dev-polling.ts
# 修改這一行：
await new Promise(resolve => setTimeout(resolve, 100)); // 改為你想要的毫秒數
```

### **過濾特定類型的更新**

```typescript
// 在 processUpdate() 函數中添加：
if (!update.message) {
  console.log('⏭️  Skipping non-message update');
  return;
}
```

---

## 📊 **與其他開發方式對比**

| 方式 | 優點 | 缺點 | 適用場景 |
|------|------|------|----------|
| **Polling 模式** | ✅ 簡單<br>✅ 不需要公網 | ❌ 無數據庫<br>❌ 無熱重載 | 快速測試 Bot 邏輯 |
| **Wrangler Dev + ngrok** | ✅ 完整功能<br>✅ 有數據庫 | ❌ 需要 ngrok<br>❌ 設置複雜 | 完整功能測試 |
| **Cloudflare Staging** | ✅ 真實環境<br>✅ 完整功能 | ❌ 需要部署<br>❌ 較慢 | 上線前測試 |

---

## 🎯 **推薦工作流程**

### **階段 1: 快速開發（使用 Polling）**

```bash
# 1. 開發新功能
vim src/telegram/handlers/new_feature.ts

# 2. 快速測試
pnpm dev:polling

# 3. 迭代修改
# 重複步驟 1-2
```

### **階段 2: 完整測試（使用 Wrangler Dev）**

```bash
# 當功能基本完成，需要測試數據庫時
pnpm dev  # 在一個終端
ngrok http 8787  # 在另一個終端
# 設置 Webhook
```

### **階段 3: 上線前驗證（部署到 Staging）**

```bash
pnpm deploy:staging
# 完整測試所有功能
```

### **階段 4: 生產部署**

```bash
pnpm deploy:production
```

---

## 🔒 **安全注意事項**

⚠️ **重要：**

1. **不要提交 `.dev.vars`**
   - 包含敏感信息
   - 已在 `.gitignore` 中

2. **Polling 模式會刪除 Webhook**
   - 啟動時自動調用 `deleteWebhook`
   - 確保不影響生產環境

3. **使用不同的 Bot Token**
   - 開發環境使用測試 Bot
   - 生產環境使用正式 Bot

---

## 📚 **相關文檔**

- `LOCAL_DEVELOPMENT_GUIDE.md` - 完整的本地開發指南
- `LOCAL_DEV_QUICK_START.md` - 快速開始指南
- `doc/ENV_CONFIG.md` - 環境配置說明

---

## 🆘 **需要幫助？**

如果遇到問題：

1. 📖 查看錯誤信息
2. 🔍 檢查 `.dev.vars` 配置
3. 🧪 運行測試：`pnpm test`
4. 📝 查看日誌輸出

---

## 🎉 **總結**

**Polling 模式是最簡單的本地開發方式！**

- ✅ 一條命令啟動
- ✅ 不需要複雜配置
- ✅ 適合快速開發和測試
- ✅ 等 Cloudflare 恢復後再切換回 Webhook

**現在就開始開發吧！** 🚀

```bash
pnpm dev:polling
```

