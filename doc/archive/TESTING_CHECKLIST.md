# æ¸¬è©¦æª¢æŸ¥æ¸…å–®ï¼ˆTesting Checklistï¼‰

> **ç›®çš„ï¼š** ç¢ºä¿æ¯æ¬¡é–‹ç™¼éƒ½ç¶“éå®Œæ•´æ¸¬è©¦ï¼Œé¿å…éºæ¼é—œéµå•é¡Œ

---

## ğŸ“‹ **éƒ¨ç½²å‰å¿…é ˆå®Œæˆçš„æ¸¬è©¦**

### **éšæ®µ 1ï¼šéœæ…‹ä»£ç¢¼æª¢æŸ¥**

#### 1.1 ä»£ç¢¼æ ¼å¼åŒ–å’Œ Lint
```bash
# å¿…é ˆæŒ‰é †åºåŸ·è¡Œ
pnpm format              # è‡ªå‹•æ ¼å¼åŒ–ä»£ç¢¼
pnpm lint                # æª¢æŸ¥ä»£ç¢¼è³ªé‡ï¼ˆå¿…é ˆ 0 éŒ¯èª¤ï¼‰
pnpm test                # åŸ·è¡Œå–®å…ƒæ¸¬è©¦ï¼ˆå¿…é ˆå…¨éƒ¨é€šéï¼‰
```

**æª¢æŸ¥é …ï¼š**
- [ ] `pnpm format` åŸ·è¡ŒæˆåŠŸ
- [ ] `pnpm lint` é›¶éŒ¯èª¤ï¼ˆè­¦å‘Šå¯æ¥å—ä½†éœ€è¨˜éŒ„ï¼‰
- [ ] `pnpm test` å…¨éƒ¨é€šé
- [ ] æ²’æœ‰æœªä½¿ç”¨çš„å°å…¥å’Œè®Šé‡

---

#### 1.2 Schema ä¸€è‡´æ€§æª¢æŸ¥

**å•é¡Œï¼š** ä»£ç¢¼ä¸­ä½¿ç”¨çš„æ¬„ä½åç¨±èˆ‡è³‡æ–™åº« schema ä¸ä¸€è‡´

**æª¢æŸ¥æ–¹æ³•ï¼š**
1. æŸ¥çœ‹ `src/db/schema.sql` ç¢ºèªè¡¨çµæ§‹
2. æª¢æŸ¥ä»£ç¢¼ä¸­æ˜¯å¦ä½¿ç”¨äº†ä¸å­˜åœ¨çš„æ¬„ä½

**å¸¸è¦‹éŒ¯èª¤ï¼š**
- âŒ ä½¿ç”¨ `user.is_super_admin`ï¼ˆä¸å­˜åœ¨ï¼‰
- âœ… æ‡‰è©²ä½¿ç”¨ `user.role === 'god'`

**æª¢æŸ¥æ¸…å–®ï¼š**
- [ ] ç¢ºèªæ‰€æœ‰æŸ¥è©¢çš„æ¬„ä½éƒ½å­˜åœ¨æ–¼ schema ä¸­
- [ ] ç¢ºèªæ‰€æœ‰ INSERT/UPDATE çš„æ¬„ä½éƒ½å­˜åœ¨
- [ ] ç¢ºèªæ‰€æœ‰æ¬Šé™æª¢æŸ¥ä½¿ç”¨æ­£ç¢ºçš„æ¬„ä½ï¼ˆ`role` è€Œä¸æ˜¯ `is_super_admin`ï¼‰

**è‡ªå‹•åŒ–æª¢æŸ¥è…³æœ¬ï¼š**
```bash
# æª¢æŸ¥æ˜¯å¦ä½¿ç”¨äº†ä¸å­˜åœ¨çš„æ¬„ä½
grep -r "is_super_admin" src/telegram/handlers/
grep -r "is_admin" src/telegram/handlers/ | grep -v "function isAdmin"
```

---

#### 1.3 è·¯ç”±å®Œæ•´æ€§æª¢æŸ¥

**å•é¡Œï¼š** æ–°å¢å‘½ä»¤æ²’æœ‰è¨»å†Šåˆ°è·¯ç”±

**æª¢æŸ¥æ¸…å–®ï¼š**
- [ ] æ–°å‘½ä»¤å·²åœ¨ `src/router.ts` ä¸­è¨»å†Š
- [ ] æ¬Šé™æª¢æŸ¥é‚è¼¯æ­£ç¢ºï¼ˆä¸€èˆ¬ç”¨æˆ¶/ç®¡ç†å“¡/è¶…ç´šç®¡ç†å“¡ï¼‰
- [ ] å‘½ä»¤å·²æ·»åŠ åˆ° `/help` ä¸­
- [ ] å‘½ä»¤å·²æ·»åŠ åˆ° `scripts/e2e-test.sh` ä¸­

**è‡ªå‹•åŒ–æª¢æŸ¥ï¼š**
```bash
# æª¢æŸ¥æ‰€æœ‰ handler æ˜¯å¦éƒ½æœ‰å°æ‡‰çš„è·¯ç”±
cd /Users/yichen/Downloads/cursor/XunNi
for handler in src/telegram/handlers/*.ts; do
  filename=$(basename "$handler" .ts)
  if ! grep -q "$filename" src/router.ts; then
    echo "âš ï¸  Handler $filename å¯èƒ½æ²’æœ‰è·¯ç”±"
  fi
done
```

---

### **éšæ®µ 2ï¼šè³‡æ–™åº«é©—è­‰**

#### 2.1 Migration é©—è­‰

```bash
# æª¢æŸ¥ local migrations
pnpm wrangler d1 migrations list DB --local

# æª¢æŸ¥ remote migrations
pnpm wrangler d1 migrations list DB --env staging --remote
```

**æª¢æŸ¥æ¸…å–®ï¼š**
- [ ] æ‰€æœ‰ migration æ–‡ä»¶éƒ½å­˜åœ¨æ–¼ `src/db/migrations/` ç›®éŒ„
- [ ] Remote è³‡æ–™åº«å·²åŸ·è¡Œæ‰€æœ‰ migrations
- [ ] æ²’æœ‰å¤±æ•—çš„ migrations

---

#### 2.2 è¡¨çµæ§‹é©—è­‰

```bash
# æª¢æŸ¥æ‰€æœ‰è¡¨æ˜¯å¦å­˜åœ¨
pnpm wrangler d1 execute DB --env staging --remote \
  --command "SELECT name FROM sqlite_master WHERE type='table' ORDER BY name;"
```

**å¿…é ˆå­˜åœ¨çš„è¡¨ï¼š**
- [ ] `users`
- [ ] `bottles`
- [ ] `conversations`
- [ ] `conversation_messages`
- [ ] `ad_providers`
- [ ] `ad_rewards`
- [ ] `official_ads`
- [ ] `analytics_events`
- [ ] `user_sessions`ï¼ˆsession managementï¼‰

---

#### 2.3 æ¸¬è©¦æ•¸æ“šé©—è­‰

```bash
# æª¢æŸ¥æ¸¬è©¦å»£å‘Šæä¾›å•†
pnpm wrangler d1 execute DB --env staging --remote \
  --command "SELECT provider_name, is_enabled FROM ad_providers;"

# æª¢æŸ¥è¶…ç´šç®¡ç†å“¡
pnpm wrangler d1 execute DB --env staging --remote \
  --command "SELECT telegram_id, role FROM users WHERE role = 'god';"
```

**æª¢æŸ¥æ¸…å–®ï¼š**
- [ ] æ¸¬è©¦å»£å‘Šæä¾›å•†å·²é…ç½®
- [ ] è¶…ç´šç®¡ç†å“¡å¸³è™Ÿå·²è¨­ç½®
- [ ] å®˜æ–¹å»£å‘Šå·²å‰µå»ºï¼ˆå¦‚éœ€è¦ï¼‰

---

### **éšæ®µ 3ï¼šåŠŸèƒ½æ¸¬è©¦**

#### 3.1 æ¬Šé™æ¸¬è©¦

**æ¸¬è©¦ç›®æ¨™ï¼š** ç¢ºä¿æ¬Šé™æª¢æŸ¥æ­£ç¢º

**æ¸¬è©¦æ­¥é©Ÿï¼š**

1. **ä¸€èˆ¬ç”¨æˆ¶æ¸¬è©¦**
   ```
   ä½¿ç”¨ä¸€èˆ¬ç”¨æˆ¶å¸³è™Ÿæ¸¬è©¦ï¼š
   - [ ] /analytics â†’ æ‡‰è©²é¡¯ç¤ºã€Œæ²’æœ‰æ¬Šé™ã€
   - [ ] /ad_performance â†’ æ‡‰è©²é¡¯ç¤ºã€Œæ²’æœ‰æ¬Šé™ã€
   - [ ] /funnel â†’ æ‡‰è©²é¡¯ç¤ºã€Œæ²’æœ‰æ¬Šé™ã€
   ```

2. **è¶…ç´šç®¡ç†å“¡æ¸¬è©¦**
   ```
   ä½¿ç”¨è¶…ç´šç®¡ç†å“¡å¸³è™Ÿæ¸¬è©¦ï¼š
   - [ ] /analytics â†’ æ‡‰è©²é¡¯ç¤ºå ±è¡¨
   - [ ] /ad_performance â†’ æ‡‰è©²é¡¯ç¤ºå ±è¡¨
   - [ ] /funnel â†’ æ‡‰è©²é¡¯ç¤ºå ±è¡¨
   ```

3. **æª¢æŸ¥æ—¥èªŒ**
   ```
   æŸ¥çœ‹ Cloudflare Worker æ—¥èªŒï¼š
   - [ ] æ²’æœ‰æ¬Šé™éŒ¯èª¤
   - [ ] æ²’æœ‰ SQL éŒ¯èª¤
   - [ ] æ²’æœ‰æœªæ•ç²çš„ç•°å¸¸
   ```

---

#### 3.2 å‘½ä»¤è·¯ç”±æ¸¬è©¦

**æ¸¬è©¦ç›®æ¨™ï¼š** ç¢ºä¿å‘½ä»¤èƒ½æ­£ç¢ºè·¯ç”±åˆ°è™•ç†å™¨

**æ¸¬è©¦æ­¥é©Ÿï¼š**

1. **ç™¼é€å‘½ä»¤**
   ```
   æ¸¬è©¦æ‰€æœ‰æ–°å‘½ä»¤ï¼š
   - [ ] /analytics
   - [ ] /ad_performance
   - [ ] /funnel
   ```

2. **æª¢æŸ¥æ—¥èªŒ**
   ```
   å¿…é ˆå‡ºç¾çš„æ—¥èªŒï¼š
   - [ ] [Router] Received update
   - [ ] [Router] Message details
   - [ ] [router] Starting command routing
   - [ ] [handleAnalytics] æˆ– [handleAdPerformance] æˆ– [handleFunnel]
   ```

3. **æª¢æŸ¥å›è¦†**
   ```
   - [ ] Bot æœ‰å›è¦†è¨Šæ¯
   - [ ] è¨Šæ¯å…§å®¹æ­£ç¢º
   - [ ] æ²’æœ‰éŒ¯èª¤è¨Šæ¯
   ```

---

#### 3.3 æ•¸æ“šæ­£ç¢ºæ€§æ¸¬è©¦

**æ¸¬è©¦ç›®æ¨™ï¼š** ç¢ºä¿å ±è¡¨æ•¸æ“šæ­£ç¢º

**æ¸¬è©¦æ­¥é©Ÿï¼š**

1. **æª¢æŸ¥å ±è¡¨æ ¼å¼**
   ```
   - [ ] æ—¥æœŸæ ¼å¼æ­£ç¢º
   - [ ] æ•¸å­—æ ¼å¼æ­£ç¢ºï¼ˆç™¾åˆ†æ¯”ã€åƒåˆ†ä½ï¼‰
   - [ ] æ²’æœ‰ NaN æˆ– undefined
   ```

2. **æª¢æŸ¥æ•¸æ“šé‚è¼¯**
   ```
   - [ ] ç™¾åˆ†æ¯”åœ¨ 0-100% ä¹‹é–“
   - [ ] ç¸½æ•¸ = å„éƒ¨åˆ†ä¹‹å’Œ
   - [ ] è½‰åŒ–ç‡è¨ˆç®—æ­£ç¢º
   ```

3. **æª¢æŸ¥é‚Šç•Œæƒ…æ³**
   ```
   - [ ] æ²’æœ‰æ•¸æ“šæ™‚é¡¯ç¤ºæ­£ç¢º
   - [ ] æ•¸æ“šç‚º 0 æ™‚é¡¯ç¤ºæ­£ç¢º
   - [ ] æ•¸æ“šå¾ˆå¤§æ™‚é¡¯ç¤ºæ­£ç¢º
   ```

---

### **éšæ®µ 4ï¼šæ•´åˆæ¸¬è©¦**

#### 4.1 ç«¯åˆ°ç«¯æ¸¬è©¦

```bash
# åŸ·è¡Œè‡ªå‹•åŒ–æ¸¬è©¦è…³æœ¬
cd /Users/yichen/Downloads/cursor/XunNi
bash scripts/e2e-test.sh
```

**æª¢æŸ¥æ¸…å–®ï¼š**
- [ ] æ‰€æœ‰è·¯ç”±æª¢æŸ¥é€šé
- [ ] æ‰€æœ‰å‡½æ•¸å°å‡ºæª¢æŸ¥é€šé
- [ ] æ‰€æœ‰æ–‡ä»¶å®Œæ•´æ€§æª¢æŸ¥é€šé

---

#### 4.2 Smoke Test

**æ¸¬è©¦æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ï¼š**

**åŸºç¤å‘½ä»¤ï¼š**
- [ ] `/start` - æ–°ç”¨æˆ¶è¨»å†Š
- [ ] `/help` - é¡¯ç¤ºå¹«åŠ©ï¼ˆæª¢æŸ¥æ˜¯å¦åŒ…å«æ–°å‘½ä»¤ï¼‰
- [ ] `/profile` - æŸ¥çœ‹å€‹äººè³‡æ–™
- [ ] `/menu` - é¡¯ç¤ºä¸»é¸å–®

**å»£å‘Šç³»çµ±ï¼š**
- [ ] `/quota` - æŸ¥çœ‹é¡åº¦
- [ ] é»æ“Šã€Œè§€çœ‹å»£å‘Šã€æŒ‰éˆ•
- [ ] å»£å‘Šé é¢è¼‰å…¥æˆåŠŸ
- [ ] å®Œæˆå»£å‘Šå¾Œé¡åº¦ +1
- [ ] é»æ“Šã€ŒæŸ¥çœ‹å®˜æ–¹å»£å‘Šã€
- [ ] å®˜æ–¹å»£å‘Šåˆ—è¡¨é¡¯ç¤º

**ç®¡ç†å“¡å‘½ä»¤ï¼ˆè¶…ç´šç®¡ç†å“¡ï¼‰ï¼š**
- [ ] `/analytics` - æ¯æ—¥é‹ç‡Ÿå ±è¡¨
- [ ] `/ad_performance` - å»£å‘Šæ•ˆæœå ±è¡¨
- [ ] `/funnel` - VIP è½‰åŒ–æ¼æ–—

---

### **éšæ®µ 5ï¼šæ—¥èªŒæª¢æŸ¥**

#### 5.1 Cloudflare Worker æ—¥èªŒ

**æª¢æŸ¥é …ï¼š**
- [ ] æ²’æœ‰æœªæ•ç²çš„ç•°å¸¸
- [ ] æ²’æœ‰ SQL éŒ¯èª¤ï¼ˆ`SQLITE_ERROR`, `no such table`, `no such column`ï¼‰
- [ ] æ²’æœ‰æ¬Šé™éŒ¯èª¤ï¼ˆé™¤äº†é æœŸçš„æ¬Šé™æ‹’çµ•ï¼‰
- [ ] æ²’æœ‰ 404 éŒ¯èª¤ï¼ˆéœæ…‹æ–‡ä»¶ï¼‰
- [ ] éŸ¿æ‡‰æ™‚é–“åˆç†ï¼ˆ< 5 ç§’ï¼‰

**å¸¸è¦‹éŒ¯èª¤æ¨¡å¼ï¼š**
```
âŒ no such column: is_super_admin
âŒ no such table: ad_providers
âŒ Cannot read property 'xxx' of undefined
âŒ Unexpected token
```

---

#### 5.2 éŒ¯èª¤ç‡æª¢æŸ¥

**æª¢æŸ¥ Cloudflare Analyticsï¼š**
- [ ] éŒ¯èª¤ç‡ < 1%
- [ ] æ²’æœ‰ 500 éŒ¯èª¤
- [ ] æ²’æœ‰ 401/403 éŒ¯èª¤ï¼ˆé™¤äº†é æœŸçš„ï¼‰

---

## ğŸ”§ **å•é¡Œç™¼ç¾å¾Œçš„è™•ç†æµç¨‹**

### **1. ç«‹å³ä¿®å¾©**
- è¨˜éŒ„å•é¡Œåˆ° `doc/HOTFIX_LOG.md`
- ä¿®å¾©ä»£ç¢¼
- åŸ·è¡Œå®Œæ•´æ¸¬è©¦æµç¨‹
- éƒ¨ç½²åˆ° Staging
- é©—è­‰ä¿®å¾©

### **2. æ›´æ–°æ¸¬è©¦è¦ç¯„**
- åˆ†æç‚ºä»€éº¼æ¸¬è©¦æ²’æœ‰ç™¼ç¾å•é¡Œ
- æ›´æ–°æ­¤æª¢æŸ¥æ¸…å–®
- æ·»åŠ è‡ªå‹•åŒ–æª¢æŸ¥ï¼ˆå¦‚å¯èƒ½ï¼‰

### **3. æ›´æ–°æ–‡æª”**
- æ›´æ–° `doc/DEVELOPMENT_STANDARDS.md`
- æ›´æ–° `doc/HOTFIX_LOG.md`
- æ›´æ–° `.cursorrules`ï¼ˆå¦‚éœ€è¦ï¼‰

---

## ğŸ“ **æ¸¬è©¦å ±å‘Šæ¨¡æ¿**

```markdown
# æ¸¬è©¦å ±å‘Š - YYYY-MM-DD

## åŠŸèƒ½ï¼š[åŠŸèƒ½åç¨±]

### éšæ®µ 1ï¼šéœæ…‹ä»£ç¢¼æª¢æŸ¥
- [x] pnpm format
- [x] pnpm lint (0 errors, X warnings)
- [x] pnpm test (all passed)
- [x] Schema ä¸€è‡´æ€§æª¢æŸ¥
- [x] è·¯ç”±å®Œæ•´æ€§æª¢æŸ¥

### éšæ®µ 2ï¼šè³‡æ–™åº«é©—è­‰
- [x] Migrations å·²åŸ·è¡Œ
- [x] è¡¨çµæ§‹æ­£ç¢º
- [x] æ¸¬è©¦æ•¸æ“šå·²é…ç½®

### éšæ®µ 3ï¼šåŠŸèƒ½æ¸¬è©¦
- [x] æ¬Šé™æ¸¬è©¦é€šé
- [x] å‘½ä»¤è·¯ç”±æ¸¬è©¦é€šé
- [x] æ•¸æ“šæ­£ç¢ºæ€§æ¸¬è©¦é€šé

### éšæ®µ 4ï¼šæ•´åˆæ¸¬è©¦
- [x] ç«¯åˆ°ç«¯æ¸¬è©¦é€šé
- [x] Smoke Test é€šé

### éšæ®µ 5ï¼šæ—¥èªŒæª¢æŸ¥
- [x] ç„¡éŒ¯èª¤æ—¥èªŒ
- [x] éŒ¯èª¤ç‡ < 1%

## ç™¼ç¾çš„å•é¡Œ
1. [å•é¡Œæè¿°]
   - åš´é‡ç¨‹åº¦ï¼š[ä½/ä¸­/é«˜/Critical]
   - ç‹€æ…‹ï¼š[å·²ä¿®å¾©/å¾…ä¿®å¾©]

## æ¸¬è©¦çµè«–
- [ ] âœ… é€šéï¼Œå¯ä»¥éƒ¨ç½²åˆ° Production
- [ ] âŒ ä¸é€šéï¼Œéœ€è¦ä¿®å¾©å•é¡Œ

## æ¸¬è©¦äººå“¡
- [å§“å/AI]

## å‚™è¨»
[å…¶ä»–éœ€è¦è¨˜éŒ„çš„ä¿¡æ¯]
```

---

## ğŸ¯ **è‡ªå‹•åŒ–æ¸¬è©¦è…³æœ¬**

### **å‰µå»ºå®Œæ•´æ¸¬è©¦è…³æœ¬**

```bash
#!/bin/bash
# scripts/full-test.sh

set -e

echo "=========================================="
echo "éšæ®µ 1ï¼šéœæ…‹ä»£ç¢¼æª¢æŸ¥"
echo "=========================================="

echo "1.1 ä»£ç¢¼æ ¼å¼åŒ–..."
pnpm format

echo "1.2 Lint æª¢æŸ¥..."
pnpm lint

echo "1.3 å–®å…ƒæ¸¬è©¦..."
pnpm test

echo "1.4 Schema ä¸€è‡´æ€§æª¢æŸ¥..."
if grep -r "is_super_admin" src/telegram/handlers/ | grep -v "function isSuperAdmin"; then
  echo "âŒ ç™¼ç¾ä½¿ç”¨ is_super_admin æ¬„ä½ï¼ˆæ‡‰è©²ä½¿ç”¨ roleï¼‰"
  exit 1
fi

echo "1.5 è·¯ç”±å®Œæ•´æ€§æª¢æŸ¥..."
bash scripts/e2e-test.sh

echo ""
echo "=========================================="
echo "éšæ®µ 2ï¼šè³‡æ–™åº«é©—è­‰"
echo "=========================================="

echo "2.1 æª¢æŸ¥ migrations..."
pnpm wrangler d1 migrations list DB --env staging --remote

echo "2.2 æª¢æŸ¥è¡¨çµæ§‹..."
pnpm wrangler d1 execute DB --env staging --remote \
  --command "SELECT name FROM sqlite_master WHERE type='table' ORDER BY name;"

echo ""
echo "=========================================="
echo "âœ… æ‰€æœ‰è‡ªå‹•åŒ–æ¸¬è©¦é€šéï¼"
echo "=========================================="
echo ""
echo "âš ï¸  è«‹æ‰‹å‹•åŸ·è¡Œä»¥ä¸‹æ¸¬è©¦ï¼š"
echo "1. æ¬Šé™æ¸¬è©¦ï¼ˆä¸€èˆ¬ç”¨æˆ¶ + è¶…ç´šç®¡ç†å“¡ï¼‰"
echo "2. å‘½ä»¤è·¯ç”±æ¸¬è©¦ï¼ˆç™¼é€æ‰€æœ‰æ–°å‘½ä»¤ï¼‰"
echo "3. æ•¸æ“šæ­£ç¢ºæ€§æ¸¬è©¦ï¼ˆæª¢æŸ¥å ±è¡¨æ•¸æ“šï¼‰"
echo "4. Smoke Testï¼ˆæ¸¬è©¦æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ï¼‰"
echo "5. æ—¥èªŒæª¢æŸ¥ï¼ˆCloudflare Worker æ—¥èªŒï¼‰"
echo ""
```

---

## ğŸ“š **ç›¸é—œæ–‡æª”**

- `doc/DEVELOPMENT_STANDARDS.md` - é–‹ç™¼è¦ç¯„
- `doc/HOTFIX_LOG.md` - å•é¡Œä¿®å¾©è¨˜éŒ„
- `doc/SMOKE_TEST_COVERAGE_REPORT.md` - Smoke Test è¦†è“‹å ±å‘Š
- `scripts/e2e-test.sh` - ç«¯åˆ°ç«¯æ¸¬è©¦è…³æœ¬

---

**æœ€å¾Œæ›´æ–°ï¼š** 2025-01-19  
**ç¶­è­·è€…ï¼š** é–‹ç™¼åœ˜éšŠ

