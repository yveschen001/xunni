# ForceReply UX 優化報告

> **日期**: 2025-11-22  
> **問題**: 點擊 `#1122DDIH` 會觸發 Telegram Hashtag 搜索，導致輸入框消失  
> **解決方案**: 移除 ForceReply 訊息中的 `#` 符號

---

## 🐛 問題描述

### 用戶反饋
當用戶點擊帶有 `#` 的訊息（如 `#1122DDIH`）時：
1. ❌ Telegram 自動進入 Hashtag 搜索模式
2. ❌ 底部輸入框消失
3. ❌ 無法直接發送訊息
4. ❌ 用戶體驗中斷

### 根本原因
Telegram 會自動將 `#開頭的文字` 識別為 **Hashtag**，點擊後會進入搜索模式。

---

## ✅ 解決方案

### 策略：混合方案
- **ForceReply 訊息**：移除 `#`（避免觸發搜索）
- **其他地方**：保留 `#`（保持視覺識別度和搜索功能）

### 修改內容

#### 1. ForceReply 訊息文案

**修改前**：
```
💬 回覆 #1122DDIH：
```

**修改後**：
```
💬 回覆對話 1122DDIH
```

**影響文件**：`src/telegram/handlers/message_forward.ts` (第 480 行)

#### 2. Router 識別邏輯

**修改前**：
```typescript
if (replyToText.includes('💬 回覆 #')) {
  const match = replyToText.match(/💬 回覆 #([A-Z0-9]+)：/);
  ...
}
```

**修改後**：
```typescript
if (replyToText.includes('💬 回覆')) {
  // Support both old format (💬 回覆 #ID：) and new format (💬 回覆對話 ID)
  const match = replyToText.match(/💬 回覆(?:對話)?\s*#?([A-Z0-9]+)[：]?/);
  ...
}
```

**影響文件**：`src/router.ts` (第 270-279 行)

### 向後兼容
✅ 新的正則表達式同時支持：
- 舊格式：`💬 回覆 #1122DDIH：`
- 新格式：`💬 回覆對話 1122DDIH`

---

## 🎯 效果

### ✅ 解決的問題
1. ✅ 用戶點擊 ForceReply 訊息不會進入搜索模式
2. ✅ 輸入框保持可見
3. ✅ 用戶體驗流暢

### ✅ 保留的功能
1. ✅ 歷史記錄標題仍使用 `#1122DDIH`（視覺識別度）
2. ✅ 新訊息通知仍使用 `#1122DDIH`（保持一致性）
3. ✅ 用戶仍可點擊這些 `#` 進行搜索（有用的功能）

---

## 📊 測試結果

### Linter 檢查
- ✅ **0 錯誤**
- ✅ 只有原本就存在的警告（與本次修改無關）

### 向後兼容測試
- ✅ 舊格式的 ForceReply 訊息仍可識別
- ✅ 新格式的 ForceReply 訊息正確識別

---

## 🚀 部署建議

### 測試重點
1. **點擊回覆按鈕**
   - 應該看到 `💬 回覆對話 1122DDIH`
   - 點擊後不會進入搜索模式

2. **發送回覆**
   - 長按 ForceReply 訊息選擇「回覆」
   - 輸入內容後發送
   - 確認訊息正確發送到對話

3. **歷史記錄**
   - 確認歷史記錄標題仍顯示 `💬 與 #1122DDIH 的對話記錄`
   - 點擊 `#1122DDIH` 仍可進入搜索模式（預期行為）

---

## 📝 修改統計

| 文件 | 修改行數 | 風險等級 |
|------|---------|---------|
| `message_forward.ts` | 1 行 | ⭐ 極低 |
| `router.ts` | 10 行 | ⭐⭐ 低 |

**總計**：2 個文件，11 行修改

---

## 🎨 設計理念

### 為什麼不全局移除 `#`？

1. **視覺識別度**
   - `#1122DDIH` 看起來像「代號」，科技感強
   - 用戶已習慣這個格式

2. **搜索功能有用**
   - 在歷史記錄或通知中點擊 `#` 可以快速搜索
   - 這是一個 **feature**，不是 bug

3. **只在輸入狀態移除**
   - ForceReply 是輸入狀態，不應該觸發搜索
   - 其他地方保留 `#` 是合理的

---

## ✅ 驗收標準

- [x] ForceReply 訊息不包含 `#`
- [x] Router 正確識別新舊格式
- [x] Linter 檢查通過（0 錯誤）
- [x] 向後兼容（舊格式仍可識別）
- [x] 歷史記錄標題保留 `#`
- [x] 新訊息通知保留 `#`

---

**修改完成！準備部署到 Staging 測試。**

