# åœ‹æ——é¡¯ç¤ºåŠŸèƒ½è¨­è¨ˆï¼ˆæ··åˆæ–¹æ¡ˆï¼‰

**ç‰ˆæœ¬**ï¼šv2.0 - é»˜èªæ¨æ¸¬ + ä»»å‹™ç¢ºèª  
**å‰µå»ºæ™‚é–“**ï¼š2025-11-21  
**ç‹€æ…‹**ï¼šè¨­è¨ˆéšæ®µï¼Œå¾…å¯¦æ–½

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

åœ¨ç”¨æˆ¶æš±ç¨±å‰é¡¯ç¤ºåœ‹æ—— Emojiï¼Œæ¡ç”¨ã€Œé»˜èªæ¨æ¸¬ + ä»»å‹™ç¢ºèªã€çš„æ··åˆæ–¹æ¡ˆï¼š
1. è¨»å†Šæ™‚æ ¹æ“š `language_code` è‡ªå‹•è¨­ç½®é»˜èªåœ‹æ——
2. é€šéæ–°æ‰‹ä»»å‹™è®“ç”¨æˆ¶ç¢ºèª/ä¿®æ­£åœ‹å®¶
3. ç„¡æ³•åˆ¤æ–·æ™‚ä½¿ç”¨ ğŸ‡ºğŸ‡³ï¼ˆè¯åˆåœ‹æ——ï¼‰
4. ç”¨æˆ¶å¯éš¨æ™‚åœ¨è¨­ç½®ä¸­ä¿®æ”¹

---

## ğŸ¯ æ ¸å¿ƒé‚è¼¯

```
è¨»å†Š â†’ è‡ªå‹•è¨­ç½®é»˜èªåœ‹æ——ï¼ˆåŸºæ–¼ language_codeï¼‰
  â†“
å®ŒæˆåŸºæœ¬è³‡æ–™ â†’ è§¸ç™¼ã€Œç¢ºèªåœ‹å®¶ã€ä»»å‹™
  â†“
ç”¨æˆ¶é¸æ“‡ï¼š
  - âœ… æ­£ç¢º â†’ ç¢ºèªï¼Œç²å¾— +1 ç“¶å­
  - âŒ ä¸æ­£ç¢º â†’ é¸æ“‡æ­£ç¢ºåœ‹å®¶ï¼Œç²å¾— +1 ç“¶å­
  - ğŸŒ è¯åˆåœ‹æ—— â†’ ä¸é€éœ²åœ‹å®¶ï¼Œç²å¾— +1 ç“¶å­
  â†“
è³‡æ–™å¡é¡¯ç¤ºç¢ºèªå¾Œçš„åœ‹æ——
```

---

## âœ… æ–¹æ¡ˆå„ªå‹¢

### **å°æ¯”å…¶ä»–æ–¹æ¡ˆ**

| æ–¹æ¡ˆ | æº–ç¢ºåº¦ | ç”¨æˆ¶é«”é©— | éš±ç§ | å¯¦æ–½é›£åº¦ |
|------|--------|----------|------|----------|
| **ç´” language_code** | â­â­â˜†â˜†â˜† | â­â­â­â­â˜† | âœ… | â­â˜†â˜†â˜†â˜† |
| **ç”¨æˆ¶ä¸»å‹•é¸æ“‡** | â­â­â­â­â­ | â­â­â­â˜†â˜† | âœ… | â­â­â­â˜†â˜† |
| **æ··åˆæ–¹æ¡ˆï¼ˆæ¨è–¦ï¼‰** | â­â­â­â­â˜† | â­â­â­â­â­ | âœ… | â­â­â­â˜†â˜† |

### **æ ¸å¿ƒå„ªå‹¢**

- âœ… **è‡ªå‹•åŒ–**ï¼šè¨»å†Šæ™‚è‡ªå‹•è¨­ç½®ï¼Œç„¡éœ€é¡å¤–æ­¥é©Ÿ
- âœ… **æº–ç¢ºåº¦é«˜**ï¼šé€šéä»»å‹™è®“ç”¨æˆ¶ç¢ºèª/ä¿®æ­£
- âœ… **ç”¨æˆ¶å‹å¥½**ï¼šæ‰€æœ‰äººéƒ½æœ‰åœ‹æ——ï¼ˆé»˜èªæˆ–ç¢ºèªå¾Œï¼‰
- âœ… **éš±ç§ä¿è­·**ï¼šå¯é¸æ“‡è¯åˆåœ‹æ——ï¼ˆä¸é€éœ²åœ‹å®¶ï¼‰
- âœ… **æ¿€å‹µæ©Ÿåˆ¶**ï¼šç¢ºèªåœ‹å®¶ç²å¾—ç“¶å­çå‹µ
- âœ… **ç¬¦åˆ GDPR**ï¼šä¸æ”¶é›† IPï¼Œç”¨æˆ¶å¯æ§

### **è§£æ±ºçš„å•é¡Œ**

- âœ… **èªè¨€ â‰  åœ‹å®¶**ï¼šç”¨æˆ¶å¯ä»¥ä¿®æ­£ï¼ˆå¦‚ä¸­åœ‹ç”¨æˆ¶ç”¨è‹±æ–‡ç‰ˆï¼‰
- âœ… **éš±ç§è€ƒé‡**ï¼šå¯é¸æ“‡è¯åˆåœ‹æ——
- âœ… **ç„¡æ³•åˆ¤æ–·**ï¼šé»˜èªä½¿ç”¨è¯åˆåœ‹æ——
- âœ… **ç”¨æˆ¶åƒèˆ‡**ï¼šé€šéä»»å‹™ç³»çµ±å¼•å°ç”¨æˆ¶ç¢ºèª

---

## ğŸ“Š æ•¸æ“šåº«è¨­è¨ˆ

### **Migration: 0045_add_country_to_users.sql**

```sql
-- æ·»åŠ åœ‹å®¶ç›¸é—œæ¬„ä½åˆ° users è¡¨
ALTER TABLE users 
ADD COLUMN country_code TEXT DEFAULT NULL,           -- åœ‹å®¶ä»£ç¢¼ (TW, US, JP, UN, etc.)
ADD COLUMN country_code_source TEXT DEFAULT 'auto',  -- ä¾†æºï¼š'auto' æˆ– 'manual'
ADD COLUMN country_confirmed INTEGER DEFAULT 0;      -- æ˜¯å¦å·²ç¢ºèªï¼š0ï¼ˆæœªç¢ºèªï¼‰1ï¼ˆå·²ç¢ºèªï¼‰

-- å‰µå»ºç´¢å¼•
CREATE INDEX idx_users_country_code ON users(country_code);
CREATE INDEX idx_users_country_confirmed ON users(country_confirmed);
```

### **æ¬„ä½èªªæ˜**

| æ¬„ä½ | é¡å‹ | èªªæ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| `country_code` | TEXT | ISO 3166-1 alpha-2 åœ‹å®¶ä»£ç¢¼ | `TW`, `US`, `JP`, `UN` |
| `country_code_source` | TEXT | ä¾†æºï¼š`auto`ï¼ˆè‡ªå‹•æ¨æ¸¬ï¼‰æˆ– `manual`ï¼ˆç”¨æˆ¶ç¢ºèªï¼‰ | `auto`, `manual` |
| `country_confirmed` | INTEGER | æ˜¯å¦å·²ç¢ºèªï¼š`0`ï¼ˆæœªç¢ºèªï¼‰`1`ï¼ˆå·²ç¢ºèªï¼‰ | `0`, `1` |

---

## ğŸ”§ æŠ€è¡“å¯¦ç¾

### **1. è¨»å†Šæ™‚è‡ªå‹•è¨­ç½®**

**æ–‡ä»¶**ï¼š`src/telegram/handlers/start.ts`

```typescript
import { getCountryCodeFromLanguage } from '~/utils/country_flag';

// å¾ language_code æ¨æ¸¬åœ‹å®¶
const languageCode = message.from!.language_code || null;
const countryCode = getCountryCodeFromLanguage(languageCode) || 'UN'; // ç„¡æ³•åˆ¤æ–·ç”¨ UN

// å‰µå»ºç”¨æˆ¶
await createUser(db, {
  telegram_id: telegramId,
  language_pref: languageCode || 'zh-TW',
  country_code: countryCode,           // è‡ªå‹•è¨­ç½®
  country_code_source: 'auto',         // æ¨™è¨˜ç‚ºè‡ªå‹•
  country_confirmed: 0,                // æœªç¢ºèª
  // ... å…¶ä»–æ¬„ä½
});
```

---

### **2. æ–°æ‰‹ä»»å‹™ï¼šç¢ºèªåœ‹å®¶**

#### **æ·»åŠ ä»»å‹™å®šç¾©**

**æ–‡ä»¶**ï¼š`src/domain/missions.ts`

```typescript
export const MISSION_DEFINITIONS = [
  // ... ç¾æœ‰ä»»å‹™ ...
  
  {
    id: 'task_confirm_country',
    category: 'profile',
    name: 'ğŸŒ ç¢ºèªä½ çš„åœ‹å®¶/åœ°å€',
    description: 'è®“å…¶ä»–ç”¨æˆ¶æ›´äº†è§£ä½ ',
    reward_amount: 1,          // çå‹µ 1 å€‹ç“¶å­
    reward_type: 'daily',      // ç•¶å¤©æœ‰æ•ˆï¼ˆä¸€æ¬¡æ€§è¿½åŠ ï¼‰
    sort_order: 4,             // åœ¨ã€Œè¨­å®šåœ°å€ã€ä¹‹å¾Œ
  },
];
```

#### **è§¸ç™¼ç¢ºèªæµç¨‹**

**æ–‡ä»¶**ï¼š`src/telegram/handlers/onboarding_complete.ts`

```typescript
// å®ŒæˆåŸºæœ¬è³‡æ–™å¾Œ
if (!user.country_confirmed) {
  await showCountryConfirmation(telegram, chatId, user);
}
```

---

### **3. ç¢ºèª UI**

**æ–‡ä»¶**ï¼š`src/telegram/handlers/country_confirmation.ts`

```typescript
import type { Env } from '~/types';
import { createTelegramService } from '~/services/telegram';
import { createDatabaseClient } from '~/db/client';
import { getCountryFlagEmoji, getCountryName } from '~/utils/country_flag';
import { completeMission } from '~/domain/missions';

/**
 * Show country confirmation dialog
 */
export async function showCountryConfirmation(
  telegram: TelegramService,
  chatId: number,
  user: User
): Promise<void> {
  const currentFlag = getCountryFlagEmoji(user.country_code || 'UN');
  const currentCountry = getCountryName(user.country_code || 'UN');
  
  const message = 
    `ğŸŒ **ç¢ºèªä½ çš„åœ‹å®¶/åœ°å€**\n\n` +
    `æˆ‘å€‘æ ¹æ“šä½ çš„èªè¨€è¨­ç½®ï¼Œæ¨æ¸¬ä½ ä¾†è‡ªï¼š\n` +
    `${currentFlag} **${currentCountry}**\n\n` +
    `é€™æ­£ç¢ºå—ï¼Ÿ\n\n` +
    `ğŸ’¡ é€™å°‡é¡¯ç¤ºåœ¨ä½ çš„è³‡æ–™å¡ä¸Šï¼Œè®“å…¶ä»–ç”¨æˆ¶æ›´äº†è§£ä½ ã€‚\n` +
    `ğŸ‰ ç¢ºèªå¾Œå¯ç²å¾— +1 ç“¶å­çå‹µï¼`;
  
  await telegram.sendMessageWithButtons(chatId, message, [
    [
      { text: 'âœ… æ­£ç¢º', callback_data: 'country_confirm_yes' },
      { text: 'âŒ ä¸æ­£ç¢º', callback_data: 'country_select' },
    ],
    [
      { text: 'ğŸ‡ºğŸ‡³ ä½¿ç”¨è¯åˆåœ‹æ——', callback_data: 'country_confirm_un' },
    ],
  ]);
}

/**
 * Handle country confirmation
 */
export async function handleCountryConfirm(
  callbackQuery: any,
  action: string,
  env: Env
): Promise<void> {
  const db = createDatabaseClient(env.DB);
  const telegram = createTelegramService(env);
  const telegramId = callbackQuery.from.id.toString();
  const chatId = callbackQuery.message!.chat.id;
  
  if (action === 'yes') {
    // ç¢ºèªç•¶å‰åœ‹å®¶
    await db.d1
      .prepare(`
        UPDATE users 
        SET country_confirmed = 1,
            country_code_source = 'manual'
        WHERE telegram_id = ?
      `)
      .bind(telegramId)
      .run();
    
    // å®Œæˆä»»å‹™ï¼Œç²å¾—çå‹µ
    await completeUserTask(db, telegramId, 'task_confirm_country');
    
    await telegram.answerCallbackQuery(callbackQuery.id, 'âœ… å·²ç¢ºèªï¼ç²å¾— 1 å€‹ç“¶å­');
    await telegram.deleteMessage(chatId, callbackQuery.message!.message_id);
    await telegram.sendMessage(
      chatId,
      'âœ… **åœ‹å®¶å·²ç¢ºèªï¼**\n\nğŸ‰ ç²å¾— +1 ç“¶å­ï¼ˆç•¶å¤©æœ‰æ•ˆï¼‰\n\nç¹¼çºŒæ¢ç´¢æ›´å¤šåŠŸèƒ½å§ï¼'
    );
  } else if (action === 'un') {
    // ä½¿ç”¨è¯åˆåœ‹æ——
    await db.d1
      .prepare(`
        UPDATE users 
        SET country_code = 'UN',
            country_confirmed = 1,
            country_code_source = 'manual'
        WHERE telegram_id = ?
      `)
      .bind(telegramId)
      .run();
    
    await completeUserTask(db, telegramId, 'task_confirm_country');
    
    await telegram.answerCallbackQuery(callbackQuery.id, 'âœ… å·²è¨­ç½®ç‚ºè¯åˆåœ‹æ——');
    await telegram.deleteMessage(chatId, callbackQuery.message!.message_id);
    await telegram.sendMessage(
      chatId,
      'ğŸ‡ºğŸ‡³ **å·²è¨­ç½®ç‚ºè¯åˆåœ‹æ——**\n\nğŸ‰ ç²å¾— +1 ç“¶å­ï¼ˆç•¶å¤©æœ‰æ•ˆï¼‰'
    );
  }
}
```

---

### **4. åœ‹å®¶é¸æ“‡å™¨**

**æ–‡ä»¶**ï¼š`src/telegram/handlers/country_selection.ts`

```typescript
/**
 * Show country selection menu
 */
export async function showCountrySelection(
  telegram: TelegramService,
  chatId: number
): Promise<void> {
  const message = 
    `ğŸŒ **è«‹é¸æ“‡ä½ çš„åœ‹å®¶/åœ°å€**\n\n` +
    `ğŸ’¡ é€™å°‡é¡¯ç¤ºåœ¨ä½ çš„è³‡æ–™å¡ä¸Š\n` +
    `ğŸ‡ºğŸ‡³ å¦‚æœæ‰¾ä¸åˆ°ï¼Œå¯ä»¥é¸æ“‡ã€Œè¯åˆåœ‹æ——ã€`;
  
  // å¸¸ç”¨åœ‹å®¶
  const popularCountries = [
    [
      { text: 'ğŸ‡¹ğŸ‡¼ å°ç£', callback_data: 'country_set_TW' },
      { text: 'ğŸ‡¨ğŸ‡³ ä¸­åœ‹', callback_data: 'country_set_CN' },
      { text: 'ğŸ‡­ğŸ‡° é¦™æ¸¯', callback_data: 'country_set_HK' },
    ],
    [
      { text: 'ğŸ‡ºğŸ‡¸ ç¾åœ‹', callback_data: 'country_set_US' },
      { text: 'ğŸ‡¯ğŸ‡µ æ—¥æœ¬', callback_data: 'country_set_JP' },
      { text: 'ğŸ‡°ğŸ‡· éŸ“åœ‹', callback_data: 'country_set_KR' },
    ],
    [
      { text: 'ğŸ‡¬ğŸ‡§ è‹±åœ‹', callback_data: 'country_set_GB' },
      { text: 'ğŸ‡«ğŸ‡· æ³•åœ‹', callback_data: 'country_set_FR' },
      { text: 'ğŸ‡©ğŸ‡ª å¾·åœ‹', callback_data: 'country_set_DE' },
    ],
    [
      { text: 'ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡', callback_data: 'country_set_SG' },
      { text: 'ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº', callback_data: 'country_set_MY' },
      { text: 'ğŸ‡¹ğŸ‡­ æ³°åœ‹', callback_data: 'country_set_TH' },
    ],
    [
      { text: 'ğŸ‡¦ğŸ‡º æ¾³æ´²', callback_data: 'country_set_AU' },
      { text: 'ğŸ‡¨ğŸ‡¦ åŠ æ‹¿å¤§', callback_data: 'country_set_CA' },
      { text: 'ğŸ‡³ğŸ‡¿ ç´è¥¿è˜­', callback_data: 'country_set_NZ' },
    ],
    [
      { text: 'ğŸŒ æŸ¥çœ‹æ›´å¤š', callback_data: 'country_show_all' },
      { text: 'ğŸ‡ºğŸ‡³ è¯åˆåœ‹æ——', callback_data: 'country_set_UN' },
    ],
  ];
  
  await telegram.sendMessageWithButtons(chatId, message, popularCountries);
}

/**
 * Handle country selection
 */
export async function handleCountrySet(
  callbackQuery: any,
  countryCode: string,
  env: Env
): Promise<void> {
  const db = createDatabaseClient(env.DB);
  const telegram = createTelegramService(env);
  const telegramId = callbackQuery.from.id.toString();
  const chatId = callbackQuery.message!.chat.id;
  
  // è¨­ç½®åœ‹å®¶
  await db.d1
    .prepare(`
      UPDATE users 
      SET country_code = ?,
          country_confirmed = 1,
          country_code_source = 'manual'
      WHERE telegram_id = ?
    `)
    .bind(countryCode, telegramId)
    .run();
  
  // å®Œæˆä»»å‹™
  await completeUserTask(db, telegramId, 'task_confirm_country');
  
  const flag = getCountryFlagEmoji(countryCode);
  const countryName = getCountryName(countryCode);
  
  await telegram.answerCallbackQuery(callbackQuery.id, `âœ… å·²è¨­ç½®ç‚º ${flag} ${countryName}`);
  await telegram.deleteMessage(chatId, callbackQuery.message!.message_id);
  await telegram.sendMessage(
    chatId,
    `${flag} **å·²è¨­ç½®ç‚º ${countryName}**\n\nğŸ‰ ç²å¾— +1 ç“¶å­ï¼ˆç•¶å¤©æœ‰æ•ˆï¼‰`
  );
}
```

---

### **5. å·¥å…·å‡½æ•¸æ›´æ–°**

**æ–‡ä»¶**ï¼š`src/utils/country_flag.ts`

```typescript
/**
 * Get country name from country code
 */
export function getCountryName(countryCode: string): string {
  const countryNames: Record<string, string> = {
    'TW': 'å°ç£',
    'CN': 'ä¸­åœ‹',
    'HK': 'é¦™æ¸¯',
    'MO': 'æ¾³é–€',
    'SG': 'æ–°åŠ å¡',
    'US': 'ç¾åœ‹',
    'GB': 'è‹±åœ‹',
    'JP': 'æ—¥æœ¬',
    'KR': 'éŸ“åœ‹',
    'FR': 'æ³•åœ‹',
    'DE': 'å¾·åœ‹',
    'IT': 'æ„å¤§åˆ©',
    'ES': 'è¥¿ç­ç‰™',
    'PT': 'è‘¡è„ç‰™',
    'BR': 'å·´è¥¿',
    'MX': 'å¢¨è¥¿å“¥',
    'AR': 'é˜¿æ ¹å»·',
    'CL': 'æ™ºåˆ©',
    'CO': 'å“¥å€«æ¯”äº',
    'RU': 'ä¿„ç¾…æ–¯',
    'UA': 'çƒå…‹è˜­',
    'PL': 'æ³¢è˜­',
    'TR': 'åœŸè€³å…¶',
    'SA': 'æ²™ç‰¹é˜¿æ‹‰ä¼¯',
    'AE': 'é˜¿è¯é…‹',
    'EG': 'åŸƒåŠ',
    'TH': 'æ³°åœ‹',
    'VN': 'è¶Šå—',
    'ID': 'å°å°¼',
    'MY': 'é¦¬ä¾†è¥¿äº',
    'PH': 'è²å¾‹è³“',
    'IN': 'å°åº¦',
    'PK': 'å·´åŸºæ–¯å¦',
    'BD': 'å­ŸåŠ æ‹‰',
    'AU': 'æ¾³æ´²',
    'NZ': 'ç´è¥¿è˜­',
    'CA': 'åŠ æ‹¿å¤§',
    'ZA': 'å—é',
    'IL': 'ä»¥è‰²åˆ—',
    'IR': 'ä¼Šæœ—',
    'IQ': 'ä¼Šæ‹‰å…‹',
    'UN': 'è¯åˆåœ‹',
  };
  
  return countryNames[countryCode] || countryCode;
}

/**
 * Format nickname with country flag prefix
 */
export function formatNicknameWithFlag(
  nickname: string,
  countryCode: string | null | undefined
): string {
  if (!countryCode) {
    return `ğŸ‡ºğŸ‡³ ${nickname}`; // é»˜èªè¯åˆåœ‹æ——
  }
  
  const flag = getCountryFlagEmoji(countryCode);
  return `${flag} ${nickname}`;
}
```

---

## ğŸ® ç”¨æˆ¶é«”é©—æµç¨‹

### **å ´æ™¯ 1ï¼šå°ç£ç”¨æˆ¶ï¼ˆèªè¨€è¨­ç½®æ­£ç¢ºï¼‰**

```
1. è¨»å†Šï¼šlanguage_code = 'zh-TW' â†’ country_code = 'TW' ğŸ‡¹ğŸ‡¼
2. å®ŒæˆåŸºæœ¬è³‡æ–™å¾Œï¼š

   ğŸŒ ç¢ºèªä½ çš„åœ‹å®¶/åœ°å€
   
   æˆ‘å€‘æ ¹æ“šä½ çš„èªè¨€è¨­ç½®ï¼Œæ¨æ¸¬ä½ ä¾†è‡ªï¼š
   ğŸ‡¹ğŸ‡¼ å°ç£
   
   é€™æ­£ç¢ºå—ï¼Ÿ
   
   [âœ… æ­£ç¢º]  [âŒ ä¸æ­£ç¢º]
   [ğŸ‡ºğŸ‡³ ä½¿ç”¨è¯åˆåœ‹æ——]

3. é»æ“Šã€Œâœ… æ­£ç¢ºã€
4. âœ… å·²ç¢ºèªï¼ç²å¾— +1 ç“¶å­
5. è³‡æ–™å¡é¡¯ç¤ºï¼šğŸ‡¹ğŸ‡¼ å¼µ**
```

---

### **å ´æ™¯ 2ï¼šä¸­åœ‹ç”¨æˆ¶ä½¿ç”¨è‹±æ–‡ç‰ˆ**

```
1. è¨»å†Šï¼šlanguage_code = 'en-US' â†’ country_code = 'US' ğŸ‡ºğŸ‡¸
2. å®ŒæˆåŸºæœ¬è³‡æ–™å¾Œï¼š

   ğŸŒ ç¢ºèªä½ çš„åœ‹å®¶/åœ°å€
   
   æˆ‘å€‘æ ¹æ“šä½ çš„èªè¨€è¨­ç½®ï¼Œæ¨æ¸¬ä½ ä¾†è‡ªï¼š
   ğŸ‡ºğŸ‡¸ ç¾åœ‹
   
   é€™æ­£ç¢ºå—ï¼Ÿ
   
   [âœ… æ­£ç¢º]  [âŒ ä¸æ­£ç¢º]
   [ğŸ‡ºğŸ‡³ ä½¿ç”¨è¯åˆåœ‹æ——]

3. é»æ“Šã€ŒâŒ ä¸æ­£ç¢ºã€
4. é¡¯ç¤ºåœ‹å®¶é¸æ“‡å™¨ï¼š

   ğŸŒ è«‹é¸æ“‡ä½ çš„åœ‹å®¶/åœ°å€
   
   [ğŸ‡¹ğŸ‡¼ å°ç£]  [ğŸ‡¨ğŸ‡³ ä¸­åœ‹]  [ğŸ‡­ğŸ‡° é¦™æ¸¯]
   [ğŸ‡ºğŸ‡¸ ç¾åœ‹]  [ğŸ‡¯ğŸ‡µ æ—¥æœ¬]  [ğŸ‡°ğŸ‡· éŸ“åœ‹]
   ...

5. é¸æ“‡ã€ŒğŸ‡¨ğŸ‡³ ä¸­åœ‹ã€
6. ğŸ‡¨ğŸ‡³ å·²è¨­ç½®ç‚ºä¸­åœ‹ï¼ç²å¾— +1 ç“¶å­
7. è³‡æ–™å¡é¡¯ç¤ºï¼šğŸ‡¨ğŸ‡³ æ**
```

---

### **å ´æ™¯ 3ï¼šä¸æƒ³é€éœ²åœ‹å®¶çš„ç”¨æˆ¶**

```
1. è¨»å†Šï¼šlanguage_code = 'ja' â†’ country_code = 'JP' ğŸ‡¯ğŸ‡µ
2. å®ŒæˆåŸºæœ¬è³‡æ–™å¾Œï¼š

   ğŸŒ ç¢ºèªä½ çš„åœ‹å®¶/åœ°å€
   
   æˆ‘å€‘æ ¹æ“šä½ çš„èªè¨€è¨­ç½®ï¼Œæ¨æ¸¬ä½ ä¾†è‡ªï¼š
   ğŸ‡¯ğŸ‡µ æ—¥æœ¬
   
   é€™æ­£ç¢ºå—ï¼Ÿ
   
   [âœ… æ­£ç¢º]  [âŒ ä¸æ­£ç¢º]
   [ğŸ‡ºğŸ‡³ ä½¿ç”¨è¯åˆåœ‹æ——]

3. é»æ“Šã€ŒğŸ‡ºğŸ‡³ ä½¿ç”¨è¯åˆåœ‹æ——ã€
4. ğŸ‡ºğŸ‡³ å·²è¨­ç½®ç‚ºè¯åˆåœ‹æ——ï¼ç²å¾— +1 ç“¶å­
5. è³‡æ–™å¡é¡¯ç¤ºï¼šğŸ‡ºğŸ‡³ ç”°ä¸­**
```

---

## ğŸ“‹ å¯¦æ–½æ­¥é©Ÿ

### **Phase 1ï¼šåŸºç¤åŠŸèƒ½**
1. [ ] æ›´æ–° `src/utils/country_flag.ts` å·¥å…·å‡½æ•¸
   - æ·»åŠ  `getCountryName()` å‡½æ•¸
   - æ›´æ–° `formatNicknameWithFlag()` é‚è¼¯
2. [ ] å‰µå»ºæ•¸æ“šåº« Migrationï¼ˆ`0045_add_country_to_users.sql`ï¼‰
3. [ ] æ›´æ–°ç”¨æˆ¶è¨»å†Šé‚è¼¯ï¼ˆ`src/telegram/handlers/start.ts`ï¼‰
   - è‡ªå‹•è¨­ç½® `country_code`
   - è¨­ç½® `country_code_source = 'auto'`
   - è¨­ç½® `country_confirmed = 0`

### **Phase 2ï¼šä»»å‹™ç³»çµ±**
4. [ ] æ·»åŠ ã€Œç¢ºèªåœ‹å®¶ã€ä»»å‹™åˆ° `src/domain/missions.ts`
5. [ ] å‰µå»º `src/telegram/handlers/country_confirmation.ts`
   - `showCountryConfirmation()` - é¡¯ç¤ºç¢ºèªå°è©±æ¡†
   - `handleCountryConfirm()` - è™•ç†ç¢ºèªæ“ä½œ
6. [ ] å‰µå»º `src/telegram/handlers/country_selection.ts`
   - `showCountrySelection()` - é¡¯ç¤ºåœ‹å®¶é¸æ“‡å™¨
   - `handleCountrySet()` - è™•ç†åœ‹å®¶è¨­ç½®
7. [ ] åœ¨ `src/router.ts` æ·»åŠ è·¯ç”±
   - `country_confirm_yes`
   - `country_confirm_un`
   - `country_select`
   - `country_set_XX`

### **Phase 3ï¼šUI é›†æˆ**
8. [ ] ä¿®æ”¹è³‡æ–™å¡é¡¯ç¤ºï¼ˆ`src/telegram/handlers/conversation_actions.ts`ï¼‰
9. [ ] ä¿®æ”¹å°è©±æ­·å²ï¼ˆ`src/services/conversation_history.ts`ï¼‰
10. [ ] ä¿®æ”¹çµ±è¨ˆé é¢ï¼ˆ`src/telegram/handlers/stats.ts`ï¼‰
11. [ ] ä¿®æ”¹é‚€è«‹åˆ—è¡¨ï¼ˆ`src/telegram/handlers/invite.ts`ï¼‰

### **Phase 4ï¼šè¨­ç½®é é¢**
12. [ ] åœ¨è¨­ç½®ä¸­æ·»åŠ ã€Œä¿®æ”¹åœ‹å®¶ã€é¸é …
13. [ ] å…è¨±ç”¨æˆ¶éš¨æ™‚ä¿®æ”¹åœ‹å®¶è¨­ç½®

### **Phase 5ï¼šæ¸¬è©¦å’Œéƒ¨ç½²**
14. [ ] ç·¨å¯«å–®å…ƒæ¸¬è©¦ï¼ˆ`tests/country_flag.test.ts`ï¼‰
15. [ ] Staging ç’°å¢ƒæ¸¬è©¦
16. [ ] Production éƒ¨ç½²

---

## ğŸ§ª æ¸¬è©¦è¨ˆåŠƒ

### **å–®å…ƒæ¸¬è©¦**

```typescript
// tests/country_flag.test.ts

describe('Country Flag - Hybrid Approach', () => {
  it('should auto-set country from language_code on registration', () => {
    const countryCode = getCountryCodeFromLanguage('zh-TW');
    expect(countryCode).toBe('TW');
  });
  
  it('should use UN flag for unknown languages', () => {
    const countryCode = getCountryCodeFromLanguage('unknown');
    expect(countryCode).toBeNull();
    
    const flag = getCountryFlagEmoji(countryCode || 'UN');
    expect(flag).toBe('ğŸ‡ºğŸ‡³');
  });
  
  it('should format nickname with flag', () => {
    expect(formatNicknameWithFlag('å¼µä¸‰', 'TW')).toBe('ğŸ‡¹ğŸ‡¼ å¼µä¸‰');
    expect(formatNicknameWithFlag('John', 'US')).toBe('ğŸ‡ºğŸ‡¸ John');
    expect(formatNicknameWithFlag('åŒ¿å', null)).toBe('ğŸ‡ºğŸ‡³ åŒ¿å');
  });
});
```

---

## ğŸ‰ é æœŸæ•ˆæœ

### **è³‡æ–™å¡**
```
ğŸ‘¤ å°æ–¹çš„è³‡æ–™å¡

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ æš±ç¨±ï¼šğŸ‡¹ğŸ‡¼ å¼µ**
ğŸ—£ï¸ èªè¨€ï¼šç¹é«”ä¸­æ–‡
ğŸ§  MBTIï¼šINFP
â­ æ˜Ÿåº§ï¼šè™•å¥³åº§
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ’¡ é€™æ˜¯åŒ¿åè³‡æ–™å¡
```

### **å°è©±æ­·å²**
```
ğŸ’¬ èˆ‡ ğŸ‡¯ğŸ‡µ ç”°ä¸­** çš„å°è©±è¨˜éŒ„

[10:30] ä½ ï¼šä½ å¥½ï¼
[10:31] å°æ–¹ï¼šã“ã‚“ã«ã¡ã¯ï¼
```

### **çµ±è¨ˆé é¢**
```
ğŸ“Š ä½ çš„çµ±è¨ˆæ•¸æ“š

ğŸ‘¥ é‚€è«‹çš„ç”¨æˆ¶ï¼š
1. ğŸ‡ºğŸ‡¸ John** (å·²æ¿€æ´»)
2. ğŸ‡°ğŸ‡· ê¹€** (å·²æ¿€æ´»)
3. ğŸ‡ºğŸ‡³ åŒ¿å** (æœªæ¿€æ´»)
```

---

## ğŸ”’ éš±ç§å’Œå®‰å…¨

### **éš±ç§ä¿è­·**
- âœ… ä¸æ”¶é›† IP åœ°å€
- âœ… ç”¨æˆ¶å¯é¸æ“‡è¯åˆåœ‹æ——ï¼ˆä¸é€éœ²åœ‹å®¶ï¼‰
- âœ… ç”¨æˆ¶å¯éš¨æ™‚ä¿®æ”¹åœ‹å®¶è¨­ç½®
- âœ… ç¬¦åˆ GDPR è¦ç¯„

### **æ•¸æ“šå®‰å…¨**
- âœ… åœ‹å®¶ä»£ç¢¼å­˜å„²åœ¨æ•¸æ“šåº«ä¸­
- âœ… ä¸èˆ‡ç¬¬ä¸‰æ–¹åˆ†äº«
- âœ… ç”¨æˆ¶å¯ä»¥åˆªé™¤æˆ–ä¿®æ”¹

---

## ğŸ“ æ–‡æª”æ›´æ–°

### **éœ€è¦æ›´æ–°çš„æ–‡æª”**
1. `doc/SPEC.md` - æ·»åŠ åœ‹æ——é¡¯ç¤ºåŠŸèƒ½èªªæ˜
2. `doc/DEVELOPMENT_STANDARDS.md` - æ·»åŠ åœ‹æ——å·¥å…·å‡½æ•¸ä½¿ç”¨è¦ç¯„
3. `doc/ONBOARDING_TUTORIAL_AND_MISSION_SYSTEM.md` - æ·»åŠ ã€Œç¢ºèªåœ‹å®¶ã€ä»»å‹™

---

## ğŸ¯ ç¸½çµ

### **æ–¹æ¡ˆç‰¹é»**
- âœ… **è‡ªå‹•åŒ– + ç”¨æˆ¶ç¢ºèª**ï¼šæœ€ä½³å¹³è¡¡
- âœ… **é«˜æº–ç¢ºåº¦**ï¼šç”¨æˆ¶ä¸»å‹•ç¢ºèª
- âœ… **ç”¨æˆ¶å‹å¥½**ï¼šæ‰€æœ‰äººéƒ½æœ‰åœ‹æ——
- âœ… **éš±ç§ä¿è­·**ï¼šå¯é¸æ“‡è¯åˆåœ‹æ——
- âœ… **æ¿€å‹µæ©Ÿåˆ¶**ï¼šç¢ºèªç²å¾—ç“¶å­

### **å¯¦æ–½é›£åº¦**
- â­â­â­â˜†â˜†ï¼ˆä¸­ç­‰ï¼‰
- éœ€è¦æ•¸æ“šåº« Migration
- éœ€è¦é›†æˆä»»å‹™ç³»çµ±
- éœ€è¦ä¿®æ”¹å¤šå€‹é¡¯ç¤ºé‚è¼¯

### **é è¨ˆæ™‚é–“**
- é–‹ç™¼ï¼š4-5 å°æ™‚
- æ¸¬è©¦ï¼š1-2 å°æ™‚
- éƒ¨ç½²ï¼š30 åˆ†é˜
- **ç¸½è¨ˆï¼š5-7 å°æ™‚**

---

**å‰µå»ºæ™‚é–“**ï¼š2025-11-21  
**ç‹€æ…‹**ï¼šè¨­è¨ˆéšæ®µï¼Œå¾…å¯¦æ–½  
**æ¨è–¦åº¦**ï¼šâ­â­â­â­â­

