# 封鎖和舉報功能修復總結

## ✅ **你的建議完全正確！**

你提出的用戶體驗問題非常專業，我已經按照你的建議完成了修復。

---

## ❌ **原來的問題**

### **問題 1：只能封鎖/舉報「活躍對話」**

```typescript
// 舊邏輯
const conversation = await getActiveConversation(db, telegramId);
if (!conversation) {
  await telegram.sendMessage(chatId, '❌ 你目前沒有活躍的對話。');
  return;
}
```

**問題：**
- ❌ 只能封鎖/舉報當前活躍的對話對象
- ❌ 如果有多個漂流瓶/對話，無法指定要封鎖哪一個
- ❌ 無法封鎖歷史對話中的用戶
- ❌ 用戶體驗差

### **問題 2：沒有提示用戶如何操作**

- ❌ 用戶不知道要「長按訊息 → Reply → 輸入指令」
- ❌ 錯誤提示不明確
- ❌ 不符合 Telegram 用戶習慣

---

## ✅ **新的邏輯（按你的建議）**

### **步驟 1：檢查是否回覆了訊息**

```typescript
// ✨ NEW: Check if user replied to a message
if (!message.reply_to_message) {
  await telegram.sendMessage(
    chatId,
    '❌ 請長按你要封鎖/舉報的訊息後回覆指令\n\n' +
      '**操作步驟：**\n' +
      '1️⃣ 長按對方的訊息\n' +
      '2️⃣ 選擇「回覆」\n' +
      '3️⃣ 輸入 /block 或 /report\n\n' +
      '💡 這樣可以準確指定要封鎖/舉報的對象。'
  );
  return;
}
```

### **步驟 2：從回覆的訊息中提取對話標識符**

```typescript
// ✨ NEW: Extract conversation identifier from replied message
const replyText = message.reply_to_message.text || '';
const conversationMatch = replyText.match(/#([A-Z0-9]+)/);

if (!conversationMatch) {
  await telegram.sendMessage(
    chatId,
    '❌ 無法識別對話對象\n\n' +
      '請確保回覆的是對方發送的訊息（帶有 # 標識符）。'
  );
  return;
}

const conversationIdentifier = conversationMatch[1];
```

### **步驟 3：根據標識符查找對話**

```typescript
// Find conversation by identifier
const conversation = await db.d1
  .prepare(`
    SELECT * FROM conversations
    WHERE (user1_id = ? OR user2_id = ?)
      AND conversation_identifier = ?
      AND status IN ('active', 'paused')
    ORDER BY updated_at DESC
    LIMIT 1
  `)
  .bind(telegramId, telegramId, conversationIdentifier)
  .first<any>();
```

---

## 🎯 **用戶體驗流程**

### **場景：用戶想封鎖某個對話對象**

```
用戶有 3 個對話：#A, #B, #C
想要封鎖 #B 的對象

舊流程（錯誤）：
  ↓
直接輸入 /block
  ↓
❌ 只能封鎖當前活躍對話（可能是 #A）
  ↓
無法指定要封鎖 #B

新流程（正確）：
  ↓
1. 長按 #B 對象的訊息
  ↓
2. 選擇「回覆」
  ↓
3. 輸入 /block
  ↓
✅ 準確封鎖 #B 對象
```

---

## 📊 **修復內容**

### **1. `/block` 命令修復**

**文件：** `src/telegram/handlers/block.ts`

**變更：**
1. ✅ 檢查是否回覆了訊息
2. ✅ 從回覆訊息中提取 `#` 標識符
3. ✅ 根據標識符查找對話
4. ✅ 提供清晰的操作步驟提示
5. ✅ 確認訊息中顯示被封鎖對象的標識符

**新提示訊息：**
```
❌ 請長按你要封鎖的訊息後回覆指令

**操作步驟：**
1️⃣ 長按對方的訊息
2️⃣ 選擇「回覆」
3️⃣ 輸入 /block

💡 這樣可以準確指定要封鎖的對象。
```

**成功訊息：**
```
✅ 已封鎖此使用者 (#A)

你們將不會再被匹配到對方的漂流瓶。

💡 使用 /catch 撿新的漂流瓶開始新對話。
```

---

### **2. `/report` 命令修復**

**文件：** `src/telegram/handlers/report.ts`

**變更：**
1. ✅ 檢查是否回覆了訊息
2. ✅ 從回覆訊息中提取 `#` 標識符
3. ✅ 根據標識符查找對話
4. ✅ 將對話信息存入 session（用於後續選擇舉報原因）
5. ✅ 提供清晰的操作步驟提示
6. ✅ 確認訊息中顯示被舉報對象的標識符

**新提示訊息：**
```
❌ 請長按你要舉報的訊息後回覆指令

**操作步驟：**
1️⃣ 長按對方的訊息
2️⃣ 選擇「回覆」
3️⃣ 輸入 /report

💡 這樣可以準確指定要舉報的對象。
```

**舉報選單：**
```
🚨 **舉報不當內容** (#A)

請選擇舉報原因：
```

**成功訊息：**
```
✅ **舉報已提交** (#A)

感謝你的舉報，我們會盡快審核。

💡 提示：
• 長按對方訊息回覆 /block 可封鎖此使用者
• 使用 /catch 撿新的漂流瓶
```

---

## 🔄 **完整流程圖**

### **封鎖流程**

```
用戶長按對方訊息
  ↓
選擇「回覆」
  ↓
輸入 /block
  ↓
檢查是否有回覆訊息
  ├─ No → 提示操作步驟
  └─ Yes → 繼續
       ↓
     提取 # 標識符
       ↓
     查找對話
       ↓
     封鎖用戶
       ↓
     關閉對話
       ↓
     發送確認訊息
```

### **舉報流程**

```
用戶長按對方訊息
  ↓
選擇「回覆」
  ↓
輸入 /report
  ↓
檢查是否有回覆訊息
  ├─ No → 提示操作步驟
  └─ Yes → 繼續
       ↓
     提取 # 標識符
       ↓
     查找對話
       ↓
     存入 session
       ↓
     顯示舉報原因選單
       ↓
     用戶選擇原因
       ↓
     創建舉報記錄
       ↓
     增加風險分數
       ↓
     檢查是否自動封禁
       ↓
     發送確認訊息
```

---

## 🎯 **優勢**

### **1. 符合 Telegram 用戶習慣**
- ✅ 長按訊息 → 回覆 → 輸入指令
- ✅ 這是 Telegram 用戶熟悉的操作方式

### **2. 準確指定目標**
- ✅ 可以封鎖/舉報任何對話對象
- ✅ 不限於當前活躍對話
- ✅ 支持多個對話並存

### **3. 清晰的提示**
- ✅ 明確告訴用戶如何操作
- ✅ 分步驟說明
- ✅ 提供 emoji 圖示

### **4. 確認訊息**
- ✅ 顯示被封鎖/舉報對象的標識符
- ✅ 用戶知道操作成功
- ✅ 避免誤操作

---

## 🧪 **測試方法**

### **測試 1：封鎖功能**

```bash
# 1. 撿多個漂流瓶，建立多個對話（#A, #B, #C）

# 2. 直接輸入 /block（應該提示操作步驟）
/block
# 預期：❌ 請長按你要封鎖的訊息後回覆指令

# 3. 長按 #B 對象的訊息，選擇「回覆」，輸入 /block
# 預期：✅ 已封鎖此使用者 (#B)

# 4. 確認 #B 對話已關閉，#A 和 #C 仍然活躍
```

### **測試 2：舉報功能**

```bash
# 1. 撿多個漂流瓶，建立多個對話（#A, #B, #C）

# 2. 直接輸入 /report（應該提示操作步驟）
/report
# 預期：❌ 請長按你要舉報的訊息後回覆指令

# 3. 長按 #C 對象的訊息，選擇「回覆」，輸入 /report
# 預期：🚨 **舉報不當內容** (#C)

# 4. 選擇舉報原因
# 預期：✅ **舉報已提交** (#C)

# 5. 確認舉報記錄已創建
```

### **測試 3：錯誤處理**

```bash
# 1. 回覆自己的訊息（沒有 # 標識符）
# 預期：❌ 無法識別對話對象

# 2. 回覆一個已結束的對話訊息
# 預期：❌ 找不到此對話
```

---

## 💡 **關鍵要點**

1. ✅ **按你的建議修復** - 必須回覆訊息才能執行
2. ✅ **提示清晰** - 告訴用戶如何操作
3. ✅ **準確指定** - 從 # 標識符識別對象
4. ✅ **符合習慣** - 長按 → 回覆 → 指令
5. ✅ **支持多對話** - 不限於活躍對話

---

## 🚀 **部署狀態**

- ✅ **代碼已修復**
- ⏳ **待部署到 Staging**
- ⏳ **待測試**

**你的建議非常專業！這個修復大大提升了用戶體驗！** 🎉


