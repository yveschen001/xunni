# 邀請功能人工測試指南

**日期：** 2025-11-17  
**測試環境：** Staging  
**Bot：** @xunni_dev_bot

---

## 🎯 測試目標

驗證邀請功能的完整流程，包括：
1. 邀請碼生成和顯示
2. 使用邀請碼註冊
3. 邀請激活（第一次丟瓶子）
4. 邀請統計更新
5. 配額獎勵計算

---

## ⚠️ 重要說明

### 邀請激活機制

**邀請不是在註冊完成時激活，而是在被邀請者第一次丟瓶子時激活！**

這是為了防止刷邀請碼的行為。只有真正使用 Bot 的用戶才會計入邀請統計。

**激活條件：**
- 被邀請者完成註冊
- 被邀請者第一次丟出漂流瓶

**激活後：**
- 邀請者的 `successful_invites` +1
- 邀請者的每日配額 +1
- 邀請者收到通知
- 被邀請者收到歡迎通知

---

## 📋 測試準備

### 需要的材料

1. **兩個 Telegram 帳號**
   - 帳號 A（邀請者）
   - 帳號 B（被邀請者）

2. **清除數據命令**
   ```
   /dev_restart
   ```
   這個命令會：
   - 清除所有用戶數據
   - 清除邀請關係
   - 自動開始註冊流程

---

## 🧪 完整測試流程

### 步驟 1：設置邀請者（帳號 A）

```
1. 帳號 A 執行：/dev_restart
   ✅ 自動開始註冊流程

2. 完成註冊流程：
   - 選擇語言（如：繁體中文）
   - 輸入暱稱（如：測試邀請者）
   - 選擇性別
   - 輸入生日
   - 選擇血型
   - 完成 MBTI 測試（可選快速或完整）
   - 通過反詐騙測試
   - 同意服務條款

3. 註冊完成後，執行：/profile
   ✅ 記下邀請碼（如：ABC123）
   ✅ 確認顯示「已激活邀請：0 / 10 人」
   ✅ 確認顯示「當前每日配額：3 個瓶子」
```

**預期結果：**
```
👤 **個人資料**

📛 暱稱：測試邀請者
🎂 年齡：25
👤 性別：男
🩸 血型：A 型
🧠 MBTI：ENTP
⭐ 星座：Capricorn
🌍 語言：zh-TW
💎 會員：一般用戶

━━━━━━━━━━━━━━━━

🎁 **邀請資訊**

📋 你的邀請碼：`ABC123`
✅ 已激活邀請：0 / 10 人
⏳ 待激活邀請：0 人
📈 轉化率：0%
📦 當前每日配額：3 個瓶子

💡 每成功邀請 1 人，每日配額 +1

━━━━━━━━━━━━━━━━

💡 提示：
• 使用 /profile_card 查看完整資料卡片
• 使用 /mbti 重新測驗或修改 MBTI
• 使用 /vip 升級 VIP 會員
• 使用 /stats 查看統計數據

🏠 返回主選單：/menu

[📤 分享邀請碼] [✏️ 編輯資料]
```

---

### 步驟 2：被邀請者註冊（帳號 B）

```
1. 帳號 B 執行：/start ABC123
   （替換 ABC123 為實際邀請碼）
   ✅ 系統識別邀請碼
   ✅ 顯示歡迎訊息

2. 完成註冊流程：
   - 選擇語言
   - 輸入暱稱（如：測試被邀請者）
   - 選擇性別
   - 輸入生日
   - 選擇血型
   - 完成 MBTI 測試
   - 通過反詐騙測試
   - 同意服務條款

3. 註冊完成後，執行：/profile
   ✅ 確認顯示邀請者信息（如果實現了的話）
```

**預期結果：**
```
🎁 好友 測試邀請者 邀請你加入 XunNi！

歡迎使用 XunNi 漂流瓶！🍾

請選擇你的語言：
[🇹🇼 繁體中文] [🇺🇸 English]
...
```

---

### 步驟 3：⚠️ 關鍵步驟 - 被邀請者丟第一個瓶子（帳號 B）

**這是激活邀請的關鍵步驟！**

```
1. 帳號 B 執行：/throw
   ✅ 進入丟瓶子流程

2. 輸入瓶子內容（至少 10 個字）：
   「你好！我是新用戶，很高興認識大家！」

3. 確認丟出瓶子
   ✅ 系統顯示「漂流瓶已丟出」
   ✅ 系統自動激活邀請關係
```

**預期結果（帳號 B）：**
```
✅ 漂流瓶已丟出！

你的漂流瓶正在大海中漂流...
等待有緣人撿起 🌊

📊 今日已丟：1/3
```

**預期結果（帳號 A - 邀請者會收到通知）：**
```
🎉 邀請成功！

你邀請的好友「測試被邀請者」已經開始使用 XunNi！

🎁 獎勵：
• 每日配額 +1（現在是 4 個/天）
• 當前已邀請：1 / 10 人

💡 繼續邀請好友，每邀請 1 人，每日配額 +1！
（免費用戶最多 +7，VIP 用戶最多 +70）

🏠 返回主選單：/menu
```

---

### 步驟 4：驗證邀請統計（帳號 A）

```
1. 帳號 A 執行：/profile
   ✅ 確認「已激活邀請：1 / 10 人」
   ✅ 確認「當前每日配額：4 個瓶子」（3 基礎 + 1 邀請獎勵）

2. 帳號 A 執行：/stats
   ✅ 確認「今日配額：4/4」
```

**預期結果（帳號 A）：**
```
👤 **個人資料**

🎁 **邀請資訊**

📋 你的邀請碼：`ABC123`
✅ 已激活邀請：1 / 10 人 ✅
⏳ 待激活邀請：0 人
📈 轉化率：100%
📦 當前每日配額：4 個瓶子 ✅

━━━━━━━━━━━━━━━━

📊 **我的統計數據**

🍾 **漂流瓶**
• 今日配額：4/4 ✅
• 已丟出：0 個
• 已撿起：0 個
```

---

### 步驟 5：測試配額實際使用（帳號 A）

```
1. 帳號 A 執行：/throw
2. 輸入瓶子內容並丟出
3. 執行：/stats
   ✅ 確認「今日配額：3/4」（已使用 1 個）

4. 重複丟瓶子，直到用完配額
5. 再次嘗試丟瓶子
   ✅ 應顯示「今日配額已用完」
```

---

### 步驟 6：測試邀請碼分享

```
1. 帳號 A 執行：/profile

2. 點擊「📤 分享邀請碼」按鈕

3. 確認分享內容：
   ✅ 包含邀請碼
   ✅ 包含邀請鏈接
   ✅ 包含說明文字
   ✅ 鏈接格式正確（https://t.me/xunni_dev_bot?start=invite_ABC123）
```

**預期分享內容：**
```
來 XunNi 一起丟漂流瓶吧！🍾 使用我的邀請碼：ABC123
```

**分享鏈接：**
```
https://t.me/xunni_dev_bot?start=invite_ABC123
```

---

### 步驟 7：測試錯誤情況

#### 7.1 無效邀請碼

```
1. 新帳號執行：/start INVALID999
   ✅ 應正常開始註冊
   ✅ 不記錄邀請關係
```

#### 7.2 自己邀請自己

```
1. 帳號 A 執行：/dev_restart
2. 帳號 A 執行：/start ABC123（自己的邀請碼）
   ✅ 應正常開始註冊
   ✅ 不記錄邀請關係（因為是自己）
```

#### 7.3 邀請碼大小寫

```
1. 新帳號執行：/start abc123（小寫）
   ✅ 應該能正確識別（邀請碼不區分大小寫）
```

---

## 📊 測試檢查清單

### 功能測試

- [ ] 邀請碼生成正確（6 位大寫字母+數字）
- [ ] 邀請碼在個人資料中正確顯示
- [ ] 使用邀請碼註冊流程正常
- [ ] 邀請關係正確記錄（但未激活）
- [ ] 被邀請者丟第一個瓶子時激活邀請
- [ ] 邀請者收到激活通知
- [ ] 邀請統計正確更新（從 0 → 1）
- [ ] 配額獎勵正確計算（從 3 → 4）
- [ ] 配額實際可用（可以丟 4 個瓶子）
- [ ] 分享按鈕正常工作
- [ ] 分享內容格式正確
- [ ] 分享鏈接可用

### 錯誤處理

- [ ] 無效邀請碼正確處理
- [ ] 自己邀請自己正確處理
- [ ] 邀請碼大小寫不敏感
- [ ] 邀請碼前後空格正確處理

### UI/UX

- [ ] 邀請信息顯示清晰
- [ ] 按鈕文字正確
- [ ] 提示信息友好
- [ ] 錯誤信息清楚
- [ ] 通知訊息及時

### 數據庫

- [ ] invites 表正確記錄
- [ ] users 表的 invited_by 正確更新
- [ ] users 表的 successful_invites 在激活時正確更新
- [ ] /dev_restart 正確清除邀請數據

---

## 🐛 已知問題

### 問題 1：`/dev_skip` 不會觸發邀請激活

**現象：**
- 使用 `/dev_skip` 快速完成註冊
- 邀請統計不會更新

**原因：**
- `/dev_skip` 只是創建用戶，跳過註冊流程
- 邀請激活需要被邀請者丟第一個瓶子

**解決方案：**
- 測試時，被邀請者必須手動丟一個瓶子
- 或者修改 `/dev_skip` 命令，自動丟一個測試瓶子

---

## 🔧 快速測試命令

### 完整測試流程（複製貼上）

```bash
# ========================================
# 帳號 A（邀請者）
# ========================================

# 1. 清除數據並註冊
/dev_restart
# 完成註冊流程...

# 2. 查看邀請碼
/profile
# 記下邀請碼，如：ABC123

# ========================================
# 帳號 B（被邀請者）
# ========================================

# 3. 使用邀請碼註冊
/start ABC123
# 完成註冊流程...

# 4. ⚠️ 關鍵步驟：丟第一個瓶子
/throw
# 輸入：你好！我是新用戶，很高興認識大家！

# ========================================
# 帳號 A（邀請者）
# ========================================

# 5. 驗證邀請統計
/profile  # 確認邀請人數 +1
/stats    # 確認配額 +1

# 6. 測試配額使用
/throw    # 應該可以丟 4 個瓶子

# ========================================
# 重置測試（需要時）
# ========================================

# 帳號 A 和 B 都執行：
/dev_restart  # 清除所有數據，重新開始
```

---

## 📝 測試報告模板

### 測試執行記錄

**測試日期：** ___________  
**測試環境：** Staging (@xunni_dev_bot)  
**測試人員：** ___________

**測試帳號：**
- 邀請者：___________
- 被邀請者：___________

**測試結果：**

| 測試項目 | 狀態 | 備註 |
|---------|------|------|
| 邀請碼生成 | ⬜ 通過 / ⬜ 失敗 | |
| 邀請碼顯示 | ⬜ 通過 / ⬜ 失敗 | |
| 使用邀請碼註冊 | ⬜ 通過 / ⬜ 失敗 | |
| 被邀請者丟瓶子 | ⬜ 通過 / ⬜ 失敗 | |
| 邀請激活 | ⬜ 通過 / ⬜ 失敗 | |
| 邀請者收到通知 | ⬜ 通過 / ⬜ 失敗 | |
| 邀請統計更新 | ⬜ 通過 / ⬜ 失敗 | |
| 配額獎勵計算 | ⬜ 通過 / ⬜ 失敗 | |
| 配額實際可用 | ⬜ 通過 / ⬜ 失敗 | |
| 分享功能 | ⬜ 通過 / ⬜ 失敗 | |
| 錯誤處理 | ⬜ 通過 / ⬜ 失敗 | |

**發現的問題：**
1. ___________
2. ___________
3. ___________

**截圖：**
- [ ] 邀請者個人資料（邀請前）
- [ ] 被邀請者註冊畫面
- [ ] 被邀請者丟瓶子畫面
- [ ] 邀請者收到通知
- [ ] 邀請者個人資料（邀請後）
- [ ] 配額使用情況

**總體評價：** ⬜ 通過 / ⬜ 需要修復

**備註：**
___________
___________
___________

---

## 💡 測試技巧

### 1. 使用 `/dev_restart` 快速重置

每次測試前，兩個帳號都執行 `/dev_restart`，確保從乾淨狀態開始。

### 2. 記錄邀請碼

測試時記下邀請碼，方便後續驗證。

### 3. 截圖保存證據

關鍵步驟都截圖保存，方便後續分析。

### 4. 測試多個邀請

如果時間允許，可以測試邀請多個用戶，驗證配額累加。

### 5. 測試配額上限

邀請 7 個用戶後，驗證配額是否達到上限（10 個瓶子/天）。

---

## 🎯 預期結果總結

### 邀請者（帳號 A）

**邀請前：**
- 已激活邀請：0 / 10 人
- 當前每日配額：3 個瓶子
- 今日配額：3/3

**邀請後（被邀請者丟瓶子後）：**
- 已激活邀請：1 / 10 人 ✅
- 當前每日配額：4 個瓶子 ✅
- 今日配額：4/4 ✅
- 收到邀請成功通知 ✅

### 被邀請者（帳號 B）

**註冊時：**
- 看到邀請者的歡迎訊息
- 正常完成註冊流程

**丟第一個瓶子後：**
- 瓶子成功丟出
- 邀請關係自動激活
- 可能收到歡迎通知（如果實現了）

---

## 📞 問題反饋

如果測試中發現問題，請記錄：
1. 問題描述
2. 重現步驟
3. 預期結果
4. 實際結果
5. 截圖或日誌

---

**最後更新：** 2025-11-17  
**文檔版本：** 1.0

