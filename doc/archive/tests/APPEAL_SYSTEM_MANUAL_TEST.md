# 申訴系統手動測試指南

**測試環境：** Staging  
**Bot：** @xunni_dev_bot  
**測試時間：** 2025-11-17  
**Version ID：** 16f34653-076a-47d4-85e7-7ee61b4fa0de

---

## 📋 測試前準備

### 1. 準備測試帳號
- **帳號 A**：測試用戶（將被封禁並提交申訴）
- **帳號 B**：管理員帳號（ID: 396943893）

### 2. 確認環境
```bash
# 確認 appeals 表已創建
pnpm wrangler d1 execute xunni-db-staging --remote --command="SELECT name FROM sqlite_master WHERE type='table' AND name='appeals';"

# 確認最新代碼已部署
# Version ID: 16f34653-076a-47d4-85e7-7ee61b4fa0de
```

---

## 🧪 測試案例

### 測試 1：未被封禁用戶提交申訴

**目的：** 驗證系統拒絕未被封禁用戶的申訴

**步驟：**
1. 使用帳號 A（未被封禁）
2. 發送命令 `/appeal`

**預期結果：**
```
✅ 你的帳號狀態正常

目前沒有任何限制，可以正常使用所有功能。
```

**驗收標準：**
- [ ] 系統正確識別用戶未被封禁
- [ ] 顯示友善的提示訊息
- [ ] 不允許提交申訴

---

### 測試 2：被封禁用戶提交申訴

**目的：** 驗證被封禁用戶可以成功提交申訴

**步驟：**
1. 手動封禁帳號 A：
   ```bash
   pnpm wrangler d1 execute xunni-db-staging --remote --command="
   UPDATE users 
   SET is_banned = 1, 
       ban_reason = '測試封禁', 
       banned_at = datetime('now'),
       banned_until = datetime('now', '+1 hour')
   WHERE telegram_id = 'YOUR_TELEGRAM_ID';
   "
   ```
2. 使用帳號 A 發送命令 `/appeal`
3. 等待系統提示
4. 輸入申訴理由：「我認為這是誤判，因為我沒有違反任何規則，請重新審核。謝謝。」

**預期結果：**
- 第一步：收到申訴提示
  ```
  📝 申訴說明

  請簡單說明你認為這是誤判的原因。我們的團隊會盡快審核你的申訴。

  💡 提示：
  • 請誠實說明情況
  • 提供相關證據或說明
  • 保持禮貌和尊重

  請直接輸入你的申訴理由：
  ```

- 第二步：收到提交成功確認
  ```
  ✅ 申訴已提交

  感謝你的申訴。我們的團隊會在 24-48 小時內審核你的情況。

  申訴編號：#1
  提交時間：2025-11-17 23:30

  💡 你可以使用 /appeal_status 查詢申訴進度
  ```

**驗收標準：**
- [ ] 申訴提示清晰友善
- [ ] 成功接收用戶輸入
- [ ] 創建申訴記錄
- [ ] 返回申訴編號
- [ ] 提供查詢方式

---

### 測試 3：申訴理由驗證

**目的：** 驗證申訴理由長度限制

**步驟：**
1. 使用帳號 A（已被封禁）
2. 發送命令 `/appeal`
3. 測試不同長度的理由：
   - 太短：「誤判」（4 字）
   - 正常：「我認為這是誤判，因為我沒有違反任何規則，請重新審核。」（30 字）
   - 太長：超過 500 字的文本

**預期結果：**
- 太短時：
  ```
  ❌ 申訴理由太短

  請提供至少 10 個字的說明，幫助我們更好地了解情況。
  ```

- 正常時：成功提交

- 太長時：
  ```
  ❌ 申訴理由太長

  請將說明控制在 500 字以內。
  ```

**驗收標準：**
- [ ] 正確驗證最小長度（10 字）
- [ ] 正確驗證最大長度（500 字）
- [ ] 錯誤提示清晰
- [ ] 允許重新輸入

---

### 測試 4：重複申訴防止

**目的：** 驗證系統防止重複申訴

**步驟：**
1. 使用帳號 A（已提交申訴）
2. 再次發送命令 `/appeal`

**預期結果：**
```
⚠️ 你已經提交過申訴

申訴編號：#1
狀態：待審核
提交時間：2025-11-17 23:30

請耐心等待審核結果。
```

**驗收標準：**
- [ ] 正確檢測到已存在的待審核申訴
- [ ] 顯示現有申訴信息
- [ ] 不允許重複提交

---

### 測試 5：查詢申訴狀態

**目的：** 驗證用戶可以查詢申訴狀態

**步驟：**
1. 使用帳號 A（已提交申訴）
2. 發送命令 `/appeal_status`

**預期結果：**
```
📋 申訴狀態

申訴編號：#1
狀態：待審核
提交時間：2025-11-17 23:30


💡 我們會盡快處理你的申訴
```

**驗收標準：**
- [ ] 正確顯示申訴編號
- [ ] 正確顯示狀態
- [ ] 正確顯示提交時間
- [ ] 多語言支援正常

---

### 測試 6：管理員查看待審核申訴

**目的：** 驗證管理員可以查看待審核申訴列表

**步驟：**
1. 使用帳號 B（管理員）
2. 發送命令 `/admin_appeals`

**預期結果：**
```
📋 待審核申訴列表

━━━━━━━━━━━━━━━━
申訴 ID: 1
用戶: 測試用戶
理由: 我認為這是誤判，因為我沒有違反任何規則，請重新審核。謝謝。
提交時間: 2025-11-17 23:30

💡 使用以下命令審核申訴：
/admin_approve <appeal_id> [備註]
/admin_reject <appeal_id> [備註]
```

**驗收標準：**
- [ ] 正確顯示待審核申訴
- [ ] 包含申訴 ID、用戶、理由、時間
- [ ] 提供審核命令說明
- [ ] 非管理員無法訪問

---

### 測試 7：管理員批准申訴

**目的：** 驗證管理員可以批准申訴並自動解封用戶

**步驟：**
1. 使用帳號 B（管理員）
2. 發送命令 `/admin_approve 1 經審核確認為誤判`
3. 檢查帳號 A 是否收到通知
4. 使用帳號 A 測試是否可以正常使用功能

**預期結果：**
- 管理員收到：
  ```
  ✅ 申訴 1 已批准，用戶已解封
  ```

- 用戶收到：
  ```
  🎉 申訴已批准

  經過審核，我們認為這確實是誤判。你的帳號限制已解除，可以正常使用所有功能了。

  感謝你的理解和配合！
  ```

- 用戶可以正常使用所有功能（/menu, /throw, /catch 等）

**驗收標準：**
- [ ] 申訴狀態更新為 'approved'
- [ ] 用戶自動解封（is_banned = 0）
- [ ] 用戶收到批准通知
- [ ] 記錄審核人和備註
- [ ] 用戶可以正常使用功能

---

### 測試 8：管理員拒絕申訴

**目的：** 驗證管理員可以拒絕申訴

**步驟：**
1. 創建新的申訴（使用另一個測試帳號或重置）
2. 使用帳號 B（管理員）
3. 發送命令 `/admin_reject 2 經審核確認原判定正確`
4. 檢查用戶是否收到通知

**預期結果：**
- 管理員收到：
  ```
  ✅ 申訴 2 已拒絕
  ```

- 用戶收到：
  ```
  ❌ 申訴未通過

  經過仔細審核，我們確認原判定正確。

  審核備註：經審核確認原判定正確

  請遵守社群規範，避免類似情況再次發生。
  ```

- 用戶仍然被封禁

**驗收標準：**
- [ ] 申訴狀態更新為 'rejected'
- [ ] 用戶仍然被封禁
- [ ] 用戶收到拒絕通知
- [ ] 顯示審核備註
- [ ] 記錄審核人和時間

---

### 測試 9：管理員查看封禁歷史

**目的：** 驗證管理員可以查看用戶的封禁歷史

**步驟：**
1. 使用帳號 B（管理員）
2. 發送命令 `/admin_bans YOUR_TELEGRAM_ID`

**預期結果：**
```
📊 用戶封禁歷史

用戶: 測試用戶
總封禁次數: 1

━━━━━━━━━━━━━━━━
ID: 1
原因: 測試封禁
風險分數: 0
開始: 2025-11-17 23:00
結束: 2025-11-18 00:00
```

**驗收標準：**
- [ ] 正確顯示用戶封禁歷史
- [ ] 包含封禁 ID、原因、風險分數、時間
- [ ] 時間格式正確
- [ ] 支援查詢特定用戶

---

### 測試 10：管理員查看最近封禁記錄

**目的：** 驗證管理員可以查看最近的封禁記錄

**步驟：**
1. 使用帳號 B（管理員）
2. 發送命令 `/admin_bans`（不帶參數）

**預期結果：**
```
📊 最近 10 條封禁記錄

ID: 1
用戶: 測試用戶
原因: 測試封禁
開始: 2025-11-17 23:00
結束: 2025-11-18 00:00

💡 使用 /admin_bans <user_id> 查看特定用戶的封禁歷史
```

**驗收標準：**
- [ ] 顯示最近 10 條記錄
- [ ] 按時間倒序排列
- [ ] 包含用戶暱稱或 ID
- [ ] 提供查詢特定用戶的提示

---

### 測試 11：多語言支援

**目的：** 驗證申訴系統的多語言支援

**步驟：**
1. 設置帳號 A 語言為英文：
   ```bash
   pnpm wrangler d1 execute xunni-db-staging --remote --command="
   UPDATE users 
   SET language_pref = 'en'
   WHERE telegram_id = 'YOUR_TELEGRAM_ID';
   "
   ```
2. 使用帳號 A 測試 `/appeal` 和 `/appeal_status`

**預期結果：**
- 申訴提示（英文）：
  ```
  📝 Appeal Explanation

  Please briefly explain why you believe this is a mistake. Our team will review your appeal as soon as possible.

  💡 Tips:
  • Be honest about the situation
  • Provide relevant evidence or explanation
  • Be polite and respectful

  Please enter your appeal reason:
  ```

- 申訴狀態（英文）：
  ```
  📋 Appeal Status

  Appeal ID: #1
  Status: Pending Review
  Submitted: 2025-11-17 23:30


  💡 We will process your appeal as soon as possible
  ```

**驗收標準：**
- [ ] 英文文案正確
- [ ] 時間格式正確（en-US）
- [ ] 狀態翻譯正確

---

## 📊 數據庫驗證

### 檢查 appeals 表記錄

```bash
# 查詢所有申訴記錄
pnpm wrangler d1 execute xunni-db-staging --remote --command="
SELECT * FROM appeals ORDER BY created_at DESC LIMIT 10;
"

# 查詢特定用戶的申訴記錄
pnpm wrangler d1 execute xunni-db-staging --remote --command="
SELECT * FROM appeals WHERE user_id = 'YOUR_TELEGRAM_ID' ORDER BY created_at DESC;
"

# 查詢待審核的申訴
pnpm wrangler d1 execute xunni-db-staging --remote --command="
SELECT * FROM appeals WHERE status = 'pending' ORDER BY created_at ASC;
"
```

**驗證項目：**
- [ ] `user_id` 正確
- [ ] `ban_id` 正確關聯
- [ ] `reason` 已記錄
- [ ] `status` 正確（pending/approved/rejected）
- [ ] `reviewed_by` 正確（審核後）
- [ ] `review_notes` 已記錄（審核後）
- [ ] `created_at` 時間正確
- [ ] `reviewed_at` 時間正確（審核後）

---

## ✅ 驗收檢查清單

### 用戶功能
- [ ] 未被封禁用戶無法提交申訴
- [ ] 被封禁用戶可以提交申訴
- [ ] 申訴理由長度驗證正確
- [ ] 防止重複申訴
- [ ] 可以查詢申訴狀態
- [ ] 收到審核結果通知
- [ ] 批准後自動解封

### 管理員功能
- [ ] 可以查看待審核申訴列表
- [ ] 可以批准申訴
- [ ] 可以拒絕申訴
- [ ] 可以查看封禁歷史
- [ ] 可以查看最近封禁記錄
- [ ] 非管理員無法訪問管理命令

### 用戶體驗
- [ ] 申訴提示清晰友善
- [ ] 錯誤提示有幫助
- [ ] 審核結果通知專業
- [ ] 多語言支援正常（zh-TW, en）

### 數據完整性
- [ ] `appeals` 表記錄正確創建
- [ ] 申訴狀態正確更新
- [ ] 審核信息完整記錄
- [ ] 時間戳記錄正確
- [ ] 用戶封禁狀態正確更新（批准後）

### 安全性
- [ ] 管理員權限檢查正常
- [ ] 防止重複申訴
- [ ] 審核記錄完整追蹤

---

## 🐛 已知問題

（測試過程中發現的問題記錄在這裡）

---

## 📝 測試結果

**測試日期：** _____________  
**測試人員：** _____________  
**測試環境：** Staging  
**Bot Version：** 16f34653-076a-47d4-85e7-7ee61b4fa0de

### 測試通過率
- 測試案例總數：11
- 通過：___
- 失敗：___
- 通過率：___%

### 問題總結
（記錄發現的問題和修復建議）

---

**維護者：** 開發團隊  
**最後更新：** 2025-11-17

