# Smoke Test 缺口分析報告

**日期**: 2025-11-19  
**目的**: 對比當前 Smoke Test 與最新功能，識別測試缺口

---

## 📊 執行摘要

### 總體評估

| 指標 | 數值 | 狀態 |
|------|------|------|
| **已實現功能** | 45+ 個命令/功能 | ✅ |
| **Smoke Test 覆蓋** | ~15 個功能 | ⚠️ |
| **測試覆蓋率** | **~33%** | 🔴 **不足** |
| **最新功能覆蓋** | **0%** | 🔴 **嚴重** |

### 關鍵發現

1. 🔴 **2025-11-19 新增功能完全未測試**
   - 新手引導教學系統（Tutorial）
   - 任務中心系統（Tasks & Missions）
   - 頻道會員驗證（Channel Membership）
   - GigaPub 廣告整合

2. 🔴 **2025-01-18 廣告系統未測試**
   - 廣告觀看流程
   - 廣告獎勵系統
   - 官方廣告系統
   - 管理員分析報表

3. 🟡 **核心功能測試不完整**
   - 對話流程（只測試了標識符，未測試完整流程）
   - MBTI 測驗（只測試了版本選擇）
   - 個人資料編輯（完全未測試）

---

## 🆕 最新功能缺口（2025-11-19）

### 1. 新手引導教學系統 ⭐⭐⭐⭐⭐

**重要性**: 🔴 **最高** - 影響新用戶首次體驗

**功能位置**: 
- `src/telegram/handlers/tutorial.ts`
- `src/domain/tutorial.ts`

**缺失測試**:

#### 基礎流程
- [ ] 註冊完成後自動觸發教學
- [ ] 教學步驟：`not_started` → `welcome` → `start_using` → `completed`
- [ ] 跳過教學功能
- [ ] 教學狀態記錄（`tutorial_step`, `tutorial_completed`）

#### 教學內容
- [ ] 歡迎頁面顯示
- [ ] 開始使用頁面顯示
- [ ] 教學完成提示

#### 教學後引導
- [ ] 點擊「丟出漂流瓶」按鈕 → 啟動 `/throw` 流程
- [ ] 點擊「撿起漂流瓶」按鈕 → 啟動 `/catch` 流程
- [ ] 點擊「查看任務」按鈕 → 顯示任務中心

#### Callback 處理
- [ ] `tutorial_next` - 下一步
- [ ] `tutorial_skip` - 跳過
- [ ] `tutorial_throw` - 丟瓶子
- [ ] `tutorial_catch` - 撿瓶子
- [ ] `tutorial_view_tasks` - 查看任務

---

### 2. 任務中心系統 ⭐⭐⭐⭐⭐

**重要性**: 🔴 **最高** - 核心留存機制

**功能位置**:
- `src/telegram/handlers/tasks.ts`
- `src/domain/task.ts`
- `src/db/queries/tasks.ts`
- `src/db/queries/user_tasks.ts`

**缺失測試**:

#### 任務中心命令
- [ ] `/tasks` - 顯示任務中心
- [ ] 任務分類顯示（個人資料、社交媒體、行為、邀請）
- [ ] 任務進度顯示（已完成/總數）
- [ ] 任務獎勵顯示（+1 瓶子）

#### 個人資料任務（3個）
- [ ] `task_interests` - 填寫興趣標籤
  - 檢測：`user.interests` 不為空
  - 獎勵：+1 瓶子（當天有效）
- [ ] `task_bio` - 完善自我介紹
  - 檢測：`user.bio.length > 0`
  - 獎勵：+1 瓶子（當天有效）
- [ ] `task_city` - 設定地區
  - 檢測：`user.city` 不為空
  - 獎勵：+1 瓶子（當天有效）

#### 社交媒體任務（1個）
- [ ] `task_join_channel` - 加入官方頻道
  - 自動檢測頻道會員資格
  - 狀態：`available` → `pending_claim` → `completed`
  - 用戶點擊「領取獎勵」按鈕
  - 再次驗證會員資格（防止立即退出）
  - 獎勵：+1 瓶子（當天有效）

#### 行為任務（3個）
- [ ] `task_first_bottle` - 丟出第一個瓶子
  - 檢測：瓶子數量 > 0
  - 獎勵：+1 瓶子（當天有效）
- [ ] `task_first_catch` - 撿起第一個瓶子
  - 檢測：撿瓶數量 > 0
  - 獎勵：+1 瓶子（當天有效）
- [ ] `task_first_conversation` - 建立第一個連接
  - 檢測：對話數量 > 0
  - 獎勵：+1 瓶子（當天有效）
  - 提示：「長按訊息 → 選擇『回覆』」

#### 邀請任務（持續性）
- [ ] `task_invite_progress` - 邀請好友
  - 每邀請 1 人 → 永久 +1 每日配額
  - 免費用戶：最多 10 人
  - VIP 用戶：最多 100 人
  - 任務完成條件：達到邀請上限

#### 任務完成通知
- [ ] 完成任務後自動發送通知
- [ ] 通知包含任務名稱和獎勵
- [ ] 提示使用 `/tasks` 查看任務中心

#### 任務獎勵計算
- [ ] 當日任務獎勵累加到配額
- [ ] 配額顯示格式：`已用/永久+任務`
- [ ] 例如：`3/5+3`（已用3，永久5，任務3）

#### 主選單整合
- [ ] `/menu` 顯示下一個未完成任務
- [ ] 點擊「下一個任務」按鈕 → 直接進入任務操作
- [ ] 例如：點擊「填寫興趣」→ 直接打開興趣編輯器

---

### 3. 頻道會員驗證系統 ⭐⭐⭐⭐

**重要性**: 🔴 **高** - 社交媒體引流

**功能位置**:
- `src/services/channel_membership_check.ts`
- `src/services/telegram.ts` (`getChatMember`)

**缺失測試**:

#### 自動檢測（Cron Job）
- [ ] 每小時執行一次（`0 * * * *`）
- [ ] 檢測所有 `task_join_channel` 狀態為 `available` 的用戶
- [ ] 調用 `telegram.getChatMember` 檢查會員資格
- [ ] 如果已加入 → 更新狀態為 `pending_claim`
- [ ] 發送通知：「檢測到你已加入官方頻道！點擊領取獎勵」

#### 手動驗證（用戶觸發）
- [ ] 用戶點擊「我已加入，領取獎勵」按鈕
- [ ] 立即檢查會員資格
- [ ] 如果已加入 → 完成任務，發放獎勵
- [ ] 如果未加入 → 提示「未檢測到你加入頻道」

#### 防作弊機制
- [ ] 領取獎勵時再次驗證會員資格
- [ ] 如果用戶已離開頻道 → 取消 `pending_claim` 狀態
- [ ] 提示「檢測到你已離開頻道，無法領取獎勵」

#### API 端點
- [ ] `/api/test/check-channel` - 手動觸發檢查（測試用）

---

### 4. GigaPub 廣告整合 ⭐⭐⭐⭐

**重要性**: 🔴 **高** - 營收關鍵

**功能位置**:
- `public/ad.html` - 廣告頁面
- `src/db/migrations/0035_insert_gigapub_provider.sql`

**缺失測試**:

#### GigaPub Script 載入
- [ ] Script URL: `https://ad.gigapub.tech/script?id=4406`
- [ ] Fallback URL: `https://ru-ad.gigapub.tech/script?id=4406`
- [ ] `window.showGiga` 可用性檢查

#### 廣告播放流程
- [ ] 用戶點擊「觀看廣告」
- [ ] 打開廣告頁面：`/ad.html?provider=gigapub&token={token}&user={userId}`
- [ ] 載入 GigaPub Script
- [ ] 調用 `window.showGiga()`
- [ ] 顯示視頻廣告
- [ ] 用戶完成觀看

#### 廣告完成回調
- [ ] 調用 `onAdComplete()`
- [ ] 發送 POST 請求到 `/api/ad/complete`
- [ ] 驗證 Token
- [ ] 發放獎勵（+1 瓶子）
- [ ] 顯示成功頁面

#### 數據庫配置
- [ ] `ad_providers` 表中有 `gigapub` 提供商
- [ ] Priority: 100（最高優先級）
- [ ] Weight: 100（100% 權重）
- [ ] `is_enabled`: 1

#### 錯誤處理
- [ ] GigaPub SDK 載入失敗
- [ ] 廣告播放失敗
- [ ] 網絡錯誤
- [ ] Token 驗證失敗

---

### 5. 智能命令提示系統 ⭐⭐⭐

**重要性**: 🟡 **中** - 用戶體驗改進

**功能位置**:
- `src/router.ts` (未知命令處理)

**缺失測試**:

#### 意圖識別
- [ ] 檢測關鍵詞：「丟」、「瓶子」、「漂流瓶」
  - 提示使用 `/throw` 命令
  - 提供快捷按鈕
- [ ] 檢測關鍵詞：「撿」、「看」、「catch」
  - 提示使用 `/catch` 命令
  - 提供快捷按鈕

#### 教學頁面提示
- [ ] 用戶在 `tutorial_step = 'start_using'` 時發送非命令消息
- [ ] 提示點擊按鈕或使用命令

#### 快捷按鈕
- [ ] 「🌊 丟出漂流瓶」按鈕
- [ ] 「🎣 撿起漂流瓶」按鈕
- [ ] 「🏠 主選單」按鈕

---

## 🔴 廣告系統缺口（2025-01-18）

### 1. 用戶廣告功能 ⭐⭐⭐⭐⭐

**重要性**: 🔴 **最高** - 營收核心

**缺失測試**:

#### 基礎命令
- [ ] `/quota` - 查看額度狀態
  - 顯示今日已用/總配額
  - 顯示廣告觀看次數
  - 顯示邀請獎勵
  - 顯示任務獎勵

#### 廣告觀看流程
- [ ] 額度用完後顯示「觀看廣告」按鈕
- [ ] 點擊按鈕 → 生成廣告 Token
- [ ] 打開廣告頁面（`/ad.html` 或 `/ad-test.html`）
- [ ] 廣告頁面載入測試（15秒倒計時或真實廣告）
- [ ] 完成廣告 → 額度 +1
- [ ] 返回 Bot 確認獎勵

#### 每日限制
- [ ] 免費用戶：每日最多 20 次廣告
- [ ] VIP 用戶：無廣告
- [ ] 超過限制後提示升級 VIP

#### 官方廣告系統
- [ ] 點擊「查看官方廣告」按鈕
- [ ] 顯示官方廣告列表
- [ ] 點擊廣告 → 獲得永久額度獎勵
- [ ] 一次性展示機制（不重複顯示）

---

### 2. 管理員分析報表 ⭐⭐⭐⭐

**重要性**: 🔴 **高** - 運營決策依據

**缺失測試**:

#### 超級管理員命令
- [ ] `/analytics` - 每日運營報表
  - 新用戶數
  - 活躍用戶數
  - 漂流瓶統計
  - 對話統計
  - VIP 轉化率
  
- [ ] `/ad_performance` - 廣告效果報表
  - 廣告請求數
  - 廣告完成數
  - 完成率
  - 獎勵發放數
  - 各提供商表現
  
- [ ] `/funnel` - VIP 轉化漏斗
  - 註冊用戶數
  - 完成 MBTI 用戶數
  - 丟瓶用戶數
  - 撿瓶用戶數
  - VIP 用戶數
  - 各階段轉化率

#### 每日自動報表
- [ ] 每天自動發送報表給超級管理員
- [ ] 報表發送時間可配置
- [ ] 測試命令：`/test_daily_reports`

---

### 3. 廣告系統基礎設施 ⭐⭐⭐⭐

**重要性**: 🔴 **高** - 系統穩定性

**缺失測試**:

#### 數據庫表
- [ ] `ad_providers` 表存在
- [ ] `ad_rewards` 表存在
- [ ] `official_ads` 表存在
- [ ] 測試提供商已配置（`gigapub_test`）

#### API 端點
- [ ] `/api/ad/complete` - 廣告完成回調
  - Token 驗證
  - 用戶驗證
  - 每日限制檢查
  - 獎勵發放
  
- [ ] `/api/ad/error` - 廣告錯誤回調
  - 錯誤記錄
  - 提供商統計更新

#### 靜態文件服務
- [ ] `/ad.html` - 真實廣告頁面
- [ ] `/ad-test.html` - 測試廣告頁面
- [ ] 頁面載入正常
- [ ] JavaScript 執行正常

---

## 🟡 核心功能缺口

### 1. 個人資料編輯 ⭐⭐⭐⭐

**重要性**: 🔴 **高** - 基礎功能

**缺失測試**:

#### 基礎命令
- [ ] `/edit_profile` - 顯示編輯選單
- [ ] 顯示當前資料
- [ ] 顯示可編輯項目
- [ ] 顯示不可編輯項目（性別、生日）

#### 編輯功能
- [ ] 編輯暱稱
  - 輸入新暱稱
  - 驗證長度（2-20 字符）
  - 更新成功提示
  
- [ ] 編輯簡介
  - 輸入新簡介
  - 驗證長度（最多 200 字符）
  - 更新成功提示
  
- [ ] 編輯地區
  - 輸入新地區
  - 更新成功提示
  
- [ ] 編輯興趣
  - 輸入興趣標籤（逗號分隔）
  - 更新成功提示
  
- [ ] 編輯匹配偏好
  - 選擇：男生/女生/任何人
  - 更新成功提示
  
- [ ] 編輯血型
  - 選擇：A/B/AB/O/不確定
  - 更新成功提示

#### Session 管理
- [ ] 創建編輯 session
- [ ] Session 超時處理
- [ ] 取消編輯（發送命令）

#### 任務整合
- [ ] 編輯興趣 → 完成 `task_interests`
- [ ] 編輯簡介 → 完成 `task_bio`
- [ ] 編輯地區 → 完成 `task_city`

---

### 2. 對話完整流程 ⭐⭐⭐⭐

**重要性**: 🔴 **高** - 核心功能

**已測試**: 對話標識符生成

**缺失測試**:

#### 丟瓶流程
- [ ] `/throw` 命令
- [ ] 選擇匹配對象（男生/女生/任何人）
- [ ] 輸入瓶子內容
- [ ] 內容驗證（12-500 字符）
- [ ] URL 白名單檢查
- [ ] 瓶子創建成功
- [ ] 配額扣除

#### 撿瓶流程
- [ ] `/catch` 命令
- [ ] 隨機匹配瓶子
- [ ] 顯示瓶子內容
- [ ] 顯示發送者資料（暱稱擾碼、年齡、MBTI、星座）
- [ ] 回覆按鈕
- [ ] 跳過按鈕

#### 對話建立
- [ ] 用戶 A 回覆瓶子
- [ ] 用戶 B 收到通知
- [ ] 用戶 B 回覆
- [ ] 對話建立成功
- [ ] 雙方收到對話標識符

#### 消息轉發
- [ ] 長按消息 → 選擇「回覆」
- [ ] 輸入回覆內容
- [ ] 消息轉發給對方
- [ ] 顯示對話標識符
- [ ] 翻譯功能（VIP）

#### 對話管理
- [ ] `/chats` - 查看對話列表
- [ ] `/end` - 結束對話
- [ ] `/block` - 封鎖用戶

---

### 3. MBTI 完整流程 ⭐⭐⭐

**重要性**: 🟡 **中** - 核心功能

**已測試**: 版本選擇（12題 vs 36題）

**缺失測試**:

#### 測驗流程
- [ ] `/mbti` 命令
- [ ] 選擇版本（快速版/完整版）
- [ ] 答題流程
  - 快速版：12 題
  - 完整版：36 題
- [ ] 每題顯示進度
- [ ] 答題按鈕（非常同意 → 非常不同意）

#### 結果顯示
- [ ] 計算 MBTI 類型
- [ ] 顯示結果（如 INFP）
- [ ] 顯示類型描述
- [ ] 顯示完成訊息（根據版本）

#### 結果操作
- [ ] 「查看 MBTI 選單」按鈕
- [ ] 「返回主選單」按鈕
- [ ] 手動輸入 MBTI（如果不滿意結果）

#### 重新測試
- [ ] `/mbti` 重新測試
- [ ] 更新用戶 MBTI 類型
- [ ] 更新 `mbti_source`（`test` 或 `manual`）

---

### 4. VIP 功能 ⭐⭐⭐

**重要性**: 🟡 **中** - 付費功能

**缺失測試**:

#### VIP 訂閱
- [ ] `/vip` 命令
- [ ] 顯示 VIP 特權
- [ ] 顯示價格（Telegram Stars）
- [ ] 訂閱按鈕
- [ ] 支付流程
- [ ] 訂閱成功通知

#### VIP 特權
- [ ] 每日配額：3 → 30（基礎）
- [ ] 最大配額：10 → 100（含邀請）
- [ ] 進階篩選（血型、星座、MBTI）
- [ ] 翻譯功能（34 種語言）
- [ ] 無廣告

#### 翻譯功能
- [ ] 自動檢測語言
- [ ] 優先使用 OpenAI GPT-4o-mini
- [ ] 失敗時降級到 Google Translate
- [ ] 翻譯失敗時發送原文
- [ ] 顯示翻譯提示

---

## 📋 測試優先級建議

### 🔴 P0 - 立即添加（本週）

1. **新手引導教學系統**
   - 影響所有新用戶首次體驗
   - 測試工作量：中
   - 預估時間：2-3 小時

2. **任務中心系統**
   - 核心留存機制
   - 測試工作量：大
   - 預估時間：4-5 小時

3. **GigaPub 廣告整合**
   - 營收關鍵功能
   - 測試工作量：中
   - 預估時間：2-3 小時

### 🟡 P1 - 優先添加（本月）

4. **用戶廣告功能**
   - 完整廣告觀看流程
   - 測試工作量：大
   - 預估時間：4-5 小時

5. **個人資料編輯**
   - 基礎功能，使用頻繁
   - 測試工作量：中
   - 預估時間：3-4 小時

6. **對話完整流程**
   - 核心功能，但已有部分測試
   - 測試工作量：大
   - 預估時間：5-6 小時

### 🟢 P2 - 後續添加（下月）

7. **管理員分析報表**
   - 運營工具，不影響用戶
   - 測試工作量：中
   - 預估時間：2-3 小時

8. **MBTI 完整流程**
   - 已有基本測試
   - 測試工作量：中
   - 預估時間：2-3 小時

9. **VIP 功能**
   - 付費功能，用戶量較少
   - 測試工作量：大
   - 預估時間：4-5 小時

---

## 📊 測試覆蓋率詳細分析

### 功能分類統計

| 分類 | 總功能數 | 已測試 | 未測試 | 覆蓋率 |
|------|----------|--------|--------|--------|
| **基礎設施** | 5 | 5 | 0 | 100% ✅ |
| **用戶註冊** | 10 | 2 | 8 | 20% 🔴 |
| **新手引導** | 5 | 0 | 5 | 0% 🔴 |
| **任務系統** | 8 | 0 | 8 | 0% 🔴 |
| **個人資料** | 8 | 0 | 8 | 0% 🔴 |
| **漂流瓶** | 10 | 3 | 7 | 30% 🔴 |
| **對話系統** | 8 | 1 | 7 | 12.5% 🔴 |
| **廣告系統** | 12 | 0 | 12 | 0% 🔴 |
| **MBTI 測驗** | 8 | 2 | 6 | 25% 🔴 |
| **VIP 功能** | 6 | 0 | 6 | 0% 🔴 |
| **管理員功能** | 15 | 1 | 14 | 6.7% 🔴 |
| **開發工具** | 4 | 4 | 0 | 100% ✅ |
| **錯誤處理** | 5 | 3 | 2 | 60% 🟡 |

**總計**: 104 個功能點，15 個已測試，89 個未測試，**覆蓋率 14.4%** 🔴

---

## 🎯 改進建議

### 1. 短期目標（1週內）

**目標覆蓋率**: 40%

**優先添加**:
- ✅ 新手引導教學（5 個測試）
- ✅ 任務中心基礎（8 個測試）
- ✅ GigaPub 廣告（5 個測試）

**預估工作量**: 8-10 小時

---

### 2. 中期目標（1個月內）

**目標覆蓋率**: 60%

**優先添加**:
- ✅ 用戶廣告功能（12 個測試）
- ✅ 個人資料編輯（8 個測試）
- ✅ 對話完整流程（8 個測試）

**預估工作量**: 12-15 小時

---

### 3. 長期目標（3個月內）

**目標覆蓋率**: 80%+

**優先添加**:
- ✅ 管理員分析報表（3 個測試）
- ✅ MBTI 完整流程（6 個測試）
- ✅ VIP 功能（6 個測試）
- ✅ 翻譯功能（4 個測試）
- ✅ 進階篩選（3 個測試）

**預估工作量**: 15-20 小時

---

## 📝 結論

### 關鍵問題

1. **最新功能完全未測試**
   - 2025-11-19 新增的 4 個核心功能（教學、任務、頻道驗證、GigaPub）
   - 2025-01-18 新增的廣告系統
   - **風險**: 生產環境可能存在未發現的 bug

2. **核心流程測試不完整**
   - 對話流程只測試了標識符，未測試完整流程
   - MBTI 只測試了版本選擇，未測試答題和結果
   - **風險**: 用戶核心體驗可能出現問題

3. **測試覆蓋率嚴重不足**
   - 當前覆蓋率：**14.4%**
   - 行業標準：60-80%
   - **風險**: 無法及時發現回歸問題

### 行動建議

1. **立即行動**（本週）
   - 添加新手引導測試
   - 添加任務中心測試
   - 添加 GigaPub 廣告測試
   - **目標**: 覆蓋率提升到 40%

2. **持續改進**（本月）
   - 添加用戶廣告功能測試
   - 添加個人資料編輯測試
   - 添加對話完整流程測試
   - **目標**: 覆蓋率提升到 60%

3. **長期優化**（3個月）
   - 補充所有核心功能測試
   - 添加邊界情況測試
   - 添加性能測試
   - **目標**: 覆蓋率提升到 80%+

---

**報告生成時間**: 2025-11-19  
**下次更新**: 添加測試後

