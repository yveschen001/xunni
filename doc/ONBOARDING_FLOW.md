# XunNi è¨»å†Šå¼•å°æµç¨‹è¨­è¨ˆ

## 1. æ¦‚è¿°

è¨»å†Šæµç¨‹æ¡ç”¨**æ™ºèƒ½å°è©±å¼å¼•å°**ï¼Œæ”¯æ´**ä¸­æ–·å¾Œç¹¼çºŒ**ï¼Œä¸¦å°é—œéµè³‡è¨Šï¼ˆæ€§åˆ¥ã€ç”Ÿæ—¥ï¼‰é€²è¡Œ**æ·±åº¦ç¢ºèª**ã€‚

---

## 2. æ ¸å¿ƒåŸå‰‡

### 2.1 ä¸å¯ä¿®æ”¹çš„æ¬„ä½

ä»¥ä¸‹æ¬„ä½**ä¸€æ—¦è¨­å®šï¼Œæ°¸é ä¸èƒ½ä¿®æ”¹**ï¼š
- **æ€§åˆ¥** (`gender`)
- **ç”Ÿæ—¥** (`birthday`) - ç”¨æ–¼è¨ˆç®—å¹´é½¡å’Œæ˜Ÿåº§
- **è¡€å‹** (`blood_type`) - ç”¨æ–¼é…å°ç¯©é¸ï¼ˆVIP åŠŸèƒ½ï¼‰

### 2.2 å¹´é½¡é™åˆ¶

- **æœªæ»¿ 18 æ­²**ï¼šä¸å…è¨±è¨»å†Šï¼Œæç¤ºã€Œå¾ˆæŠ±æ­‰ï¼Œä½ å¿…é ˆå¹´æ»¿ 18 æ­²æ‰èƒ½ä½¿ç”¨æœ¬æœå‹™ã€‚è«‹æˆå¹´å¾Œå†ä¾†ï¼ã€
- **å¹´é½¡é©—è­‰**ï¼š
  - å¿…é ˆè¼¸å…¥çœŸå¯¦ç”Ÿæ—¥ï¼ˆæ ¼å¼ï¼šYYYY-MM-DDï¼‰
  - ç³»çµ±è‡ªå‹•è¨ˆç®—å¹´é½¡ï¼š`ç•¶å‰å¹´ä»½ - å‡ºç”Ÿå¹´ä»½`
  - å¦‚æœæœªæ»¿ 18 æ­²ï¼Œç«‹å³çµ‚æ­¢è¨»å†Šæµç¨‹
  - ç”Ÿæ—¥è¨­å®šå¾Œæ°¸é ä¸èƒ½ä¿®æ”¹

### 2.3 æš±ç¨±è¦å‰‡

- **é•·åº¦é™åˆ¶**ï¼š2-20 å€‹å­—ç¬¦
- **å…§å®¹é™åˆ¶**ï¼š
  - âŒ ä¸å…è¨±åŒ…å«ç¶²å€ï¼ˆhttp://, https://, www., .com, .net ç­‰ï¼‰
  - âŒ ä¸å…è¨±åŒ…å«ç‰¹æ®Šç¬¦è™Ÿï¼ˆåƒ…å…è¨±ä¸­æ–‡ã€è‹±æ–‡ã€æ•¸å­—ã€ç©ºæ ¼ã€emojiï¼‰
  - âœ… å…è¨±ä½¿ç”¨ emoji
- **å”¯ä¸€æ€§**ï¼šæš±ç¨±å¯ä»¥é‡è¤‡ï¼ˆä¸å¼·åˆ¶å”¯ä¸€ï¼‰
- **ä¿®æ”¹**ï¼šè¨»å†Šå¾Œå¯ä»¥ä¿®æ”¹æš±ç¨±ï¼ˆä½†ä»éœ€éµå®ˆè¦å‰‡ï¼‰

### 2.4 éš±ç§ä¿è­·ï¼ˆæš±ç¨±æ“¾äº‚ï¼‰

åœ¨é‚€è«‹é€šçŸ¥ç­‰å ´æ™¯ä¸­ï¼Œéœ€è¦ä¿è­·ç”¨æˆ¶éš±ç§ï¼š
- **åŸå‰‡**ï¼šé¡¯ç¤ºéƒ¨åˆ†æš±ç¨± + éƒ¨åˆ†é®è”½
- **è¦å‰‡**ï¼š
  - 2 å­—ä»¥ä¸‹ï¼šé¡¯ç¤ºç¬¬ 1 å­— + `**`ï¼ˆä¾‹ï¼š`ç‹` â†’ `ç‹**`ï¼‰
  - 3 å­—ï¼šé¡¯ç¤ºç¬¬ 1 å­— + `**`ï¼ˆä¾‹ï¼š`å¼µå°æ˜` â†’ `å¼µ**`ï¼‰
  - 4 å­—ä»¥ä¸Šï¼šé¡¯ç¤ºå‰ 3 å­— + `***`ï¼ˆä¾‹ï¼š`Alexander` â†’ `Ale***`ï¼‰

### 2.5 ä¸­æ–·æ¢å¾©æ©Ÿåˆ¶

- ä½¿ç”¨ `onboarding_step` æ¬„ä½è¨˜éŒ„ç•¶å‰æ­¥é©Ÿ
- ä½¿ç”¨è€…ä¸­æ–·å¾Œï¼Œä¸‹æ¬¡ `/start` å¾ä¸­æ–·è™•ç¹¼çºŒ
- æ”¯æ´æŸ¥çœ‹å·²å®Œæˆçš„æ­¥é©Ÿ

---

## 3. è³‡æ–™åº«æ“´å……

### 3.1 users è¡¨æ–°å¢æ¬„ä½

```sql
-- æ–°å¢åˆ° users è¡¨
ALTER TABLE users ADD COLUMN birthday DATE;              -- ç”Ÿæ—¥ï¼ˆç”¨æ–¼è¨ˆç®—å¹´é½¡å’Œæ˜Ÿåº§ï¼‰
ALTER TABLE users ADD COLUMN blood_type TEXT;            -- è¡€å‹ï¼šA, B, O, AB, unknown
ALTER TABLE users ADD COLUMN onboarding_state TEXT;     -- JSON: { step: 3, data: {...} }
ALTER TABLE users ADD COLUMN onboarding_started_at DATETIME;
ALTER TABLE users ADD COLUMN onboarding_completed_at DATETIME;
ALTER TABLE users ADD COLUMN terms_accepted INTEGER DEFAULT 0;  -- æ˜¯å¦æ¥å—æ¢æ¬¾
ALTER TABLE users ADD COLUMN privacy_accepted INTEGER DEFAULT 0; -- æ˜¯å¦æ¥å—éš±ç§æ¬Š
ALTER TABLE users ADD COLUMN terms_accepted_at DATETIME;
ALTER TABLE users ADD COLUMN privacy_accepted_at DATETIME;
```

**è¡€å‹èªªæ˜**ï¼š
- å¯é¸å€¼ï¼š`A`, `B`, `O`, `AB`, `unknown`ï¼ˆä¸é¡˜é€éœ²ï¼‰
- è¨­å®šå¾Œæ°¸é ä¸èƒ½ä¿®æ”¹
- VIP ç”¨æˆ¶å¯ä»¥åœ¨ä¸Ÿç“¶å­æ™‚ç¯©é¸ç‰¹å®šè¡€å‹

### 3.2 onboarding_state JSON çµæ§‹

```typescript
interface OnboardingState {
  step: number;           // ç•¶å‰æ­¥é©Ÿ (0-9)
  data: {
    nickname?: string;
    avatar_url?: string;
    language_pref?: string;
    gender?: string;
    birthday?: string;    // YYYY-MM-DD
    country?: string;
    prefer_gender?: string;
    mbti_answers?: number[];  // MBTI æ¸¬é©—ç­”æ¡ˆ
    anti_scam_score?: number; // åè©é¨™æ¸¬é©—åˆ†æ•¸
  };
  last_updated: string;   // ISO datetime
}
```

---

## 4. å®Œæ•´è¨»å†Šæµç¨‹ï¼ˆ11 æ­¥ï¼‰

**æµç¨‹ç¸½è¦½**ï¼š
1. Step 0ï¼šæ­¡è¿èˆ‡æ¢æ¬¾åŒæ„
2. Step 1ï¼šæš±ç¨± & é ­åƒ
3. Step 2ï¼šä¸»è¦ä½¿ç”¨èªè¨€
4. Step 3ï¼šæ€§åˆ¥ï¼ˆæ·±åº¦ç¢ºèªï¼‰
5. Step 4ï¼šç”Ÿæ—¥èˆ‡å¹´é½¡é©—è­‰ï¼ˆ18æ­²é™åˆ¶ï¼‰
6. **Step 5ï¼šè¡€å‹ï¼ˆæ·±åº¦ç¢ºèªï¼‰** â­ æ–°å¢
7. Step 6ï¼šåœ‹å®¶
8. Step 7ï¼šå–œå¥½æ€§å‘ï¼ˆç›®æ¨™å°è±¡ï¼‰
9. Step 8ï¼šMBTI æ¸¬é©—
10. Step 9ï¼šåè©é¨™æ¸¬é©—
11. Step 10ï¼šå®Œæˆè¨»å†Š

---

### Step 0ï¼šæ­¡è¿èˆ‡æ¢æ¬¾åŒæ„

**æ™ºèƒ½å°è©±**ï¼š
```
Bot: ğŸ‘‹ å—¨ï¼æ­¡è¿ä¾†åˆ° XunNiï½æˆ‘æ˜¯ä½ çš„å°ˆå±¬å¼•å°å°åŠ©æ‰‹ âœ¨

è®“æˆ‘å…ˆç°¡å–®ä»‹ç´¹ä¸€ä¸‹ï¼š
XunNi æ˜¯ä¸€å€‹åŒ¿åæ¼‚æµç“¶äº¤å‹å¹³å°ï¼Œé€é MBTI å’Œæ˜Ÿåº§å¹«ä½ æ‰¾åˆ°å¿—åŒé“åˆçš„æœ‹å‹ï¼

åœ¨é–‹å§‹ä¹‹å‰ï¼Œæˆ‘éœ€è¦ä½ åŒæ„æˆ‘å€‘çš„æ¢æ¬¾ï¼š
```

**é¡¯ç¤ºæŒ‰éˆ•**ï¼š
- [ğŸ“„ æŸ¥çœ‹ä½¿ç”¨è€…æ¢æ¬¾]
- [ğŸ”’ æŸ¥çœ‹éš±ç§æ¬Šæ”¿ç­–]
- [âœ… æˆ‘å·²é–±è®€ä¸¦åŒæ„] (å¿…é ˆå…ˆæŸ¥çœ‹æ‰èƒ½åŒæ„)
- [âŒ ä¸åŒæ„ï¼Œé›¢é–‹]

**é©—è­‰é‚è¼¯**ï¼š
- å¿…é ˆå…ˆé»æ“Šã€ŒæŸ¥çœ‹ä½¿ç”¨è€…æ¢æ¬¾ã€å’Œã€ŒæŸ¥çœ‹éš±ç§æ¬Šæ”¿ç­–ã€
- å…©å€‹éƒ½æŸ¥çœ‹å¾Œï¼Œã€Œæˆ‘å·²é–±è®€ä¸¦åŒæ„ã€æ‰å¯é»æ“Š
- è¨˜éŒ„ `terms_accepted` å’Œ `privacy_accepted` ç‚º 1ï¼Œè¨˜éŒ„æ™‚é–“

**ä¸­æ–·æ¢å¾©**ï¼š
- å¦‚æœå·²åŒæ„æ¢æ¬¾ï¼Œè·³éæ­¤æ­¥é©Ÿ
- å¦‚æœæœªåŒæ„ï¼Œå¾æ­¤æ­¥é©Ÿé–‹å§‹

---

### Step 1ï¼šæš±ç¨± & é ­åƒ

**æ™ºèƒ½å°è©±**ï¼š
```
Bot: å¤ªå¥½äº†ï¼è®“æˆ‘å€‘é–‹å§‹è¨­å®šä½ çš„å€‹äººè³‡æ–™å§ ğŸ¨

é¦–å…ˆï¼Œçµ¦è‡ªå·±å–ä¸€å€‹æœ‰è¶£çš„æš±ç¨±å§ï½
ï¼ˆé€™æ˜¯ä½ çµ¦åˆ¥äººçš„ç¬¬ä¸€å°è±¡ï¼Œè¦å¥½å¥½æƒ³å“¦ï½ï¼‰

ğŸ“ æš±ç¨±è¦å‰‡ï¼š
â€¢ é•·åº¦ï¼š2-20 å€‹å­—ç¬¦
â€¢ ä¸å…è¨±åŒ…å«ç¶²å€
â€¢ å¯ä»¥ä½¿ç”¨ emoji ğŸ˜Š
```

**æµç¨‹**ï¼š
1. é è¨­ä½¿ç”¨ Telegram `first_name` æˆ– `username`
2. AI ç”Ÿæˆ 1-3 å€‹æš±ç¨±å»ºè­°ï¼ˆæ ¹æ“šèªè¨€ã€ç”¢å“ä¸»é¡Œï¼‰
3. ä½¿ç”¨è€…å¯ï¼š
   - é»æ“Šå»ºè­°æš±ç¨±
   - è¼¸å…¥è‡ªè¨‚æš±ç¨±
   - ä½¿ç”¨é è¨­å€¼

**æš±ç¨±é©—è­‰**ï¼š
```typescript
function validateNickname(nickname: string): { valid: boolean; error?: string } {
  // 1. é•·åº¦æª¢æŸ¥
  if (nickname.length < 2 || nickname.length > 20) {
    return { valid: false, error: 'æš±ç¨±é•·åº¦å¿…é ˆåœ¨ 2-20 å€‹å­—ç¬¦ä¹‹é–“' };
  }
  
  // 2. ç¶²å€æª¢æŸ¥
  const urlPatterns = [
    /https?:\/\//i,           // http:// or https://
    /www\./i,                 // www.
    /\.com|\.net|\.org|\.tw/i // common TLDs
  ];
  
  for (const pattern of urlPatterns) {
    if (pattern.test(nickname)) {
      return { valid: false, error: 'æš±ç¨±ä¸èƒ½åŒ…å«ç¶²å€' };
    }
  }
  
  // 3. ç‰¹æ®Šç¬¦è™Ÿæª¢æŸ¥ï¼ˆå…è¨±ä¸­æ–‡ã€è‹±æ–‡ã€æ•¸å­—ã€ç©ºæ ¼ã€emojiï¼‰
  // é€™è£¡å¯ä»¥æ ¹æ“šéœ€è¦èª¿æ•´
  
  return { valid: true };
}
```

**éŒ¯èª¤æç¤º**ï¼š
```
Bot: âŒ æš±ç¨±ä¸ç¬¦åˆè¦å‰‡ï¼š{error}

è«‹é‡æ–°è¼¸å…¥ä¸€å€‹æš±ç¨±ï½
```

**é ­åƒè¨­å®š**ï¼š
```
Bot: æ¥ä¸‹ä¾†ï¼Œè¨­å®šä½ çš„é ­åƒå§ ğŸ“¸

ä½ å¯ä»¥ï¼š
1. ä½¿ç”¨ Telegram é ­åƒ
2. ä¸Šå‚³è‡ªè¨‚é ­åƒ
3. ç¨å¾Œå†è¨­å®šï¼ˆå¯é¸ï¼‰
```

**ä¿å­˜ç‹€æ…‹**ï¼š
```typescript
onboarding_state = {
  step: 1,
  data: {
    nickname: '...',
    avatar_url: '...',
  },
  last_updated: '...'
}
```

---

### Step 2ï¼šä¸»è¦ä½¿ç”¨èªè¨€

**æ™ºèƒ½å°è©±**ï¼š
```
Bot: ğŸŒ ä½ ä¸»è¦ä½¿ç”¨å“ªç¨®èªè¨€å‘¢ï¼Ÿ

é€™æœƒå½±éŸ¿ï¼š
- ä»‹é¢é¡¯ç¤ºèªè¨€
- èŠå¤©æ™‚çš„ç¿»è­¯ç›®æ¨™èªè¨€ï¼ˆVIP åŠŸèƒ½ï¼‰
```

**é¸é …**ï¼šæŒ‰éˆ•é¸æ“‡ï¼ˆzh-TW, en, ja, ko, th, vi, ...ï¼‰

---

### Step 3ï¼šæ€§åˆ¥ï¼ˆæ·±åº¦ç¢ºèªï¼‰

**æ™ºèƒ½å°è©±**ï¼š
```
Bot: ğŸ‘¤ è«‹å‘Šè¨´æˆ‘ä½ çš„æ€§åˆ¥

âš ï¸ é‡è¦æé†’ï¼š
æ€§åˆ¥è¨­å®šå¾Œå°‡**æ°¸é ä¸èƒ½ä¿®æ”¹**ï¼Œè«‹ä»”ç´°é¸æ“‡ï¼
```

**AI æç¤º**ï¼ˆå¯é¸ï¼‰ï¼š
```
Bot: æ ¹æ“šä½ çš„ Telegram è³‡æ–™ï¼Œæˆ‘çŒœæ¸¬ä½ å¯èƒ½æ˜¯ {ai_gender_hint}
ï¼ˆé€™åªæ˜¯å»ºè­°ï¼Œè«‹æ ¹æ“šå¯¦éš›æƒ…æ³é¸æ“‡ï¼‰
```

**é¸é …**ï¼š
- [ğŸ‘¨ ç”·]
- [ğŸ‘© å¥³]
- [ğŸŒˆ å…¶ä»–]

**æ·±åº¦ç¢ºèª**ï¼ˆé¸æ“‡å¾Œï¼‰ï¼š
```
Bot: ä½ é¸æ“‡äº†ã€Œ{gender}ã€

âš ï¸ å†æ¬¡ç¢ºèªï¼š
æ€§åˆ¥è¨­å®šå¾Œå°‡**æ°¸é ä¸èƒ½ä¿®æ”¹**ï¼

è«‹ç¢ºèªï¼š
[âœ… ç¢ºèªï¼Œé€™å°±æ˜¯æˆ‘çš„æ€§åˆ¥]
[âŒ é‡æ–°é¸æ“‡]
```

**æœ€çµ‚ç¢ºèª**ï¼š
- é»æ“Šã€Œç¢ºèªã€å¾Œï¼Œå¯«å…¥ `gender` æ¬„ä½
- è¨˜éŒ„ç¢ºèªæ™‚é–“
- å¦‚æœé»æ“Šã€Œé‡æ–°é¸æ“‡ã€ï¼Œå›åˆ°é¸é …

---

### Step 4ï¼šç”Ÿæ—¥èˆ‡å¹´é½¡é©—è­‰

**æ™ºèƒ½å°è©±**ï¼š
```
Bot: ğŸ‚ è«‹è¼¸å…¥ä½ çš„ç”Ÿæ—¥ï¼ˆYYYY-MM-DDï¼‰

ä¾‹å¦‚ï¼š2000-01-15

âš ï¸ é‡è¦ï¼š
1. ç”Ÿæ—¥è¨­å®šå¾Œå°‡**æ°¸é ä¸èƒ½ä¿®æ”¹**
2. æœªæ»¿ 18 æ­²ç„¡æ³•ä½¿ç”¨æœ¬æœå‹™
3. è«‹è¼¸å…¥çœŸå¯¦ç”Ÿæ—¥ï¼Œç”¨æ–¼è¨ˆç®—æ˜Ÿåº§
```

**è¼¸å…¥é©—è­‰**ï¼š
1. æ ¼å¼æª¢æŸ¥ï¼šYYYY-MM-DD
2. æ—¥æœŸåˆç†æ€§æª¢æŸ¥ï¼ˆä¸èƒ½æ˜¯æœªä¾†æ—¥æœŸï¼‰
3. å¹´é½¡è¨ˆç®—ï¼š`age = (today - birthday) / 365.25`
4. **18 æ­²é©—è­‰**ï¼š
   ```typescript
   if (age < 18) {
     return {
       error: 'AGE_RESTRICTION',
       message: 'å¾ˆæŠ±æ­‰ï¼Œä½ æœªæ»¿ 18 æ­²ï¼Œç„¡æ³•ä½¿ç”¨æœ¬æœå‹™ã€‚\n\nè«‹æˆå¹´å¾Œå†ä¾†ï¼Œæˆ‘å€‘ç­‰ä½ ï¼ğŸ‘‹'
     };
   }
   ```

**æ·±åº¦ç¢ºèª**ï¼š
```
Bot: ä½ çš„ç”Ÿæ—¥æ˜¯ï¼š{birthday}
è¨ˆç®—å‡ºçš„å¹´é½¡ï¼š{age} æ­²
å°æ‡‰çš„æ˜Ÿåº§ï¼š{zodiac_sign}

âš ï¸ å†æ¬¡ç¢ºèªï¼š
ç”Ÿæ—¥è¨­å®šå¾Œå°‡**æ°¸é ä¸èƒ½ä¿®æ”¹**ï¼

è«‹ç¢ºèªï¼š
[âœ… ç¢ºèªï¼Œé€™æ˜¯æˆ‘çš„çœŸå¯¦ç”Ÿæ—¥]
[âŒ é‡æ–°è¼¸å…¥]
```

**ä¿å­˜**ï¼š
- ç¢ºèªå¾Œå¯«å…¥ `birthday` å’Œ `zodiac_sign`
- è¨ˆç®— `age_range`ï¼ˆ18-22 / 23-30 / 31-40 / 40+ï¼‰

---

### Step 5ï¼šè¡€å‹ï¼ˆæ·±åº¦ç¢ºèªï¼‰

**æ™ºèƒ½å°è©±**ï¼š
```
Bot: ğŸ©¸ è«‹é¸æ“‡ä½ çš„è¡€å‹

âš ï¸ é‡è¦æé†’ï¼š
è¡€å‹è¨­å®šå¾Œå°‡**æ°¸é ä¸èƒ½ä¿®æ”¹**ï¼Œè«‹ä»”ç´°é¸æ“‡ï¼

ğŸ’¡ è¡€å‹æœƒç”¨æ–¼ï¼š
- VIP ç”¨æˆ¶å¯ä»¥ç¯©é¸ç‰¹å®šè¡€å‹çš„é…å°å°è±¡
- å¢åŠ é…å°çš„è¶£å‘³æ€§
```

**é¸é …**ï¼š
- [ğŸ…°ï¸ A å‹]
- [ğŸ…±ï¸ B å‹]
- [ğŸ…¾ï¸ O å‹]
- [ğŸ† AB å‹]
- [â“ ä¸é¡˜é€éœ²]

**æ·±åº¦ç¢ºèª**ï¼ˆé¸æ“‡å¾Œï¼‰ï¼š
```
Bot: ä½ é¸æ“‡äº†ã€Œ{blood_type}ã€

âš ï¸ å†æ¬¡ç¢ºèªï¼š
è¡€å‹è¨­å®šå¾Œå°‡**æ°¸é ä¸èƒ½ä¿®æ”¹**ï¼

è«‹ç¢ºèªï¼š
[âœ… ç¢ºèªï¼Œé€™å°±æ˜¯æˆ‘çš„è¡€å‹]
[âŒ é‡æ–°é¸æ“‡]
```

**æœ€çµ‚ç¢ºèª**ï¼š
- é»æ“Šã€Œç¢ºèªã€å¾Œï¼Œå¯«å…¥ `blood_type` æ¬„ä½
- è¨˜éŒ„ç¢ºèªæ™‚é–“
- å¦‚æœé»æ“Šã€Œé‡æ–°é¸æ“‡ã€ï¼Œå›åˆ°é¸é …

**ä¿å­˜**ï¼š
- ç¢ºèªå¾Œå¯«å…¥ `blood_type`ï¼ˆA, B, O, AB, unknownï¼‰

---

### Step 6ï¼šåœ‹å®¶

**æ™ºèƒ½å°è©±**ï¼š
```
Bot: ğŸŒ ä½ ä¾†è‡ªå“ªå€‹åœ‹å®¶/åœ°å€ï¼Ÿ

é€™æœƒå¹«åŠ©æˆ‘å€‘ç‚ºä½ æ¨è–¦æ›´åˆé©çš„é…å°ï½
```

**é¸é …**ï¼šæŒ‰éˆ•é¸æ“‡ï¼ˆTW, JP, KR, TH, VN, US, ...ï¼‰

---

### Step 7ï¼šå–œå¥½æ€§å‘ï¼ˆç›®æ¨™å°è±¡ï¼‰

**æ™ºèƒ½å°è©±**ï¼š
```
Bot: ğŸ’• ä½ æƒ³èªè­˜ä»€éº¼æ€§åˆ¥çš„æœ‹å‹ï¼Ÿ

ï¼ˆé€™æ˜¯ä½ ä¸Ÿæ¼‚æµç“¶æ™‚çš„ç›®æ¨™ç¯©é¸æ¢ä»¶ï¼‰
```

**é¸é …**ï¼š
- [ğŸ‘¨ ç”·]
- [ğŸ‘© å¥³]
- [ğŸŒˆ å…¶ä»–]
- [ğŸŒ ä¸é™]

---

### Step 8ï¼šMBTI æ¸¬é©—

**æ™ºèƒ½å°è©±**ï¼š
```
Bot: ğŸ§  è®“æˆ‘å€‘ä¾†åšå€‹ MBTI æ¸¬é©—å§ï¼

é€™æœƒå¹«åŠ©æˆ‘å€‘ç‚ºä½ æ‰¾åˆ°æ›´åˆé©çš„é…å°å°è±¡ï½
æ¸¬é©—å…±æœ‰ {totalQuestions} é¡Œï¼Œæ¯é  3-5 é¡Œ
```

**æµç¨‹**ï¼š
1. åˆ†é é¡¯ç¤ºï¼ˆæ¯é  3-5 é¡Œï¼‰
2. æ¯é å®Œæˆå¾Œï¼š
   ```
   Bot: å¤ªå¥½äº†ï¼ä½ å·²ç¶“å®Œæˆäº† {current}/{total} é¡Œ
   ç¹¼çºŒåŠ æ²¹ï½ ğŸ’ª
   ```
3. å®Œæˆå¾Œè¨ˆç®— MBTI é¡å‹
4. é¡¯ç¤ºçµæœï¼š
   ```
   Bot: ğŸ‰ æ¸¬é©—å®Œæˆï¼

   ä½ çš„ MBTI é¡å‹æ˜¯ï¼š{mbti_type}
   {mbti_description}
   ```

**ä¸­æ–·æ¢å¾©**ï¼š
- ä¿å­˜å·²ç­”é¡Œç›®åˆ° `onboarding_state.data.mbti_answers`
- æ¢å¾©æ™‚å¾æœªç­”é¡Œç›®ç¹¼çºŒ

---

### Step 9ï¼šåè©é¨™æ¸¬é©—

**æ™ºèƒ½å°è©±**ï¼š
```
Bot: ğŸ›¡ï¸ æœ€å¾Œä¸€æ­¥ï¼è®“æˆ‘å€‘åšå€‹ç°¡å–®çš„å®‰å…¨æ¸¬é©—

é€™æœƒå¹«åŠ©æˆ‘å€‘å»ºç«‹ä¸€å€‹æ›´å®‰å…¨çš„ç’°å¢ƒï½
å…±æœ‰ 5 é¡Œæƒ…å¢ƒé¡Œ
```

**æµç¨‹**ï¼š
1. é¡¯ç¤ºæƒ…å¢ƒé¡Œï¼ˆæ¯é¡Œ 1 åˆ†ï¼‰
2. å®Œæˆå¾Œè¨ˆç®—åˆ†æ•¸
3. å¾—åˆ† >= 3 åˆ†ï¼šé€šé
4. å¾—åˆ† < 3 åˆ†ï¼š
   ```
   Bot: å¾ˆéºæ†¾ï¼Œä½ æ²’æœ‰é€šéæ¸¬é©— ğŸ˜”

   åˆ¥æ“”å¿ƒï¼ä½ å¯ä»¥é‡æ–°æ¸¬é©—
   é€™æ¬¡è¦æ›´ä»”ç´°é–±è®€é¡Œç›®å“¦ï½
   
   [ğŸ”„ é‡æ–°æ¸¬é©—]
   ```

**ä¸­æ–·æ¢å¾©**ï¼š
- ä¿å­˜å·²ç­”é¡Œç›®å’Œåˆ†æ•¸
- æ¢å¾©æ™‚å¾æœªç­”é¡Œç›®ç¹¼çºŒ

---

### Step 10ï¼šå®Œæˆè¨»å†Š

**æ™ºèƒ½å°è©±**ï¼š
```
Bot: ğŸ‰ æ­å–œï¼ä½ å·²ç¶“å®Œæˆæ‰€æœ‰è¨­å®šï¼

ä½ çš„å€‹äººè³‡æ–™ï¼š
- æš±ç¨±ï¼š{nickname}
- æ€§åˆ¥ï¼š{gender}
- å¹´é½¡ï¼š{age} æ­²
- æ˜Ÿåº§ï¼š{zodiac_sign}
- MBTIï¼š{mbti_type}

ç¾åœ¨ä½ å¯ä»¥é–‹å§‹ä½¿ç”¨ XunNi äº†ï¼

[ğŸ“¦ ä¸Ÿå€‹æ¼‚æµç“¶] [ğŸ” æ’¿å€‹ç“¶å­] [ğŸ‘¤ æŸ¥çœ‹å€‹äººè³‡æ–™]
```

**ä¿å­˜**ï¼š
- `onboarding_completed_at` = now()
- `onboarding_state.step` = 9
- æ¨™è¨˜ä½¿ç”¨è€…ç‚ºã€Œå¯ç”¨ç‹€æ…‹ã€

---

## 5. ä¸­æ–·æ¢å¾©æ©Ÿåˆ¶

### 5.1 æ¢å¾©é‚è¼¯

```typescript
// src/domain/user.ts

export async function getOnboardingState(
  userId: string,
  db: D1Database
): Promise<OnboardingState | null> {
  const user = await db.getUser(userId);
  if (!user || !user.onboarding_state) {
    return null;
  }
  
  return JSON.parse(user.onboarding_state);
}

export async function resumeOnboarding(
  userId: string,
  db: D1Database
): Promise<number> {
  const state = await getOnboardingState(userId, db);
  
  if (!state) {
    return 0; // å¾é ­é–‹å§‹
  }
  
  // æª¢æŸ¥æ˜¯å¦å·²å®Œæˆ
  if (state.step >= 9) {
    return -1; // å·²å®Œæˆ
  }
  
  return state.step; // å¾ä¸­æ–·è™•ç¹¼çºŒ
}
```

### 5.2 æ¢å¾©æç¤º

```
Bot: ğŸ‘‹ æ­¡è¿å›ä¾†ï¼

ä½ ä¸Šæ¬¡çš„è¨»å†Šé€²åº¦ï¼š{step}/9

[â–¶ï¸ ç¹¼çºŒè¨»å†Š] [ğŸ”„ é‡æ–°é–‹å§‹] [ğŸ‘€ æŸ¥çœ‹å·²å¡«å¯«è³‡æ–™]
```

---

## 6. æ¢æ¬¾èˆ‡éš±ç§æ¬Š

### 6.1 ä½¿ç”¨è€…æ¢æ¬¾

**å…§å®¹**ï¼ˆéœ€æ³•å¾‹é¡§å•å¯©æ ¸ï¼‰ï¼š
- æœå‹™ä½¿ç”¨è¦ç¯„
- ä½¿ç”¨è€…è¡Œç‚ºæº–å‰‡
- é•è¦è™•ç½°æ©Ÿåˆ¶
- å…è²¬è²æ˜

**é¡¯ç¤ºæ–¹å¼**ï¼š
- é•·æ–‡æœ¬ï¼Œæ”¯æ´ Markdown æ ¼å¼
- å¯æ»¾å‹•æŸ¥çœ‹
- å¿…é ˆå®Œæ•´é–±è®€ï¼ˆæª¢æ¸¬æ»¾å‹•åˆ°åº•éƒ¨ï¼‰æ‰èƒ½åŒæ„

### 6.2 éš±ç§æ¬Šæ”¿ç­–

**å…§å®¹**ï¼ˆéœ€æ³•å¾‹é¡§å•å¯©æ ¸ï¼‰ï¼š
- è³‡æ–™æ”¶é›†ç¯„åœ
- è³‡æ–™ä½¿ç”¨ç›®çš„
- è³‡æ–™ä¿è­·æªæ–½
- ä½¿ç”¨è€…æ¬Šåˆ©

**é¡¯ç¤ºæ–¹å¼**ï¼šåŒä¸Š

### 6.3 æ¢æ¬¾ç‰ˆæœ¬ç®¡ç†

```sql
CREATE TABLE terms_versions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  type TEXT,              -- 'terms' / 'privacy'
  version TEXT,           -- '1.0', '1.1', ...
  content TEXT,           -- Markdown æ ¼å¼
  effective_date DATE,
  created_at DATETIME
);

-- ä½¿ç”¨è€…æ¥å—çš„ç‰ˆæœ¬è¨˜éŒ„
ALTER TABLE users ADD COLUMN terms_version TEXT;
ALTER TABLE users ADD COLUMN privacy_version TEXT;
```

**ç‰ˆæœ¬æ›´æ–°**ï¼š
- é‡å¤§æ›´æ–°æ™‚ï¼Œè¦æ±‚ä½¿ç”¨è€…é‡æ–°åŒæ„
- è¨˜éŒ„ä½¿ç”¨è€…æ¥å—çš„ç‰ˆæœ¬è™Ÿ

---

## 7. å¯¦ä½œç¯„ä¾‹

### 7.1 è™•ç† /start

```typescript
// src/telegram/handlers/start.ts

export async function handleStart(
  update: TelegramUpdate,
  env: Env,
  db: D1Database
): Promise<void> {
  const userId = String(update.message.from.id);
  
  // 1. æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å­˜åœ¨
  let user = await db.getUser(userId);
  
  if (!user) {
    // æ–°ä½¿ç”¨è€…ï¼šå»ºç«‹è¨˜éŒ„
    user = await db.createUser({
      telegram_id: userId,
      onboarding_state: JSON.stringify({
        step: 0,
        data: {},
        last_updated: new Date().toISOString(),
      }),
      onboarding_started_at: new Date().toISOString(),
    });
  }
  
  // 2. æª¢æŸ¥æ˜¯å¦å·²å®Œæˆ
  if (user.onboarding_completed_at) {
    await sendMessage(env, userId, 'ä½ å·²ç¶“å®Œæˆè¨»å†Šï¼ä½¿ç”¨ /help æŸ¥çœ‹å¯ç”¨æŒ‡ä»¤');
    return;
  }
  
  // 3. æª¢æŸ¥ä¸­æ–·æ¢å¾©
  const state = JSON.parse(user.onboarding_state || '{}');
  const currentStep = state.step || 0;
  
  // 4. æ ¹æ“šæ­¥é©Ÿè™•ç†
  switch (currentStep) {
    case 0:
      await handleTermsStep(userId, env, db);
      break;
    case 1:
      await handleNicknameStep(userId, env, db);
      break;
    // ... å…¶ä»–æ­¥é©Ÿ
  }
}
```

### 7.2 æ€§åˆ¥æ·±åº¦ç¢ºèª

```typescript
async function handleGenderConfirmation(
  userId: string,
  selectedGender: string,
  env: Env,
  db: D1Database
): Promise<void> {
  // ç¬¬ä¸€æ¬¡é¸æ“‡
  await sendMessage(env, userId, 
    `ä½ é¸æ“‡äº†ã€Œ${selectedGender}ã€\n\n` +
    `âš ï¸ å†æ¬¡ç¢ºèªï¼š\n` +
    `æ€§åˆ¥è¨­å®šå¾Œå°‡**æ°¸é ä¸èƒ½ä¿®æ”¹**ï¼\n\n` +
    `è«‹ç¢ºèªï¼š`,
    {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'âœ… ç¢ºèªï¼Œé€™å°±æ˜¯æˆ‘çš„æ€§åˆ¥', callback_data: `confirm_gender_${selectedGender}` }],
          [{ text: 'âŒ é‡æ–°é¸æ“‡', callback_data: 'reselect_gender' }],
        ],
      },
    }
  );
}

// è™•ç†ç¢ºèªå›èª¿
export async function handleGenderConfirmCallback(
  callbackQuery: CallbackQuery,
  env: Env,
  db: D1Database
): Promise<void> {
  const userId = String(callbackQuery.from.id);
  const data = callbackQuery.data;
  
  if (data.startsWith('confirm_gender_')) {
    const gender = data.replace('confirm_gender_', '');
    
    // æœ€çµ‚ç¢ºèªï¼šå¯«å…¥è³‡æ–™åº«
    await db.prepare(`
      UPDATE users
      SET gender = ?,
          onboarding_state = json_set(
            onboarding_state,
            '$.step', 4,
            '$.data.gender', ?
          ),
          updated_at = datetime('now')
      WHERE telegram_id = ?
    `).bind(gender, gender, userId).run();
    
    await sendMessage(env, userId, 'âœ… æ€§åˆ¥å·²ç¢ºèªï¼è®“æˆ‘å€‘ç¹¼çºŒï½');
    await handleBirthdayStep(userId, env, db);
  }
}
```

---

## 8. æ¸¬è©¦è¦é»

1. **ä¸­æ–·æ¢å¾©æ¸¬è©¦**ï¼šè¨»å†Šåˆ°ä¸€åŠä¸­æ–·ï¼Œé‡æ–°é€²å…¥æ‡‰å¾ä¸­æ–·è™•ç¹¼çºŒ
2. **å¹´é½¡é©—è­‰æ¸¬è©¦**ï¼šæœªæ»¿ 18 æ­²æ‡‰è¢«æ‹’çµ•
3. **æ€§åˆ¥ç¢ºèªæ¸¬è©¦**ï¼šå¿…é ˆç¶“éå…©æ¬¡ç¢ºèªæ‰èƒ½è¨­å®š
4. **ç”Ÿæ—¥ç¢ºèªæ¸¬è©¦**ï¼šå¿…é ˆç¶“éå…©æ¬¡ç¢ºèªæ‰èƒ½è¨­å®š
5. **æ¢æ¬¾åŒæ„æ¸¬è©¦**ï¼šå¿…é ˆå…ˆæŸ¥çœ‹æ‰èƒ½åŒæ„

---

## 9. æ³¨æ„äº‹é …

1. **æ³•å¾‹åˆè¦**ï¼šæ¢æ¬¾å’Œéš±ç§æ¬Šæ”¿ç­–éœ€æ³•å¾‹é¡§å•å¯©æ ¸
2. **è³‡æ–™ä¿è­·**ï¼šç”Ÿæ—¥ç­‰æ•æ„Ÿè³‡è¨Šéœ€åŠ å¯†å­˜å„²ï¼ˆå¯é¸ï¼‰
3. **ä½¿ç”¨è€…é«”é©—**ï¼šæ™ºèƒ½å°è©±è¦å‹å¥½ã€ä¸å†—é•·
4. **éŒ¯èª¤è™•ç†**ï¼šå¦¥å–„è™•ç†ä½¿ç”¨è€…è¼¸å…¥éŒ¯èª¤ã€ç¶²è·¯ä¸­æ–·ç­‰æƒ…æ³

