# XunNi ä¸»å‹•æ¨é€èˆ‡å¬å›æ©Ÿåˆ¶

> **æœ€å¾Œæ›´æ–°**ï¼š2025-11-21  
> **ç‰ˆæœ¬**ï¼šv2.0ï¼ˆæ•´åˆå»£æ’­ç³»çµ±ï¼‰  
> **ç¸½è¦½æ–‡æª”**ï¼š[`doc/PUSH_SYSTEM_MASTER.md`](./PUSH_SYSTEM_MASTER.md)
> **è¨­è¨ˆè¦ç¯„**ï¼š[`@doc/DESIGN_STANDARDS.md`](./DESIGN_STANDARDS.md) (éš±ç§ã€i18nã€UX æ¨™æº–)

## 1. æ¦‚è¿°

è¨­è¨ˆæ™ºèƒ½çš„ä¸»å‹•æ¨é€æ©Ÿåˆ¶ï¼Œåœ¨åˆé©çš„æ™‚æ©Ÿæé†’ä½¿ç”¨è€…ï¼Œæé«˜æ´»èºåº¦ï¼ŒåŒæ™‚é¿å…æ‰“æ“¾ä½¿ç”¨è€…ã€‚

**è¨­è¨ˆåˆè¦æ€§ (Compliance)**ï¼š
- âœ… **éš±ç§å„ªå…ˆ**ï¼šæ‰€æœ‰æ¨é€ä¸­çš„ä»–äººæš±ç¨±å¿…é ˆç¶“é `maskNickname()` è™•ç†ï¼ˆè©³è¦‹ Design Standards 1.1ï¼‰ã€‚
- âœ… **å¼·åˆ¶ i18n**ï¼šæ‰€æœ‰æ–‡æ¡ˆå¿…é ˆä½¿ç”¨ `i18n.t()`ï¼Œç¦æ­¢ç¡¬ç·¨ç¢¼ã€‚
- âœ… **å¯æ“ä½œæ€§**ï¼šæ¯æ¢é€šçŸ¥éƒ½å¿…é ˆåŒ…å«ä¸‹ä¸€æ­¥å‹•ä½œæŒ‰éˆ•ï¼ˆActionable Notificationsï¼‰ã€‚

**æ¨é€èªè¨€è¦ç¯„**ï¼š
- æ‰€æœ‰æ¨é€è¨Šæ¯**å¿…é ˆä½¿ç”¨ i18n ç³»çµ±**
- æ ¹æ“šä½¿ç”¨è€…çš„ `users.language_pref` è¨­å®šæ¨é€èªè¨€
- æ¨é€å…§å®¹ä½¿ç”¨ `@src/i18n/keys.ts` ä¸­å®šç¾©çš„éµå€¼
- å¯¦ä½œç¯„ä¾‹ï¼š`t(user.language_pref, I18N_KEYS.PUSH.MATCH_SUCCESS)`

**èˆ‡å»£æ’­ç³»çµ±çš„æ•´åˆæ¶æ§‹ (Integration Architecture)**ï¼š
- ğŸ— **åŸºç¤è¨­æ–½å¾©ç”¨**ï¼šæœ¬ç³»çµ±**ä¸å†é‡è¤‡é–‹ç™¼**åº•å±¤ç™¼é€é‚è¼¯ã€‚
- ğŸ”„ **ç™¼é€å™¨å¾©ç”¨**ï¼šå¿…é ˆèª¿ç”¨å»£æ’­ç³»çµ±çš„ `NotificationService` (æˆ– `SafeSender`) è™•ç†ç™¼é€èˆ‡éŒ¯èª¤æ¨™è¨˜ã€‚
- ğŸ” **éæ¿¾å™¨å¾©ç”¨**ï¼šå¿…é ˆèª¿ç”¨å»£æ’­ç³»çµ±çš„ `FilterEngine` è™•ç†ç”¨æˆ¶ç¯©é¸ã€‚
- ğŸš€ **æ‰¹é‡ä»»å‹™å¤–åŒ…**ï¼šå°æ–¼æ‰¹é‡æ¨é€ï¼ˆå¦‚ç”Ÿæ—¥ç¥ç¦ï¼‰ï¼Œæ‡‰å»ºç«‹ `System Broadcast` ä»»å‹™ï¼Œäº¤ç”±å»£æ’­éšŠåˆ—è™•ç†ã€‚
- âš¡ï¸ **å³æ™‚ä»»å‹™**ï¼šå°æ–¼åŒ¹é…æˆåŠŸç­‰å³æ™‚é€šçŸ¥ï¼Œç›´æ¥èª¿ç”¨ `NotificationService.sendImmediate()`ã€‚
- è©³è¦‹ [`doc/BROADCAST_SYSTEM_DESIGN.md`](./BROADCAST_SYSTEM_DESIGN.md) ç¬¬ 12 ç« èˆ‡æ¶æ§‹åœ–ã€‚

**âš ï¸ Telegram æ”¿ç­–èˆ‡å®‰å…¨è¦ç¯„**ï¼š
- âŒ **çµ•å°ç¦æ­¢**å‘ `bot_status != 'active'` çš„ç”¨æˆ¶ç™¼é€è¨Šæ¯
- âŒ **çµ•å°ç¦æ­¢**å‘å·²å°é– Bot çš„ç”¨æˆ¶ï¼ˆ`bot_status = 'blocked'`ï¼‰ç™¼é€
- âŒ **çµ•å°ç¦æ­¢**å‘å·²åˆªé™¤å¸³è™Ÿï¼ˆ`deleted_at IS NOT NULL`ï¼‰ç™¼é€
- âœ… ç³»çµ±å·²å…§å»ºè‡ªå‹•éæ¿¾æ©Ÿåˆ¶ï¼ˆ`telegram_error_handler.ts`ï¼‰
- âš ï¸ é•åæ­¤è¦ç¯„å¯èƒ½å°è‡´ Bot è¢« Telegram é™åˆ¶æˆ–å°ç¦

---

## 2. æ¨é€ç­–ç•¥

### 2.1 æ ¸å¿ƒåŸå‰‡

- **ä¸æ‰“æ“¾**ï¼šé¿å…éåº¦æ¨é€
- **æœ‰åƒ¹å€¼**ï¼šæ¨é€å…§å®¹å°ä½¿ç”¨è€…æœ‰æ„ç¾©
- **å€‹æ€§åŒ–**ï¼šæ ¹æ“šä½¿ç”¨è€…è¡Œç‚ºèª¿æ•´æ¨é€æ™‚æ©Ÿ
- **å¯æ§åˆ¶**ï¼šä½¿ç”¨è€…å¯é¸æ“‡é—œé–‰æ¨é€

### 2.2 æ¨é€æ™‚æ©Ÿåˆ¤æ–·

#### 2.2.1 ä¸Ÿç“¶æé†’

**è§¸ç™¼æ¢ä»¶**ï¼š
- ä½¿ç”¨è€…è¶…é 24 å°æ™‚æœªä¸Ÿç“¶
- ä½¿ç”¨è€…ä»Šæ—¥é‚„æœ‰å‰©é¤˜é…é¡
- ä½¿ç”¨è€…æœªåœ¨å°ç¦ç‹€æ…‹
- ä½¿ç”¨è€…å·²å®Œæˆ onboarding

**æ¨é€é »ç‡**ï¼š
- æ¯å¤©æœ€å¤š 1 æ¬¡
- å¦‚æœä½¿ç”¨è€…é€£çºŒ 3 å¤©æœªå›æ‡‰ï¼Œæš«åœæ¨é€ 2 å¤©

**æ¨é€å…§å®¹**ï¼š
```
ğŸŒŠ å—¨ï½ä»Šå¤©é‚„æ²’ä¸Ÿæ¼‚æµç“¶å‘¢ï¼

ä½ é‚„æœ‰ {remaining} å€‹é…é¡å¯ä»¥ç”¨
èªªä¸å®šæœ‰äººåœ¨ç­‰ä½ å“¦ï½ ğŸ’«

[ğŸ“¦ ç¾åœ¨å°±ä¸Ÿä¸€å€‹] [ç¨å¾Œæé†’æˆ‘]
```

#### 2.2.2 æ’¿ç“¶æé†’

**è§¸ç™¼æ¢ä»¶**ï¼š
- ä½¿ç”¨è€…è¶…é 12 å°æ™‚æœªæ’¿ç“¶
- ç³»çµ±ä¸­æœ‰ç¬¦åˆæ¢ä»¶çš„ç“¶å­
- ä½¿ç”¨è€…æœªåœ¨å°ç¦ç‹€æ…‹

**æ¨é€é »ç‡**ï¼š
- æ¯å¤©æœ€å¤š 2 æ¬¡ï¼ˆä¸Šåˆã€ä¸‹åˆå„ä¸€æ¬¡ï¼‰

**æ¨é€å…§å®¹**ï¼š
```
ğŸ” ç™¼ç¾æ–°çš„æ¼‚æµç“¶ï¼

æœ‰ {count} å€‹ç“¶å­åœ¨ç­‰ä½ æ’¿èµ·
èªªä¸å®šæœƒé‡åˆ°æœ‰è¶£çš„äººå“¦ï½ âœ¨

[ğŸ” å»æ’¿ç“¶å­] [ç¨å¾Œæé†’æˆ‘]
```

#### 2.2.3 åŒ¹é…æˆåŠŸå³æ™‚æ¨é€ï¼ˆMatch Success Notificationï¼‰

**è§¸ç™¼æ¢ä»¶**ï¼š
- ç•¶æœ‰ä½¿ç”¨è€…æ’¿åˆ°ä½ çš„ç“¶å­æ™‚
- å»ºç«‹ conversations å¾Œ**ç«‹å³æ¨é€**

**æ¨é€å°è±¡**ï¼š
- **ç“¶å­ä¸»äºº**ï¼ˆbottle.ownerï¼‰ï¼šå‘ŠçŸ¥æœ‰äººæ’¿åˆ°äº†ä½ çš„ç“¶å­

**æ¨é€é »ç‡**ï¼š
- **å³æ™‚æ¨é€**ï¼ˆéå®šæ™‚ï¼Œäº‹ä»¶è§¸ç™¼ï¼‰
- ä¸å—å®‰éœæ™‚æ®µé™åˆ¶ï¼ˆä½†å°Šé‡ä½¿ç”¨è€…çš„æ¨é€åå¥½è¨­å®šï¼‰

**æ¨é€å…§å®¹**ï¼š
```
ğŸ‰ æœ‰äººæ’¿åˆ°ä½ çš„æ¼‚æµç“¶äº†ï¼

å·²ç‚ºä½ å€‘å»ºç«‹äº†åŒ¿åå°è©±
å¿«ä¾†é–‹å§‹èŠå¤©å§ï½ âœ¨

[ğŸ’¬ é–‹å§‹å°è©±] [æŸ¥çœ‹å°æ–¹è³‡æ–™]
```

**æŠ€è¡“å¯¦ä½œ**ï¼š
- åœ¨ `handleCatch` handler ä¸­ï¼Œå»ºç«‹ conversations å¾Œç«‹å³èª¿ç”¨æ¨é€
- ä½¿ç”¨ `users.language_pref` æ±ºå®šæ¨é€èªè¨€ï¼ˆi18nï¼‰
- å°Šé‡ä½¿ç”¨è€…çš„ `user_push_preferences.message_reminder_enabled` è¨­å®š

#### 2.2.2 æœªå›è¦†è¨Šæ¯å–šé†’ (Message Retention)

**è¨­è¨ˆç›®æ¨™**ï¼šå–šé†’ã€Œå¿˜è¨˜å›è¦†ã€çš„ç”¨æˆ¶ï¼ŒæŒ½æ•‘ç€•è‡¨æ­»äº¡çš„å°è©±ã€‚

**è§¸ç™¼æ¢ä»¶**ï¼š
- å°è©±ç‹€æ…‹ç‚º `active`
- ç”¨æˆ¶æ˜¯ã€Œä¸‹ä¸€ä½ç™¼è¨€è€…ã€ï¼ˆLast Sender æ˜¯å°æ–¹ï¼‰
- è·é›¢ä¸Šä¸€æ¢è¨Šæ¯è¶…é **24 å°æ™‚**ï¼ˆé»ƒé‡‘å–šé†’é»ï¼‰
- è·é›¢ä¸Šä¸€æ¢è¨Šæ¯ä¸è¶…é **30 å¤©**ï¼ˆ30 å¤©å¾Œè¦–ç‚ºæ­»äº¡å°è©±ï¼Œæ”¾æ£„æ²»ç™‚ï¼‰

**é »ç‡é™åˆ¶**ï¼š
- **æ¯æ¢è¨Šæ¯åªæé†’ä¸€æ¬¡**ï¼ˆé¿å…å°åŒä¸€å¥è©±é‡è¤‡å˜®å¨ï¼‰
- **æ¯ 3 å¤©**æœ€å¤šæ”¶åˆ°ä¸€æ¬¡æ­¤é¡æé†’ï¼ˆå¦‚æœæœ‰å¤šå€‹å°è©±åŒæ™‚å†·æ‰ï¼‰

**æ–‡æ¡ˆç­–ç•¥ (å‹•æ…‹éš¨æ©Ÿ + éš±ç§é®ç½©)**ï¼š
- **éš±ç§åŸå‰‡**ï¼šæ¨é€é€šçŸ¥ä¸­çš„å°æ–¹æš±ç¨±**å¿…é ˆå»è­˜åˆ¥åŒ–**ï¼ˆå¦‚ `Alic***`ï¼‰ï¼Œä¿è­·ç”¨æˆ¶éš±ç§ã€‚
- *æ–‡æ¡ˆ A (æº«æƒ…)*: "ğŸ‘‹ Hey **{masked_partner_name}** é‚„åœ¨ç­‰ä½ å›è¦†å–”ï¼åˆ¥è®“å°è©±å†·æ‰äº†ï½"
- *æ–‡æ¡ˆ B (å¥½å¥‡)*: "ğŸ“© ä½ æœ‰ä¸€å‰‡ä¾†è‡ª **{masked_partner_name}** çš„æœªè®€è¨Šæ¯ï¼š"
  > *"{last_message_preview}..."*
  > (å·²ç¶“éäº† 24 å°æ™‚å›‰ï¼)
- *æ–‡æ¡ˆ C (ç›´æ¥)*: "â³ **{masked_partner_name}** æ­£åœ¨ç­‰å¾…ä½ çš„å›è¦†..."

**å¢å¼·å‹æ“ä½œ (Actionable)**ï¼š
æ¨é€è¨Šæ¯éœ€é™„å¸¶ Inline Keyboardï¼Œæ–¹ä¾¿ç”¨æˆ¶ä¸€éµè™•ç†ï¼š
- **[ğŸ’¬ å›è¦† {masked_partner_name}]**ï¼šé»æ“Šè§¸ç™¼ `/reply {conversation_id}`ï¼Œç›´æ¥é€²å…¥è©²å°è©±ã€‚
- **[ğŸ“œ æŸ¥çœ‹ä¸Šä¸‹æ–‡]**ï¼šé»æ“Šè§¸ç™¼ `/history {conversation_id} 3`ï¼Œé¡¯ç¤ºæœ€å¾Œ 3 å‰‡è¨Šæ¯å¹«åŠ©å›æ†¶ã€‚

**æŠ€è¡“å¯¦ä½œè¦æ±‚**ï¼š
- éœ€åœ¨ `conversations` è¡¨æ–°å¢ `last_sender_id` æ¬„ä½ä»¥è¿½è¹¤ç™¼è¨€æ¬Šã€‚
- æ¨é€å‰éœ€èª¿ç”¨ `maskNickname()` è™•ç†å°æ–¹æš±ç¨±ã€‚
- éœ€æˆªå– `last_message` çš„å‰ 15 å€‹å­—ä½œç‚ºé è¦½ï¼ˆæ³¨æ„éæ¿¾æ•æ„Ÿè©ï¼‰ã€‚
- Cron Job æ¯å°æ™‚æƒæä¸€æ¬¡ã€‚

#### 2.2.5 Onboarding æœªå®Œæˆæé†’

**è§¸ç™¼æ¢ä»¶**ï¼š
- ä½¿ç”¨è€…é–‹å§‹ onboarding ä½†æœªå®Œæˆ
- è·é›¢ä¸Šæ¬¡æ“ä½œè¶…é 24 å°æ™‚
- è·é›¢é–‹å§‹æ™‚é–“ä¸è¶…é 7 å¤©ï¼ˆè¶…é 7 å¤©ä¸å†æé†’ï¼‰

**æ¨é€é »ç‡**ï¼š
- æ¯ 24 å°æ™‚æœ€å¤š 1 æ¬¡
- æœ€å¤šæ¨é€ 3 æ¬¡ï¼ˆå¦‚æœä½¿ç”¨è€… 3 æ¬¡éƒ½æœªå›æ‡‰ï¼Œåœæ­¢æé†’ï¼‰

**æ¨é€å…§å®¹**ï¼š
```
ğŸ“ ä½ çš„è¨»å†Šé‚„æ²’å®Œæˆå‘¢ï¼

é‚„å·® {remaining_steps} æ­¥å°±å¯ä»¥é–‹å§‹ä½¿ç”¨ XunNi äº†
å®Œæˆå¾Œå°±èƒ½ä¸Ÿæ¼‚æµç“¶ã€èªè­˜æ–°æœ‹å‹å“¦ï½ âœ¨

[â–¶ï¸ ç¹¼çºŒå®Œæˆè¨»å†Š] [ç¨å¾Œæé†’æˆ‘]
```

**æœªå®Œæˆé …ç›®æç¤º**ï¼š
- å¦‚æœç¼ºå°‘ MBTI æ¸¬é©—ï¼šã€Œé‚„å·® MBTI æ¸¬é©—ã€
- å¦‚æœç¼ºå°‘åè©é¨™æ¸¬é©—ï¼šã€Œé‚„å·®å®‰å…¨æ¸¬é©—ã€
- å¦‚æœç¼ºå°‘å€‹äººè³‡æ–™ï¼šã€Œé‚„å·®å€‹äººè³‡æ–™è¨­å®šã€

#### 2.2.6 æ¸¬é©—å®Œæˆåˆ†äº«æé†’

**è§¸ç™¼æ¢ä»¶**ï¼š
- ä½¿ç”¨è€…å®Œæˆ MBTI æ¸¬é©—
- ä½¿ç”¨è€…æœªåœ¨ 24 å°æ™‚å…§åˆ†äº«æ¸¬é©—çµæœ

**æ¨é€é »ç‡**ï¼š
- æ¸¬é©—å®Œæˆå¾Œ 2 å°æ™‚æ¨é€ç¬¬ä¸€æ¬¡
- å¦‚æœæœªåˆ†äº«ï¼Œ24 å°æ™‚å¾Œæ¨é€ç¬¬äºŒæ¬¡
- æœ€å¤šæ¨é€ 2 æ¬¡

**æ¨é€å…§å®¹**ï¼š
```
ğŸ‰ ä½ çš„ MBTI æ¸¬é©—çµæœå‡ºçˆäº†ï¼

å¿«ä¾†çœ‹çœ‹ä½ çš„æ€§æ ¼é¡å‹
èªªä¸å®šæœƒæ‰¾åˆ°ç›¸ä¼¼çš„äººå“¦ï½ âœ¨

[ğŸ“Š æŸ¥çœ‹çµæœ] [ğŸ”— åˆ†äº«çµ¦å¥½å‹] [ç¨å¾Œæé†’æˆ‘]
```

**åˆ†äº«åŠŸèƒ½**ï¼š
- é»æ“Šã€Œåˆ†äº«çµ¦å¥½å‹ã€å¾Œï¼š
  - ä½¿ç”¨ `WebApp.share` API åˆ†äº«
  - Deep Link æ ¼å¼ï¼š`startapp=share_mbti_{resultId}`
  - åˆ†äº«æ–‡æ¡ˆç¤ºä¾‹ï¼šã€Œæˆ‘çš„ MBTI æ¸¬é©—çµæœæ˜¯ {type}ï¼ä½ ä¹Ÿä¾†æ¸¬æ¸¬å§ï½ã€
  - åŒ…å«æ¸¬é©—çµæœé è¦½åœ–ç‰‡
- åŸ‹é»è¦æ±‚ï¼š
  - `POST /api/tests/:slug/share` åŸ‹é»
  - è¨˜éŒ„åˆ†äº«ä¾†æºï¼ˆMBTI æ¸¬é©—å®Œæˆï¼‰ã€æ™‚é–“ã€ä½¿ç”¨è€… ID
  - è¿½è¹¤åˆ†äº«è½‰åŒ–ç‡ï¼ˆé»æ“Šåˆ†äº«é€£çµä¸¦å®Œæˆè¨»å†Šçš„ä½¿ç”¨è€…ï¼‰

**åˆ†äº« Deep Link è™•ç†**ï¼š
- ç•¶ä½¿ç”¨è€…é»æ“Šåˆ†äº«é€£çµé€²å…¥ Bot æ™‚ï¼š
  - æª¢æŸ¥ `startapp` åƒæ•¸
  - å¦‚æœæ˜¯ `share_mbti_{resultId}`ï¼Œé¡¯ç¤ºï¼š
    ```
    ğŸ‘‹ ä½ çš„å¥½å‹é‚€è«‹ä½ ä¾†æ¸¬ MBTIï¼
    
    å¿«ä¾†çœ‹çœ‹ä½ çš„æ€§æ ¼é¡å‹å§ï½
    [ğŸ“Š é–‹å§‹æ¸¬é©—]
    ```
  - è¨˜éŒ„åˆ†äº«ä¾†æºï¼ˆç”¨æ–¼ KPI è¿½è¹¤ï¼‰

---

## 3. æ™ºèƒ½æ¨é€ç®—æ³•

### 3.1 ä½¿ç”¨è€…æ´»èºåº¦åˆ†ç´š

```typescript
enum UserActivityLevel {
  VERY_ACTIVE = 'very_active',    // æ¯å¤©ä½¿ç”¨
  ACTIVE = 'active',              // æ¯é€±ä½¿ç”¨ 3+ æ¬¡
  MODERATE = 'moderate',          // æ¯é€±ä½¿ç”¨ 1-2 æ¬¡
  INACTIVE = 'inactive',         // è¶…é 7 å¤©æœªä½¿ç”¨
  DORMANT = 'dormant'            // è¶…é 30 å¤©æœªä½¿ç”¨
}
```

### 3.2 æ¨é€é »ç‡èª¿æ•´

| æ´»èºåº¦ | ä¸Ÿç“¶æé†’ | æ’¿ç“¶æé†’ | å°è©±æé†’ | åŒ¹é…æˆåŠŸæ¨é€ |
|--------|---------|---------|---------|------------|
| VERY_ACTIVE | ä¸æ¨é€ | ä¸æ¨é€ | åƒ…æœªè®€æé†’ | âœ… å³æ™‚æ¨é€ |
| ACTIVE | 48 å°æ™‚ | 24 å°æ™‚ | 4 å°æ™‚ | âœ… å³æ™‚æ¨é€ |
| MODERATE | 24 å°æ™‚ | 12 å°æ™‚ | 2 å°æ™‚ | âœ… å³æ™‚æ¨é€ |
| INACTIVE | 12 å°æ™‚ | 6 å°æ™‚ | 1 å°æ™‚ | âœ… å³æ™‚æ¨é€ |
| DORMANT | ä¸æ¨é€ | ä¸æ¨é€ | ä¸æ¨é€ | âŒ ä¸æ¨é€ï¼ˆé¿å…æ‰“æ“¾ï¼‰ |

**æ³¨æ„**ï¼š
- **åŒ¹é…æˆåŠŸæ¨é€**ç‚ºå³æ™‚äº‹ä»¶æ¨é€ï¼Œä¸å—å®šæ™‚æ¨é€é »ç‡é™åˆ¶
- ä½†éœ€å°Šé‡ä½¿ç”¨è€…çš„æ¨é€åå¥½è¨­å®šï¼ˆå¦‚å·²é—œé–‰å°è©±æé†’ï¼Œå‰‡ä¸æ¨é€åŒ¹é…æˆåŠŸï¼‰

### 3.3 ä½¿ç”¨è€…åå¥½è¨­å®š

**è®Šæ›´èªªæ˜**ï¼š
- **ç§»é™¤å‰ç«¯é–‹é—œ**ï¼šUI ä¸Šä¸å†æä¾› `throw/catch/message` çš„é–‹é—œã€‚
- **å¾Œç«¯ä¿ç•™æ¬„ä½**ï¼šè³‡æ–™åº« `user_push_preferences` ä»ä¿ç•™é€™äº›æ¬„ä½ï¼ˆé è¨­ç‚º 1ï¼‰ï¼Œä»¥ä¾¿æœªä¾†é‹ç‡Ÿéœ€è¦æ™‚å¯å¾å¾Œç«¯èª¿æ•´ï¼Œæˆ–ä½œç‚º A/B Test çš„æ§åˆ¶é …ã€‚
- **å®‰éœæ™‚æ®µ**ï¼šä¿ç•™å®‰éœæ™‚æ®µè¨­å®šï¼Œé€™æ˜¯å°ç”¨æˆ¶å‹å¥½çš„å¿…è¦åŠŸèƒ½ã€‚

```sql
CREATE TABLE user_push_preferences (
  user_id TEXT PRIMARY KEY,
  throw_reminder_enabled INTEGER DEFAULT 1,   -- UI ä¸é¡¯ç¤ºï¼Œå¾Œç«¯é è¨­ 1
  catch_reminder_enabled INTEGER DEFAULT 1,   -- UI ä¸é¡¯ç¤ºï¼Œå¾Œç«¯é è¨­ 1
  message_reminder_enabled INTEGER DEFAULT 1, -- UI ä¸é¡¯ç¤ºï¼Œå¾Œç«¯é è¨­ 1
  quiet_hours_start INTEGER DEFAULT 0,        -- é è¨­ 00:00 (UTC)
  quiet_hours_end INTEGER DEFAULT 8,          -- é è¨­ 08:00 (UTC)
  updated_at DATETIME
);
```

---

## 4. è³‡æ–™åº«è¨­è¨ˆ

### 4.1 conversations è¡¨è®Šæ›´ (Migration 0059)

ç‚ºäº†æ”¯æ´ã€Œæœªå›è¦†å–šé†’ã€ï¼Œå¿…é ˆçŸ¥é“æœ€å¾Œä¸€å¥è©±æ˜¯èª°èªªçš„ã€‚

```sql
ALTER TABLE conversations ADD COLUMN last_sender_id TEXT;
CREATE INDEX IF NOT EXISTS idx_conversations_remind_check ON conversations(status, last_message_at, last_sender_id);
```

### 4.2 push_notificationsï¼ˆæ¨é€è¨˜éŒ„ï¼‰

```sql
CREATE TABLE push_notifications (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT,
  type TEXT,         -- 'throw_reminder' / 'catch_reminder' / 'message_reminder'
  status TEXT DEFAULT 'sent', -- 'sent', 'failed', 'blocked'
  sent_at TEXT DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(telegram_id)
);

CREATE INDEX idx_push_notifications_user_id ON push_notifications(user_id);
CREATE INDEX idx_push_notifications_sent_at ON push_notifications(sent_at);
```

### 4.2 push_scheduleï¼ˆæ¨é€æ’ç¨‹ï¼‰

```sql
CREATE TABLE push_schedule (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT,
  notification_type TEXT,
  scheduled_at DATETIME,
  status TEXT,                   -- 'pending' / 'sent' / 'cancelled'
  created_at DATETIME
);

CREATE INDEX idx_push_schedule_user_id ON push_schedule(user_id);
CREATE INDEX idx_push_schedule_scheduled_at ON push_schedule(scheduled_at);
```

---

## 5. Cron ä»»å‹™è¨­è¨ˆ

### 5.1 /cron/push_remindersï¼ˆæ¨é€æé†’ï¼‰

æ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡ï¼š

```typescript
// src/telegram/handlers/cron_push.ts

export async function handlePushReminders(
  env: Env,
  db: D1Database
): Promise<void> {
  const now = new Date();
  
  // 1. æ‰¾å‡ºéœ€è¦æ¨é€çš„ä½¿ç”¨è€…
  const usersToNotify = await db.prepare(`
    SELECT u.*, p.throw_reminder_enabled, p.catch_reminder_enabled
    FROM users u
    LEFT JOIN user_push_preferences p ON u.telegram_id = p.user_id
    WHERE u.onboarding_completed_at IS NOT NULL
      AND u.risk_score < 50
      AND NOT EXISTS (
        SELECT 1 FROM bans b
        WHERE b.user_id = u.telegram_id
          AND b.ban_end > datetime('now')
      )
  `).all();
  
  for (const user of usersToNotify.results) {
    const activityLevel = await getUserActivityLevel(user.telegram_id, db);
    const preferences = await getUserPushPreferences(user.telegram_id, db);
    
    // æª¢æŸ¥å®‰éœæ™‚æ®µ
    if (isQuietHours(now, preferences)) {
      continue;
    }
    
    // ä¸Ÿç“¶æé†’
    if (shouldSendThrowReminder(user, activityLevel, db)) {
      await sendThrowReminder(env, user, db);
    }
    
    // æ’¿ç“¶æé†’
    if (shouldSendCatchReminder(user, activityLevel, db)) {
      await sendCatchReminder(env, user, db);
    }
    
    // å°è©±æé†’
    if (shouldSendMessageReminder(user, activityLevel, db)) {
      await sendMessageReminder(env, user, db);
    }
  }
}
```

**æ³¨æ„**ï¼šåŒ¹é…æˆåŠŸæ¨é€ä¸åœ¨ Cron ä»»å‹™ä¸­è™•ç†ï¼Œè€Œæ˜¯åœ¨ `handleCatch` handler ä¸­**å³æ™‚è§¸ç™¼**ã€‚

---

## 6. æ¨é€å…§å®¹è¨­è¨ˆ

### 6.1 ä¸Ÿç“¶æé†’ï¼ˆå¤šç¨®ç‰ˆæœ¬ï¼‰

**ç‰ˆæœ¬ 1ï¼ˆæº«å’Œï¼‰**ï¼š
```
ğŸŒŠ ä»Šå¤©é‚„æ²’ä¸Ÿæ¼‚æµç“¶å‘¢ï½

ä½ é‚„æœ‰ {remaining} å€‹é…é¡
èªªä¸å®šæœ‰äººåœ¨ç­‰ä½ å“¦ ğŸ’«

[ğŸ“¦ ç¾åœ¨å°±ä¸Ÿ] [ç¨å¾Œæé†’]
```

**ç‰ˆæœ¬ 2ï¼ˆé¼“å‹µï¼‰**ï¼š
```
âœ¨ æ–°çš„é–‹å§‹ï¼Œæ–°çš„ç›¸é‡

ä»Šå¤©é‚„æ²’ä¸Ÿæ¼‚æµç“¶ï¼Ÿ
ä¹Ÿè¨±æœƒé‡åˆ°ç‰¹åˆ¥çš„äººå“¦ï½

[ğŸ“¦ ä¸Ÿä¸€å€‹è©¦è©¦] [ç¨å¾Œæé†’]
```

**ç‰ˆæœ¬ 3ï¼ˆæ•¸æ“šé©…å‹•ï¼‰**ï¼š
```
ğŸ“Š ä½ çš„æ•¸æ“š

ç¸½å…±ä¸Ÿäº† {total} å€‹ç“¶å­
é…å°æˆåŠŸ {matches} æ¬¡

ä»Šå¤©è¦ä¸è¦å†è©¦è©¦ï¼Ÿ ğŸ¯

[ğŸ“¦ ä¸Ÿç“¶å­] [ç¨å¾Œæé†’]
```

### 6.2 äº’å‹•æŒ‰éˆ•

æ‰€æœ‰æ¨é€éƒ½åŒ…å«ï¼š
- **ä¸»è¦è¡Œå‹•æŒ‰éˆ•**ï¼šç›´æ¥åŸ·è¡Œæ“ä½œï¼ˆä¸Ÿç“¶/æ’¿ç“¶/æŸ¥çœ‹å°è©±ï¼‰
- **ç¨å¾Œæé†’**ï¼šè¨­å®š 2 å°æ™‚å¾Œå†æé†’
- **é—œé–‰æé†’**ï¼šä»Šå¤©ä¸å†æé†’

---

## 7. é¿å…æ‰“æ“¾æ©Ÿåˆ¶

### 7.1 æ¨é€é™åˆ¶è¦å‰‡

1. **æ¯æ—¥ä¸Šé™**ï¼šæ¯å€‹ä½¿ç”¨è€…æ¯å¤©æœ€å¤šæ”¶åˆ° 3 æ¢æ¨é€
2. **é–“éš”é™åˆ¶**ï¼šåŒä¸€é¡å‹æ¨é€é–“éš”è‡³å°‘ 4 å°æ™‚
3. **å›æ‡‰è¿½è¹¤**ï¼šå¦‚æœä½¿ç”¨è€…é€£çºŒ 3 æ¬¡é»æ“Šã€Œç¨å¾Œæé†’ã€ï¼Œæš«åœè©²é¡å‹æ¨é€ 24 å°æ™‚
4. **é—œé–‰é¸é …**ï¼šä½¿ç”¨è€…å¯å®Œå…¨é—œé–‰æŸé¡æ¨é€

### 7.2 å®‰éœæ™‚æ®µ

- é è¨­ï¼š22:00 - 08:00ï¼ˆä½¿ç”¨è€…ç•¶åœ°æ™‚é–“ï¼‰
- ä½¿ç”¨è€…å¯è‡ªè¨‚
- å®‰éœæ™‚æ®µå…§ä¸ç™¼é€éç·Šæ€¥æ¨é€

### 7.3 æ¨é€æ•ˆæœè¿½è¹¤

```typescript
// è¿½è¹¤æ¨é€æ•ˆæœ
interface PushNotificationMetrics {
  sent: number;
  clicked: number;
  dismissed: number;
  conversionRate: number; // é»æ“Šå¾Œå¯¦éš›å®Œæˆæ“ä½œçš„æ¯”ä¾‹
}

// æ ¹æ“šæ•ˆæœèª¿æ•´ç­–ç•¥
if (metrics.conversionRate < 0.1) {
  // è½‰åŒ–ç‡ä½æ–¼ 10%ï¼Œæ¸›å°‘è©²é¡å‹æ¨é€é »ç‡
  adjustPushFrequency(type, -20);
}
```

---

## 8. ä½¿ç”¨è€…æ§åˆ¶ (UI è®Šæ›´)

### 8.1 /settingsï¼ˆè¨­å®šï¼‰

**ç§»é™¤ç´°ç²’åº¦é–‹é—œï¼Œç°¡åŒ–ç‚º**ï¼š

```
âš™ï¸ è¨­å®š

ğŸŒ èªè¨€ï¼šç¹é«”ä¸­æ–‡
ğŸŒ™ å®‰éœæ™‚æ®µï¼š22:00 - 08:00
   (åœ¨æ­¤æ™‚æ®µå…§ä¸æœƒæ”¶åˆ°éç·Šæ€¥é€šçŸ¥)

[ä¿®æ”¹èªè¨€] [ä¿®æ”¹å®‰éœæ™‚æ®µ]
[è¿”å›]
```

**ç†ç”±**ï¼šæ¸›å°‘æ±ºç­–è² æ“”ï¼Œé¼“å‹µç”¨æˆ¶ä½¿ç”¨ Telegram çš„ Mute åŠŸèƒ½ä¾†ç®¡ç†å¹²æ“¾ï¼Œå¾è€Œæœ€å¤§åŒ–æˆ‘å€‘çš„è§¸é”ç‡ã€‚

---

## 9. æœ€ä½³å¯¦è¸

1. **A/B æ¸¬è©¦**ï¼šæ¸¬è©¦ä¸åŒæ¨é€å…§å®¹çš„æ•ˆæœ
2. **å€‹æ€§åŒ–**ï¼šæ ¹æ“šä½¿ç”¨è€…è¡Œç‚ºèª¿æ•´æ¨é€å…§å®¹
3. **æ•¸æ“šé©…å‹•**ï¼šæ ¹æ“šæ¨é€æ•ˆæœæŒçºŒå„ªåŒ–
4. **ä½¿ç”¨è€…åé¥‹**ï¼šæ”¶é›†ä½¿ç”¨è€…å°æ¨é€çš„æ„è¦‹
5. **å°Šé‡é¸æ“‡**ï¼šæä¾›ç°¡å–®çš„é—œé–‰é¸é …

---

## 10. æ³¨æ„äº‹é …

1. **æˆæœ¬æ§åˆ¶**ï¼šæ¨é€æœƒæ¶ˆè€— Telegram API é…é¡ï¼Œéœ€æ§åˆ¶é »ç‡
2. **éš±ç§ä¿è­·**ï¼šæ¨é€å…§å®¹ä¸åŒ…å«æ•æ„Ÿè³‡è¨Š
3. **éŒ¯èª¤è™•ç†**ï¼šè™•ç†ä½¿ç”¨è€…å·²å°é– Bot çš„æƒ…æ³
4. **ç›£æ§å‘Šè­¦**ï¼šç›£æ§æ¨é€å¤±æ•—ç‡ï¼ŒåŠæ™‚è™•ç†å•é¡Œ

