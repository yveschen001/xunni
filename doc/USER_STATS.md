# XunNi ä½¿ç”¨è€…æ•¸æ“šçµ±è¨ˆåŠŸèƒ½

## 1. æ¦‚è¿°

æä¾›å®Œæ•´çš„ä½¿ç”¨è€…æ•¸æ“šçµ±è¨ˆåŠŸèƒ½ï¼Œè®“ä½¿ç”¨è€…äº†è§£è‡ªå·±çš„ä½¿ç”¨æƒ…æ³å’Œæ´»èºåº¦æ’åã€‚

---

## 2. æ•¸æ“šçµ±è¨ˆå…§å®¹

### 2.1 æ¼‚æµç“¶çµ±è¨ˆ

- ç¸½ä¸Ÿç“¶æ•¸ï¼šå¾è¨»å†Šè‡³ä»Šç´¯è¨ˆ
- æœ€è¿‘ 7 å¤©ä¸Ÿç“¶æ•¸
- æœ€è¿‘ 30 å¤©ä¸Ÿç“¶æ•¸
- ä»Šæ—¥ä¸Ÿç“¶æ•¸
- ç¸½æ’¿ç“¶æ•¸
- æˆåŠŸé…å°æ•¸ï¼ˆæ’¿åˆ°ç“¶å¾Œå»ºç«‹å°è©±ï¼‰

### 2.2 èŠå¤©çµ±è¨ˆ

- ç¸½èŠå¤©æ¬¡æ•¸ï¼šæ‰€æœ‰å°è©±çš„è¨Šæ¯ç¸½æ•¸
- æ´»èºå°è©±æ•¸ï¼šç•¶å‰æœ‰æ´»èºå°è©±çš„æ•¸é‡
- ç¸½å°è©±å°è±¡æ•¸ï¼šæ›¾ç¶“èŠéçš„ä¸åŒä½¿ç”¨è€…æ•¸é‡
- æœ€è¿‘ 7 å¤©èŠå¤©æ¬¡æ•¸
- æœ€è¿‘ 30 å¤©èŠå¤©æ¬¡æ•¸

### 2.3 å……å€¼è¨˜éŒ„

- ç¸½å……å€¼é‡‘é¡ï¼ˆTelegram Starsï¼‰
- å……å€¼æ¬¡æ•¸
- å……å€¼è¨˜éŒ„åˆ—è¡¨ï¼ˆæ™‚é–“ã€é‡‘é¡ã€ç‹€æ…‹ï¼‰
- ç•¶å‰é¤˜é¡ï¼ˆå¦‚æœ‰é¤˜é¡ç³»çµ±ï¼‰

### 2.4 æ´»èºåº¦æ’å

- å…¨çƒæ’åç™¾åˆ†æ¯”
- æ´»èºåº¦åˆ†æ•¸è¨ˆç®—
- æ’åè®ŠåŒ–è¶¨å‹¢

---

## 3. æŒ‡ä»¤è¨­è¨ˆ

### 3.1 /statsï¼ˆæˆ‘çš„çµ±è¨ˆï¼‰

é¡¯ç¤ºå®Œæ•´çš„ä½¿ç”¨è€…çµ±è¨ˆæ•¸æ“šï¼š

```
ğŸ“Š æˆ‘çš„æ•¸æ“šçµ±è¨ˆ

ğŸ“¦ æ¼‚æµç“¶æ•¸æ“š
â”œâ”€ ç¸½ä¸Ÿç“¶æ•¸ï¼š{totalThrows}
â”œâ”€ ç¸½æ’¿ç“¶æ•¸ï¼š{totalCatches}
â”œâ”€ æˆåŠŸé…å°ï¼š{successfulMatches}
â”œâ”€ ä»Šæ—¥ä¸Ÿç“¶ï¼š{throwsToday} / {dailyLimit}
â””â”€ æœ€è¿‘ 7 å¤©ï¼š{throws7d} å€‹

ğŸ’¬ èŠå¤©æ•¸æ“š
â”œâ”€ ç¸½èŠå¤©æ¬¡æ•¸ï¼š{totalMessages}
â”œâ”€ æ´»èºå°è©±ï¼š{activeConversations} å€‹
â”œâ”€ å°è©±å°è±¡ï¼š{uniquePartners} äºº
â””â”€ æœ€è¿‘ 7 å¤©ï¼š{messages7d} å‰‡

ğŸ’° å……å€¼è¨˜éŒ„
â”œâ”€ ç¸½å……å€¼ï¼š{totalRecharged} Stars
â”œâ”€ å……å€¼æ¬¡æ•¸ï¼š{rechargeCount} æ¬¡
â””â”€ [æŸ¥çœ‹è©³ç´°è¨˜éŒ„]

ğŸ† æ´»èºåº¦æ’å
â”œâ”€ å…¨çƒæ’åï¼šå‰ {percentile}%
â”œâ”€ æ´»èºåº¦åˆ†æ•¸ï¼š{activityScore}
â””â”€ [æŸ¥çœ‹æ’è¡Œæ¦œ]

[ğŸ“ˆ æŸ¥çœ‹è¶¨å‹¢] [ğŸ”„ åˆ·æ–°æ•¸æ“š]
```

### 3.2 /recharge_historyï¼ˆå……å€¼è¨˜éŒ„ï¼‰

é¡¯ç¤ºè©³ç´°çš„å……å€¼è¨˜éŒ„ï¼š

```
ğŸ’° å……å€¼è¨˜éŒ„

ç¸½è¨ˆï¼š{totalStars} Stars
å…± {count} ç­†è¨˜éŒ„

ğŸ“… {date} - {amount} Stars
   ç‹€æ…‹ï¼š{status}
   è¨‚å–®è™Ÿï¼š{payment_id}

ğŸ“… {date} - {amount} Stars
   ç‹€æ…‹ï¼š{status}
   è¨‚å–®è™Ÿï¼š{payment_id}

...

[ä¸Šä¸€é ] [ä¸‹ä¸€é ]
```

---

## 4. è³‡æ–™åº«è¨­è¨ˆ

### 4.1 user_statisticsï¼ˆä½¿ç”¨è€…çµ±è¨ˆå¿«å–ï¼‰

```sql
CREATE TABLE user_statistics (
  user_id TEXT PRIMARY KEY,
  
  -- æ¼‚æµç“¶çµ±è¨ˆ
  total_throws INTEGER DEFAULT 0,
  total_catches INTEGER DEFAULT 0,
  successful_matches INTEGER DEFAULT 0,
  
  -- èŠå¤©çµ±è¨ˆ
  total_messages INTEGER DEFAULT 0,
  unique_partners INTEGER DEFAULT 0,
  
  -- æ´»èºåº¦
  activity_score INTEGER DEFAULT 0,
  last_active_at DATETIME,
  
  -- æ™‚é–“æˆ³
  updated_at DATETIME,
  last_calculated_at DATETIME
);

CREATE INDEX idx_user_statistics_activity_score ON user_statistics(activity_score DESC);
```

### 4.2 recharge_recordsï¼ˆå……å€¼è¨˜éŒ„ï¼‰

```sql
CREATE TABLE recharge_records (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT,
  payment_id INTEGER,           -- FK -> payments.id
  stars_amount INTEGER,          -- å……å€¼é‡‘é¡ï¼ˆStarsï¼‰
  recharge_type TEXT,            -- 'vip_subscription' / 'direct_recharge' / 'gift'
  status TEXT,                   -- 'success' / 'pending' / 'failed' / 'refunded'
  created_at DATETIME,
  
  FOREIGN KEY (payment_id) REFERENCES payments(id)
);

CREATE INDEX idx_recharge_records_user_id ON recharge_records(user_id);
CREATE INDEX idx_recharge_records_created_at ON recharge_records(created_at DESC);
```

### 4.3 conversation_messagesï¼ˆèŠå¤©è¨˜éŒ„ï¼‰

```sql
CREATE TABLE conversation_messages (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  conversation_id INTEGER,       -- FK -> conversations.id
  sender_id TEXT,                -- FK -> users.telegram_id
  receiver_id TEXT,               -- FK -> users.telegram_id
  message_text TEXT,
  is_translated INTEGER DEFAULT 0, -- æ˜¯å¦ç¶“éç¿»è­¯
  original_language TEXT,
  translated_language TEXT,
  created_at DATETIME,
  
  FOREIGN KEY (conversation_id) REFERENCES conversations(id)
);

CREATE INDEX idx_conversation_messages_conversation_id ON conversation_messages(conversation_id);
CREATE INDEX idx_conversation_messages_sender_id ON conversation_messages(sender_id);
CREATE INDEX idx_conversation_messages_created_at ON conversation_messages(created_at);
```

### 4.4 bottle_chat_historyï¼ˆæ¼‚æµç“¶èŠå¤©è¨˜éŒ„ï¼‰

```sql
CREATE TABLE bottle_chat_history (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  bottle_id INTEGER,             -- FK -> bottles.id
  conversation_id INTEGER,       -- FK -> conversations.id
  user_a_id TEXT,               -- ä¸Ÿç“¶è€…
  user_b_id TEXT,               -- æ’¿ç“¶è€…
  bottle_content TEXT,          -- ç“¶å­åŸå§‹å…§å®¹
  first_message_at DATETIME,    -- ç¬¬ä¸€æ¢è¨Šæ¯æ™‚é–“
  last_message_at DATETIME,     -- æœ€å¾Œä¸€æ¢è¨Šæ¯æ™‚é–“
  total_messages INTEGER DEFAULT 0,
  status TEXT,                  -- 'active' / 'closed' / 'blocked'
  created_at DATETIME
);

CREATE INDEX idx_bottle_chat_history_bottle_id ON bottle_chat_history(bottle_id);
CREATE INDEX idx_bottle_chat_history_user_a_id ON bottle_chat_history(user_a_id);
CREATE INDEX idx_bottle_chat_history_user_b_id ON bottle_chat_history(user_b_id);
```

---

## 5. æ´»èºåº¦è¨ˆç®—

### 5.1 æ´»èºåº¦åˆ†æ•¸å…¬å¼

```typescript
activityScore = 
  (totalThrows * 10) +           // ä¸Ÿç“¶ï¼š10 åˆ†/å€‹
  (totalCatches * 5) +          // æ’¿ç“¶ï¼š5 åˆ†/å€‹
  (totalMessages * 1) +         // èŠå¤©ï¼š1 åˆ†/å‰‡
  (activeDays7d * 20) +         // 7 å¤©æ´»èºï¼š20 åˆ†/å¤©
  (uniquePartners * 15) +       // å°è©±å°è±¡ï¼š15 åˆ†/äºº
  (isVip ? 100 : 0)             // VIP åŠ æˆï¼š100 åˆ†
```

### 5.2 æ’åè¨ˆç®—

```typescript
async function getUserRankPercentile(
  userId: string,
  db: D1Database
): Promise<number> {
  const userStats = await db.getUserStatistics(userId);
  if (!userStats) return 100;
  
  // è¨ˆç®—æœ‰å¤šå°‘ä½¿ç”¨è€…çš„æ´»èºåº¦åˆ†æ•¸ä½æ–¼ç•¶å‰ä½¿ç”¨è€…
  const lowerCount = await db.prepare(`
    SELECT COUNT(*) as count
    FROM user_statistics
    WHERE activity_score < ?
  `).bind(userStats.activity_score).first();
  
  // è¨ˆç®—ç¸½ä½¿ç”¨è€…æ•¸
  const totalCount = await db.prepare(`
    SELECT COUNT(*) as count
    FROM user_statistics
  `).first();
  
  const percentile = (lowerCount.count / totalCount.count) * 100;
  return Math.round(percentile * 100) / 100; // ä¿ç•™å…©ä½å°æ•¸
}
```

---

## 6. å¯¦ä½œç¯„ä¾‹

### 6.1 æ›´æ–°ä½¿ç”¨è€…çµ±è¨ˆ

```typescript
// src/domain/user_stats.ts

export async function updateUserStatistics(
  userId: string,
  db: D1Database
): Promise<void> {
  // è¨ˆç®—ç¸½ä¸Ÿç“¶æ•¸
  const totalThrows = await db.prepare(`
    SELECT COUNT(*) as count
    FROM bottles
    WHERE owner_id = ?
  `).bind(userId).first();
  
  // è¨ˆç®—ç¸½æ’¿ç“¶æ•¸ï¼ˆæˆåŠŸé…å°ï¼‰
  const totalCatches = await db.prepare(`
    SELECT COUNT(*) as count
    FROM conversations
    WHERE user_b_id = ? OR (user_a_id = ? AND user_b_id != user_a_id)
  `).bind(userId, userId).first();
  
  // è¨ˆç®—ç¸½èŠå¤©æ¬¡æ•¸
  const totalMessages = await db.prepare(`
    SELECT COUNT(*) as count
    FROM conversation_messages
    WHERE sender_id = ?
  `).bind(userId).first();
  
  // è¨ˆç®—å°è©±å°è±¡æ•¸
  const uniquePartners = await db.prepare(`
    SELECT COUNT(DISTINCT CASE 
      WHEN user_a_id = ? THEN user_b_id 
      ELSE user_a_id 
    END) as count
    FROM conversations
    WHERE (user_a_id = ? OR user_b_id = ?)
      AND status = 'active'
  `).bind(userId, userId, userId).first();
  
  // è¨ˆç®—æ´»èºåº¦åˆ†æ•¸
  const user = await db.getUser(userId);
  const activityScore = calculateActivityScore({
    totalThrows: totalThrows.count,
    totalCatches: totalCatches.count,
    totalMessages: totalMessages.count,
    uniquePartners: uniquePartners.count,
    isVip: user.is_vip === 1,
  });
  
  // æ›´æ–°çµ±è¨ˆè¡¨
  await db.prepare(`
    INSERT INTO user_statistics (
      user_id, total_throws, total_catches, total_messages,
      unique_partners, activity_score, updated_at, last_calculated_at
    ) VALUES (?, ?, ?, ?, ?, ?, datetime('now'), datetime('now'))
    ON CONFLICT(user_id) DO UPDATE SET
      total_throws = excluded.total_throws,
      total_catches = excluded.total_catches,
      total_messages = excluded.total_messages,
      unique_partners = excluded.unique_partners,
      activity_score = excluded.activity_score,
      updated_at = datetime('now'),
      last_calculated_at = datetime('now')
  `).bind(
    userId,
    totalThrows.count,
    totalCatches.count,
    totalMessages.count,
    uniquePartners.count,
    activityScore
  ).run();
}
```

---

## 7. èŠå¤©è¨˜éŒ„æŸ¥çœ‹

### 7.1 /chat_historyï¼ˆèŠå¤©è¨˜éŒ„ï¼‰

```
ğŸ’¬ æˆ‘çš„èŠå¤©è¨˜éŒ„

ç•¶å‰æ´»èºå°è©±ï¼š{activeCount} å€‹

ğŸ“¦ ä¾†è‡ªæ¼‚æµç“¶ #{bottle_id}
   å°æ–¹ï¼šåŒ¿åä½¿ç”¨è€…
   é–‹å§‹æ™‚é–“ï¼š{startTime}
   è¨Šæ¯æ•¸ï¼š{messageCount}
   [æŸ¥çœ‹è©³æƒ…] [ç¹¼çºŒèŠå¤©]

ğŸ“¦ ä¾†è‡ªæ¼‚æµç“¶ #{bottle_id}
   å°æ–¹ï¼šåŒ¿åä½¿ç”¨è€…
   é–‹å§‹æ™‚é–“ï¼š{startTime}
   è¨Šæ¯æ•¸ï¼š{messageCount}
   [æŸ¥çœ‹è©³æƒ…] [ç¹¼çºŒèŠå¤©]

[æŸ¥çœ‹æ­·å²å°è©±] [è¿”å›]
```

### 7.2 æŸ¥çœ‹å°è©±è©³æƒ…

```
ğŸ’¬ å°è©±è©³æƒ…

æ¼‚æµç“¶å…§å®¹ï¼š
"{bottleContent}"

èŠå¤©è¨˜éŒ„ï¼š
[{time}] ä½ ï¼š{message}
[{time}] å°æ–¹ï¼š{message}
[{time}] ä½ ï¼š{message}
...

[è¿”å›] [èˆ‰å ±] [å°é–]
```

---

## 8. æ³¨æ„äº‹é …

1. **æ€§èƒ½å„ªåŒ–**ï¼šçµ±è¨ˆæ•¸æ“šä½¿ç”¨å¿«å–ï¼Œé¿å…æ¯æ¬¡æŸ¥è©¢éƒ½è¨ˆç®—
2. **éš±ç§ä¿è­·**ï¼šèŠå¤©è¨˜éŒ„ä¸­ä¸é¡¯ç¤ºçœŸå¯¦ Telegram ID
3. **æ•¸æ“šæ›´æ–°**ï¼šçµ±è¨ˆæ•¸æ“šå¯è¨­å®šå®šæ™‚æ›´æ–°ï¼ˆå¦‚æ¯å°æ™‚ï¼‰
4. **æ’åå…¬å¹³æ€§**ï¼šæ´»èºåº¦è¨ˆç®—å…¬å¼éœ€å®šæœŸæª¢è¨ï¼Œç¢ºä¿å…¬å¹³

