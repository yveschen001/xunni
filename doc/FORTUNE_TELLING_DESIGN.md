# 🔮 AI 算命功能設計 (AI Fortune Telling)

> **⚠️ 開發規範與引用**
> 本設計必須嚴格遵守以下文檔規範：
> *   `@doc/UI_GUIDELINE.md`: UI 交互體驗、按鈕佈局、返回邏輯。
> *   `@doc/DEVELOPMENT_STANDARDS.md`: 代碼風格、錯誤處理、i18n 規範。
> *   `@doc/ECONOMICS_AND_PRICING.md`: 算命瓶消耗與經濟模型。

## 1. 核心邏輯與架構

本系統採用 **「邏輯層 (Logic)」 + 「文學層 (Literature)」** 的雙層架構，確保算命的準確性與多語言適配性。

### 1.1 差異化優勢：多維度數據融合 (Why us?)
一般的 GPT 算命只看星座。我們的優勢在於整合了用戶的 **全方位數據**：
*   **西方占星**: 太陽/月亮/上升星座 (需出生時間)。
*   **東方八字**: 天干地支、五行缺補。
*   **心理測評**: MBTI 人格類型 (已在 `users` 表中)。
*   **生理特徵**: 血型 (需收集)、性別。

**結論**：我們餵給 AI 的 Prompt 包含了「MBTI + 星盤 + 八字 + 血型」的交叉分析，這是用戶自己去問 ChatGPT 很難做到的（因為他們通常不會同時提供這麼多維度的數據，也不懂如何整合）。

### 1.3 數據源與運算 (Data Source & Calculation)

**Q: 是否需要維護龐大的命理資料庫（流年、星曆表）？**
**A: 不需要。**

我們採用 **"On-Demand Calculation" (即時運算)** 模式：

1.  **星曆數據 (Ephemeris)**:
    *   直接使用開源庫 `swisseph` (瑞士星曆表) 或 `astrology-js`。
    *   這些庫內建了數千年的行星位置數據，準確度極高（NASA 等級）。
    *   **優勢**：無需自己維護資料庫，減少維護成本，避免數據錯誤。

2.  **紫微/八字排盤**:
    *   使用 `lunar-javascript` 等成熟開源庫。
    *   它們能根據時間自動算出「命宮、大限、流年」等所有格局。

3.  **知識庫 (Knowledge Base)**:
    *   **不需要** 建立「金牛座解釋庫」或「紫微星解釋庫」。
    *   這部分完全依賴 **LLM (AI) 的內建知識**。AI 已經讀過數百萬本命理書，它知道「流年走到夫妻宮」意味著什麼。

**結論**：我們只存「用戶的出生數據」和「算命歷史結果」，不存「命理規則數據」。這讓系統極其輕量化。

---

## 2. 用戶體驗 (UX) 與入口設計

為避免主菜單擁擠，我們採用 **「單一入口，分層引導」** 策略。

### 2.1 菜單結構
*   **主菜單**: 只有一個按鈕 `🔮 AI 算命`。
*   **二級菜單 (點擊後彈出)**:
    1.  `📅 今日運勢 (免費)` - 每日一次點擊查看。
    2.  `📜 深度批命 (付費)` - 消耗算命瓶，詳批流年/事業。
    3.  `❤️ 緣分合盤 (付費)` - 消耗算命瓶，輸入對象生日。
    4.  `🌟 名人同盤 (免費)` - 趣味功能。

### 2.3 訊息策略 (Message Strategy) & 交互優化

**Telegram UX 原則**: 減少屏幕佔用，避免刷屏，保持線性流暢。

1.  **摘要先行 (Summary First)**:
    *   **不要** 一次性轟炸 3-4 條長訊息。
    *   **先發送**: 一張精美的 **摘要卡片** (Emoji + 關鍵結論 + 評分)。
    *   **按需展開**: 卡片下方附帶按鈕 `[📜 展開八字詳批]`, `[✨ 展開星盤解讀]`。用戶點擊後才發送長文。

2.  **Inline 交互 (Clean UI)**:
    *   **Wizard 流程**: 盡量使用 `editMessageText` 更新當前訊息，而不是發送新訊息。
        *   *Bad*: User: "男" -> Bot: "收到，請輸入生日..." (兩條訊息)
        *   *Good*: User 點擊 `[🚹 男]` -> 原訊息變為 "✅ 性別: 男。接下來，請選擇生日..." (始終只有一條訊息在變)
    *   **防迷失**: 每個步驟必須帶有 `[🔙 上一步]` 和 `[❌ 取消]` 按鈕。

3.  **結構化輸出 (詳細報告)**:
    *   **Header**: Emoji 標題 + 摘要。
    *   **Body**: 詳細內容 (分段發送，如果太長)。
    *   **Footer**: 導航按鈕 + Hashtags。

### 2.4 歷史記錄與導航 (History & Navigation)

**痛點**: Telegram 搜索功能有限，用戶難以找回之前的算命結果。

**解決方案**:
1.  **智能 Hashtags**:
    *   每份報告附帶唯一且易搜的 Tags: `#MyFortune_{ProfileName}`, `#BaZi`, `#2025`。
2.  **無死角導航 (No Dead-ends)**:
    *   報告底部必須包含行動按鈕 (Call to Action):
        *   `[🔗 分享給朋友]` (帶裂變參數)
        *   `[📅 訂閱每日運勢]` (提升留存)
        *   `[🔮 再算一卦]` (回到主菜單)
3.  **緩存重用**: 同日同類型不重複扣費。

---

## 3. 算命瓶 (Fortune Bottle) 經濟模型

### 3.1 獲取機制
*   **每週免費配額 (Weekly Reset)**:
    *   一般用戶: 每週 **1 瓶** (不可累積)。
    *   **VIP 用戶**: 每天 **1 瓶** (不可累積，每日 00:00 重置)。
*   **額外獲取 (可累積)**:
    *   **活躍獎勵**: 每丟出 10 個漂流瓶 -> **+1 瓶**。
    *   **裂變獎勵**: 邀請的朋友(B)再邀請朋友(C)時 -> **A 獲得 +1 瓶**。
    *   **付費充值**:
        *   小包: 100 Stars / 10 瓶。
        *   大包: 385 Stars / 50 瓶。

### 3.2 消費模塊化 (Modular Consumption)
為了提高 ARPU (每用戶平均收入) 並提供更細緻的服務，我們將「深度批命」拆分為獨立模塊，**每個模塊單獨扣瓶**。

*   **模塊 A: 東方八字/紫微排盤與解讀** (-1 瓶)
    *   包含：命盤圖（文字版）、五行分析、大運流年。
*   **模塊 B: 西方星盤解讀** (-1 瓶)
    *   包含：太陽/月亮/上升星座、行星相位分析。
*   **模塊 C: 專項預測 (愛情/事業)** (-1 瓶)
    *   包含：針對特定問題的深度回答 (800字+)。
    *   **模塊 D: 緣分合盤** (-1 瓶)
    *   包含：雙人命盤對照、關係潛力分析。

**優惠**: `[解鎖全套報告 (-3 瓶)]` (原價 4 瓶)。

### 3.3 反作弊與裂變規則 (Anti-Cheat & Referral)
*   **新用戶定義**: 被邀請者必須是 **從未註冊過** 的新 Telegram ID。
*   **重複邀請檢查**: 
    *   系統記錄 `invited_users` 表。
    *   A 邀請 B，B 刪除帳號重來 -> 不算。
    *   A 邀請 B，B 封鎖機器人再解封 -> 不算。
*   **觸發獎勵條件**: 被邀請者 (B) 必須完成 **Wizard 註冊流程** (語言/性別/生日) 才算有效邀請。

---

## 4. 數據運營與追蹤 (Data Tracking)

我們需要從第一天開始就追蹤以下關鍵指標，以便優化轉換率：

1.  **漏斗轉化率 (Funnel)**:
    *   `Fortune_Click`: 點擊「今日運勢」的人數。
    *   `Fortune_Upsell_Click`: 點擊「解鎖詳細解讀」的人數 (轉化率)。
    *   `Wizard_Completion`: 開始輸入生辰 -> 完成輸入的比例 (流失率)。

2.  **用戶行為**:
    *   `Profiles_Per_User`: 平均每人創建多少個命盤檔案 (自己/老公/小孩)。
    *   `Retention_Rate`: 看過運勢的人，第二天回訪的比例。

3.  **收入監控**:
    *   `Bottles_Consumed_Per_Module`: 哪個模組最受歡迎 (八字 vs 星盤 vs 愛情)？

---

## 5. 技術實現細節：全球城市選擇器 (Global City Selector)

**挑戰**: 用戶體驗不能讓用戶手打 (Typo/語言問題)，但按鈕庫 (Inline Keyboard) 不能塞下全球 10萬+ 城市。外部 API (如 GeoNames) 有穩定性與成本風險。

**解決方案**: **自建輕量級地理資料庫 (D1)**

1.  **數據源 (Data Source)**:
    *   使用開源數據集 (如 `GeoNames` 的 dump 或 `cities.json`)。
    *   篩選規則：人口 > 15,000 的城市（覆蓋絕大多數用戶出生地）。
    *   **數據結構**:
        *   `countries`: 代碼 (TW), 多語言名稱 (JSON)。
        *   `cities`: 名字 (Taipei), 本地名 (臺北), 經緯度, 時區 ID (Asia/Taipei), 國家代碼。
    *   **導入方式**: 一次性導入到 D1 Database (`geo_cities` 表)。

2.  **優勢**:
    *   **0 API 成本**: 不依賴 Google Maps 或付費服務。
    *   **高可用性**: 數據在自己手上，永遠不會「打一打不見了」或服務中斷。
    *   **極速響應**: D1 查詢比 HTTP 請求快得多。

3.  **交互流程 (Interaction Flow)**:
    *   **Step 1: 選擇國家 (按洲分組)**
        *   讀取 `geo_countries` 表。
        *   `[🌏 亞洲]`, `[🌍 歐洲]`, ... -> `[🇯🇵 日本]`, `[🇹🇼 台灣]`, ...
    *   **Step 2: 智能搜索城市**
        *   Bot: "請輸入出生城市名稱（中文或英文）。"
        *   User: "板橋"
        *   Backend: `SELECT * FROM geo_cities WHERE name LIKE '板橋%' OR local_name LIKE '板橋%'`
        *   Bot 回傳按鈕: `[板橋區, TW (25.01, 121.46)]`

5.  **智能預設 (Smart Defaults) 與複用**:
    *   **註冊整合**: 用戶註冊 (Onboarding) 時的「所在城市」也改用此選擇器，確保獲得精確經緯度。
    *   **命盤預填**:
        *   創建新命盤時，**默認帶入用戶註冊時的城市**。
        *   Bot: "出生城市是 **台北** 嗎？" -> 用戶只需點 `[是]` 即可跳過選擇步驟。
        *   **場景**: 大多數家庭成員出生在同一城市，此舉可節省 80% 的操作時間。

---

## 10. 法务与合规 (Legal & Compliance)

**⚠️ 必須與新功能同步上線**

### 10.1 法律免責聲明 (Disclaimer)
*   **性質聲明**: 必須在算命功能的入口或結果頁腳註明：**"此服務僅供娛樂用途 (For entertainment purposes only)。"**
*   **專業建議免責**: 明確指出 AI 提供的建議（特別是健康、投資、法律相關）不代表專業意見，不應作為決策依據。

### 10.2 隱私權政策更新 (Privacy Policy Update)
*   **數據收集聲明**: 明確告知用戶我們收集「出生日期、時間、地點」僅用於命理計算。
*   **數據存儲**: 根據 GDPR/CCPA 原則，用戶有權要求「被遺忘」。我們的 `fortune_profiles` 必須支援物理刪除（已在 Database Schema 中支援）。
*   **託管位置**: 所有法律條款統一託管於 `https://api.xunni.xyz/privacy` (或對應生產環境域名)，確保單一來源，即時更新。

---

## 7. 附錄：註冊流程升級 (Onboarding Upgrade)

**策略調整**: 為了不降低註冊轉化率，我們採取 **「漸進式收集 (Progressive Profiling)」** 策略。

### 7.1 註冊階段 (Lightweight)
*   **目標**: 快速完成註冊，獲取基礎匹配數據。
*   **數據**:
    1.  **語言**: (現有)
    2.  **性別**: (現有)
    3.  **生日 (日期)**: (現有，用於年齡驗證)
    4.  **所在國家/地區**: **(新)** 使用按鈕快速選擇 (Country Level)。**不強制選城市**，避免隱私顧慮導致流失。

### 7.2 算命/完善資料階段 (Deep Dive)
*   **場景**: 當用戶第一次點擊 `🔮 AI 算命` 或編輯個人資料時。
*   **補充數據**:
    1.  **出生時間**: (精確到分鐘)
    2.  **出生城市**: (使用新的全球城市選擇器 -> 獲取經緯度/時區)
*   **優勢**: 降低註冊門檻，但在用戶有強烈動機（想算命）時才收集高阻力數據。

---

## 8. 實作步驟 (Implementation Roadmap)

**⚠️ 自動化開發原則**: 每個階段完成後，必須先通過 Local Simulation 測試，確認無誤後才進入下一階段。**絕對禁止破壞現有功能**（如舊版註冊流程）。

### 8.1 階段一：地理資料庫與基礎建設 (Geo Infrastructure)
1.  **數據準備**:
    *   下載 `cities15000.zip` (GeoNames)。
    *   編寫腳本 `scripts/prepare-geo-data.ts`:
        *   過濾人口 > 15,000 的城市。
        *   使用 `geo-tz` 庫根據經緯度計算 Timezone ID (如 `Asia/Taipei`)。
        *   生成 `geo_countries` 和 `geo_cities` 的 CSV/SQL 文件。
2.  **資料庫遷移**:
    *   創建 `00xx_add_geo_tables.sql`。
    *   編寫分批導入腳本 (D1 Batch Import) 以避免 Wrangler 限制。
3.  **註冊流程重構 (Onboarding V2)**:
    *   實現 `CitySelector` 服務。
    *   更新 `src/telegram/handlers/onboarding.ts`，替換舊的城市輸入步驟。
    *   **回歸測試**: 確保新舊用戶數據兼容，不影響現有用戶。

### 8.2 階段二：算命核心服務 (Fortune Core)
1.  **FortuneService 開發**:
    *   實現 `calculateChart` (整合 `lunar-javascript` + `astronomy-engine`)。
    *   實現 `FortuneQuota` 管理 (扣瓶子、重置)。
    *   **單元測試**: 測試配額扣除邏輯、星盤計算準確性。
2.  **AI Service 整合**:
    *   設計 Prompt Template (八字/星盤/流年)。
    *   實現 `generateFortune` 方法。

### 8.3 階段三：UI 與業務邏輯 (UI & Business Logic)
1.  **Wizard 開發**:
    *   `src/telegram/handlers/fortune_wizard.ts`: 收集/確認生辰八字。
    *   支援多命盤管理 (Profile Management)。
2.  **模組化報告輸出**:
    *   實現分段訊息發送 (Message Splitting)。
    *   加入 Hashtags 與 Deep Links 導航。
3.  **今日運勢推送**:
    *   利用 `users.timezone` 實現按時區推送 (Cron Job)。

---

## 9. 測試與質量保證 (QA & Testing)

**⚠️ 嚴格執行 `@doc/TESTING.md` 規範**

### 9.1 Local Simulation (必做)
在 `scripts/local-simulation.ts` 中新增以下測試場景：
1.  **Geo Selector Test**: 模擬用戶輸入 "Taipei"，確認返回正確的按鈕和經緯度。
2.  **Fortune Flow Test**: 
    *   完整走一遍 Wizard (輸入生日 -> 創建檔案)。
    *   測試扣費邏輯 (餘額不足 vs 餘額充足)。
    *   測試重複查看不扣費邏輯。
3.  **Regression Test**: 
    *   **關鍵**: 測試舊的 `/start` 流程，確保新加的 Geo Selector 沒有讓註冊流程卡死。

### 9.2 數據一致性檢查
*   確認所有新註冊用戶都有 `lat`, `lng`, `timezone`。
*   確認 `fortune_history` 正確記錄了 `tokens_used` 和 `provider`。

---

## 5. 成本估算

*   **今日運勢 (免費版)**: `gpt-4o-mini`，極短，成本忽略不計。
*   **深度批命 (付費版)**: `gpt-4o`，輸入約 500 tokens，輸出約 1000 tokens。
    *   API 成本: ~$0.02 USD。
    *   收入 (若用瓶子): ~$0.15 - $1.00 USD。
    *   **利潤**: 極高。

---

**最後更新**: 2025-11-29
**維護者**: 專案團隊
