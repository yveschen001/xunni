# âœ… æœ¬åœ°é–‹ç™¼ç’°å¢ƒå·²å°±ç·’ï¼

## ğŸ‰ **å®Œæˆï¼ä½ ç¾åœ¨å¯ä»¥åœ¨æœ¬åœ°é–‹ç™¼äº†ï¼**

---

## ğŸš€ **ç«‹å³é–‹å§‹**

### **ä¸€æ¢å‘½ä»¤å•Ÿå‹•ï¼š**

```bash
pnpm dev:polling
```

å°±é€™éº¼ç°¡å–®ï¼ğŸŠ

---

## ğŸ“‹ **å·²å®Œæˆçš„é…ç½®**

### âœ… **1. å‰µå»ºäº† Polling æ¨¡å¼è…³æœ¬**

- `scripts/dev-polling.ts` - ä¸»è¦çš„ Polling è…³æœ¬
- `scripts/load-env-and-run.ts` - ç’°å¢ƒè®Šæ•¸åŠ è¼‰å™¨
- `scripts/start-local-dev.sh` - Bash å•Ÿå‹•è…³æœ¬ï¼ˆå¯é¸ï¼‰

### âœ… **2. æ›´æ–°äº† package.json**

```json
{
  "scripts": {
    "dev:polling": "tsx scripts/load-env-and-run.ts"
  }
}
```

### âœ… **3. å‰µå»ºäº†å®Œæ•´æ–‡æª”**

- `æœ¬åœ°é–‹ç™¼æŒ‡å—.md` - å®Œæ•´çš„ä½¿ç”¨æŒ‡å—ï¼ˆä¸­æ–‡ï¼‰
- `LOCAL_DEV_QUICK_START.md` - å¿«é€Ÿé–‹å§‹æŒ‡å—ï¼ˆè‹±æ–‡ï¼‰
- `LOCAL_DEVELOPMENT_GUIDE.md` - è©³ç´°é–‹ç™¼æŒ‡å—ï¼ˆè‹±æ–‡ï¼‰

---

## ğŸ¯ **å·¥ä½œæµç¨‹**

### **ç¾åœ¨ï¼ˆCloudflare ç„¡æ³•é€£æ¥æ™‚ï¼‰**

```bash
# 1. å•Ÿå‹•æœ¬åœ°é–‹ç™¼
pnpm dev:polling

# 2. åœ¨ Telegram æ¸¬è©¦ä½ çš„ Bot
# ç™¼é€æ¶ˆæ¯ï¼ŒæŸ¥çœ‹çµ‚ç«¯è¼¸å‡º

# 3. ä¿®æ”¹ä»£ç¢¼
vim src/telegram/handlers/ä½ çš„æ–‡ä»¶.ts

# 4. é‡å•Ÿ Botï¼ˆCtrl+C ç„¶å¾Œé‡æ–°é‹è¡Œï¼‰
pnpm dev:polling

# 5. é‡è¤‡æ­¥é©Ÿ 2-4
```

### **ä¹‹å¾Œï¼ˆCloudflare æ¢å¾©å¾Œï¼‰**

```bash
# 1. åœæ­¢ Polling æ¨¡å¼ï¼ˆCtrl+Cï¼‰

# 2. éƒ¨ç½²åˆ° Cloudflare
pnpm deploy:staging

# 3. è¨­ç½® Webhook
curl -X POST "https://api.telegram.org/botä½ çš„TOKEN/setWebhook" \
  -d "url=https://ä½ çš„workeråœ°å€.workers.dev/webhook"

# 4. ç¹¼çºŒæ­£å¸¸é–‹ç™¼
```

---

## ğŸ’¡ **é‡è¦æç¤º**

### âš ï¸ **Polling æ¨¡å¼çš„é™åˆ¶**

1. **æ•¸æ“šåº«åŠŸèƒ½å—é™**
   - ä½¿ç”¨ Mock æ•¸æ“šåº«
   - æ•¸æ“šåº«æ“ä½œæœƒå¤±æ•—
   - é©åˆæ¸¬è©¦ Bot é‚è¼¯ï¼Œä¸é©åˆæ¸¬è©¦æ•¸æ“šåº«åŠŸèƒ½

2. **ä¸æ”¯æŒç†±é‡è¼‰**
   - ä¿®æ”¹ä»£ç¢¼å¾Œéœ€è¦æ‰‹å‹•é‡å•Ÿ
   - æŒ‰ `Ctrl+C` åœæ­¢ï¼Œç„¶å¾Œé‡æ–°é‹è¡Œ `pnpm dev:polling`

3. **æœƒè‡ªå‹•åˆªé™¤ Webhook**
   - å•Ÿå‹•æ™‚æœƒèª¿ç”¨ `deleteWebhook` API
   - ç¢ºä¿ä½¿ç”¨çš„æ˜¯é–‹ç™¼ç’°å¢ƒçš„ Bot Token

### âœ… **Polling æ¨¡å¼çš„å„ªé»**

1. **å®Œå…¨æœ¬åœ°é‹è¡Œ**
   - ä¸éœ€è¦ Cloudflare
   - ä¸éœ€è¦ ngrok
   - ä¸éœ€è¦å…¬ç¶² IP

2. **ç°¡å–®å¿«é€Ÿ**
   - ä¸€æ¢å‘½ä»¤å•Ÿå‹•
   - ç«‹å³é–‹å§‹æ¸¬è©¦
   - å¿«é€Ÿè¿­ä»£é–‹ç™¼

3. **é©åˆå¿«é€Ÿé–‹ç™¼**
   - æ¸¬è©¦ Bot å‘½ä»¤
   - æ¸¬è©¦æ¶ˆæ¯è™•ç†
   - æ¸¬è©¦æŒ‰éˆ•äº¤äº’
   - é–‹ç™¼æ–°åŠŸèƒ½

---

## ğŸ¨ **ä½¿ç”¨ç¤ºä¾‹**

### **å ´æ™¯ 1: é–‹ç™¼å»£å‘Šç³»çµ±**

```bash
# 1. å•Ÿå‹•æœ¬åœ°é–‹ç™¼
pnpm dev:polling

# 2. å‰µå»ºå»£å‘Šç›¸é—œçš„ Handler
vim src/telegram/handlers/ad.ts

# 3. æ¸¬è©¦å»£å‘Šé¡¯ç¤ºé‚è¼¯
# åœ¨ Telegram ä¸­è§¸ç™¼å»£å‘Š

# 4. æŸ¥çœ‹çµ‚ç«¯è¼¸å‡ºï¼Œèª¿è©¦é‚è¼¯

# 5. ä¿®æ”¹ä»£ç¢¼ï¼Œé‡å•Ÿæ¸¬è©¦
```

### **å ´æ™¯ 2: æ¸¬è©¦æ–°å‘½ä»¤**

```bash
# 1. å•Ÿå‹• Bot
pnpm dev:polling

# 2. æ·»åŠ æ–°å‘½ä»¤
vim src/telegram/handlers/new_command.ts

# 3. åœ¨ Telegram ä¸­ç™¼é€å‘½ä»¤
/new_command

# 4. æŸ¥çœ‹çµ‚ç«¯è¼¸å‡º
# æœƒé¡¯ç¤ºè©³ç´°çš„è™•ç†éç¨‹

# 5. èª¿è©¦ä¸¦ä¿®æ”¹
```

### **å ´æ™¯ 3: ä¿®å¾© Bug**

```bash
# 1. é‡ç¾ Bug
pnpm dev:polling
# åœ¨ Telegram ä¸­è§¸ç™¼ Bug

# 2. æŸ¥çœ‹çµ‚ç«¯éŒ¯èª¤ä¿¡æ¯
# æœƒé¡¯ç¤ºå®Œæ•´çš„ Stack Trace

# 3. ä¿®å¾©ä»£ç¢¼
vim src/...

# 4. é‡å•Ÿæ¸¬è©¦
pnpm dev:polling

# 5. é©—è­‰ä¿®å¾©
```

---

## ğŸ“Š **çµ‚ç«¯è¼¸å‡ºç¤ºä¾‹**

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ¤– XunNi Bot - Local Development (Polling Mode)     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ Environment: development
ğŸ”‘ Bot Token: 8226418094:AAE5wfp_...
ğŸ—„ï¸  Database: Mock (no persistence)
ğŸ”„ Mode: Long Polling (30s timeout)
âš ï¸  Note: Database operations will fail - use for testing bot logic only

ğŸ”§ Removing webhook to enable polling...
âœ… Webhook removed successfully
ğŸš€ Starting to poll for updates...
ğŸ’¡ Send a message to your bot to test!

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ“¬ Received 1 update(s) (Total: 1)

ğŸ“¨ Processing update 123456789
   From: Yichen (@yichen)
   Text: /start
âœ… Update processed successfully

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ“¬ Received 1 update(s) (Total: 2)

ğŸ“¨ Processing update 123456790
   From: Yichen (@yichen)
   Text: Hello Bot!
âœ… Update processed successfully

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

---

## ğŸ”§ **æ•…éšœæ’é™¤**

### **å•é¡Œ 1: Bot æ²’æœ‰éŸ¿æ‡‰**

```bash
# æª¢æŸ¥ Token æ˜¯å¦æœ‰æ•ˆ
curl "https://api.telegram.org/botä½ çš„TOKEN/getMe"

# æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
cat .dev.vars | grep TELEGRAM_BOT_TOKEN

# é‡å•Ÿ Bot
pnpm dev:polling
```

### **å•é¡Œ 2: ç’°å¢ƒè®Šæ•¸æœªåŠ è¼‰**

```bash
# ç¢ºèª .dev.vars å­˜åœ¨
ls -la .dev.vars

# æŸ¥çœ‹å…§å®¹
cat .dev.vars

# ç¢ºä¿æ ¼å¼æ­£ç¢ºï¼ˆKEY=VALUEï¼‰
```

### **å•é¡Œ 3: æ•¸æ“šåº«éŒ¯èª¤**

é€™æ˜¯æ­£å¸¸çš„ï¼Polling æ¨¡å¼ä½¿ç”¨ Mock æ•¸æ“šåº«ã€‚

**è§£æ±ºæ–¹æ¡ˆï¼š**
- å¦‚æœéœ€è¦æ¸¬è©¦æ•¸æ“šåº«åŠŸèƒ½ï¼Œç­‰ Cloudflare æ¢å¾©å¾Œä½¿ç”¨ `wrangler dev` + ngrok
- æˆ–è€…ç›´æ¥éƒ¨ç½²åˆ° Staging ç’°å¢ƒæ¸¬è©¦

---

## ğŸ“š **ä¸‹ä¸€æ­¥**

### **é¸é … A: ç«‹å³é–‹å§‹é–‹ç™¼å»£å‘Šç³»çµ±** â­ æ¨è–¦

```bash
# 1. å•Ÿå‹•æœ¬åœ°é–‹ç™¼
pnpm dev:polling

# 2. é–‹å§‹é–‹ç™¼
# - è¨­è¨ˆå»£å‘Šæ•¸æ“šçµæ§‹
# - å¯¦ç¾å»£å‘Šé¡¯ç¤ºé‚è¼¯
# - æ¸¬è©¦å»£å‘Šè¼ªæ’­

# 3. ç­‰ Cloudflare æ¢å¾©å¾Œ
# - æ·»åŠ æ•¸æ“šåº«æ”¯æŒ
# - éƒ¨ç½²åˆ° Staging æ¸¬è©¦
# - éƒ¨ç½²åˆ° Production
```

### **é¸é … B: æ¸¬è©¦ç¾æœ‰åŠŸèƒ½**

```bash
# 1. å•Ÿå‹• Bot
pnpm dev:polling

# 2. æ¸¬è©¦å„ç¨®å‘½ä»¤
/start
/help
/profile
# ç­‰ç­‰...

# 3. ç¢ºä¿åŸºæœ¬åŠŸèƒ½æ­£å¸¸
```

### **é¸é … C: é‹è¡Œæ¸¬è©¦**

```bash
# é‹è¡Œæ‰€æœ‰æ¸¬è©¦
pnpm test

# é‹è¡Œç‰¹å®šæ¸¬è©¦
pnpm test src/domain/user.test.ts

# æŸ¥çœ‹è¦†è“‹ç‡
pnpm test:coverage
```

---

## ğŸŠ **ç¸½çµ**

### âœ… **å·²å®Œæˆï¼š**

1. âœ… å‰µå»ºäº† Polling æ¨¡å¼è…³æœ¬
2. âœ… é…ç½®äº†ç’°å¢ƒè®Šæ•¸åŠ è¼‰
3. âœ… æ›´æ–°äº† package.json
4. âœ… å‰µå»ºäº†å®Œæ•´æ–‡æª”
5. âœ… æ¸¬è©¦äº†åŸºæœ¬åŠŸèƒ½

### ğŸš€ **ç¾åœ¨å¯ä»¥ï¼š**

1. âœ… åœ¨æœ¬åœ°é–‹ç™¼å’Œæ¸¬è©¦ Bot
2. âœ… ä¸ä¾è³´ Cloudflare
3. âœ… å¿«é€Ÿè¿­ä»£é–‹ç™¼
4. âœ… æ¸¬è©¦æ–°åŠŸèƒ½
5. âœ… ä¿®å¾© Bug

### ğŸ¯ **ä¸‹ä¸€æ­¥ï¼š**

**ç«‹å³é–‹å§‹é–‹ç™¼ï¼**

```bash
pnpm dev:polling
```

---

## ğŸ†˜ **éœ€è¦å¹«åŠ©ï¼Ÿ**

æŸ¥çœ‹ä»¥ä¸‹æ–‡æª”ï¼š

- `æœ¬åœ°é–‹ç™¼æŒ‡å—.md` - å®Œæ•´ä½¿ç”¨æŒ‡å—
- `LOCAL_DEV_QUICK_START.md` - å¿«é€Ÿé–‹å§‹
- `LOCAL_DEVELOPMENT_GUIDE.md` - è©³ç´°é–‹ç™¼æŒ‡å—

---

## ğŸ‰ **Happy Coding!**

**ä½ ç¾åœ¨æ“æœ‰å®Œæ•´çš„æœ¬åœ°é–‹ç™¼ç’°å¢ƒäº†ï¼**

ä¸ç®¡ Cloudflare æ˜¯å¦å¯ç”¨ï¼Œä½ éƒ½å¯ä»¥ç¹¼çºŒé–‹ç™¼ï¼ğŸš€

```bash
# é–‹å§‹å§ï¼
pnpm dev:polling
```

---

**æœ€å¾Œæ›´æ–°ï¼š** 2025-01-18  
**ç‹€æ…‹ï¼š** âœ… å°±ç·’  
**ä¸‹ä¸€æ­¥ï¼š** é–‹å§‹é–‹ç™¼å»£å‘Šç³»çµ±æˆ–æ¸¬è©¦ç¾æœ‰åŠŸèƒ½

