# XunNi 未完成功能檢查清單

**生成時間：** 2025-11-17  
**當前版本：** ab09ab3  
**當前階段：** M1（Telegram Bot + Mini App）

---

## ✅ 已完成的核心功能

### 1. 用戶系統
- ✅ 註冊流程（10 步）
- ✅ 暱稱驗證（URL 檢查、長度限制）
- ✅ 年齡驗證（18+ 限制）
- ✅ 性別選擇（不可修改）
- ✅ 生日輸入（不可修改）
- ✅ 語言選擇（34 種語言）
- ✅ MBTI 測試（12 題快速版）
- ✅ 反詐騙測試
- ✅ 條款同意

### 2. 漂流瓶系統
- ✅ 丟瓶功能（/throw）
- ✅ 撿瓶功能（/catch）
- ✅ 每日配額限制（免費 3 個，VIP 30 個）
- ✅ 邀請獎勵系統（+1 配額/人，最多 10 人）
- ✅ 瓶子內容驗證（最少 4 字，最多 500 字）
- ✅ URL 白名單檢查

### 3. 匿名聊天系統
- ✅ 訊息轉發（/reply）
- ✅ 對話歷史帖子系統（history post + new message post）
- ✅ 對話標識符（#MMDDHHHH 格式）
- ✅ 每日訊息配額（免費 10 條/對象，VIP 100 條/對象）
- ✅ 對方資料卡顯示（暱稱、MBTI、星座、語言）
- ✅ VIP 翻譯功能（OpenAI + Google Translate 降級）

### 4. 個人資料管理
- ✅ 查看個人資料（/profile）
- ✅ 編輯暱稱（/edit_profile）
- ✅ 編輯簡介（/edit_profile）
- ✅ 編輯地區（/edit_profile）
- ✅ 編輯興趣（/edit_profile）
- ✅ 匹配偏好設定（/edit_profile）
- ✅ 暱稱遮罩（部分顯示 + 至少 4 個 *，總長 10 字）

### 5. 邀請裂變系統
- ✅ 邀請碼生成（XUNNI-XXXXXXXX 格式）
- ✅ 邀請鏈接分享
- ✅ 邀請激活（被邀請者丟第一個瓶子）
- ✅ 邀請獎勵（邀請者 +1 配額）
- ✅ 邀請統計（/profile 查看）
- ✅ 邀請上限（免費 10 人，VIP 100 人）

### 6. VIP 系統
- ✅ VIP 訂閱（Telegram Stars）
- ✅ VIP 權益（30 個瓶子/天，翻譯功能，高級篩選）
- ✅ VIP 到期檢查

### 7. 安全與風控
- ✅ 舉報系統（/report）
- ✅ 封鎖系統（/block）
- ✅ 風險分數累積
- ✅ 分級封禁機制
- ✅ 申訴系統（/appeal）

### 8. 管理功能
- ✅ 開發者命令（/dev_info, /dev_reset）
- ✅ 統計數據（/stats）
- ✅ 聊天記錄（/chats）

---

## ⚠️ 部分完成的功能

### 1. 血型功能（50% 完成）
- ✅ 數據庫欄位已添加（`users.blood_type`）
- ❌ **註冊流程中未添加血型選擇**
- ❌ **編輯個人資料中未添加血型編輯**
- ❌ **VIP 血型配對功能未實現**
- ❌ **資料卡中未顯示血型**

**參考文檔：** `doc/BLOOD_TYPE_FEATURE_PLAN.md`

### 2. MBTI 36 題測試（0% 完成）
- ✅ 12 題快速版已完成（註冊流程）
- ❌ **36 題完整版未開發**
- ❌ **重新測試功能未實現**
- ❌ **版本選擇界面未實現**

**參考文檔：** `doc/MBTI_36_QUESTIONS_PLAN.md`

### 3. 推送通知系統（0% 完成）
- ❌ **星座運勢推播未實現**
- ❌ **丟瓶提醒未實現**
- ❌ **撿瓶提醒未實現**
- ❌ **邀請成功通知未實現**（已有激活通知，但缺少推送策略）

**參考文檔：** `doc/PUSH_NOTIFICATIONS.md`

**代碼位置：** `src/worker.ts` line 89-96（TODO 標記）

---

## ❌ 未完成的功能

### 1. 核心功能

#### 1.1 封禁檢查
- **位置：** `src/router.ts` line 109
- **狀態：** TODO
- **說明：** 每次請求應檢查用戶是否被封禁

#### 1.2 支付處理
- **位置：** `src/router.ts` line 866, 873
- **狀態：** TODO
- **說明：** Telegram Stars 支付回調處理

### 2. 聊天功能

#### 2.1 推送偏好檢查
- **位置：** `src/telegram/handlers/catch.ts` line 293
- **狀態：** TODO
- **說明：** 檢查用戶推送偏好設定

### 3. 邀請功能

#### 3.1 邀請獎勵計算
- **位置：** `src/telegram/handlers/throw.ts` line 88
- **狀態：** TODO（已實現，但註釋未更新）
- **說明：** 從 invites 表計算邀請獎勵（實際上已在 `calculateDailyQuota` 中實現）

### 4. i18n 系統

#### 4.1 CSV/Google Sheets 導入
- **位置：** `src/i18n/index.ts` line 100
- **狀態：** TODO
- **說明：** 從 CSV 或 Google Sheets 導入翻譯

#### 4.2 CSV 導出
- **位置：** `src/i18n/index.ts` line 109
- **狀態：** TODO
- **說明：** 導出翻譯到 CSV

### 5. Cron 任務

#### 5.1 星座運勢推播
- **位置：** `src/worker.ts` line 89
- **狀態：** TODO
- **說明：** 每週星座運勢推播

#### 5.2 廣播隊列處理
- **位置：** `src/worker.ts` line 96
- **狀態：** TODO
- **說明：** 處理群發訊息隊列

---

## 🔮 未來功能（M2/M3）

### M2: WeChat / Line 插件
- ❌ WeChat Mini Program
- ❌ Line Bot / LIFF App
- ❌ 統一的 AuthAdapter
- ❌ 統一的 NotificationAdapter
- ❌ 帳號綁定機制

### M3: App Store / Google Play
- ❌ iOS App
- ❌ Android App
- ❌ OAuth 登入
- ❌ Push Notification

**參考文檔：** `doc/ROADMAP.md`

---

## 📊 完成度統計

### 核心功能完成度
- ✅ 用戶系統：100%
- ✅ 漂流瓶系統：100%
- ✅ 匿名聊天系統：100%
- ✅ 個人資料管理：90%（缺少血型編輯）
- ✅ 邀請裂變系統：100%
- ✅ VIP 系統：90%（缺少血型配對）
- ✅ 安全與風控：95%（缺少封禁檢查）
- ✅ 管理功能：100%

**總體完成度：** 約 95%

### 待開發功能優先級

#### 🔴 高優先級（影響核心體驗）
1. **血型功能完整實現**（註冊、編輯、配對、顯示）
2. **封禁檢查實現**（安全必須）
3. **MBTI 36 題測試**（提升用戶體驗）

#### 🟡 中優先級（提升用戶體驗）
4. **推送通知系統**（提升活躍度）
5. **支付處理完善**（商業化必須）

#### 🟢 低優先級（錦上添花）
6. **i18n CSV 導入/導出**（運營工具）
7. **星座運勢推播**（召回用戶）
8. **廣播隊列處理**（運營工具）

---

## 🎯 建議的開發順序

### 第一階段：完善核心功能（1-2 天）
1. ✅ 實現封禁檢查（`src/router.ts`）
2. ✅ 完善血型功能（註冊、編輯、配對、顯示）
3. ✅ 完善支付處理（Telegram Stars 回調）

### 第二階段：提升用戶體驗（2-3 天）
4. ✅ 開發 MBTI 36 題測試
5. ✅ 實現推送通知系統
6. ✅ 實現推送偏好檢查

### 第三階段：運營工具（1-2 天）
7. ✅ 實現 i18n CSV 導入/導出
8. ✅ 實現星座運勢推播
9. ✅ 實現廣播隊列處理

### 第四階段：準備 M2（未來）
10. ✅ 設計統一的 AuthAdapter
11. ✅ 設計統一的 NotificationAdapter
12. ✅ 準備 WeChat / Line 審查資源

---

## 📝 注意事項

### 開發前必讀
1. ✅ 閱讀 `@doc/SPEC.md` 了解完整業務邏輯
2. ✅ 閱讀 `@doc/DEVELOPMENT_STANDARDS.md` 了解開發規範
3. ✅ 閱讀 `@doc/SAFE_DEVELOPMENT_PRACTICES.md` 了解安全開發流程
4. ✅ 執行 `pnpm lint` 確保 0 錯誤
5. ✅ 執行 `pnpm test` 確保所有測試通過
6. ✅ 執行完整 Smoke Test 確保核心功能正常

### 部署前檢查清單
1. ✅ 確認 remote 資料庫 schema 最新
2. ✅ 執行 `pnpm lint` - 確保 0 錯誤
3. ✅ 執行 `pnpm test` - 確保所有測試通過
4. ✅ 核對 SPEC.md - 確認完整需求
5. ✅ 執行完整 Smoke Test - 測試所有核心功能
6. ✅ 檢查 UI 顯示 - 暱稱遮罩、統計數據、按鈕提示

---

**維護者：** 開發團隊  
**最後更新：** 2025-11-17

