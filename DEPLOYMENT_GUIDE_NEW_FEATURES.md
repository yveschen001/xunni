# æ–°åŠŸèƒ½éƒ¨ç½²æŒ‡å—

**æ—¥æœŸ**: 2025-11-17  
**ç‰ˆæœ¬**: v2.0 - å»£æ’­ç³»çµ±ã€ç¶­è­·æ¨¡å¼ã€æ¯æ—¥çµ±è¨ˆ

---

## ğŸ“‹ æ–°åŠŸèƒ½ç¸½è¦½

### 1. **å»£æ’­ç³»çµ±** ğŸ””
- ç®¡ç†å“¡å¯ä»¥æ¨é€è¨Šæ¯çµ¦æ‰€æœ‰ç”¨æˆ¶
- æ”¯æŒç”¨æˆ¶ç¯©é¸ï¼ˆå…¨éƒ¨/VIP/éVIPï¼‰
- æ‰¹é‡ç™¼é€ + è‡ªå‹•é™é€Ÿï¼ˆ25å€‹/æ‰¹ï¼Œé–“éš”1ç§’ï¼‰
- å»£æ’­ç‹€æ…‹è¿½è¹¤

### 2. **ç¶­è­·æ¨¡å¼** ğŸ› ï¸
- ç¶­è­·æ™‚é˜»æ­¢ä¸€èˆ¬ç”¨æˆ¶ç™»å…¥
- åªå…è¨±ç®¡ç†å“¡ç™»å…¥
- è‡ªå‹•æ¨é€ç¶­è­·é€šçŸ¥
- å€’æ•¸è¨ˆæ™‚é¡¯ç¤º

### 3. **æ¯æ—¥çµ±è¨ˆ** ğŸ“Š
- è‡ªå‹•ç”Ÿæˆæ¯æ—¥æ•¸æ“šå ±å‘Š
- ç™¼é€çµ¦æ‰€æœ‰ç®¡ç†å“¡
- åŒ…å«ï¼šæ¼‚æµç“¶ã€å°è©±ã€ç”¨æˆ¶ã€VIP çµ±è¨ˆ

---

## ğŸ—„ï¸ æ•¸æ“šåº«è®Šæ›´

### æ–°å¢ 3 å€‹è¡¨
1. `broadcasts` - å»£æ’­è¨˜éŒ„
2. `maintenance_mode` - ç¶­è­·æ¨¡å¼é…ç½®
3. `daily_stats` - æ¯æ—¥çµ±è¨ˆ

### Migration æ–‡ä»¶
- `src/db/migrations/0020_create_broadcast_and_maintenance_tables.sql`

---

## ğŸš€ éƒ¨ç½²æ­¥é©Ÿ

### Step 1: åŸ·è¡Œæ•¸æ“šåº« Migration

```bash
cd /Users/yichen/Downloads/cursor/XunNi

# Staging ç’°å¢ƒ
pnpm wrangler d1 execute xunni-db-staging --remote --file=src/db/migrations/0020_create_broadcast_and_maintenance_tables.sql

# Production ç’°å¢ƒï¼ˆæ¸¬è©¦é€šéå¾Œï¼‰
pnpm wrangler d1 execute xunni-db-production --remote --file=src/db/migrations/0020_create_broadcast_and_maintenance_tables.sql
```

### Step 2: é…ç½® Cron Triggers

åœ¨ `wrangler.toml` ä¸­æ·»åŠ ï¼ˆå¦‚æœé‚„æ²’æœ‰ï¼‰ï¼š

```toml
[triggers]
crons = [
  "5 0 * * *",    # Daily stats at 00:05 UTC
  "*/5 * * * *"   # Broadcast queue every 5 minutes
]
```

### Step 3: éƒ¨ç½²åˆ° Staging

```bash
pnpm deploy:staging
```

### Step 4: æ¸¬è©¦æ–°åŠŸèƒ½

è©³è¦‹ä¸‹æ–¹ã€Œæ¸¬è©¦æ¸…å–®ã€

### Step 5: éƒ¨ç½²åˆ° Production

```bash
# ç¢ºèª staging æ¸¬è©¦é€šéå¾Œ
pnpm deploy:production
```

---

## ğŸ§ª æ¸¬è©¦æ¸…å–®

### 1. å»£æ’­ç³»çµ±æ¸¬è©¦

#### æ¸¬è©¦ 1.1: ç™¼é€å»£æ’­çµ¦æ‰€æœ‰ç”¨æˆ¶
```
/broadcast æ¸¬è©¦è¨Šæ¯ï¼šç³»çµ±æ­£å¸¸é‹è¡Œä¸­
```
**é æœŸçµæœ**:
- âœ… æ”¶åˆ°ç¢ºèªè¨Šæ¯ï¼ˆåŒ…å«å»£æ’­ IDï¼‰
- âœ… æ‰€æœ‰ç”¨æˆ¶æ”¶åˆ°å»£æ’­è¨Šæ¯

#### æ¸¬è©¦ 1.2: ç™¼é€å»£æ’­çµ¦ VIP
```
/broadcast_vip VIP å°ˆå±¬é€šçŸ¥
```
**é æœŸçµæœ**:
- âœ… åªæœ‰ VIP ç”¨æˆ¶æ”¶åˆ°è¨Šæ¯

#### æ¸¬è©¦ 1.3: æŸ¥çœ‹å»£æ’­ç‹€æ…‹
```
/broadcast_status
/broadcast_status 1
```
**é æœŸçµæœ**:
- âœ… é¡¯ç¤ºå»£æ’­åˆ—è¡¨
- âœ… é¡¯ç¤ºå…·é«”å»£æ’­çš„è©³ç´°ç‹€æ…‹

---

### 2. ç¶­è­·æ¨¡å¼æ¸¬è©¦

#### æ¸¬è©¦ 2.1: é–‹å•Ÿç¶­è­·æ¨¡å¼
```
/maintenance_enable 30 ç³»çµ±å‡ç´šç¶­è­·
```
**é æœŸçµæœ**:
- âœ… æ”¶åˆ°ç¢ºèªè¨Šæ¯
- âœ… æ‰€æœ‰ç”¨æˆ¶æ”¶åˆ°ç¶­è­·é€šçŸ¥
- âœ… ä¸€èˆ¬ç”¨æˆ¶ç„¡æ³•ä½¿ç”¨ï¼ˆæ”¶åˆ°ç¶­è­·æç¤ºï¼‰
- âœ… ç®¡ç†å“¡å¯ä»¥æ­£å¸¸ä½¿ç”¨

#### æ¸¬è©¦ 2.2: æŸ¥çœ‹ç¶­è­·ç‹€æ…‹
```
/maintenance_status
```
**é æœŸçµæœ**:
- âœ… é¡¯ç¤ºç¶­è­·ç‹€æ…‹
- âœ… é¡¯ç¤ºå‰©é¤˜æ™‚é–“

#### æ¸¬è©¦ 2.3: é—œé–‰ç¶­è­·æ¨¡å¼
```
/maintenance_disable
```
**é æœŸçµæœ**:
- âœ… æ”¶åˆ°ç¢ºèªè¨Šæ¯
- âœ… æ‰€æœ‰ç”¨æˆ¶æ”¶åˆ°æ¢å¾©é€šçŸ¥
- âœ… ä¸€èˆ¬ç”¨æˆ¶å¯ä»¥æ­£å¸¸ä½¿ç”¨

---

### 3. æ¯æ—¥çµ±è¨ˆæ¸¬è©¦

#### æ¸¬è©¦ 3.1: æ‰‹å‹•è§¸ç™¼çµ±è¨ˆï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰
```bash
# åœ¨ Cloudflare Dashboard ä¸­æ‰‹å‹•è§¸ç™¼ Cron
# æˆ–ç­‰å¾…æ¯æ—¥ 00:05 UTC è‡ªå‹•åŸ·è¡Œ
```

**é æœŸçµæœ**:
- âœ… æ‰€æœ‰ç®¡ç†å“¡æ”¶åˆ°æ¯æ—¥å ±å‘Š
- âœ… å ±å‘ŠåŒ…å«å®Œæ•´çµ±è¨ˆæ•¸æ“š
- âœ… æ•¸æ“šä¿å­˜åˆ° `daily_stats` è¡¨

---

## ğŸ“ æ–°å¢å‘½ä»¤åˆ—è¡¨

### å»£æ’­å‘½ä»¤ï¼ˆç®¡ç†å“¡ï¼‰
```
/broadcast <è¨Šæ¯>           - ç™¼é€çµ¦æ‰€æœ‰ç”¨æˆ¶
/broadcast_vip <è¨Šæ¯>       - ç™¼é€çµ¦ VIP ç”¨æˆ¶
/broadcast_non_vip <è¨Šæ¯>   - ç™¼é€çµ¦é VIP ç”¨æˆ¶
/broadcast_status [id]      - æŸ¥çœ‹å»£æ’­ç‹€æ…‹
```

### ç¶­è­·æ¨¡å¼å‘½ä»¤ï¼ˆè¶…ç´šç®¡ç†å“¡ï¼‰
```
/maintenance_enable <åˆ†é˜> [è¨Šæ¯]  - é–‹å•Ÿç¶­è­·æ¨¡å¼
/maintenance_disable                - é—œé–‰ç¶­è­·æ¨¡å¼
/maintenance_status                 - æŸ¥çœ‹ç¶­è­·ç‹€æ…‹ï¼ˆç®¡ç†å“¡å¯ç”¨ï¼‰
```

---

## ğŸ” æ¬Šé™èªªæ˜

### å»£æ’­ç³»çµ±
- âœ… Super Admin - å¯ä»¥ç™¼é€æ‰€æœ‰é¡å‹å»£æ’­
- âœ… Admin - å¯ä»¥ç™¼é€æ‰€æœ‰é¡å‹å»£æ’­
- âŒ ä¸€èˆ¬ç”¨æˆ¶ - ç„¡æ¬Šé™

### ç¶­è­·æ¨¡å¼
- âœ… Super Admin - å¯ä»¥é–‹å•Ÿ/é—œé–‰ç¶­è­·æ¨¡å¼
- âœ… Admin - å¯ä»¥æŸ¥çœ‹ç¶­è­·ç‹€æ…‹
- âŒ ä¸€èˆ¬ç”¨æˆ¶ - ç„¡æ¬Šé™

### æ¯æ—¥çµ±è¨ˆ
- âœ… Super Admin - è‡ªå‹•æ¥æ”¶å ±å‘Š
- âœ… Admin - è‡ªå‹•æ¥æ”¶å ±å‘Š
- âŒ ä¸€èˆ¬ç”¨æˆ¶ - ä¸æ¥æ”¶

---

## âš ï¸ æ³¨æ„äº‹é …

### 1. å»£æ’­é™é€Ÿ
- æ¯æ‰¹ 25 å€‹ç”¨æˆ¶
- æ‰¹æ¬¡é–“éš” 1 ç§’
- å¤§é‡ç”¨æˆ¶æ™‚æœƒè¼ƒæ…¢ï¼ˆä¾‹å¦‚ 1000 ç”¨æˆ¶éœ€è¦ç´„ 40 ç§’ï¼‰

### 2. ç¶­è­·æ¨¡å¼
- é–‹å•Ÿç¶­è­·æ¨¡å¼æœƒç«‹å³é˜»æ­¢ä¸€èˆ¬ç”¨æˆ¶
- ç®¡ç†å“¡ä¸å—å½±éŸ¿
- å»ºè­°åœ¨ä½å³°æ™‚æ®µé–‹å•Ÿ

### 3. æ¯æ—¥çµ±è¨ˆ
- çµ±è¨ˆæ™‚é–“ç‚º 00:05 UTCï¼ˆå°åŒ—æ™‚é–“ 08:05ï¼‰
- çµ±è¨ˆå‰ä¸€å¤©çš„æ•¸æ“š
- å¦‚æœ Cron æœªè§¸ç™¼ï¼Œæª¢æŸ¥ wrangler.toml é…ç½®

### 4. æ•¸æ“šåº«
- ç¢ºä¿ migration å·²åŸ·è¡Œ
- æª¢æŸ¥è¡¨æ˜¯å¦æ­£ç¢ºå‰µå»ºï¼š
  ```sql
  SELECT name FROM sqlite_master WHERE type='table';
  ```

---

## ğŸ› æ•…éšœæ’é™¤

### å•é¡Œ 1: å»£æ’­ç™¼é€å¤±æ•—
**ç—‡ç‹€**: å»£æ’­ç‹€æ…‹é¡¯ç¤º 'failed'  
**è§£æ±ºæ–¹æ¡ˆ**:
1. æª¢æŸ¥ Cloudflare Logs
2. ç¢ºèª Telegram API æ­£å¸¸
3. æª¢æŸ¥ç”¨æˆ¶ ID æ˜¯å¦æœ‰æ•ˆ

### å•é¡Œ 2: ç¶­è­·æ¨¡å¼ç„¡æ•ˆ
**ç—‡ç‹€**: ä¸€èˆ¬ç”¨æˆ¶ä»å¯ç™»å…¥  
**è§£æ±ºæ–¹æ¡ˆ**:
1. æª¢æŸ¥ `maintenance_mode` è¡¨çš„ `is_active` æ¬„ä½
2. ç¢ºèª router.ts ä¸­çš„ç¶­è­·æ¨¡å¼æª¢æŸ¥å·²éƒ¨ç½²
3. æ¸…é™¤ Cloudflare ç·©å­˜

### å•é¡Œ 3: æ¯æ—¥çµ±è¨ˆæœªç™¼é€
**ç—‡ç‹€**: ç®¡ç†å“¡æœªæ”¶åˆ°å ±å‘Š  
**è§£æ±ºæ–¹æ¡ˆ**:
1. æª¢æŸ¥ Cron Triggers æ˜¯å¦é…ç½®
2. æŸ¥çœ‹ Cloudflare Logs ç¢ºèª Cron æ˜¯å¦è§¸ç™¼
3. ç¢ºèªç®¡ç†å“¡ ID é…ç½®æ­£ç¢ºï¼ˆ`ADMIN_USER_IDS`ï¼‰

### å•é¡Œ 4: Migration åŸ·è¡Œå¤±æ•—
**ç—‡ç‹€**: è¡¨ä¸å­˜åœ¨éŒ¯èª¤  
**è§£æ±ºæ–¹æ¡ˆ**:
```bash
# æª¢æŸ¥ migration ç‹€æ…‹
pnpm wrangler d1 execute xunni-db-staging --remote --command="SELECT name FROM sqlite_master WHERE type='table';"

# é‡æ–°åŸ·è¡Œ migration
pnpm wrangler d1 execute xunni-db-staging --remote --file=src/db/migrations/0020_create_broadcast_and_maintenance_tables.sql
```

---

## ğŸ“Š ç›£æ§æŒ‡æ¨™

### éœ€è¦ç›£æ§çš„é …ç›®
1. **å»£æ’­æˆåŠŸç‡**: `sent_count / total_users`
2. **å»£æ’­å¤±æ•—ç‡**: `failed_count / total_users`
3. **ç¶­è­·æ¨¡å¼ç‹€æ…‹**: æ˜¯å¦æ„å¤–é–‹å•Ÿ
4. **æ¯æ—¥çµ±è¨ˆç”Ÿæˆ**: æ˜¯å¦æŒ‰æ™‚ç”Ÿæˆ
5. **Cron åŸ·è¡Œç‹€æ…‹**: æ˜¯å¦æ­£å¸¸è§¸ç™¼

### æŸ¥è©¢ SQL
```sql
-- æŸ¥çœ‹æœ€è¿‘å»£æ’­
SELECT * FROM broadcasts ORDER BY created_at DESC LIMIT 10;

-- æŸ¥çœ‹ç¶­è­·æ¨¡å¼ç‹€æ…‹
SELECT * FROM maintenance_mode WHERE id = 1;

-- æŸ¥çœ‹æœ€è¿‘çµ±è¨ˆ
SELECT * FROM daily_stats ORDER BY stat_date DESC LIMIT 7;
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥ï¼ˆå¯é¸ï¼‰

### æœªå¯¦ç¾çš„åŠŸèƒ½
1. **çµ±è¨ˆ API ç«¯é»** - REST API æŸ¥è©¢çµ±è¨ˆ
2. **ç¶­è­· API ç«¯é»** - API æ§åˆ¶ç¶­è­·æ¨¡å¼
3. **å»£æ’­å–æ¶ˆåŠŸèƒ½** - å–æ¶ˆé€²è¡Œä¸­çš„å»£æ’­
4. **å»£æ’­é ç´„åŠŸèƒ½** - é ç´„æœªä¾†æ™‚é–“ç™¼é€

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰å•é¡Œï¼Œè«‹æŸ¥çœ‹ï¼š
1. Cloudflare Logs
2. `PROJECT_STATUS_REPORT.md`
3. `BROADCAST_AND_MAINTENANCE_DESIGN.md`

---

**æœ€å¾Œæ›´æ–°**: 2025-11-17  
**ä½œè€…**: AI Assistant  
**ç‰ˆæœ¬**: v2.0

