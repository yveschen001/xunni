image.png# XunNi 專案 Cursor AI 規則

> **⚠️ 重要：在開始任何編輯前，必須先閱讀 `@doc/SPEC.md`**

## 文檔編輯規則（必須遵守）

**⚠️ 嚴格遵守以下規則，避免創建不必要的文檔或發明新規則：**

- **不要創建新的頂層文檔**：除非用戶明確要求，否則不要在 `doc/` 目錄下創建新的頂層文檔
- **優先編輯現有文檔**：更新文檔時，優先編輯和合併現有文檔（`@doc/SPEC.md`、`@doc/ENV_CONFIG.md` 等）
- **不要發明新規則**：不要發明新的業務規則或功能。如果不清楚，請添加簡短的 `TODO:` 註釋
- **單一來源原則**：將 `@doc/SPEC.md` 視為以下內容的單一來源：
  - 業務邏輯
  - 領域術語
  - 資料庫設計
- **變更前先總結**：在變更文檔中的領域邏輯前：
  1. 先總結 `@doc/SPEC.md` 中描述的當前行為
  2. 然後用自然語言提出變更建議
  3. 最後再應用編輯

## Protected Documentation

The following files are considered **protected**:

- `@doc/SPEC.md`
- `@doc/ENV_CONFIG.md`
- `@doc/DEVELOPMENT_STANDARDS.md`
- `@doc/DEPLOYMENT.md`
- `@doc/BACKUP_STRATEGY.md`

**Rules for protected docs:**

- **Do NOT modify these files unless the user explicitly says that they MUST be updated.**
  - Examples of explicit permission:
    - "MUST update SPEC"
    - "Please update SPEC accordingly"
    - "我允許你修改 SPEC / ENV_CONFIG"
- **If a task might affect these docs:**
  1. First, summarise which sections would need changes and why.
  2. Then ask the user for confirmation.
  3. Only after clear confirmation, apply the minimal necessary edits.
- **Never create new top-level docs that replace these protected files unless the user explicitly requests a new document.**

## ⚠️ 安全開發原則（Critical: Prevent Breaking Changes）

**在修改任何代碼前，必須遵守以下原則：**

### 部署前檢查清單（必須完成）
1. ✅ **確認 remote 資料庫 schema 最新** - 檢查 migration 是否已執行
2. ✅ **執行 `pnpm lint`** - 確保 0 錯誤
3. ✅ **執行 `pnpm test`** - 確保所有測試通過
4. ✅ **核對 SPEC.md** - 確認完整需求（如：34 種語言）
5. ✅ **執行完整 Smoke Test** - 測試所有核心功能
6. ✅ **檢查 UI 顯示** - 暱稱擾碼、統計數據、按鈕提示

### 常見錯誤預防
- ❌ **資料庫 Migration 未在 Remote 執行** → 部署前確認表存在
- ❌ **使用錯誤的工具函數** → 暱稱擾碼統一使用 `maskNickname`
- ❌ **計算邏輯錯誤** → 百分比必須加 `Math.min(100, ...)`
- ❌ **語言映射不完整** → 確認支援 34 種語言
- ❌ **Smoke Test 不完整** → 每次新增功能都要更新測試

### 安全修改流程
1. **理解現有實現** - 閱讀代碼、查看 SPEC.md、查看測試
2. **規劃變更** - 列出範圍、確認依賴、規劃測試
3. **執行變更** - 一次只改一個地方、保持一致性
4. **驗證變更** - 執行測試、Smoke Test、手動測試
5. **更新文檔** - 更新 SPEC.md、相關文檔、CHANGELOG

**詳細規範請參考：`@doc/DEVELOPMENT_STANDARDS.md` 第 6 節**

## 第一步：閱讀專案概覽

**在開始任何工作前，必須先閱讀：**
- `@doc/SPEC.md` - 專案規格書（**必讀**，包含專案概覽、結構、完整業務邏輯和**術語表**）
- `@doc/ENV_CONFIG.md` - 開發環境設置指南（如何設置本地環境，包含**開發前檢查清單**）
- `@doc/DEVELOPMENT_STANDARDS.md` - 代碼風格和命名規範（包含**AI 協作流程**和**安全開發流程**）
- `@doc/I18N_EXTRACTION_AND_REPLACEMENT_STANDARDS.md` - **i18n 提取與替換規範**（**進行 i18n 相關工作前必讀**）

## 開發規範（必須遵守）

### 代碼風格

**必須遵守以下規範（詳見 `@doc/DEVELOPMENT_STANDARDS.md` 和 `@doc/CODE_QUALITY_GUIDELINES.md`）：**

- **TypeScript**: 使用嚴格模式（`strict: true`）
- **命名規範**:
  - 變數和函數：`camelCase`
  - 常數：`UPPER_SNAKE_CASE`
  - 類別和型別：`PascalCase`
  - 檔案名稱：小寫 + 下劃線（如 `msg_forward.ts`）
- **模組化**: 遵循 `@doc/MODULE_DESIGN.md` 中的分層設計原則
- **代碼質量**: 
  - 刪除所有未使用的導入和變量
  - 避免使用 `any` 類型
  - 不使用 `console.log`（只允許 `console.error`）
  - 未使用但必須存在的參數使用 `_` 前綴

### Telegram 訊息格式

**⚠️ 嚴格遵守：**

- **所有 Telegram 訊息使用純文字 + 官方 Emoji**
- **絕對不使用 HTML 或 Markdown 格式**
- 使用表情符號增加友好度

### 資料庫規範

- **表名**: 小寫 + 下劃線（如 `users`, `bottles`）
- **欄位名**: 小寫 + 下劃線（如 `telegram_id`, `is_vip`）
- **變更管理**: 必須通過遷移腳本（`@src/db/migrations/`），禁止直接修改 `@src/db/schema.sql`

### 國際化（⚠️ 嚴格遵守，禁止硬編碼）

**必須遵守：**

- **所有使用者可見文字必須使用 i18n 系統**
- **禁止硬編碼中文字符串**（除了技術標識符、callback_data、正則表達式等）
- 使用 `i18n.t(key)` 調用，禁止使用字串字面量
- 參考 `@doc/I18N_GUIDE.md` 了解如何使用
- 參考 `@doc/I18N_EXTRACTION_AND_REPLACEMENT_STANDARDS.md` 了解提取和替換規範

**開發新功能時：**

1. **編寫代碼時**：
   - ✅ 直接使用 `i18n.t('key')`，不要先寫中文再替換
   - ✅ 如果 key 不存在，先添加到 `src/i18n/locales/zh-TW.ts` 和 `src/i18n/types.ts`
   - ✅ 確保所有用戶可見文字都通過 i18n

2. **提交前檢查**：
   - ✅ 運行 `pnpm lint` 檢查（會檢查硬編碼）
   - ✅ 確認沒有硬編碼的中文字符串
   - ✅ 確認所有 `sendMessage` 等都使用 `i18n.t()`

3. **禁止的做法**：
   - ❌ 先寫中文，說「之後再提取」
   - ❌ 使用字串字面量（如 `'❌ 錯誤'`）
   - ❌ 在代碼中直接寫中文（除了技術標識符）

### 測試要求

**在提交代碼前，必須確保測試通過：**

- Domain 層：目標 90%+ 覆蓋率（`@tests/domain/`）
- Utils：目標 80%+ 覆蓋率（`@tests/utils/`）
- Handlers：目標 60%+ 覆蓋率（`@tests/telegram/handlers/`）

**測試命令**：`pnpm test`

## 受保護的文件/目錄

**⚠️ 修改前必須謹慎，建議先與維護者確認：**

- `@wrangler.toml` - Cloudflare 配置（部署相關）
- `@src/db/schema.sql` - 資料庫 Schema（必須通過遷移腳本）
- `@src/db/migrations/` - 遷移腳本目錄（變更需審核）
- `@scripts/backup-*.ts` - 備份腳本（備份策略相關）

**注意**：核心受保護文檔（`@doc/SPEC.md`、`@doc/ENV_CONFIG.md` 等）的規則見上方「Protected Documentation」章節。

**🔒 絕對禁止修改：**

- `.dev.vars` - 包含敏感資訊（在 `.gitignore` 中）
- `node_modules/` - 依賴包
- `package-lock.json` / `pnpm-lock.yaml` - 鎖定文件（除非明確要求更新依賴）

## 業務規則（不可違反）

### 不可修改的欄位

- **性別（gender）**: 設定後永遠不能修改（需二次確認）
- **生日（birthday）**: 設定後永遠不能修改（需二次確認）

**實作位置**: `@src/telegram/handlers/profile.ts` 和 `@src/telegram/handlers/start.ts`

### 年齡限制

- 未滿 18 歲不允許註冊
- 必須輸入真實生日驗證

**實作位置**: `@src/domain/user.ts` 和 `@src/telegram/handlers/start.ts`

### 安全規範

- 所有 URL 必須通過白名單檢查（`@src/utils/url-whitelist.ts`）
- 匿名轉發不暴露真實 Telegram ID（`@src/telegram/handlers/msg_forward.ts`）
- 敏感資訊使用 Cloudflare Secrets（不在代碼中硬編碼）

## 備份策略（必須遵守）

### 單向備份原則

**絕對禁止使用以下命令：**
- `git pull`
- `git fetch`
- `git merge`
- `git reset --hard`
- `git checkout -f`

**正確做法：**

```bash
# 本地備份
pnpm backup

# 推送到 GitHub
pnpm backup:push
```

**詳細說明**: 參考 `@doc/BACKUP_STRATEGY.md`

## 開發流程（必須遵循）

**在編輯任何文件前，請確認已完成以下步驟：**

### 第一步：文檔準備（必須完成）

1. **閱讀專案概覽**: 閱讀 `@doc/SPEC.md` 第 1 節「專案總覽」了解專案概況
2. **閱讀術語表**: 閱讀 `@doc/SPEC.md` 附錄「術語表 / Glossary」了解核心詞彙定義（**重要**）
3. **閱讀開發環境設置**: 閱讀 `@doc/ENV_CONFIG.md` 第 1 節「快速開始」和第 3 節「本地開發設置」
4. **閱讀開發規範**: 閱讀 `@doc/DEVELOPMENT_STANDARDS.md` 了解代碼風格和命名規範
5. **閱讀 AI 協作流程**: 閱讀 `@doc/DEVELOPMENT_STANDARDS.md` 第 5 節「與 AI 協作流程」
6. **查看開發前檢查清單**: 查看 `@doc/ENV_CONFIG.md` 第 6 節「開發前檢查清單」確認所有事項已完成

### 第二步：環境驗證（必須完成）

7. **驗證本地環境**: 確認 `pnpm install`、`pnpm dev`、`pnpm test`、`pnpm lint` 都能正常執行
8. **查看受保護文件**: 閱讀 `@doc/SPEC.md` 附錄「受保護的文件/目錄」，了解哪些文件不能隨意修改

### 第三步：開發流程（必須遵循）

9. **理解業務邏輯**: 確保理解該功能的業務邏輯和資料庫設計（見 `@doc/SPEC.md`）
10. **遵循規範**: 嚴格遵守 `@doc/DEVELOPMENT_STANDARDS.md` 中的規範和術語定義
11. **⚠️ 嚴格遵守 i18n 規範（必須同步到所有語言）**: 
    - **所有用戶可見文字都使用 `i18n.t()`**
    - **禁止硬編碼中文字符串**
    - 編寫代碼時直接使用 i18n，不要先寫中文
    - 新增文字時立即添加到 `src/i18n/locales/zh-TW.ts`（參考語言）
    - **⚠️ 必須執行 i18n 同步**：
      - 新增或修改 i18n key 後，**必須執行 `pnpm i18n:sync`** 同步到所有 34 種語言
      - 執行 `pnpm i18n:check` 檢查是否有問題
      - 執行 `pnpm i18n:fix-templates` 修復模板字符串問題
      - 確認所有語言都有對應的 key（或占位符 `[需要翻译]`）
    - **這是開發流程的一部分，不是可選步驟！**
12. **編寫測試**: Domain 層函數必須先寫測試（`@tests/domain/`），目標 90%+ 覆蓋率
13. **執行測試**: 執行 `pnpm test` 確保所有測試通過
14. **執行 Lint**: 執行 `pnpm lint` 檢查代碼風格
15. **檢查硬編碼**: 執行 `pnpm check:i18n` 檢查是否有硬編碼中文（**必須通過**）
16. **⚠️ i18n 同步（必須執行）**:
    - 新增或修改 i18n key 後，**必須執行 `pnpm i18n:sync`** 同步到所有 34 種語言
    - 執行 `pnpm i18n:check` 檢查是否有問題
    - 執行 `pnpm i18n:fix-templates` 修復模板字符串問題
    - 確認所有語言都有對應的 key（或占位符 `[需要翻译]`）
    - **這是開發流程的一部分，不是可選步驟！**
17. **檢查術語**: 確認使用的術語符合 `@doc/SPEC.md` 術語表定義
18. **更新文檔**: 如有資料庫或業務邏輯變更，更新 `@doc/SPEC.md` 相應章節
19. **備份**: 使用 `pnpm backup` 進行本地備份
20. **推送**: 使用 `pnpm backup:push` 推送到 GitHub

## 命令速查

```bash
# 本地開發
pnpm dev

# 執行測試
pnpm test

# 執行 Lint
pnpm lint

# 本地備份
pnpm backup

# 推送到 GitHub
pnpm backup:push

# ⚠️ 部署前必須執行檢查（強制）
./scripts/pre-deploy-check.sh staging
./scripts/pre-deploy-check.sh production

# 部署到 Staging
pnpm deploy:staging

# 部署到 Production
pnpm deploy:production
```

## ⚠️ 部署前強制檢查

**在執行任何部署前，必須先執行**：

```bash
./scripts/pre-deploy-check.sh staging
```

**此腳本會強制檢查**：
1. Migration 是否已執行
2. i18n Keys 是否存在
3. **i18n 同步狀態**（⚠️ 必須同步到所有語言）
4. Lint 是否通過
5. 測試是否通過
6. 變更內容是否已檢查
7. **功能是否已實際測試**（最重要！）
8. Cloudflare Logs 是否已確認無錯誤

**詳細說明**：`@doc/DEPLOYMENT_CHECKLIST.md`

**絕對禁止**：
- ❌ 沒有實際測試就說「已測試好了」
- ❌ 跳過任何檢查項目
- ❌ 部署前不執行 migration

## 文件路徑規範

**使用 `@` 前綴引用文件路徑（如 `@src/worker.ts`）**

**重要文件位置：**

- 專案規格（必讀）: `@doc/SPEC.md` - 包含專案概覽、結構、完整規格、**術語表**和**開發前準備**
- 開發環境設置: `@doc/ENV_CONFIG.md` - 本地環境設置、環境變數配置和**開發前檢查清單**
- 開發規範: `@doc/DEVELOPMENT_STANDARDS.md` - 代碼風格、命名規範和**AI 協作流程**
- 模組設計: `@doc/MODULE_DESIGN.md` - 架構原則和分層設計
- 國際化指南: `@doc/I18N_GUIDE.md` - i18n 使用方式
- UI 設計指南: `@doc/UI_GUIDELINE.md` - UI 設計規範、動畫規範和互動體驗標準（Mini App 開發必讀）
- 測試規範: `@doc/TESTING.md` - 測試策略和覆蓋率目標
- 部署指南: `@doc/DEPLOYMENT.md` - 部署流程和監控
- 備份策略: `@doc/BACKUP_STRATEGY.md` - 備份原則和流程

**完整文檔索引**: `@doc/README.md`

## 架構原則

### 分層設計（詳見 `@doc/MODULE_DESIGN.md`）

- **Domain 層** (`@src/domain/`): 純函數，無副作用，易於測試
- **Services 層** (`@src/services/`): 外部服務封裝
- **Handlers 層** (`@src/telegram/handlers/`): Telegram 指令處理
- **Utils 層** (`@src/utils/`): 通用工具函數

**原則**:
- Domain 層不依賴外部服務
- Handlers 層依賴 Domain 層，不直接操作資料庫
- Services 層獨立，可被多個 Handlers 使用

## 故障排除

### 不確定從哪裡開始？
**解決方案**: 
1. **閱讀專案概覽**：先閱讀 `@doc/SPEC.md` 第 1 節「專案總覽」了解專案概況
2. **閱讀術語表**：閱讀 `@doc/SPEC.md` 附錄「術語表 / Glossary」了解核心詞彙定義
3. **設置環境**：閱讀 `@doc/ENV_CONFIG.md` 設置本地環境（參考第 6 節「開發前檢查清單」）
4. **了解開發流程**：閱讀 `@doc/SPEC.md` 第 15 節「建議的 Cursor 開發順序」了解開發流程
5. **了解 AI 協作**：閱讀 `@doc/DEVELOPMENT_STANDARDS.md` 第 5 節「與 AI 協作流程」

### 不確定命名規範？
**解決方案**: 查看 `@doc/DEVELOPMENT_STANDARDS.md` 第 2.2 節

### 不確定術語使用？
**解決方案**: 
1. 查看 `@doc/SPEC.md` 附錄「術語表 / Glossary」了解標準術語定義
2. 嚴格遵守術語表中的定義，不要混用 "user"/"member"/"player" 等
3. 不要使用 "message" 代替 "Bottle" 或 "Conversation Message"

### 不確定如何測試？
**解決方案**: 參考 `@doc/TESTING.md` 和現有測試文件 `@tests/domain/`

### 不確定架構設計？
**解決方案**: 閱讀 `@doc/MODULE_DESIGN.md` 了解分層設計原則

---

**最後更新**: 2025-01-15  
**維護者**: 專案團隊
