<!DOCTYPE html>
<html lang="{{LANG}}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>{{TITLE}} - XunNi</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 600px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      text-align: center;
    }

    .header h1 {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .header p {
      font-size: 14px;
      opacity: 0.9;
    }

    .ad-container {
      padding: 20px;
      min-height: 400px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .loading {
      text-align: center;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading p {
      color: #666;
      font-size: 16px;
    }

    .error {
      text-align: center;
      color: #e74c3c;
    }

    .error-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .error h2 {
      font-size: 20px;
      margin-bottom: 12px;
    }

    .error p {
      color: #666;
      margin-bottom: 20px;
    }

    .success {
      text-align: center;
      color: #27ae60;
    }

    .success-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .success h2 {
      font-size: 24px;
      margin-bottom: 12px;
    }

    .success p {
      color: #666;
      margin-bottom: 8px;
    }

    .btn {
      display: inline-block;
      padding: 12px 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-decoration: none;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      margin-top: 20px;
      cursor: pointer;
      border: none;
      transition: transform 0.2s;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: #f0f0f0;
      border-radius: 3px;
      overflow: hidden;
      margin-top: 20px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.3s ease;
    }

    .ad-placeholder {
      width: 100%;
      min-height: 300px;
      background: #f5f5f5;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }

    .countdown {
      font-size: 18px;
      color: #667eea;
      font-weight: 600;
      margin-top: 16px;
    }

    .footer {
      padding: 16px;
      text-align: center;
      color: #999;
      font-size: 12px;
      border-top: 1px solid #f0f0f0;
    }
  </style>
  <script>
    window.I18N = {{TRANSLATIONS_JSON}};
  </script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“º {{TITLE}}</h1>
      <p>{{SUBTITLE}}</p>
    </div>

    <div class="ad-container" id="adContainer">
      <div class="loading">
        <div class="loading-spinner"></div>
        <p>{{LOADING}}</p>
      </div>
    </div>

    <div class="footer">
      <p>{{FOOTER}}</p>
    </div>
  </div>

  <!-- GigaPub Enhanced Reliability Script -->
  <script data-project-id="4406">
    !function(){
      var s=document.currentScript,p=s.getAttribute('data-project-id')||'4406';
      var d=['https://ad.gigapub.tech','https://ru-ad.gigapub.tech'],i=0,t,sc;
      function l(){
        sc=document.createElement('script');
        sc.async=true;
        sc.src=d[i]+'/script?id='+p;
        clearTimeout(t);
        t=setTimeout(function(){
          sc.onload=sc.onerror=null;
          sc.src='';
          if(++i<d.length)l();
        },15000);
        sc.onload=function(){clearTimeout(t)};
        sc.onerror=function(){clearTimeout(t);if(++i<d.length)l()};
        document.head.appendChild(sc);
      }
      l();
    }();
  </script>

  <script>
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const provider = urlParams.get('provider');
    const token = urlParams.get('token');
    const userId = urlParams.get('user');

    // Configuration
    const API_BASE_URL = window.location.origin;
    const AD_DURATION = 15; // seconds
    const MIN_REQUIRED_SECONDS = 10; // minimum playback seconds required

    // State
    let adStartTime = null;
    let adCompleted = false;
    let playbackDurationMs = null;
    let countdownInterval = null;
    let isSubmittingCompletion = false;

    // Helper for I18N
    function t(key, defaultVal) {
      return (window.I18N && window.I18N[key]) || defaultVal || key;
    }

    // ========================================================================
    // Main Flow
    // ========================================================================

    async function init() {
      try {
        // Validate parameters
        if (!provider || !token || !userId) {
          showError(t('invalidParams', 'ç„¡æ•ˆçš„åƒæ•¸'), t('restartBot', 'è«‹å¾ Telegram Bot é‡æ–°é–‹å§‹'));
          return;
        }

        const startOk = await notifyAdStart();
        if (!startOk) {
          return;
        }

        // Load ad provider script
        await loadAdProvider(provider);

        // Start ad
        await startAd(provider);

      } catch (error) {
        console.error('Init error:', error);
        showError(t('loadFailed', 'å»£å‘ŠåŠ è¼‰å¤±æ•—'), error.message || t('tryAgainLater', 'è«‹ç¨å¾Œå†è©¦'));
        reportError(error.message || 'Unknown error');
      }
    }

    // ========================================================================
    // Ad Provider Integration
    // ========================================================================

    async function notifyAdStart() {
      try {
        const response = await fetch(
          `${API_BASE_URL}/api/ad/start?user=${userId}&token=${token}&provider=${provider}`,
          { method: 'POST' }
        );
        const data = await response.json();
        if (!data.success) {
          showError(t('startFailed', 'ç„¡æ³•é–‹å§‹å»£å‘Š'), data.message || t('restartBot', 'è«‹è¿”å› Telegram é‡æ–°é–‹å§‹'));
          await reportError(data.message || 'start_failed');
          return false;
        }
        return true;
      } catch (error) {
        console.error('Start error:', error);
        showError(t('startFailed', 'ç„¡æ³•é–‹å§‹å»£å‘Š'), t('networkError', 'é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦'));
        await reportError(error.message || 'start_network_error');
        return false;
      }
    }

    async function loadAdProvider(providerName) {
      // GigaPub script is already loaded in HTML
      // Wait for it to be ready
      if (providerName === 'gigapub' || providerName === 'gigapub_test') {
        // Wait for window.showGiga to be available
        let attempts = 0;
        while (!window.showGiga && attempts < 50) {
          await new Promise(resolve => setTimeout(resolve, 100));
          attempts++;
        }
        
        if (!window.showGiga) {
          throw new Error('GigaPub SDK åŠ è¼‰å¤±æ•—');
        }
      }
    }

    async function startAd(providerName) {
      adStartTime = Date.now();

      if (providerName === 'gigapub' || providerName === 'gigapub_test') {
        // Use real GigaPub ad
        await startGigaPubAd();
      } else {
        // Fallback to mock ad for testing
        showAdPlaceholder();
        simulateAdPlayback();
      }
    }

    async function startGigaPubAd() {
      try {
        // Show loading state
        const container = document.getElementById('adContainer');
        container.innerHTML = `
          <div class="loading">
            <div class="loading-spinner"></div>
            <p>${t('loadingAd', 'æ­£åœ¨åŠ è¼‰ GigaPub å»£å‘Š...')}</p>
            <p style="font-size: 12px; color: #999; margin-top: 10px;">${t('waitAd', 'è«‹è€å¿ƒç­‰å¾…å»£å‘ŠåŠ è¼‰å®Œæˆ')}</p>
          </div>
        `;

        console.log('[GigaPub] Starting ad playback...');
        console.log('[GigaPub] window.showGiga available:', !!window.showGiga);
        console.log('[GigaPub] Time:', new Date().toISOString());

        // Call GigaPub showGiga() and wait for completion
        const startTime = Date.now();
        
        // GigaPub showGiga() returns a Promise that resolves when ad completes
        // According to GigaPub docs, this should wait for user interaction
        const result = await window.showGiga();
        
        const duration = Date.now() - startTime;
        const durationSeconds = (duration / 1000).toFixed(2);

        console.log('[GigaPub] Ad completed:', {
          result,
          duration: `${duration}ms`,
          durationSeconds: `${durationSeconds}s`,
          timestamp: new Date().toISOString()
        });

        playbackDurationMs = duration;

        // Check if ad actually played long enough
        if (duration < MIN_REQUIRED_SECONDS * 1000) {
          console.warn('[GigaPub] Ad completed suspiciously fast:', {
            duration: `${duration}ms`,
            result
          });
          showShortPlaybackWarning(durationSeconds);
          return;
        }

        // Normal completion (ad played for reasonable duration)
        console.log('[GigaPub] Ad played successfully for', durationSeconds, 'seconds');
        showCompletionPrompt(durationSeconds);

      } catch (error) {
        console.error('[GigaPub] Ad error:', error);
        
        // If GigaPub fails, show error
        showError(t('loadFailed', 'å»£å‘ŠåŠ è¼‰å¤±æ•—'), error.message || t('tryAgainLater', 'è«‹ç¨å¾Œå†è©¦'));
        reportError(`GigaPub error: ${error.message || 'Unknown'}`);
      }
    }

    function showShortPlaybackWarning(duration) {
      const container = document.getElementById('adContainer');
      container.innerHTML = `
        <div class="loading">
          <div style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>
          <p style="color: #f39c12; font-size: 16px; margin-bottom: 12px;">${t('shortAdTitle', 'å»£å‘Šæ’­æ”¾æ™‚é–“è¼ƒçŸ­')}</p>
          <p style="color: #666; font-size: 14px;">${t('duration', 'æ’­æ”¾æ™‚é•·')}: ${duration}s</p>
          <p style="color: #666; font-size: 14px; margin-top: 8px;">${t('shortAdReason', 'å¯èƒ½æ˜¯å»£å‘Šåº«å­˜ä¸è¶³')}</p>
          <p style="color: #666; font-size: 14px; margin-top: 16px;">${t('shortAdConfirm', 'è«‹ç¢ºèªæ˜¯å¦å®Œæ•´è§€çœ‹')}</p>
          <button class="btn" id="confirmShortAd">âœ… ${t('confirmWatched', 'æˆ‘ç¢ºå¯¦çœ‹å®Œ')}</button>
          <button class="btn btn-secondary" id="replayShortAd" style="margin-left: 8px;">${t('replay', 'é‡æ–°æ’­æ”¾')}</button>
        </div>
      `;

      document.getElementById('confirmShortAd')?.addEventListener('click', () => {
        showCompletionPrompt(duration);
      });
      document.getElementById('replayShortAd')?.addEventListener('click', () => {
        window.location.reload();
      });
    }

    function showAdPlaceholder() {
      const container = document.getElementById('adContainer');
      container.innerHTML = `
        <div class="ad-placeholder">
          <div style="text-align: center;">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“º</div>
            <p style="font-size: 18px; color: #666; margin-bottom: 8px;">${t('adPlaying', 'å»£å‘Šæ’­æ”¾ä¸­...')}</p>
            <p class="countdown" id="countdown">${t('remaining', 'å‰©é¤˜æ™‚é–“')}: ${AD_DURATION}s</p>
          </div>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      `;

      // Start countdown
      startCountdown();
    }

    function startCountdown() {
      let remaining = AD_DURATION;
      const countdownEl = document.getElementById('countdown');
      const progressFill = document.getElementById('progressFill');

      if (countdownInterval) {
        clearInterval(countdownInterval);
      }

      countdownInterval = setInterval(() => {
        remaining--;
        
        if (countdownEl) {
          countdownEl.textContent = `${t('remaining', 'å‰©é¤˜æ™‚é–“')}: ${remaining}s`;
        }

        if (progressFill) {
          const progress = ((AD_DURATION - remaining) / AD_DURATION) * 100;
          progressFill.style.width = `${progress}%`;
        }

        if (remaining <= 0) {
          clearInterval(countdownInterval);
          countdownInterval = null;
          playbackDurationMs = AD_DURATION * 1000;
          showCompletionPrompt(AD_DURATION);
        }
      }, 1000);
    }

    function simulateAdPlayback() {
      // In production, this would integrate with actual ad provider
      // For now, we just wait for the countdown
    }

    function showCompletionPrompt(durationSeconds) {
      const container = document.getElementById('adContainer');
      container.innerHTML = `
        <div class="success">
          <div class="success-icon">âœ…</div>
          <h2>${t('confirmFullWatch', 'è«‹ç¢ºèªå»£å‘Šå·²å®Œæ•´è§€çœ‹')}</h2>
          <p>${t('duration', 'æ’­æ”¾æ™‚é•·')}: ~${durationSeconds}s</p>
          <p style="color: #666; font-size: 14px; margin-top: 8px;">${t('clickToClaim', 'é»æ“Šä¸‹æ–¹æŒ‰éˆ•é ˜å–çå‹µ')}</p>
          <button class="btn" id="completeAdButton">âœ… ${t('confirmWatched', 'æˆ‘å·²å®Œæ•´è§€çœ‹')}</button>
          <button class="btn btn-secondary" id="replayAdButton" style="margin-left: 8px;">ğŸ” ${t('replay', 'é‡æ–°æ’­æ”¾')}</button>
        </div>
      `;

      document.getElementById('completeAdButton')?.addEventListener('click', confirmCompletion);
      document.getElementById('replayAdButton')?.addEventListener('click', () => {
        window.location.reload();
      });
    }

    function confirmCompletion() {
      if (adCompleted || isSubmittingCompletion) {
        return;
      }
      const button = document.getElementById('completeAdButton');
      if (button) {
        button.textContent = `âŒ› ${t('sending', 'å‚³é€ä¸­...')}`;
        button.setAttribute('disabled', 'true');
      }
      onAdComplete();
    }

    // ========================================================================
    // Ad Completion
    // ========================================================================

    async function onAdComplete() {
      if (adCompleted || isSubmittingCompletion) {
        return;
      }

      isSubmittingCompletion = true;

      try {
        // Report completion to server
        const response = await fetch(`${API_BASE_URL}/api/ad/complete?user=${userId}&token=${token}&provider=${provider}`, {
          method: 'POST',
        });

        const data = await response.json();

        if (data.success) {
          adCompleted = true;
          showSuccess();
        } else {
          isSubmittingCompletion = false;
          showError(t('completeFailed', 'å®Œæˆå¤±æ•—'), data.message || t('tryAgainLater', 'è«‹ç¨å¾Œå†è©¦'));
          await reportError(data.message || 'completion_failed');
        }

      } catch (error) {
        console.error('Completion error:', error);
        showError(t('completeFailed', 'å®Œæˆå¤±æ•—'), t('networkError', 'ç¶²çµ¡éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦'));
        isSubmittingCompletion = false;
        await reportError(error.message || 'completion_network_error');
      }
    }

    // ========================================================================
    // UI Updates
    // ========================================================================

    function showSuccess() {
      const container = document.getElementById('adContainer');
      container.innerHTML = `
        <div class="success">
          <div class="success-icon">ğŸ‰</div>
          <h2>${t('completedTitle', 'è§€çœ‹å®Œæˆï¼')}</h2>
          <p>${t('completedReward', 'æ­å–œä½ ç²å¾— <strong>+1 å€‹é¡åº¦</strong>')}</p>
          <p style="margin-top: 16px; color: #999;">${t('returnToBot', 'è«‹è¿”å› Telegram ç¹¼çºŒä½¿ç”¨')}</p>
          <button class="btn" onclick="window.close()">${t('closePage', 'é—œé–‰é é¢')}</button>
        </div>
      `;
    }

    function showError(title, message) {
      const container = document.getElementById('adContainer');
      container.innerHTML = `
        <div class="error">
          <div class="error-icon">âŒ</div>
          <h2>${title}</h2>
          <p>${message}</p>
          <button class="btn" onclick="window.close()">${t('closePage', 'é—œé–‰é é¢')}</button>
        </div>
      `;
    }

    async function reportError(errorMessage) {
      try {
        await fetch(`${API_BASE_URL}/api/ad/error?user=${userId}&token=${token}&provider=${provider}&error=${encodeURIComponent(errorMessage)}`, {
          method: 'POST',
        });
      } catch (error) {
        console.error('Error reporting error:', error);
      }
    }

    // ========================================================================
    // Utility Functions
    // ========================================================================

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = () => reject(new Error(`Failed to load script: ${src}`));
        document.head.appendChild(script);
      });
    }

    // ========================================================================
    // Initialize
    // ========================================================================

    // Start when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    // Prevent accidental page close during ad
    window.addEventListener('beforeunload', (e) => {
      if (!adCompleted && adStartTime) {
        e.preventDefault();
        e.returnValue = '';
        return '';
      }
    });
  </script>
</body>
</html>